<!doctype html><html lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>æ·±å…¥ç†è§£MCPï¼šModel Context Protocolæ¶æ„è§£æä¸å¼€å‘å®è·µ - SincereCSL's Blog</title><meta name=Description content="å…¨é¢è§£æMCPï¼ˆModel Context Protocolï¼‰ï¼šä»æ¶æ„åŸç†åˆ°å¼€å‘å®è·µï¼Œæ¢ç´¢AIå·¥å…·çš„æ ‡å‡†åŒ–è¿æ¥åè®®"><meta property="og:url" content="https://sincerecsl.github.io/mcp/"><meta property="og:site_name" content="SincereCSL's Blog"><meta property="og:title" content="æ·±å…¥ç†è§£MCPï¼šModel Context Protocolæ¶æ„è§£æä¸å¼€å‘å®è·µ"><meta property="og:description" content="å…¨é¢è§£æMCPï¼ˆModel Context Protocolï¼‰ï¼šä»æ¶æ„åŸç†åˆ°å¼€å‘å®è·µï¼Œæ¢ç´¢AIå·¥å…·çš„æ ‡å‡†åŒ–è¿æ¥åè®®"><meta property="og:locale" content="zh_CN"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-06-15T10:30:00+08:00"><meta property="article:modified_time" content="2025-06-15T10:30:00+08:00"><meta property="article:tag" content="MCP"><meta property="article:tag" content="AI"><meta property="article:tag" content="LLM"><meta property="article:tag" content="Claude"><meta property="article:tag" content="åè®®"><meta property="article:tag" content="æ¶æ„"><meta name=twitter:card content="summary"><meta name=twitter:title content="æ·±å…¥ç†è§£MCPï¼šModel Context Protocolæ¶æ„è§£æä¸å¼€å‘å®è·µ"><meta name=twitter:description content="å…¨é¢è§£æMCPï¼ˆModel Context Protocolï¼‰ï¼šä»æ¶æ„åŸç†åˆ°å¼€å‘å®è·µï¼Œæ¢ç´¢AIå·¥å…·çš„æ ‡å‡†åŒ–è¿æ¥åè®®"><meta name=twitter:site content="@SincereCSL95"><meta name=application-name content="LoveIt"><meta name=apple-mobile-web-app-title content="LoveIt"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://sincerecsl.github.io/mcp/><link rel=next href=https://sincerecsl.github.io/ai/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=/lib/fontawesome-free/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/fontawesome-free/all.min.css></noscript><link rel=preload href=/lib/animate/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/animate/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"æ·±å…¥ç†è§£MCPï¼šModel Context Protocolæ¶æ„è§£æä¸å¼€å‘å®è·µ","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/sincerecsl.github.io\/mcp\/"},"genre":"posts","keywords":"MCP, AI, LLM, Claude, åè®®, æ¶æ„","wordcount":18885,"url":"https:\/\/sincerecsl.github.io\/mcp\/","datePublished":"2025-06-15T10:30:00+08:00","dateModified":"2025-06-15T10:30:00+08:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"SincereCSL"},"description":"å…¨é¢è§£æMCPï¼ˆModel Context Protocolï¼‰ï¼šä»æ¶æ„åŸç†åˆ°å¼€å‘å®è·µï¼Œæ¢ç´¢AIå·¥å…·çš„æ ‡å‡†åŒ–è¿æ¥åè®®"}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="SincereCSL's Blog"><span class=header-title-pre><i class='far fa-grin-stars fa-fw'></i></span>SincereCSL</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/>ä¸»é¡µ </a><a class=menu-item href=/posts/>æ‰€æœ‰æ–‡ç«  </a><a class=menu-item href=/links/>Links </a><a class=menu-item href=/categories/>åˆ†ç±» </a><a class=menu-item href=/about/>å…³äº </a><a class=menu-item href=https://github.com/SincereCSL rel="noopener noreffer" target=_blank><i class='fab fa-github fa-fw'></i> </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder=æœç´¢æ–‡ç« æ ‡é¢˜æˆ–å†…å®¹... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=æœç´¢><i class="fas fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=æ¸…ç©º><i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i>
</span></span><a href=javascript:void(0); class="menu-item theme-switch" title=åˆ‡æ¢ä¸»é¢˜><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="SincereCSL's Blog"><span class=header-title-pre><i class='far fa-grin-stars fa-fw'></i></span>SincereCSL</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=æœç´¢æ–‡ç« æ ‡é¢˜æˆ–å†…å®¹... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=æœç´¢><i class="fas fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=æ¸…ç©º><i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>å–æ¶ˆ</a></div><a class=menu-item href=/ title>ä¸»é¡µ</a><a class=menu-item href=/posts/ title>æ‰€æœ‰æ–‡ç« </a><a class=menu-item href=/links/ title>Links</a><a class=menu-item href=/categories/ title>åˆ†ç±»</a><a class=menu-item href=/about/ title>å…³äº</a><a class=menu-item href=https://github.com/SincereCSL title rel="noopener noreffer" target=_blank><i class='fab fa-github fa-fw'></i></a><a href=javascript:void(0); class="menu-item theme-switch" title=åˆ‡æ¢ä¸»é¢˜>
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>ç›®å½•</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">æ·±å…¥ç†è§£MCPï¼šModel Context Protocolæ¶æ„è§£æä¸å¼€å‘å®è·µ</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>SincereCSL</a></span>&nbsp;<span class=post-category>æ”¶å½•äº <a href=/categories/ai%E5%B7%A5%E5%85%B7/><i class="far fa-folder fa-fw" aria-hidden=true></i>AIå·¥å…·</a>&nbsp;<a href=/categories/%E6%8A%80%E6%9C%AF%E6%B7%B1%E5%BA%A6/><i class="far fa-folder fa-fw" aria-hidden=true></i>æŠ€æœ¯æ·±åº¦</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2025-06-15>2025-06-15</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;çº¦ 18885 å­—&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;é¢„è®¡é˜…è¯» 38 åˆ†é’Ÿ&nbsp;<span id=/mcp/ class=leancloud_visitors data-flag-title="æ·±å…¥ç†è§£MCPï¼šModel Context Protocolæ¶æ„è§£æä¸å¼€å‘å®è·µ">
<i class="far fa-eye fa-fw" aria-hidden=true></i>&nbsp;<span class=leancloud-visitors-count></span>&nbsp;æ¬¡é˜…è¯»
</span>&nbsp;</div></div><div class="details toc" id=toc-static data-kept=true><div class="details-summary toc-title"><span>ç›®å½•</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#-ä»€ä¹ˆæ˜¯mcp>ğŸ¯ ä»€ä¹ˆæ˜¯MCPï¼Ÿ</a><ul><li><a href=#å®šä¹‰ä¸æ¦‚å¿µ>å®šä¹‰ä¸æ¦‚å¿µ</a></li><li><a href=#æ ¸å¿ƒä»·å€¼>æ ¸å¿ƒä»·å€¼</a></li></ul></li><li><a href=#-mcpæ¶æ„æ·±åº¦è§£æ>ğŸ—ï¸ MCPæ¶æ„æ·±åº¦è§£æ</a><ul><li><a href=#æ•´ä½“æ¶æ„>æ•´ä½“æ¶æ„</a></li><li><a href=#æ ¸å¿ƒç»„ä»¶è¯¦è§£>æ ¸å¿ƒç»„ä»¶è¯¦è§£</a></li><li><a href=#é€šä¿¡æœºåˆ¶>é€šä¿¡æœºåˆ¶</a></li></ul></li><li><a href=#-mcpæ ¸å¿ƒæ¦‚å¿µè¯¦è§£>ğŸ’» MCPæ ¸å¿ƒæ¦‚å¿µè¯¦è§£</a><ul><li><a href=#åè®®ç”Ÿå‘½å‘¨æœŸç®¡ç†>åè®®ç”Ÿå‘½å‘¨æœŸç®¡ç†</a></li><li><a href=#1-resourcesèµ„æºæ·±åº¦è§£æ>1. Resourcesï¼ˆèµ„æºï¼‰æ·±åº¦è§£æ</a></li><li><a href=#2-toolså·¥å…·é«˜çº§ç‰¹æ€§>2. Toolsï¼ˆå·¥å…·ï¼‰é«˜çº§ç‰¹æ€§</a></li><li><a href=#3-promptsæç¤ºæ¨¡æ¿>3. Promptsï¼ˆæç¤ºæ¨¡æ¿ï¼‰</a></li><li><a href=#æ•°æ®åŠ å¯†ä¸è„±æ•>æ•°æ®åŠ å¯†ä¸è„±æ•</a></li></ul></li><li><a href=#-mcpåè®®æ‰©å±•>ğŸ”„ MCPåè®®æ‰©å±•</a><ul><li><a href=#è‡ªå®šä¹‰åè®®æ‰©å±•>è‡ªå®šä¹‰åè®®æ‰©å±•</a></li><li><a href=#äº‹ä»¶é©±åŠ¨æ¶æ„>äº‹ä»¶é©±åŠ¨æ¶æ„</a></li><li><a href=#äº‘åŸç”Ÿéƒ¨ç½²æ–¹æ¡ˆ>äº‘åŸç”Ÿéƒ¨ç½²æ–¹æ¡ˆ</a></li><li><a href=#é«˜çº§è°ƒè¯•ä¸è¯Šæ–­å·¥å…·>é«˜çº§è°ƒè¯•ä¸è¯Šæ–­å·¥å…·</a></li><li><a href=#æ™ºèƒ½é”™è¯¯æ¢å¤æœºåˆ¶>æ™ºèƒ½é”™è¯¯æ¢å¤æœºåˆ¶</a></li><li><a href=#å¤šç§Ÿæˆ·æ”¯æŒ>å¤šç§Ÿæˆ·æ”¯æŒ</a></li></ul></li><li><a href=#-mcpå¼€å‘å®è·µ>ğŸ› ï¸ MCPå¼€å‘å®è·µ</a><ul><li><a href=#å¼€å‘ç¯å¢ƒæ­å»º>å¼€å‘ç¯å¢ƒæ­å»º</a></li><li><a href=#å¼€å‘æœ€ä½³å®è·µ>å¼€å‘æœ€ä½³å®è·µ</a></li><li><a href=#è°ƒè¯•ä¸æµ‹è¯•>è°ƒè¯•ä¸æµ‹è¯•</a></li></ul></li><li><a href=#-å®é™…åº”ç”¨æ¡ˆä¾‹>ğŸ”§ å®é™…åº”ç”¨æ¡ˆä¾‹</a><ul><li><a href=#æ¡ˆä¾‹ä¸€ä»£ç åº“åˆ†ææœåŠ¡å™¨>æ¡ˆä¾‹ä¸€ï¼šä»£ç åº“åˆ†ææœåŠ¡å™¨</a></li><li><a href=#æ¡ˆä¾‹äºŒæ•°æ®åº“ç®¡ç†æœåŠ¡å™¨>æ¡ˆä¾‹äºŒï¼šæ•°æ®åº“ç®¡ç†æœåŠ¡å™¨</a></li><li><a href=#æ¡ˆä¾‹ä¸‰æ–‡æ¡£çŸ¥è¯†åº“æœåŠ¡å™¨>æ¡ˆä¾‹ä¸‰ï¼šæ–‡æ¡£çŸ¥è¯†åº“æœåŠ¡å™¨</a></li></ul></li><li><a href=#-ä¼ä¸šçº§éƒ¨ç½²æ–¹æ¡ˆ>ğŸ¢ ä¼ä¸šçº§éƒ¨ç½²æ–¹æ¡ˆ</a><ul><li><a href=#éƒ¨ç½²æ¶æ„>éƒ¨ç½²æ¶æ„</a></li><li><a href=#å®‰å…¨æœ€ä½³å®è·µ>å®‰å…¨æœ€ä½³å®è·µ</a></li></ul></li><li><a href=#-æœªæ¥å‘å±•è¶‹åŠ¿>ğŸš€ æœªæ¥å‘å±•è¶‹åŠ¿</a><ul><li><a href=#æŠ€æœ¯æ¼”è¿›æ–¹å‘>æŠ€æœ¯æ¼”è¿›æ–¹å‘</a></li></ul></li><li><a href=#-æ€§èƒ½ä¼˜åŒ–ä¸ç›‘æ§ç³»ç»Ÿ>ğŸ“Š æ€§èƒ½ä¼˜åŒ–ä¸ç›‘æ§ç³»ç»Ÿ</a><ul><li><a href=#é«˜çº§æ€§èƒ½ç›‘æ§>é«˜çº§æ€§èƒ½ç›‘æ§</a></li><li><a href=#ç¼“å­˜ä¼˜åŒ–ç­–ç•¥>ç¼“å­˜ä¼˜åŒ–ç­–ç•¥</a></li><li><a href=#æ€§èƒ½è°ƒä¼˜>æ€§èƒ½è°ƒä¼˜</a></li><li><a href=#ç›‘æ§ä½“ç³»>ç›‘æ§ä½“ç³»</a></li></ul></li><li><a href=#-å­¦ä¹ èµ„æºä¸ç¤¾åŒº>ğŸ“š å­¦ä¹ èµ„æºä¸ç¤¾åŒº</a><ul><li><a href=#å®˜æ–¹èµ„æº>å®˜æ–¹èµ„æº</a></li><li><a href=#å¼€å‘å·¥å…·>å¼€å‘å·¥å…·</a></li><li><a href=#ç¤¾åŒºé¡¹ç›®>ç¤¾åŒºé¡¹ç›®</a></li></ul></li><li><a href=#-æ€»ç»“>ğŸ“ æ€»ç»“</a><ul><li><a href=#-æ ¸å¿ƒä»·å€¼>ğŸ¯ æ ¸å¿ƒä»·å€¼</a></li><li><a href=#-æŠ€æœ¯ç‰¹ç‚¹>ğŸ—ï¸ æŠ€æœ¯ç‰¹ç‚¹</a></li><li><a href=#-å‘å±•å‰æ™¯>ğŸš€ å‘å±•å‰æ™¯</a></li></ul></li></ul></nav></div></div><div class=content id=content><blockquote><p>ğŸ“ <strong>å‰è¨€</strong>ï¼šMCPï¼ˆModel Context Protocolï¼‰æ˜¯ç”±Anthropicå‘å¸ƒçš„å¼€æ”¾æ ‡å‡†ï¼Œæ—¨åœ¨æ ‡å‡†åŒ–AIåŠ©æ‰‹ä¸æ•°æ®æºä¹‹é—´çš„è¿æ¥æ–¹å¼ã€‚æœ¬æ–‡å°†æ·±å…¥è§£æMCPçš„æ¶æ„åŸç†ã€å¼€å‘æ¨¡å¼å’Œå®é™…åº”ç”¨ï¼Œå¸®åŠ©å¼€å‘è€…ç†è§£å’Œä½¿ç”¨è¿™ä¸€é©å‘½æ€§çš„åè®®ã€‚</p></blockquote><h2 id=-ä»€ä¹ˆæ˜¯mcp>ğŸ¯ ä»€ä¹ˆæ˜¯MCPï¼Ÿ</h2><h3 id=å®šä¹‰ä¸æ¦‚å¿µ>å®šä¹‰ä¸æ¦‚å¿µ</h3><p><strong>Model Context Protocol (MCP)</strong> æ˜¯ä¸€ä¸ªå¼€æ”¾çš„åè®®æ ‡å‡†ï¼Œå®ƒæ ‡å‡†åŒ–äº†åº”ç”¨ç¨‹åºå‘å¤§è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰æä¾›ä¸Šä¸‹æ–‡çš„æ–¹å¼ã€‚</p><h4 id=å½¢è±¡æ¯”å–»>å½¢è±¡æ¯”å–»</h4><p>å¦‚æœæŠŠMCPæ¯”ä½œUSB-Cæ¥å£ï¼š</p><ul><li><strong>USB-C</strong>ï¼šä¸ºè®¾å¤‡è¿æ¥å„ç§å¤–è®¾æä¾›æ ‡å‡†åŒ–æ¥å£</li><li><strong>MCP</strong>ï¼šä¸ºAIæ¨¡å‹è¿æ¥ä¸åŒæ•°æ®æºå’Œå·¥å…·æä¾›æ ‡å‡†åŒ–åè®®</li></ul><h3 id=æ ¸å¿ƒä»·å€¼>æ ¸å¿ƒä»·å€¼</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-markdown data-lang=markdown><span class=line><span class=cl>ğŸ¯ MCPè§£å†³çš„æ ¸å¿ƒé—®é¢˜ï¼š
</span></span><span class=line><span class=cl><span class=k>1.</span> æ•°æ®å­¤å²›ï¼šAIæ¨¡å‹è¢«å›°åœ¨ä¿¡æ¯å­¤å²›ä¸­
</span></span><span class=line><span class=cl><span class=k>2.</span> é›†æˆå¤æ‚ï¼šæ¯ä¸ªæ•°æ®æºéœ€è¦å®šåˆ¶åŒ–å®ç°
</span></span><span class=line><span class=cl><span class=k>3.</span> æ‰©å±•å›°éš¾ï¼šè¿æ¥ç³»ç»Ÿéš¾ä»¥è§„æ¨¡åŒ–
</span></span><span class=line><span class=cl><span class=k>4.</span> ç»´æŠ¤æˆæœ¬ï¼šç¢ç‰‡åŒ–é›†æˆéš¾ä»¥ç»´æŠ¤
</span></span></code></pre></td></tr></table></div></div><h2 id=-mcpæ¶æ„æ·±åº¦è§£æ>ğŸ—ï¸ MCPæ¶æ„æ·±åº¦è§£æ</h2><h3 id=æ•´ä½“æ¶æ„>æ•´ä½“æ¶æ„</h3><p>MCPé‡‡ç”¨<strong>å®¢æˆ·ç«¯-æœåŠ¡å™¨</strong>æ¶æ„ï¼Œæ”¯æŒä¸€ä¸ªå®¿ä¸»åº”ç”¨è¿æ¥å¤šä¸ªæœåŠ¡å™¨ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>graph TB
</span></span><span class=line><span class=cl>    Host[MCP Host&lt;br/&gt;å®¿ä¸»åº”ç”¨] --&gt; Client1[MCP Client 1]
</span></span><span class=line><span class=cl>    Host --&gt; Client2[MCP Client 2]
</span></span><span class=line><span class=cl>    Host --&gt; Client3[MCP Client 3]
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    Client1 --&gt; Server1[MCP Server 1&lt;br/&gt;æ–‡ä»¶ç³»ç»Ÿ]
</span></span><span class=line><span class=cl>    Client2 --&gt; Server2[MCP Server 2&lt;br/&gt;æ•°æ®åº“]
</span></span><span class=line><span class=cl>    Client3 --&gt; Server3[MCP Server 3&lt;br/&gt;APIæœåŠ¡]
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    Server1 --&gt; Data1[æœ¬åœ°æ–‡ä»¶]
</span></span><span class=line><span class=cl>    Server2 --&gt; Data2[PostgreSQL]
</span></span><span class=line><span class=cl>    Server3 --&gt; Data3[å¤–éƒ¨API]
</span></span></code></pre></td></tr></table></div></div><h3 id=æ ¸å¿ƒç»„ä»¶è¯¦è§£>æ ¸å¿ƒç»„ä»¶è¯¦è§£</h3><h4 id=1-mcp-hostå®¿ä¸»>1. MCP Hostï¼ˆå®¿ä¸»ï¼‰</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-markdown data-lang=markdown><span class=line><span class=cl>ğŸ  å®šä¹‰ï¼šè¿è¡ŒAIæ¨¡å‹çš„åº”ç”¨ç¨‹åº
</span></span><span class=line><span class=cl>ğŸ“‹ åŠŸèƒ½ï¼š
</span></span><span class=line><span class=cl><span class=k>-</span> ç®¡ç†ä¸å¤šä¸ªMCPæœåŠ¡å™¨çš„è¿æ¥
</span></span><span class=line><span class=cl><span class=k>-</span> åè°ƒAIæ¨¡å‹ä¸å¤–éƒ¨æ•°æ®çš„äº¤äº’
</span></span><span class=line><span class=cl><span class=k>-</span> å¤„ç†ç”¨æˆ·è¯·æ±‚å’Œå“åº”
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ğŸ’¡ å…¸å‹ç¤ºä¾‹ï¼š
</span></span><span class=line><span class=cl><span class=k>-</span> Claude Desktop
</span></span><span class=line><span class=cl><span class=k>-</span> VS Codeæ’ä»¶
</span></span><span class=line><span class=cl><span class=k>-</span> è‡ªå®šä¹‰AIåº”ç”¨
</span></span></code></pre></td></tr></table></div></div><h4 id=2-mcp-clientå®¢æˆ·ç«¯>2. MCP Clientï¼ˆå®¢æˆ·ç«¯ï¼‰</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-markdown data-lang=markdown><span class=line><span class=cl>ğŸ”Œ å®šä¹‰ï¼šåè®®å®¢æˆ·ç«¯ï¼Œç»´æŠ¤ä¸æœåŠ¡å™¨çš„1:1è¿æ¥
</span></span><span class=line><span class=cl>ğŸ“‹ åŠŸèƒ½ï¼š
</span></span><span class=line><span class=cl><span class=k>-</span> å¤„ç†åè®®é€šä¿¡
</span></span><span class=line><span class=cl><span class=k>-</span> ç®¡ç†è¿æ¥çŠ¶æ€
</span></span><span class=line><span class=cl><span class=k>-</span> æ•°æ®åºåˆ—åŒ–/ååºåˆ—åŒ–
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ğŸ› ï¸ å®ç°æ–¹å¼ï¼š
</span></span><span class=line><span class=cl><span class=k>-</span> é€šå¸¸å†…åµŒåœ¨Hoståº”ç”¨ä¸­
</span></span><span class=line><span class=cl><span class=k>-</span> ä½¿ç”¨å®˜æ–¹SDKå¼€å‘
</span></span><span class=line><span class=cl><span class=k>-</span> æ”¯æŒå¤šç§ä¼ è¾“åè®®
</span></span></code></pre></td></tr></table></div></div><h4 id=3-mcp-serveræœåŠ¡å™¨>3. MCP Serverï¼ˆæœåŠ¡å™¨ï¼‰</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-markdown data-lang=markdown><span class=line><span class=cl>âš™ï¸ å®šä¹‰ï¼šè½»é‡çº§ç¨‹åºï¼Œé€šè¿‡æ ‡å‡†åè®®æš´éœ²ç‰¹å®šèƒ½åŠ›
</span></span><span class=line><span class=cl>ğŸ“‹ åŠŸèƒ½ï¼š
</span></span><span class=line><span class=cl><span class=k>-</span> æä¾›Resourcesï¼ˆèµ„æºï¼‰
</span></span><span class=line><span class=cl><span class=k>-</span> æš´éœ²Toolsï¼ˆå·¥å…·ï¼‰
</span></span><span class=line><span class=cl><span class=k>-</span> å®ç°Promptsï¼ˆæç¤ºæ¨¡æ¿ï¼‰
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ğŸŒŸ ç‰¹ç‚¹ï¼š
</span></span><span class=line><span class=cl><span class=k>-</span> å•ä¸€èŒè´£åŸåˆ™
</span></span><span class=line><span class=cl><span class=k>-</span> æ ‡å‡†åŒ–æ¥å£
</span></span><span class=line><span class=cl><span class=k>-</span> æ˜“äºéƒ¨ç½²å’Œç»´æŠ¤
</span></span></code></pre></td></tr></table></div></div><h3 id=é€šä¿¡æœºåˆ¶>é€šä¿¡æœºåˆ¶</h3><h4 id=ä¼ è¾“å±‚transport>ä¼ è¾“å±‚ï¼ˆTransportï¼‰</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;jsonrpc&#34;</span><span class=p>:</span> <span class=s2>&#34;2.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;method&#34;</span><span class=p>:</span> <span class=s2>&#34;resources/list&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;params&#34;</span><span class=p>:</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>MCPæ”¯æŒå¤šç§ä¼ è¾“æ–¹å¼ï¼š</p><h4 id=æ ‡å‡†è¾“å…¥è¾“å‡ºstdio>æ ‡å‡†è¾“å…¥/è¾“å‡ºï¼ˆstdioï¼‰</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># å¯åŠ¨stdioä¼ è¾“çš„MCPæœåŠ¡å™¨</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>sys</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>asyncio</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>mcp.server.stdio</span> <span class=kn>import</span> <span class=n>stdio_server</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>main</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>with</span> <span class=n>stdio_server</span><span class=p>()</span> <span class=k>as</span> <span class=p>(</span><span class=n>read_stream</span><span class=p>,</span> <span class=n>write_stream</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=n>run_server</span><span class=p>(</span><span class=n>read_stream</span><span class=p>,</span> <span class=n>write_stream</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>asyncio</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>main</span><span class=p>())</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=httpä¼ è¾“>HTTPä¼ è¾“</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># HTTPä¼ è¾“é…ç½®</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>mcp.server.fastapi</span> <span class=kn>import</span> <span class=n>create_mcp_app</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>fastapi</span> <span class=kn>import</span> <span class=n>FastAPI</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>app</span> <span class=o>=</span> <span class=n>FastAPI</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>mcp_app</span> <span class=o>=</span> <span class=n>create_mcp_app</span><span class=p>(</span><span class=n>MyMcpServer</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=n>app</span><span class=o>.</span><span class=n>mount</span><span class=p>(</span><span class=s2>&#34;/mcp&#34;</span><span class=p>,</span> <span class=n>mcp_app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># å¯åŠ¨HTTPæœåŠ¡å™¨</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=kn>import</span> <span class=nn>uvicorn</span>
</span></span><span class=line><span class=cl>    <span class=n>uvicorn</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>app</span><span class=p>,</span> <span class=n>host</span><span class=o>=</span><span class=s2>&#34;0.0.0.0&#34;</span><span class=p>,</span> <span class=n>port</span><span class=o>=</span><span class=mi>8000</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=websocketä¼ è¾“>WebSocketä¼ è¾“</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># WebSocketå®æ—¶é€šä¿¡</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>websockets</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>mcp.server.websocket</span> <span class=kn>import</span> <span class=n>websocket_server</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>handle_websocket</span><span class=p>(</span><span class=n>websocket</span><span class=p>,</span> <span class=n>path</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>with</span> <span class=n>websocket_server</span><span class=p>(</span><span class=n>websocket</span><span class=p>)</span> <span class=k>as</span> <span class=n>server</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=n>server</span><span class=o>.</span><span class=n>run</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>start_server</span> <span class=o>=</span> <span class=n>websockets</span><span class=o>.</span><span class=n>serve</span><span class=p>(</span><span class=n>handle_websocket</span><span class=p>,</span> <span class=s2>&#34;localhost&#34;</span><span class=p>,</span> <span class=mi>8765</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>asyncio</span><span class=o>.</span><span class=n>get_event_loop</span><span class=p>()</span><span class=o>.</span><span class=n>run_until_complete</span><span class=p>(</span><span class=n>start_server</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=åè®®æ¶ˆæ¯æ ¼å¼è¯¦è§£>åè®®æ¶ˆæ¯æ ¼å¼è¯¦è§£</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;jsonrpc&#34;</span><span class=p>:</span> <span class=s2>&#34;2.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;method&#34;</span><span class=p>:</span> <span class=s2>&#34;initialize&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;params&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;protocolVersion&#34;</span><span class=p>:</span> <span class=s2>&#34;2024-11-05&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;capabilities&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;resources&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;subscribe&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;listChanged&#34;</span><span class=p>:</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;tools&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;listChanged&#34;</span><span class=p>:</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;prompts&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;listChanged&#34;</span><span class=p>:</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;logging&#34;</span><span class=p>:</span> <span class=p>{},</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;sampling&#34;</span><span class=p>:</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;clientInfo&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;example-client&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;version&#34;</span><span class=p>:</span> <span class=s2>&#34;1.0.0&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=-mcpæ ¸å¿ƒæ¦‚å¿µè¯¦è§£>ğŸ’» MCPæ ¸å¿ƒæ¦‚å¿µè¯¦è§£</h2><h3 id=åè®®ç”Ÿå‘½å‘¨æœŸç®¡ç†>åè®®ç”Ÿå‘½å‘¨æœŸç®¡ç†</h3><h4 id=1-è¿æ¥å»ºç«‹æµç¨‹>1. è¿æ¥å»ºç«‹æµç¨‹</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>sequenceDiagram</span>
</span></span><span class=line><span class=cl>    <span class=n>participant</span> <span class=n>Client</span>
</span></span><span class=line><span class=cl>    <span class=n>participant</span> <span class=n>Server</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>Client</span><span class=o>-&gt;&gt;</span><span class=n>Server</span><span class=p>:</span> <span class=n>initialize</span> <span class=n>request</span>
</span></span><span class=line><span class=cl>    <span class=n>Server</span><span class=o>-&gt;&gt;</span><span class=n>Client</span><span class=p>:</span> <span class=n>initialize</span> <span class=n>response</span>
</span></span><span class=line><span class=cl>    <span class=n>Client</span><span class=o>-&gt;&gt;</span><span class=n>Server</span><span class=p>:</span> <span class=n>initialized</span> <span class=n>notification</span>
</span></span><span class=line><span class=cl>    <span class=n>Note</span> <span class=n>over</span> <span class=n>Client</span><span class=p>,</span><span class=n>Server</span><span class=p>:</span> <span class=err>è¿æ¥å»ºç«‹å®Œæˆ</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>Client</span><span class=o>-&gt;&gt;</span><span class=n>Server</span><span class=p>:</span> <span class=n>resources</span><span class=o>/</span><span class=n>list</span>
</span></span><span class=line><span class=cl>    <span class=n>Server</span><span class=o>-&gt;&gt;</span><span class=n>Client</span><span class=p>:</span> <span class=n>resources</span> <span class=n>list</span> <span class=n>response</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>Client</span><span class=o>-&gt;&gt;</span><span class=n>Server</span><span class=p>:</span> <span class=n>tools</span><span class=o>/</span><span class=n>list</span>  
</span></span><span class=line><span class=cl>    <span class=n>Server</span><span class=o>-&gt;&gt;</span><span class=n>Client</span><span class=p>:</span> <span class=n>tools</span> <span class=n>list</span> <span class=n>response</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>Note</span> <span class=n>over</span> <span class=n>Client</span><span class=p>,</span><span class=n>Server</span><span class=p>:</span> <span class=err>æ­£å¸¸é€šä¿¡é˜¶æ®µ</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=2-èƒ½åŠ›åå•†capabilities>2. èƒ½åŠ›åå•†ï¼ˆCapabilitiesï¼‰</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>ServerCapabilities</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>resources</span> <span class=o>=</span> <span class=n>ResourceCapabilities</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>subscribe</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>        <span class=c1># æ”¯æŒèµ„æºè®¢é˜…</span>
</span></span><span class=line><span class=cl>            <span class=n>listChanged</span><span class=o>=</span><span class=kc>True</span>      <span class=c1># æ”¯æŒåˆ—è¡¨å˜æ›´é€šçŸ¥</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>tools</span> <span class=o>=</span> <span class=n>ToolCapabilities</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>listChanged</span><span class=o>=</span><span class=kc>True</span>      <span class=c1># æ”¯æŒå·¥å…·åˆ—è¡¨å˜æ›´</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>prompts</span> <span class=o>=</span> <span class=n>PromptCapabilities</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>listChanged</span><span class=o>=</span><span class=kc>True</span>      <span class=c1># æ”¯æŒæç¤ºæ¨¡æ¿å˜æ›´</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>logging</span> <span class=o>=</span> <span class=n>LoggingCapabilities</span><span class=p>()</span>      <span class=c1># æ—¥å¿—åŠŸèƒ½</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>sampling</span> <span class=o>=</span> <span class=n>SamplingCapabilities</span><span class=p>()</span>   <span class=c1># é‡‡æ ·åŠŸèƒ½</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># æœåŠ¡å™¨èƒ½åŠ›å£°æ˜</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>handle_initialize</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>params</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>InitializeResult</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>protocolVersion</span><span class=o>=</span><span class=s2>&#34;2024-11-05&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>capabilities</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>get_capabilities</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=n>serverInfo</span><span class=o>=</span><span class=n>ServerInfo</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>name</span><span class=o>=</span><span class=s2>&#34;advanced-mcp-server&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>version</span><span class=o>=</span><span class=s2>&#34;2.0.0&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=1-resourcesèµ„æºæ·±åº¦è§£æ>1. Resourcesï¼ˆèµ„æºï¼‰æ·±åº¦è§£æ</h3><h4 id=å®šä¹‰ä¸ä½œç”¨>å®šä¹‰ä¸ä½œç”¨</h4><p>Resourcesæ˜¯MCPæœåŠ¡å™¨æš´éœ²ç»™AIæ¨¡å‹çš„<strong>åªè¯»æ•°æ®</strong>ï¼Œå¯ä»¥æ˜¯æ–‡ä»¶ã€æ•°æ®åº“è®°å½•ã€APIå“åº”ç­‰ã€‚</p><h4 id=èµ„æºç±»å‹ç³»ç»Ÿ>èµ„æºç±»å‹ç³»ç»Ÿ</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Union</span><span class=p>,</span> <span class=n>List</span><span class=p>,</span> <span class=n>Dict</span><span class=p>,</span> <span class=n>Any</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>dataclasses</span> <span class=kn>import</span> <span class=n>dataclass</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>enum</span> <span class=kn>import</span> <span class=n>Enum</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ResourceType</span><span class=p>(</span><span class=n>Enum</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>TEXT</span> <span class=o>=</span> <span class=s2>&#34;text&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>BINARY</span> <span class=o>=</span> <span class=s2>&#34;binary&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>JSON</span> <span class=o>=</span> <span class=s2>&#34;json&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>XML</span> <span class=o>=</span> <span class=s2>&#34;xml&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>CSV</span> <span class=o>=</span> <span class=s2>&#34;csv&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>IMAGE</span> <span class=o>=</span> <span class=s2>&#34;image&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>AUDIO</span> <span class=o>=</span> <span class=s2>&#34;audio&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>VIDEO</span> <span class=o>=</span> <span class=s2>&#34;video&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@dataclass</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ResourceMetadata</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;èµ„æºå…ƒæ•°æ®&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>size</span><span class=p>:</span> <span class=nb>int</span>
</span></span><span class=line><span class=cl>    <span class=n>lastModified</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>encoding</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>language</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=n>tags</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=n>permissions</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=nb>bool</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@dataclass</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>AdvancedResource</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>uri</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>name</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>description</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>mimeType</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>resourceType</span><span class=p>:</span> <span class=n>ResourceType</span>
</span></span><span class=line><span class=cl>    <span class=n>metadata</span><span class=p>:</span> <span class=n>ResourceMetadata</span>
</span></span><span class=line><span class=cl>    <span class=n>annotations</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=é«˜çº§èµ„æºå®ç°>é«˜çº§èµ„æºå®ç°</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>AdvancedResourceServer</span><span class=p>(</span><span class=n>McpServer</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span><span class=s2>&#34;advanced-resource-server&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>resource_cache</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>resource_subscribers</span> <span class=o>=</span> <span class=nb>set</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>list_resources</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=n>AdvancedResource</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;åˆ—å‡ºæ‰€æœ‰å¯ç”¨èµ„æº&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>resources</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># åŠ¨æ€æ‰«ææ–‡ä»¶ç³»ç»Ÿ</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>file_path</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>scan_directory</span><span class=p>(</span><span class=s2>&#34;/data&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>resource</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>create_resource_from_file</span><span class=p>(</span><span class=n>file_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>resources</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>resource</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>        <span class=c1># æ•°æ®åº“èµ„æº</span>
</span></span><span class=line><span class=cl>        <span class=n>db_resources</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_database_resources</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>resources</span><span class=o>.</span><span class=n>extend</span><span class=p>(</span><span class=n>db_resources</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># APIèµ„æº</span>
</span></span><span class=line><span class=cl>        <span class=n>api_resources</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_api_resources</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>resources</span><span class=o>.</span><span class=n>extend</span><span class=p>(</span><span class=n>api_resources</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>resources</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>read_resource</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>uri</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Union</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=nb>bytes</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;è¯»å–èµ„æºå†…å®¹ï¼Œæ”¯æŒç¼“å­˜å’Œå‹ç¼©&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># æ£€æŸ¥ç¼“å­˜</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>uri</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>resource_cache</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>cache_entry</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>resource_cache</span><span class=p>[</span><span class=n>uri</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>is_cache_expired</span><span class=p>(</span><span class=n>cache_entry</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>cache_entry</span><span class=p>[</span><span class=s1>&#39;content&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># æ ¹æ®URIç±»å‹è¯»å–èµ„æº</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>uri</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s2>&#34;file://&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>content</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>read_file_resource</span><span class=p>(</span><span class=n>uri</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>uri</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s2>&#34;db://&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>content</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>read_database_resource</span><span class=p>(</span><span class=n>uri</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>uri</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s2>&#34;api://&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>content</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>read_api_resource</span><span class=p>(</span><span class=n>uri</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;ä¸æ”¯æŒçš„èµ„æºURI: </span><span class=si>{</span><span class=n>uri</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># æ›´æ–°ç¼“å­˜</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>resource_cache</span><span class=p>[</span><span class=n>uri</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;content&#39;</span><span class=p>:</span> <span class=n>content</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;timestamp&#39;</span><span class=p>:</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;size&#39;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=n>content</span><span class=p>)</span> <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>content</span><span class=p>,</span> <span class=nb>str</span><span class=p>)</span> <span class=k>else</span> <span class=nb>len</span><span class=p>(</span><span class=n>content</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>content</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>subscribe_to_resource</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>uri</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;è®¢é˜…èµ„æºå˜æ›´é€šçŸ¥&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>resource_subscribers</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>uri</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># å¯åŠ¨æ–‡ä»¶ç›‘æ§</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>start_file_watcher</span><span class=p>(</span><span class=n>uri</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>notify_resource_changed</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>uri</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;é€šçŸ¥èµ„æºå˜æ›´&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>uri</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>resource_subscribers</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>send_notification</span><span class=p>(</span><span class=s2>&#34;notifications/resources/updated&#34;</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;uri&#34;</span><span class=p>:</span> <span class=n>uri</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;timestamp&#34;</span><span class=p>:</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=p>})</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=å®ç°ç¤ºä¾‹>å®ç°ç¤ºä¾‹</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># æ–‡ä»¶ç³»ç»Ÿèµ„æºæœåŠ¡å™¨</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>mcp</span> <span class=kn>import</span> <span class=n>McpServer</span><span class=p>,</span> <span class=n>Resource</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>FileSystemServer</span><span class=p>(</span><span class=n>McpServer</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>list_resources</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=n>Resource</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>uri</span><span class=o>=</span><span class=s2>&#34;file:///path/to/document.txt&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>name</span><span class=o>=</span><span class=s2>&#34;é¡¹ç›®æ–‡æ¡£&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>description</span><span class=o>=</span><span class=s2>&#34;é¡¹ç›®çš„è¯¦ç»†è¯´æ˜æ–‡æ¡£&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>mimeType</span><span class=o>=</span><span class=s2>&#34;text/plain&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>read_resource</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>uri</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>uri</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s2>&#34;file://&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>path</span> <span class=o>=</span> <span class=n>uri</span><span class=p>[</span><span class=mi>7</span><span class=p>:]</span>  <span class=c1># ç§»é™¤file://å‰ç¼€</span>
</span></span><span class=line><span class=cl>            <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>path</span><span class=p>,</span> <span class=s1>&#39;r&#39;</span><span class=p>,</span> <span class=n>encoding</span><span class=o>=</span><span class=s1>&#39;utf-8&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>f</span><span class=o>.</span><span class=n>read</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=åº”ç”¨åœºæ™¯>åº”ç”¨åœºæ™¯</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-markdown data-lang=markdown><span class=line><span class=cl>ğŸ“ æ–‡ä»¶ç³»ç»Ÿï¼š
</span></span><span class=line><span class=cl><span class=k>-</span> ä»£ç æ–‡ä»¶ã€æ–‡æ¡£ã€é…ç½®æ–‡ä»¶
</span></span><span class=line><span class=cl><span class=k>-</span> æ”¯æŒå¤šç§æ–‡ä»¶æ ¼å¼ï¼ˆtxt, md, json, etc.ï¼‰
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ğŸ—„ï¸ æ•°æ®åº“ï¼š
</span></span><span class=line><span class=cl><span class=k>-</span> è¡¨ç»“æ„ã€æŸ¥è¯¢ç»“æœ
</span></span><span class=line><span class=cl><span class=k>-</span> æ”¯æŒSQLå’ŒNoSQLæ•°æ®åº“
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ğŸŒ Webèµ„æºï¼š
</span></span><span class=line><span class=cl><span class=k>-</span> APIå“åº”ã€ç½‘é¡µå†…å®¹
</span></span><span class=line><span class=cl><span class=k>-</span> å®æ—¶æ•°æ®æŠ“å–
</span></span></code></pre></td></tr></table></div></div><h3 id=2-toolså·¥å…·é«˜çº§ç‰¹æ€§>2. Toolsï¼ˆå·¥å…·ï¼‰é«˜çº§ç‰¹æ€§</h3><h4 id=å®šä¹‰ä¸ä½œç”¨-1>å®šä¹‰ä¸ä½œç”¨</h4><p>Toolså…è®¸AIæ¨¡å‹<strong>æ‰§è¡Œæ“ä½œ</strong>ï¼Œå¦‚æ–‡ä»¶å†™å…¥ã€APIè°ƒç”¨ã€æ•°æ®åº“æ›´æ–°ç­‰ã€‚</p><h4 id=å·¥å…·å‚æ•°éªŒè¯ç³»ç»Ÿ>å·¥å…·å‚æ•°éªŒè¯ç³»ç»Ÿ</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pydantic</span> <span class=kn>import</span> <span class=n>BaseModel</span><span class=p>,</span> <span class=n>validator</span><span class=p>,</span> <span class=n>Field</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Optional</span><span class=p>,</span> <span class=n>Union</span><span class=p>,</span> <span class=n>List</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>jsonschema</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>AdvancedToolParameter</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;é«˜çº§å·¥å…·å‚æ•°å®šä¹‰&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>name</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=nb>type</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>description</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>required</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>    <span class=n>default</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=n>Any</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=n>enum</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]]</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=n>pattern</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=n>minimum</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>float</span><span class=p>]]</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=n>maximum</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>float</span><span class=p>]]</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@validator</span><span class=p>(</span><span class=s1>&#39;type&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>validate_type</span><span class=p>(</span><span class=bp>cls</span><span class=p>,</span> <span class=n>v</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>valid_types</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;string&#39;</span><span class=p>,</span> <span class=s1>&#39;number&#39;</span><span class=p>,</span> <span class=s1>&#39;integer&#39;</span><span class=p>,</span> <span class=s1>&#39;boolean&#39;</span><span class=p>,</span> <span class=s1>&#39;array&#39;</span><span class=p>,</span> <span class=s1>&#39;object&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>v</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>valid_types</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;Invalid type: </span><span class=si>{</span><span class=n>v</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>v</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>AdvancedTool</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;é«˜çº§å·¥å…·å®šä¹‰&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>name</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>description</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>parameters</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>AdvancedToolParameter</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>examples</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=n>List</span><span class=p>[</span><span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]]]</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=n>category</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s2>&#34;general&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>tags</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=n>timeout</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>30</span>  <span class=c1># è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰</span>
</span></span><span class=line><span class=cl>    <span class=n>retryable</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>    <span class=n>permissions</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>validate_input</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>arguments</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;éªŒè¯è¾“å…¥å‚æ•°&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>schema</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>generate_json_schema</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>jsonschema</span><span class=o>.</span><span class=n>validate</span><span class=p>(</span><span class=n>arguments</span><span class=p>,</span> <span class=n>schema</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=n>jsonschema</span><span class=o>.</span><span class=n>ValidationError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;å‚æ•°éªŒè¯å¤±è´¥: </span><span class=si>{</span><span class=n>e</span><span class=o>.</span><span class=n>message</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>generate_json_schema</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;ç”ŸæˆJSON Schemaç”¨äºå‚æ•°éªŒè¯&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>properties</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=n>required</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>param</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>parameters</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>prop</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;type&#34;</span><span class=p>:</span> <span class=n>param</span><span class=o>.</span><span class=n>type</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;description&#34;</span><span class=p>:</span> <span class=n>param</span><span class=o>.</span><span class=n>description</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>param</span><span class=o>.</span><span class=n>enum</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>prop</span><span class=p>[</span><span class=s2>&#34;enum&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=n>param</span><span class=o>.</span><span class=n>enum</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>param</span><span class=o>.</span><span class=n>pattern</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>prop</span><span class=p>[</span><span class=s2>&#34;pattern&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=n>param</span><span class=o>.</span><span class=n>pattern</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>param</span><span class=o>.</span><span class=n>minimum</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>prop</span><span class=p>[</span><span class=s2>&#34;minimum&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=n>param</span><span class=o>.</span><span class=n>minimum</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>param</span><span class=o>.</span><span class=n>maximum</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>prop</span><span class=p>[</span><span class=s2>&#34;maximum&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=n>param</span><span class=o>.</span><span class=n>maximum</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>param</span><span class=o>.</span><span class=n>default</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>prop</span><span class=p>[</span><span class=s2>&#34;default&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=n>param</span><span class=o>.</span><span class=n>default</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>            <span class=n>properties</span><span class=p>[</span><span class=n>param</span><span class=o>.</span><span class=n>name</span><span class=p>]</span> <span class=o>=</span> <span class=n>prop</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>param</span><span class=o>.</span><span class=n>required</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>required</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>param</span><span class=o>.</span><span class=n>name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;object&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;properties&#34;</span><span class=p>:</span> <span class=n>properties</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;required&#34;</span><span class=p>:</span> <span class=n>required</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=å·¥å…·æ‰§è¡Œå¼•æ“>å·¥å…·æ‰§è¡Œå¼•æ“</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>asyncio</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>contextlib</span> <span class=kn>import</span> <span class=n>asynccontextmanager</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>AsyncGenerator</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ToolExecutionContext</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;å·¥å…·æ‰§è¡Œä¸Šä¸‹æ–‡&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>tool_name</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>client_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>tool_name</span> <span class=o>=</span> <span class=n>tool_name</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>client_id</span> <span class=o>=</span> <span class=n>client_id</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>start_time</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>execution_id</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>tool_name</span><span class=si>}</span><span class=s2>_</span><span class=si>{</span><span class=nb>int</span><span class=p>(</span><span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>())</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>metadata</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>AdvancedToolServer</span><span class=p>(</span><span class=n>McpServer</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span><span class=s2>&#34;advanced-tool-server&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>tool_registry</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>execution_history</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>concurrent_executions</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>register_tool</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>tool</span><span class=p>:</span> <span class=n>AdvancedTool</span><span class=p>,</span> <span class=n>handler_func</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;æ³¨å†Œå·¥å…·å’Œå¤„ç†å‡½æ•°&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>tool_registry</span><span class=p>[</span><span class=n>tool</span><span class=o>.</span><span class=n>name</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;tool&#39;</span><span class=p>:</span> <span class=n>tool</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;handler&#39;</span><span class=p>:</span> <span class=n>handler_func</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>list_tools</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=n>AdvancedTool</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;åˆ—å‡ºæ‰€æœ‰æ³¨å†Œçš„å·¥å…·&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>[</span><span class=n>entry</span><span class=p>[</span><span class=s1>&#39;tool&#39;</span><span class=p>]</span> <span class=k>for</span> <span class=n>entry</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>tool_registry</span><span class=o>.</span><span class=n>values</span><span class=p>()]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@asynccontextmanager</span>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>execution_context</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>tool_name</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>client_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>AsyncGenerator</span><span class=p>[</span><span class=n>ToolExecutionContext</span><span class=p>,</span> <span class=kc>None</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;å·¥å…·æ‰§è¡Œä¸Šä¸‹æ–‡ç®¡ç†å™¨&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>context</span> <span class=o>=</span> <span class=n>ToolExecutionContext</span><span class=p>(</span><span class=n>tool_name</span><span class=p>,</span> <span class=n>client_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>concurrent_executions</span><span class=p>[</span><span class=n>context</span><span class=o>.</span><span class=n>execution_id</span><span class=p>]</span> <span class=o>=</span> <span class=n>context</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>yield</span> <span class=n>context</span>
</span></span><span class=line><span class=cl>        <span class=k>finally</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># è®°å½•æ‰§è¡Œå†å²</span>
</span></span><span class=line><span class=cl>            <span class=n>context</span><span class=o>.</span><span class=n>end_time</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>context</span><span class=o>.</span><span class=n>duration</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=n>end_time</span> <span class=o>-</span> <span class=n>context</span><span class=o>.</span><span class=n>start_time</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>execution_history</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>context</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># æ¸…ç†å¹¶å‘æ‰§è¡Œè®°å½•</span>
</span></span><span class=line><span class=cl>            <span class=k>del</span> <span class=bp>self</span><span class=o>.</span><span class=n>concurrent_executions</span><span class=p>[</span><span class=n>context</span><span class=o>.</span><span class=n>execution_id</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>call_tool</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>arguments</span><span class=p>:</span> <span class=nb>dict</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>ToolResult</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;æ‰§è¡Œå·¥å…·è°ƒç”¨&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>name</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>tool_registry</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=n>McpError</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>code</span><span class=o>=</span><span class=n>ErrorCode</span><span class=o>.</span><span class=n>METHOD_NOT_FOUND</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>message</span><span class=o>=</span><span class=sa>f</span><span class=s2>&#34;å·¥å…· &#39;</span><span class=si>{</span><span class=n>name</span><span class=si>}</span><span class=s2>&#39; æœªæ‰¾åˆ°&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>tool_entry</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>tool_registry</span><span class=p>[</span><span class=n>name</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>tool</span> <span class=o>=</span> <span class=n>tool_entry</span><span class=p>[</span><span class=s1>&#39;tool&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>handler</span> <span class=o>=</span> <span class=n>tool_entry</span><span class=p>[</span><span class=s1>&#39;handler&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># å‚æ•°éªŒè¯</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>tool</span><span class=o>.</span><span class=n>validate_input</span><span class=p>(</span><span class=n>arguments</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>ValueError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=n>McpError</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>code</span><span class=o>=</span><span class=n>ErrorCode</span><span class=o>.</span><span class=n>INVALID_PARAMS</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>message</span><span class=o>=</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># æƒé™æ£€æŸ¥</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>check_tool_permissions</span><span class=p>(</span><span class=n>tool</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_current_client_id</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># æ‰§è¡Œå·¥å…·</span>
</span></span><span class=line><span class=cl>        <span class=k>async</span> <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>execution_context</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_current_client_id</span><span class=p>())</span> <span class=k>as</span> <span class=n>context</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1># è®¾ç½®è¶…æ—¶</span>
</span></span><span class=line><span class=cl>                <span class=n>result</span> <span class=o>=</span> <span class=k>await</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>wait_for</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                    <span class=n>handler</span><span class=p>(</span><span class=n>arguments</span><span class=p>,</span> <span class=n>context</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                    <span class=n>timeout</span><span class=o>=</span><span class=n>tool</span><span class=o>.</span><span class=n>timeout</span>
</span></span><span class=line><span class=cl>                <span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>            <span class=k>except</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>TimeoutError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>raise</span> <span class=n>McpError</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                    <span class=n>code</span><span class=o>=</span><span class=n>ErrorCode</span><span class=o>.</span><span class=n>REQUEST_TIMEOUT</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>message</span><span class=o>=</span><span class=sa>f</span><span class=s2>&#34;å·¥å…·æ‰§è¡Œè¶…æ—¶ (</span><span class=si>{</span><span class=n>tool</span><span class=o>.</span><span class=n>timeout</span><span class=si>}</span><span class=s2>ç§’)&#34;</span>
</span></span><span class=line><span class=cl>                <span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>tool</span><span class=o>.</span><span class=n>retryable</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=c1># å¯é‡è¯•çš„å·¥å…·è¿›è¡Œé‡è¯•</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>retry_tool_execution</span><span class=p>(</span><span class=n>tool</span><span class=p>,</span> <span class=n>handler</span><span class=p>,</span> <span class=n>arguments</span><span class=p>,</span> <span class=n>context</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>raise</span> <span class=n>McpError</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                        <span class=n>code</span><span class=o>=</span><span class=n>ErrorCode</span><span class=o>.</span><span class=n>INTERNAL_ERROR</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>message</span><span class=o>=</span><span class=sa>f</span><span class=s2>&#34;å·¥å…·æ‰§è¡Œå¤±è´¥: </span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>retry_tool_execution</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>tool</span><span class=p>:</span> <span class=n>AdvancedTool</span><span class=p>,</span> <span class=n>handler</span><span class=p>,</span> <span class=n>arguments</span><span class=p>:</span> <span class=nb>dict</span><span class=p>,</span> <span class=n>context</span><span class=p>:</span> <span class=n>ToolExecutionContext</span><span class=p>,</span> <span class=n>max_retries</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>3</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>ToolResult</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;é‡è¯•å·¥å…·æ‰§è¡Œ&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>attempt</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>max_retries</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>await</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>2</span> <span class=o>**</span> <span class=n>attempt</span><span class=p>)</span>  <span class=c1># æŒ‡æ•°é€€é¿</span>
</span></span><span class=line><span class=cl>                <span class=n>result</span> <span class=o>=</span> <span class=k>await</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>wait_for</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                    <span class=n>handler</span><span class=p>(</span><span class=n>arguments</span><span class=p>,</span> <span class=n>context</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                    <span class=n>timeout</span><span class=o>=</span><span class=n>tool</span><span class=o>.</span><span class=n>timeout</span>
</span></span><span class=line><span class=cl>                <span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>            <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>attempt</span> <span class=o>==</span> <span class=n>max_retries</span> <span class=o>-</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>raise</span> <span class=n>McpError</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                        <span class=n>code</span><span class=o>=</span><span class=n>ErrorCode</span><span class=o>.</span><span class=n>INTERNAL_ERROR</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>message</span><span class=o>=</span><span class=sa>f</span><span class=s2>&#34;å·¥å…·æ‰§è¡Œå¤±è´¥ï¼ˆé‡è¯•</span><span class=si>{</span><span class=n>max_retries</span><span class=si>}</span><span class=s2>æ¬¡åï¼‰: </span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>continue</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=å·¥å…·ç»„åˆä¸å·¥ä½œæµ>å·¥å…·ç»„åˆä¸å·¥ä½œæµ</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>ToolWorkflow</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;å·¥å…·å·¥ä½œæµç¼–æ’&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>name</span> <span class=o>=</span> <span class=n>name</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>steps</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>conditions</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>add_step</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>tool_name</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>arguments</span><span class=p>:</span> <span class=nb>dict</span><span class=p>,</span> <span class=n>condition</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=n>callable</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;æ·»åŠ å·¥ä½œæµæ­¥éª¤&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>steps</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;tool&#39;</span><span class=p>:</span> <span class=n>tool_name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;arguments&#39;</span><span class=p>:</span> <span class=n>arguments</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;condition&#39;</span><span class=p>:</span> <span class=n>condition</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>execute</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>tool_server</span><span class=p>:</span> <span class=n>AdvancedToolServer</span><span class=p>,</span> <span class=n>context</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=n>ToolResult</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;æ‰§è¡Œå·¥ä½œæµ&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>results</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=n>workflow_context</span> <span class=o>=</span> <span class=n>context</span> <span class=ow>or</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>step</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>steps</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># æ£€æŸ¥æ‰§è¡Œæ¡ä»¶</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>step</span><span class=p>[</span><span class=s1>&#39;condition&#39;</span><span class=p>]</span> <span class=ow>and</span> <span class=ow>not</span> <span class=n>step</span><span class=p>[</span><span class=s1>&#39;condition&#39;</span><span class=p>](</span><span class=n>workflow_context</span><span class=p>,</span> <span class=n>results</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=k>continue</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># åŠ¨æ€å‚æ•°æ›¿æ¢</span>
</span></span><span class=line><span class=cl>            <span class=n>arguments</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>resolve_arguments</span><span class=p>(</span><span class=n>step</span><span class=p>[</span><span class=s1>&#39;arguments&#39;</span><span class=p>],</span> <span class=n>workflow_context</span><span class=p>,</span> <span class=n>results</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># æ‰§è¡Œå·¥å…·</span>
</span></span><span class=line><span class=cl>            <span class=n>result</span> <span class=o>=</span> <span class=k>await</span> <span class=n>tool_server</span><span class=o>.</span><span class=n>call_tool</span><span class=p>(</span><span class=n>step</span><span class=p>[</span><span class=s1>&#39;tool&#39;</span><span class=p>],</span> <span class=n>arguments</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>results</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>result</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># æ›´æ–°ä¸Šä¸‹æ–‡</span>
</span></span><span class=line><span class=cl>            <span class=n>workflow_context</span><span class=p>[</span><span class=sa>f</span><span class=s2>&#34;step_</span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>results</span><span class=p>)</span><span class=si>}</span><span class=s2>_result&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>results</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>resolve_arguments</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>arguments</span><span class=p>:</span> <span class=nb>dict</span><span class=p>,</span> <span class=n>context</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>],</span> <span class=n>results</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>ToolResult</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=nb>dict</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;è§£æåŠ¨æ€å‚æ•°&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>resolved</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>key</span><span class=p>,</span> <span class=n>value</span> <span class=ow>in</span> <span class=n>arguments</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>value</span><span class=p>,</span> <span class=nb>str</span><span class=p>)</span> <span class=ow>and</span> <span class=n>value</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s2>&#34;${&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=c1># åŠ¨æ€å‚æ•°è§£æ</span>
</span></span><span class=line><span class=cl>                <span class=n>var_name</span> <span class=o>=</span> <span class=n>value</span><span class=p>[</span><span class=mi>2</span><span class=p>:</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>  <span class=c1># ç§»é™¤ ${ å’Œ }</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>var_name</span> <span class=ow>in</span> <span class=n>context</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>resolved</span><span class=p>[</span><span class=n>key</span><span class=p>]</span> <span class=o>=</span> <span class=n>context</span><span class=p>[</span><span class=n>var_name</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                <span class=k>elif</span> <span class=n>var_name</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s2>&#34;result_&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                    <span class=c1># å¼•ç”¨ä¹‹å‰çš„ç»“æœ</span>
</span></span><span class=line><span class=cl>                    <span class=n>index</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>var_name</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&#34;_&#34;</span><span class=p>)[</span><span class=mi>1</span><span class=p>])</span> <span class=o>-</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=mi>0</span> <span class=o>&lt;=</span> <span class=n>index</span> <span class=o>&lt;</span> <span class=nb>len</span><span class=p>(</span><span class=n>results</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                        <span class=n>resolved</span><span class=p>[</span><span class=n>key</span><span class=p>]</span> <span class=o>=</span> <span class=n>results</span><span class=p>[</span><span class=n>index</span><span class=p>]</span><span class=o>.</span><span class=n>content</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>text</span>
</span></span><span class=line><span class=cl>                <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>resolved</span><span class=p>[</span><span class=n>key</span><span class=p>]</span> <span class=o>=</span> <span class=n>value</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>resolved</span><span class=p>[</span><span class=n>key</span><span class=p>]</span> <span class=o>=</span> <span class=n>value</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>resolved</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># å·¥ä½œæµä½¿ç”¨ç¤ºä¾‹</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>setup_code_analysis_workflow</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>workflow</span> <span class=o>=</span> <span class=n>ToolWorkflow</span><span class=p>(</span><span class=s2>&#34;code_analysis&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># æ­¥éª¤1: æ‰«æä»£ç æ–‡ä»¶</span>
</span></span><span class=line><span class=cl>    <span class=n>workflow</span><span class=o>.</span><span class=n>add_step</span><span class=p>(</span><span class=s2>&#34;scan_code_files&#34;</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;directory&#34;</span><span class=p>:</span> <span class=s2>&#34;$</span><span class=si>{target_directory}</span><span class=s2>&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;extensions&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;.py&#34;</span><span class=p>,</span> <span class=s2>&#34;.js&#34;</span><span class=p>,</span> <span class=s2>&#34;.ts&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># æ­¥éª¤2: åˆ†æä»£ç å¤æ‚åº¦</span>
</span></span><span class=line><span class=cl>    <span class=n>workflow</span><span class=o>.</span><span class=n>add_step</span><span class=p>(</span><span class=s2>&#34;analyze_complexity&#34;</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;files&#34;</span><span class=p>:</span> <span class=s2>&#34;$</span><span class=si>{result_1}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span> <span class=n>condition</span><span class=o>=</span><span class=k>lambda</span> <span class=n>ctx</span><span class=p>,</span> <span class=n>results</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=n>results</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=ow>and</span> <span class=n>results</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>isError</span> <span class=o>==</span> <span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># æ­¥éª¤3: ç”ŸæˆæŠ¥å‘Š</span>
</span></span><span class=line><span class=cl>    <span class=n>workflow</span><span class=o>.</span><span class=n>add_step</span><span class=p>(</span><span class=s2>&#34;generate_report&#34;</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;analysis_data&#34;</span><span class=p>:</span> <span class=s2>&#34;$</span><span class=si>{result_2}</span><span class=s2>&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;format&#34;</span><span class=p>:</span> <span class=s2>&#34;markdown&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>workflow</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=å®ç°ç¤ºä¾‹-1>å®ç°ç¤ºä¾‹</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>mcp</span> <span class=kn>import</span> <span class=n>Tool</span><span class=p>,</span> <span class=n>ToolResult</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>DatabaseTool</span><span class=p>(</span><span class=n>McpServer</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>list_tools</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=n>Tool</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>name</span><span class=o>=</span><span class=s2>&#34;execute_query&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>description</span><span class=o>=</span><span class=s2>&#34;æ‰§è¡ŒSQLæŸ¥è¯¢&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>inputSchema</span><span class=o>=</span><span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;object&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;properties&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;query&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                            <span class=s2>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;string&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                            <span class=s2>&#34;description&#34;</span><span class=p>:</span> <span class=s2>&#34;è¦æ‰§è¡Œçš„SQLæŸ¥è¯¢&#34;</span>
</span></span><span class=line><span class=cl>                        <span class=p>}</span>
</span></span><span class=line><span class=cl>                    <span class=p>},</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;required&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;query&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>call_tool</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>arguments</span><span class=p>:</span> <span class=nb>dict</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>name</span> <span class=o>==</span> <span class=s2>&#34;execute_query&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>query</span> <span class=o>=</span> <span class=n>arguments</span><span class=p>[</span><span class=s2>&#34;query&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=c1># æ‰§è¡Œæ•°æ®åº“æŸ¥è¯¢</span>
</span></span><span class=line><span class=cl>            <span class=n>result</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>db</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=n>query</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>ToolResult</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>content</span><span class=o>=</span><span class=p>[{</span><span class=s2>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;text&#34;</span><span class=p>,</span> <span class=s2>&#34;text&#34;</span><span class=p>:</span> <span class=nb>str</span><span class=p>(</span><span class=n>result</span><span class=p>)}],</span>
</span></span><span class=line><span class=cl>                <span class=n>isError</span><span class=o>=</span><span class=kc>False</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=å®‰å…¨è€ƒè™‘>å®‰å…¨è€ƒè™‘</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-markdown data-lang=markdown><span class=line><span class=cl>ğŸ”’ æƒé™æ§åˆ¶ï¼š
</span></span><span class=line><span class=cl><span class=k>-</span> å·¥å…·æƒé™æœ€å°åŒ–åŸåˆ™
</span></span><span class=line><span class=cl><span class=k>-</span> æ•æ„Ÿæ“ä½œéœ€è¦ç¡®è®¤
</span></span><span class=line><span class=cl><span class=k>-</span> å®¡è®¡æ—¥å¿—è®°å½•
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>âš ï¸ è¾“å…¥éªŒè¯ï¼š
</span></span><span class=line><span class=cl><span class=k>-</span> å‚æ•°ç±»å‹æ£€æŸ¥
</span></span><span class=line><span class=cl><span class=k>-</span> SQLæ³¨å…¥é˜²æŠ¤
</span></span><span class=line><span class=cl><span class=k>-</span> æ–‡ä»¶è·¯å¾„éªŒè¯
</span></span></code></pre></td></tr></table></div></div><h3 id=3-promptsæç¤ºæ¨¡æ¿>3. Promptsï¼ˆæç¤ºæ¨¡æ¿ï¼‰</h3><h4 id=å®šä¹‰ä¸ä½œç”¨-2>å®šä¹‰ä¸ä½œç”¨</h4><p>Promptsæ˜¯å¯é‡ç”¨çš„æç¤ºæ¨¡æ¿ï¼ŒåŒ…å«åŠ¨æ€å‚æ•°ï¼Œç”¨äºæ ‡å‡†åŒ–AIäº¤äº’æ¨¡å¼ã€‚</p><h4 id=å®ç°ç¤ºä¾‹-2>å®ç°ç¤ºä¾‹</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>mcp</span> <span class=kn>import</span> <span class=n>Prompt</span><span class=p>,</span> <span class=n>PromptArgument</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>CodeReviewServer</span><span class=p>(</span><span class=n>McpServer</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>list_prompts</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=n>Prompt</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>name</span><span class=o>=</span><span class=s2>&#34;code_review&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>description</span><span class=o>=</span><span class=s2>&#34;ä»£ç è¯„å®¡æç¤ºæ¨¡æ¿&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>arguments</span><span class=o>=</span><span class=p>[</span>
</span></span><span class=line><span class=cl>                    <span class=n>PromptArgument</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                        <span class=n>name</span><span class=o>=</span><span class=s2>&#34;code&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>description</span><span class=o>=</span><span class=s2>&#34;è¦è¯„å®¡çš„ä»£ç &#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>required</span><span class=o>=</span><span class=kc>True</span>
</span></span><span class=line><span class=cl>                    <span class=p>),</span>
</span></span><span class=line><span class=cl>                    <span class=n>PromptArgument</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                        <span class=n>name</span><span class=o>=</span><span class=s2>&#34;language&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>description</span><span class=o>=</span><span class=s2>&#34;ç¼–ç¨‹è¯­è¨€&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>required</span><span class=o>=</span><span class=kc>False</span>
</span></span><span class=line><span class=cl>                    <span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>get_prompt</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>arguments</span><span class=p>:</span> <span class=nb>dict</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>name</span> <span class=o>==</span> <span class=s2>&#34;code_review&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>code</span> <span class=o>=</span> <span class=n>arguments</span><span class=p>[</span><span class=s2>&#34;code&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>language</span> <span class=o>=</span> <span class=n>arguments</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;language&#34;</span><span class=p>,</span> <span class=s2>&#34;æœªçŸ¥&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>è¯·å¯¹ä»¥ä¸‹</span><span class=si>{</span><span class=n>language</span><span class=si>}</span><span class=s2>ä»£ç è¿›è¡Œè¯¦ç»†è¯„å®¡ï¼š
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>ä»£ç å†…å®¹ï¼š
</span></span></span><span class=line><span class=cl><span class=s2>```</span><span class=si>{</span><span class=n>language</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2></span><span class=si>{</span><span class=n>code</span><span class=si>}</span><span class=s2>
</span></span></span></code></pre></td></tr></table></div></div><p>è¯·ä»ä»¥ä¸‹å‡ ä¸ªæ–¹é¢è¿›è¡Œåˆ†æï¼š</p><ol><li>ä»£ç è´¨é‡å’Œè§„èŒƒæ€§</li><li>æ€§èƒ½ä¼˜åŒ–å»ºè®®</li><li>å®‰å…¨æ€§é—®é¢˜</li><li>å¯ç»´æŠ¤æ€§æ”¹è¿›</li><li>æœ€ä½³å®è·µå»ºè®®</li></ol><p>è¯·æä¾›å…·ä½“çš„ä¿®æ”¹å»ºè®®å’Œç¤ºä¾‹ä»£ç ã€‚
"""</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## ğŸ”’ MCPå®‰å…¨ä¸ä¸­é—´ä»¶ç³»ç»Ÿ</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>### è®¤è¯ä¸æˆæƒä¸­é—´ä»¶</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#### JWTè®¤è¯ä¸­é—´ä»¶</span>
</span></span><span class=line><span class=cl><span class=err>```</span><span class=n>python</span>
</span></span><span class=line><span class=cl><span class=n>import</span> <span class=n>jwt</span>
</span></span><span class=line><span class=cl><span class=n>from</span> <span class=n>functools</span> <span class=n>import</span> <span class=n>wraps</span>
</span></span><span class=line><span class=cl><span class=n>from</span> <span class=n>typing</span> <span class=n>import</span> <span class=n>Dict</span><span class=p>,</span> <span class=n>Any</span><span class=p>,</span> <span class=n>Optional</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=n>JWTAuthMiddleware</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>secret_key</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>algorithm</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s2>&#34;HS256&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>secret_key</span> <span class=o>=</span> <span class=n>secret_key</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>algorithm</span> <span class=o>=</span> <span class=n>algorithm</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>verify_token</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>token</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;éªŒè¯JWTä»¤ç‰Œ&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>payload</span> <span class=o>=</span> <span class=n>jwt</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=n>token</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>secret_key</span><span class=p>,</span> <span class=n>algorithms</span><span class=o>=</span><span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>algorithm</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>payload</span>
</span></span><span class=line><span class=cl>        <span class=n>except</span> <span class=n>jwt</span><span class=o>.</span><span class=n>ExpiredSignatureError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>raise</span> <span class=n>McpError</span><span class=p>(</span><span class=n>code</span><span class=o>=</span><span class=n>ErrorCode</span><span class=o>.</span><span class=n>UNAUTHORIZED</span><span class=p>,</span> <span class=n>message</span><span class=o>=</span><span class=s2>&#34;ä»¤ç‰Œå·²è¿‡æœŸ&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>except</span> <span class=n>jwt</span><span class=o>.</span><span class=n>InvalidTokenError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>raise</span> <span class=n>McpError</span><span class=p>(</span><span class=n>code</span><span class=o>=</span><span class=n>ErrorCode</span><span class=o>.</span><span class=n>UNAUTHORIZED</span><span class=p>,</span> <span class=n>message</span><span class=o>=</span><span class=s2>&#34;æ— æ•ˆä»¤ç‰Œ&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>require_permission</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>permission</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;æƒé™è£…é¥°å™¨&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>decorator</span><span class=p>(</span><span class=k>func</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=err>@</span><span class=n>wraps</span><span class=p>(</span><span class=k>func</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>async</span> <span class=k>def</span> <span class=nf>wrapper</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=n>client_token</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_client_token</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=n>payload</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>verify_token</span><span class=p>(</span><span class=n>client_token</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=n>user_permissions</span> <span class=o>=</span> <span class=n>payload</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;permissions&#39;</span><span class=p>,</span> <span class=p>[])</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>permission</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>user_permissions</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>raise</span> <span class=n>McpError</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                        <span class=n>code</span><span class=o>=</span><span class=n>ErrorCode</span><span class=o>.</span><span class=n>PERMISSION_DENIED</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>message</span><span class=o>=</span><span class=n>f</span><span class=s2>&#34;ç¼ºå°‘æƒé™: {permission}&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=p>)</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>await</span> <span class=k>func</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>wrapper</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>decorator</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=n>SecureServer</span><span class=p>(</span><span class=n>McpServer</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>super</span><span class=p>()</span><span class=o>.</span><span class=n>__init__</span><span class=p>(</span><span class=s2>&#34;secure-server&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>auth_middleware</span> <span class=o>=</span> <span class=n>JWTAuthMiddleware</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>getenv</span><span class=p>(</span><span class=s2>&#34;JWT_SECRET&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=err>@</span><span class=n>auth_middleware</span><span class=o>.</span><span class=n>require_permission</span><span class=p>(</span><span class=s2>&#34;read:resources&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>async</span> <span class=k>def</span> <span class=nf>read_resource</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>uri</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>await</span> <span class=n>super</span><span class=p>()</span><span class=o>.</span><span class=n>read_resource</span><span class=p>(</span><span class=n>uri</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=err>@</span><span class=n>auth_middleware</span><span class=o>.</span><span class=n>require_permission</span><span class=p>(</span><span class=s2>&#34;execute:tools&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>async</span> <span class=k>def</span> <span class=nf>call_tool</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>arguments</span><span class=p>:</span> <span class=n>dict</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>await</span> <span class=n>super</span><span class=p>()</span><span class=o>.</span><span class=n>call_tool</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>arguments</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=è¯·æ±‚é™æµä¸­é—´ä»¶>è¯·æ±‚é™æµä¸­é—´ä»¶</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>collections</span> <span class=kn>import</span> <span class=n>defaultdict</span><span class=p>,</span> <span class=n>deque</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>DefaultDict</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>RateLimiter</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>max_requests</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>window_seconds</span><span class=p>:</span> <span class=nb>int</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>max_requests</span> <span class=o>=</span> <span class=n>max_requests</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>window_seconds</span> <span class=o>=</span> <span class=n>window_seconds</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>requests</span><span class=p>:</span> <span class=n>DefaultDict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>deque</span><span class=p>]</span> <span class=o>=</span> <span class=n>defaultdict</span><span class=p>(</span><span class=n>deque</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>is_allowed</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>client_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;æ£€æŸ¥æ˜¯å¦å…è®¸è¯·æ±‚&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>now</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>client_requests</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>requests</span><span class=p>[</span><span class=n>client_id</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># æ¸…ç†è¿‡æœŸè¯·æ±‚</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=n>client_requests</span> <span class=ow>and</span> <span class=n>client_requests</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>&lt;=</span> <span class=n>now</span> <span class=o>-</span> <span class=bp>self</span><span class=o>.</span><span class=n>window_seconds</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>client_requests</span><span class=o>.</span><span class=n>popleft</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># æ£€æŸ¥è¯·æ±‚æ•°é‡</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>client_requests</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=bp>self</span><span class=o>.</span><span class=n>max_requests</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># è®°å½•æ–°è¯·æ±‚</span>
</span></span><span class=line><span class=cl>        <span class=n>client_requests</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>now</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>RateLimitedServer</span><span class=p>(</span><span class=n>McpServer</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span><span class=s2>&#34;rate-limited-server&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>rate_limiter</span> <span class=o>=</span> <span class=n>RateLimiter</span><span class=p>(</span><span class=n>max_requests</span><span class=o>=</span><span class=mi>100</span><span class=p>,</span> <span class=n>window_seconds</span><span class=o>=</span><span class=mi>60</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>handle_request</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>method</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>params</span><span class=p>:</span> <span class=nb>dict</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>client_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_current_client_id</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>rate_limiter</span><span class=o>.</span><span class=n>is_allowed</span><span class=p>(</span><span class=n>client_id</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=n>McpError</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>code</span><span class=o>=</span><span class=n>ErrorCode</span><span class=o>.</span><span class=n>RATE_LIMITED</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>message</span><span class=o>=</span><span class=s2>&#34;è¯·æ±‚é¢‘ç‡è¶…é™ï¼Œè¯·ç¨åé‡è¯•&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>await</span> <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=n>handle_request</span><span class=p>(</span><span class=n>method</span><span class=p>,</span> <span class=n>params</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=æ•°æ®åŠ å¯†ä¸è„±æ•>æ•°æ®åŠ å¯†ä¸è„±æ•</h3><h4 id=å­—æ®µçº§åŠ å¯†>å­—æ®µçº§åŠ å¯†</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>cryptography.fernet</span> <span class=kn>import</span> <span class=n>Fernet</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>base64</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>FieldEncryption</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>encryption_key</span><span class=p>:</span> <span class=nb>bytes</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>cipher_suite</span> <span class=o>=</span> <span class=n>Fernet</span><span class=p>(</span><span class=n>encryption_key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>encrypt_field</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;åŠ å¯†å­—æ®µ&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>encrypted_data</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>cipher_suite</span><span class=o>.</span><span class=n>encrypt</span><span class=p>(</span><span class=n>data</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>base64</span><span class=o>.</span><span class=n>b64encode</span><span class=p>(</span><span class=n>encrypted_data</span><span class=p>)</span><span class=o>.</span><span class=n>decode</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>decrypt_field</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>encrypted_data</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;è§£å¯†å­—æ®µ&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>decoded_data</span> <span class=o>=</span> <span class=n>base64</span><span class=o>.</span><span class=n>b64decode</span><span class=p>(</span><span class=n>encrypted_data</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=n>decrypted_data</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>cipher_suite</span><span class=o>.</span><span class=n>decrypt</span><span class=p>(</span><span class=n>decoded_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>decrypted_data</span><span class=o>.</span><span class=n>decode</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>DataMasking</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;æ•°æ®è„±æ•å·¥å…·&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@staticmethod</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>mask_email</span><span class=p>(</span><span class=n>email</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;é‚®ç®±è„±æ•&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=s1>&#39;@&#39;</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>email</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>email</span>
</span></span><span class=line><span class=cl>        <span class=n>local</span><span class=p>,</span> <span class=n>domain</span> <span class=o>=</span> <span class=n>email</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;@&#39;</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>masked_local</span> <span class=o>=</span> <span class=n>local</span><span class=p>[:</span><span class=mi>2</span><span class=p>]</span> <span class=o>+</span> <span class=s1>&#39;*&#39;</span> <span class=o>*</span> <span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>local</span><span class=p>)</span> <span class=o>-</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>masked_local</span><span class=si>}</span><span class=s2>@</span><span class=si>{</span><span class=n>domain</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@staticmethod</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>mask_phone</span><span class=p>(</span><span class=n>phone</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;ç”µè¯å·ç è„±æ•&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>phone</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>7</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>phone</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>phone</span><span class=p>[:</span><span class=mi>3</span><span class=p>]</span> <span class=o>+</span> <span class=s1>&#39;*&#39;</span> <span class=o>*</span> <span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>phone</span><span class=p>)</span> <span class=o>-</span> <span class=mi>6</span><span class=p>)</span> <span class=o>+</span> <span class=n>phone</span><span class=p>[</span><span class=o>-</span><span class=mi>3</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@staticmethod</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>mask_id_card</span><span class=p>(</span><span class=n>id_card</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;èº«ä»½è¯è„±æ•&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>id_card</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>8</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>id_card</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>id_card</span><span class=p>[:</span><span class=mi>4</span><span class=p>]</span> <span class=o>+</span> <span class=s1>&#39;*&#39;</span> <span class=o>*</span> <span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>id_card</span><span class=p>)</span> <span class=o>-</span> <span class=mi>8</span><span class=p>)</span> <span class=o>+</span> <span class=n>id_card</span><span class=p>[</span><span class=o>-</span><span class=mi>4</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>SecureDataServer</span><span class=p>(</span><span class=n>McpServer</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span><span class=s2>&#34;secure-data-server&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>field_encryption</span> <span class=o>=</span> <span class=n>FieldEncryption</span><span class=p>(</span><span class=n>Fernet</span><span class=o>.</span><span class=n>generate_key</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>data_masking</span> <span class=o>=</span> <span class=n>DataMasking</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>read_resource</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>uri</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;è¯»å–èµ„æºå¹¶è¿›è¡Œæ•°æ®è„±æ•&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>raw_data</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>load_raw_data</span><span class=p>(</span><span class=n>uri</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># æ ¹æ®èµ„æºç±»å‹è¿›è¡Œè„±æ•</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>uri</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s2>&#34;user://&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>mask_user_data</span><span class=p>(</span><span class=n>raw_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>uri</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s2>&#34;sensitive://&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>decrypt_and_mask_data</span><span class=p>(</span><span class=n>raw_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>raw_data</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>mask_user_data</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;ç”¨æˆ·æ•°æ®è„±æ•&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>user_data</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=s1>&#39;email&#39;</span> <span class=ow>in</span> <span class=n>user_data</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>user_data</span><span class=p>[</span><span class=s1>&#39;email&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>data_masking</span><span class=o>.</span><span class=n>mask_email</span><span class=p>(</span><span class=n>user_data</span><span class=p>[</span><span class=s1>&#39;email&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=s1>&#39;phone&#39;</span> <span class=ow>in</span> <span class=n>user_data</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>user_data</span><span class=p>[</span><span class=s1>&#39;phone&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>data_masking</span><span class=o>.</span><span class=n>mask_phone</span><span class=p>(</span><span class=n>user_data</span><span class=p>[</span><span class=s1>&#39;phone&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=s1>&#39;id_card&#39;</span> <span class=ow>in</span> <span class=n>user_data</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>user_data</span><span class=p>[</span><span class=s1>&#39;id_card&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>data_masking</span><span class=o>.</span><span class=n>mask_id_card</span><span class=p>(</span><span class=n>user_data</span><span class=p>[</span><span class=s1>&#39;id_card&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>user_data</span><span class=p>,</span> <span class=n>ensure_ascii</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=n>json</span><span class=o>.</span><span class=n>JSONDecodeError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>data</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=-mcpåè®®æ‰©å±•>ğŸ”„ MCPåè®®æ‰©å±•</h2><h3 id=è‡ªå®šä¹‰åè®®æ‰©å±•>è‡ªå®šä¹‰åè®®æ‰©å±•</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>CustomProtocolExtension</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;è‡ªå®šä¹‰åè®®æ‰©å±•&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>namespace</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>namespace</span> <span class=o>=</span> <span class=n>namespace</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>custom_methods</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>register_method</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>method_name</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>handler</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;æ³¨å†Œè‡ªå®šä¹‰æ–¹æ³•&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>full_method_name</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>namespace</span><span class=si>}</span><span class=s2>/</span><span class=si>{</span><span class=n>method_name</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>custom_methods</span><span class=p>[</span><span class=n>full_method_name</span><span class=p>]</span> <span class=o>=</span> <span class=n>handler</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>handle_custom_request</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>method</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>params</span><span class=p>:</span> <span class=nb>dict</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;å¤„ç†è‡ªå®šä¹‰è¯·æ±‚&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>method</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>custom_methods</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>custom_methods</span><span class=p>[</span><span class=n>method</span><span class=p>](</span><span class=n>params</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=n>McpError</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>code</span><span class=o>=</span><span class=n>ErrorCode</span><span class=o>.</span><span class=n>METHOD_NOT_FOUND</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>message</span><span class=o>=</span><span class=sa>f</span><span class=s2>&#34;è‡ªå®šä¹‰æ–¹æ³•æœªæ‰¾åˆ°: </span><span class=si>{</span><span class=n>method</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ExtendedServer</span><span class=p>(</span><span class=n>McpServer</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span><span class=s2>&#34;extended-server&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>extension</span> <span class=o>=</span> <span class=n>CustomProtocolExtension</span><span class=p>(</span><span class=s2>&#34;mycompany&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>setup_custom_methods</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>setup_custom_methods</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;è®¾ç½®è‡ªå®šä¹‰æ–¹æ³•&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>extension</span><span class=o>.</span><span class=n>register_method</span><span class=p>(</span><span class=s2>&#34;bulk_upload&#34;</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>handle_bulk_upload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>extension</span><span class=o>.</span><span class=n>register_method</span><span class=p>(</span><span class=s2>&#34;stream_data&#34;</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>handle_stream_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>extension</span><span class=o>.</span><span class=n>register_method</span><span class=p>(</span><span class=s2>&#34;batch_process&#34;</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>handle_batch_process</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>handle_bulk_upload</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>params</span><span class=p>:</span> <span class=nb>dict</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;å¤„ç†æ‰¹é‡ä¸Šä¼ &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>files</span> <span class=o>=</span> <span class=n>params</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;files&#39;</span><span class=p>,</span> <span class=p>[])</span>
</span></span><span class=line><span class=cl>        <span class=n>results</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>file_info</span> <span class=ow>in</span> <span class=n>files</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>result</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>upload_single_file</span><span class=p>(</span><span class=n>file_info</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>results</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>result</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;uploaded&#34;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=n>results</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;results&#34;</span><span class=p>:</span> <span class=n>results</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>handle_stream_data</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>params</span><span class=p>:</span> <span class=nb>dict</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;å¤„ç†æµæ•°æ®&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>stream_id</span> <span class=o>=</span> <span class=n>params</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;stream_id&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>chunk_size</span> <span class=o>=</span> <span class=n>params</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;chunk_size&#39;</span><span class=p>,</span> <span class=mi>1024</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>async</span> <span class=k>for</span> <span class=n>chunk</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_data_stream</span><span class=p>(</span><span class=n>stream_id</span><span class=p>,</span> <span class=n>chunk_size</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>yield</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;stream_id&#34;</span><span class=p>:</span> <span class=n>stream_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;chunk&#34;</span><span class=p>:</span> <span class=n>chunk</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;timestamp&#34;</span><span class=p>:</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=äº‹ä»¶é©±åŠ¨æ¶æ„>äº‹ä»¶é©±åŠ¨æ¶æ„</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span><span class=lnt>210
</span><span class=lnt>211
</span><span class=lnt>212
</span><span class=lnt>213
</span><span class=lnt>214
</span><span class=lnt>215
</span><span class=lnt>216
</span><span class=lnt>217
</span><span class=lnt>218
</span><span class=lnt>219
</span><span class=lnt>220
</span><span class=lnt>221
</span><span class=lnt>222
</span><span class=lnt>223
</span><span class=lnt>224
</span><span class=lnt>225
</span><span class=lnt>226
</span><span class=lnt>227
</span><span class=lnt>228
</span><span class=lnt>229
</span><span class=lnt>230
</span><span class=lnt>231
</span><span class=lnt>232
</span><span class=lnt>233
</span><span class=lnt>234
</span><span class=lnt>235
</span><span class=lnt>236
</span><span class=lnt>237
</span><span class=lnt>238
</span><span class=lnt>239
</span><span class=lnt>240
</span><span class=lnt>241
</span><span class=lnt>242
</span><span class=lnt>243
</span><span class=lnt>244
</span><span class=lnt>245
</span><span class=lnt>246
</span><span class=lnt>247
</span><span class=lnt>248
</span><span class=lnt>249
</span><span class=lnt>250
</span><span class=lnt>251
</span><span class=lnt>252
</span><span class=lnt>253
</span><span class=lnt>254
</span><span class=lnt>255
</span><span class=lnt>256
</span><span class=lnt>257
</span><span class=lnt>258
</span><span class=lnt>259
</span><span class=lnt>260
</span><span class=lnt>261
</span><span class=lnt>262
</span><span class=lnt>263
</span><span class=lnt>264
</span><span class=lnt>265
</span><span class=lnt>266
</span><span class=lnt>267
</span><span class=lnt>268
</span><span class=lnt>269
</span><span class=lnt>270
</span><span class=lnt>271
</span><span class=lnt>272
</span><span class=lnt>273
</span><span class=lnt>274
</span><span class=lnt>275
</span><span class=lnt>276
</span><span class=lnt>277
</span><span class=lnt>278
</span><span class=lnt>279
</span><span class=lnt>280
</span><span class=lnt>281
</span><span class=lnt>282
</span><span class=lnt>283
</span><span class=lnt>284
</span><span class=lnt>285
</span><span class=lnt>286
</span><span class=lnt>287
</span><span class=lnt>288
</span><span class=lnt>289
</span><span class=lnt>290
</span><span class=lnt>291
</span><span class=lnt>292
</span><span class=lnt>293
</span><span class=lnt>294
</span><span class=lnt>295
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>asyncio</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Callable</span><span class=p>,</span> <span class=n>List</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>dataclasses</span> <span class=kn>import</span> <span class=n>dataclass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@dataclass</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>McpEvent</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;MCPäº‹ä»¶&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>type</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span><span class=p>:</span> <span class=nb>dict</span>
</span></span><span class=line><span class=cl>    <span class=n>timestamp</span><span class=p>:</span> <span class=nb>float</span>
</span></span><span class=line><span class=cl>    <span class=n>source</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>EventBus</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;äº‹ä»¶æ€»çº¿&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>subscribers</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>List</span><span class=p>[</span><span class=n>Callable</span><span class=p>]]</span> <span class=o>=</span> <span class=n>defaultdict</span><span class=p>(</span><span class=nb>list</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>event_history</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>McpEvent</span><span class=p>]</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>subscribe</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>event_type</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>handler</span><span class=p>:</span> <span class=n>Callable</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;è®¢é˜…äº‹ä»¶&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>subscribers</span><span class=p>[</span><span class=n>event_type</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>handler</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>unsubscribe</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>event_type</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>handler</span><span class=p>:</span> <span class=n>Callable</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;å–æ¶ˆè®¢é˜…&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>handler</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>subscribers</span><span class=p>[</span><span class=n>event_type</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>subscribers</span><span class=p>[</span><span class=n>event_type</span><span class=p>]</span><span class=o>.</span><span class=n>remove</span><span class=p>(</span><span class=n>handler</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>publish</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>event</span><span class=p>:</span> <span class=n>McpEvent</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;å‘å¸ƒäº‹ä»¶&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>event_history</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># é€šçŸ¥æ‰€æœ‰è®¢é˜…è€…</span>
</span></span><span class=line><span class=cl>        <span class=n>handlers</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>subscribers</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>event</span><span class=o>.</span><span class=n>type</span><span class=p>,</span> <span class=p>[])</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>handlers</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>await</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>gather</span><span class=p>(</span><span class=o>*</span><span class=p>[</span><span class=n>handler</span><span class=p>(</span><span class=n>event</span><span class=p>)</span> <span class=k>for</span> <span class=n>handler</span> <span class=ow>in</span> <span class=n>handlers</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_event_history</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>event_type</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span> <span class=n>limit</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>100</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=n>McpEvent</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;è·å–äº‹ä»¶å†å²&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>events</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>event_history</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>event_type</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>events</span> <span class=o>=</span> <span class=p>[</span><span class=n>e</span> <span class=k>for</span> <span class=n>e</span> <span class=ow>in</span> <span class=n>events</span> <span class=k>if</span> <span class=n>e</span><span class=o>.</span><span class=n>type</span> <span class=o>==</span> <span class=n>event_type</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>events</span><span class=p>[</span><span class=o>-</span><span class=n>limit</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>EventDrivenServer</span><span class=p>(</span><span class=n>McpServer</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span><span class=s2>&#34;event-driven-server&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>event_bus</span> <span class=o>=</span> <span class=n>EventBus</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>setup_event_handlers</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>setup_event_handlers</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;è®¾ç½®äº‹ä»¶å¤„ç†å™¨&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>event_bus</span><span class=o>.</span><span class=n>subscribe</span><span class=p>(</span><span class=s2>&#34;resource.created&#34;</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>on_resource_created</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>event_bus</span><span class=o>.</span><span class=n>subscribe</span><span class=p>(</span><span class=s2>&#34;resource.updated&#34;</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>on_resource_updated</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>event_bus</span><span class=o>.</span><span class=n>subscribe</span><span class=p>(</span><span class=s2>&#34;tool.executed&#34;</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>on_tool_executed</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>event_bus</span><span class=o>.</span><span class=n>subscribe</span><span class=p>(</span><span class=s2>&#34;client.connected&#34;</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>on_client_connected</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>on_resource_created</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>event</span><span class=p>:</span> <span class=n>McpEvent</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;èµ„æºåˆ›å»ºäº‹ä»¶å¤„ç†&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>resource_uri</span> <span class=o>=</span> <span class=n>event</span><span class=o>.</span><span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;uri&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>send_notification</span><span class=p>(</span><span class=s2>&#34;notifications/resources/created&#34;</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;uri&#34;</span><span class=p>:</span> <span class=n>resource_uri</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;timestamp&#34;</span><span class=p>:</span> <span class=n>event</span><span class=o>.</span><span class=n>timestamp</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>on_tool_executed</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>event</span><span class=p>:</span> <span class=n>McpEvent</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;å·¥å…·æ‰§è¡Œäº‹ä»¶å¤„ç†&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>tool_name</span> <span class=o>=</span> <span class=n>event</span><span class=o>.</span><span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;tool_name&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>execution_time</span> <span class=o>=</span> <span class=n>event</span><span class=o>.</span><span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;duration&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># è®°å½•æ€§èƒ½æŒ‡æ ‡</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>record_performance_metric</span><span class=p>(</span><span class=n>tool_name</span><span class=p>,</span> <span class=n>execution_time</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># å¦‚æœæ‰§è¡Œæ—¶é—´è¿‡é•¿ï¼Œå‘é€è­¦å‘Š</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>execution_time</span> <span class=o>&gt;</span> <span class=mi>10</span><span class=p>:</span>  <span class=c1># 10ç§’</span>
</span></span><span class=line><span class=cl>            <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>send_notification</span><span class=p>(</span><span class=s2>&#34;notifications/performance/warning&#34;</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;tool&#34;</span><span class=p>:</span> <span class=n>tool_name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;duration&#34;</span><span class=p>:</span> <span class=n>execution_time</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;message&#34;</span><span class=p>:</span> <span class=s2>&#34;å·¥å…·æ‰§è¡Œæ—¶é—´è¿‡é•¿&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>### åˆ†å¸ƒå¼MCPæ¶æ„</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#### æœåŠ¡å‘ç°ä¸è´Ÿè½½å‡è¡¡</span>
</span></span><span class=line><span class=cl><span class=err>```</span><span class=n>python</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>consul</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>hashlib</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>List</span><span class=p>,</span> <span class=n>Dict</span><span class=p>,</span> <span class=n>Optional</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ServiceDiscovery</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;æœåŠ¡å‘ç°&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>consul_host</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s2>&#34;localhost&#34;</span><span class=p>,</span> <span class=n>consul_port</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>8500</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>consul</span> <span class=o>=</span> <span class=n>consul</span><span class=o>.</span><span class=n>Consul</span><span class=p>(</span><span class=n>host</span><span class=o>=</span><span class=n>consul_host</span><span class=p>,</span> <span class=n>port</span><span class=o>=</span><span class=n>consul_port</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>service_cache</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>cache_ttl</span> <span class=o>=</span> <span class=mi>30</span>  <span class=c1># ç¼“å­˜30ç§’</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>register_service</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>service_name</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>host</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>port</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>tags</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;æ³¨å†ŒæœåŠ¡&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>service_id</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>service_name</span><span class=si>}</span><span class=s2>-</span><span class=si>{</span><span class=n>host</span><span class=si>}</span><span class=s2>-</span><span class=si>{</span><span class=n>port</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>consul</span><span class=o>.</span><span class=n>agent</span><span class=o>.</span><span class=n>service</span><span class=o>.</span><span class=n>register</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>name</span><span class=o>=</span><span class=n>service_name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>service_id</span><span class=o>=</span><span class=n>service_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>address</span><span class=o>=</span><span class=n>host</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>port</span><span class=o>=</span><span class=n>port</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>tags</span><span class=o>=</span><span class=n>tags</span> <span class=ow>or</span> <span class=p>[],</span>
</span></span><span class=line><span class=cl>            <span class=n>check</span><span class=o>=</span><span class=n>consul</span><span class=o>.</span><span class=n>Check</span><span class=o>.</span><span class=n>http</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;http://</span><span class=si>{</span><span class=n>host</span><span class=si>}</span><span class=s2>:</span><span class=si>{</span><span class=n>port</span><span class=si>}</span><span class=s2>/health&#34;</span><span class=p>,</span> <span class=n>interval</span><span class=o>=</span><span class=s2>&#34;10s&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>discover_services</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>service_name</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=n>Dict</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;å‘ç°æœåŠ¡&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># æ£€æŸ¥ç¼“å­˜</span>
</span></span><span class=line><span class=cl>        <span class=n>cache_key</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;services:</span><span class=si>{</span><span class=n>service_name</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>cache_key</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>service_cache</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>cached_data</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>service_cache</span><span class=p>[</span><span class=n>cache_key</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>cached_data</span><span class=p>[</span><span class=s1>&#39;timestamp&#39;</span><span class=p>]</span> <span class=o>&lt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>cache_ttl</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>cached_data</span><span class=p>[</span><span class=s1>&#39;services&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># ä»Consulè·å–æœåŠ¡åˆ—è¡¨</span>
</span></span><span class=line><span class=cl>        <span class=n>_</span><span class=p>,</span> <span class=n>services</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>consul</span><span class=o>.</span><span class=n>health</span><span class=o>.</span><span class=n>service</span><span class=p>(</span><span class=n>service_name</span><span class=p>,</span> <span class=n>passing</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>service_list</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>service</span> <span class=ow>in</span> <span class=n>services</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>service_info</span> <span class=o>=</span> <span class=n>service</span><span class=p>[</span><span class=s1>&#39;Service&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>service_list</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;id&#39;</span><span class=p>:</span> <span class=n>service_info</span><span class=p>[</span><span class=s1>&#39;ID&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;address&#39;</span><span class=p>:</span> <span class=n>service_info</span><span class=p>[</span><span class=s1>&#39;Address&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;port&#39;</span><span class=p>:</span> <span class=n>service_info</span><span class=p>[</span><span class=s1>&#39;Port&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;tags&#39;</span><span class=p>:</span> <span class=n>service_info</span><span class=p>[</span><span class=s1>&#39;Tags&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=p>})</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># æ›´æ–°ç¼“å­˜</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>service_cache</span><span class=p>[</span><span class=n>cache_key</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;services&#39;</span><span class=p>:</span> <span class=n>service_list</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;timestamp&#39;</span><span class=p>:</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>service_list</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>LoadBalancer</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;è´Ÿè½½å‡è¡¡å™¨&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>strategy</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s2>&#34;round_robin&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>strategy</span> <span class=o>=</span> <span class=n>strategy</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>round_robin_index</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>service_weights</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>service_health</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>select_service</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>services</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>Dict</span><span class=p>],</span> <span class=n>client_id</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=kc>None</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=n>Dict</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;é€‰æ‹©æœåŠ¡å®ä¾‹&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>services</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># è¿‡æ»¤å¥åº·çš„æœåŠ¡</span>
</span></span><span class=line><span class=cl>        <span class=n>healthy_services</span> <span class=o>=</span> <span class=p>[</span><span class=n>s</span> <span class=k>for</span> <span class=n>s</span> <span class=ow>in</span> <span class=n>services</span> <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>service_health</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>s</span><span class=p>[</span><span class=s1>&#39;id&#39;</span><span class=p>],</span> <span class=kc>True</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>healthy_services</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>strategy</span> <span class=o>==</span> <span class=s2>&#34;round_robin&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_round_robin_select</span><span class=p>(</span><span class=n>healthy_services</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=bp>self</span><span class=o>.</span><span class=n>strategy</span> <span class=o>==</span> <span class=s2>&#34;weighted&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_weighted_select</span><span class=p>(</span><span class=n>healthy_services</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=bp>self</span><span class=o>.</span><span class=n>strategy</span> <span class=o>==</span> <span class=s2>&#34;consistent_hash&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_consistent_hash_select</span><span class=p>(</span><span class=n>healthy_services</span><span class=p>,</span> <span class=n>client_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>healthy_services</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_round_robin_select</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>services</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>Dict</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;è½®è¯¢é€‰æ‹©&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>service</span> <span class=o>=</span> <span class=n>services</span><span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>round_robin_index</span> <span class=o>%</span> <span class=nb>len</span><span class=p>(</span><span class=n>services</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>round_robin_index</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>service</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_weighted_select</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>services</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>Dict</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;åŠ æƒé€‰æ‹©&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># æ ¹æ®æœåŠ¡æƒé‡é€‰æ‹©</span>
</span></span><span class=line><span class=cl>        <span class=n>total_weight</span> <span class=o>=</span> <span class=nb>sum</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>service_weights</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>s</span><span class=p>[</span><span class=s1>&#39;id&#39;</span><span class=p>],</span> <span class=mi>1</span><span class=p>)</span> <span class=k>for</span> <span class=n>s</span> <span class=ow>in</span> <span class=n>services</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=kn>import</span> <span class=nn>random</span>
</span></span><span class=line><span class=cl>        <span class=n>target</span> <span class=o>=</span> <span class=n>random</span><span class=o>.</span><span class=n>uniform</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>total_weight</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>current_weight</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>service</span> <span class=ow>in</span> <span class=n>services</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>current_weight</span> <span class=o>+=</span> <span class=bp>self</span><span class=o>.</span><span class=n>service_weights</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>service</span><span class=p>[</span><span class=s1>&#39;id&#39;</span><span class=p>],</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>current_weight</span> <span class=o>&gt;=</span> <span class=n>target</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>service</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>services</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_consistent_hash_select</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>services</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>Dict</span><span class=p>],</span> <span class=n>client_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;ä¸€è‡´æ€§å“ˆå¸Œé€‰æ‹©&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>client_id</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>services</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># è®¡ç®—å®¢æˆ·ç«¯IDçš„å“ˆå¸Œå€¼</span>
</span></span><span class=line><span class=cl>        <span class=n>client_hash</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>hashlib</span><span class=o>.</span><span class=n>md5</span><span class=p>(</span><span class=n>client_id</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span><span class=o>.</span><span class=n>hexdigest</span><span class=p>(),</span> <span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># ä¸ºæ¯ä¸ªæœåŠ¡è®¡ç®—å“ˆå¸Œå€¼å¹¶æ‰¾åˆ°æœ€æ¥è¿‘çš„</span>
</span></span><span class=line><span class=cl>        <span class=n>service_hashes</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>service</span> <span class=ow>in</span> <span class=n>services</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>service_key</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>service</span><span class=p>[</span><span class=s1>&#39;address&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>:</span><span class=si>{</span><span class=n>service</span><span class=p>[</span><span class=s1>&#39;port&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>            <span class=n>service_hash</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>hashlib</span><span class=o>.</span><span class=n>md5</span><span class=p>(</span><span class=n>service_key</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span><span class=o>.</span><span class=n>hexdigest</span><span class=p>(),</span> <span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>service_hashes</span><span class=o>.</span><span class=n>append</span><span class=p>((</span><span class=n>service_hash</span><span class=p>,</span> <span class=n>service</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># æ’åºå¹¶æ‰¾åˆ°å¤§äºç­‰äºå®¢æˆ·ç«¯å“ˆå¸Œçš„ç¬¬ä¸€ä¸ªæœåŠ¡</span>
</span></span><span class=line><span class=cl>        <span class=n>service_hashes</span><span class=o>.</span><span class=n>sort</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>service_hash</span><span class=p>,</span> <span class=n>service</span> <span class=ow>in</span> <span class=n>service_hashes</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>service_hash</span> <span class=o>&gt;=</span> <span class=n>client_hash</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>service</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># å¦‚æœæ²¡æ‰¾åˆ°ï¼Œè¿”å›ç¬¬ä¸€ä¸ªæœåŠ¡ï¼ˆç¯å½¢ç»“æ„ï¼‰</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>service_hashes</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>DistributedMcpClient</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;åˆ†å¸ƒå¼MCPå®¢æˆ·ç«¯&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>service_name</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>service_name</span> <span class=o>=</span> <span class=n>service_name</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>service_discovery</span> <span class=o>=</span> <span class=n>ServiceDiscovery</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>load_balancer</span> <span class=o>=</span> <span class=n>LoadBalancer</span><span class=p>(</span><span class=n>strategy</span><span class=o>=</span><span class=s2>&#34;consistent_hash&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>circuit_breakers</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>call_service</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>method</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>params</span><span class=p>:</span> <span class=nb>dict</span><span class=p>,</span> <span class=n>client_id</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;è°ƒç”¨åˆ†å¸ƒå¼æœåŠ¡&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># æœåŠ¡å‘ç°</span>
</span></span><span class=line><span class=cl>        <span class=n>services</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>service_discovery</span><span class=o>.</span><span class=n>discover_services</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>service_name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># è´Ÿè½½å‡è¡¡é€‰æ‹©æœåŠ¡</span>
</span></span><span class=line><span class=cl>        <span class=n>selected_service</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>load_balancer</span><span class=o>.</span><span class=n>select_service</span><span class=p>(</span><span class=n>services</span><span class=p>,</span> <span class=n>client_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>selected_service</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=n>McpError</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>code</span><span class=o>=</span><span class=n>ErrorCode</span><span class=o>.</span><span class=n>SERVICE_UNAVAILABLE</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>message</span><span class=o>=</span><span class=sa>f</span><span class=s2>&#34;æ²¡æœ‰å¯ç”¨çš„ </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>service_name</span><span class=si>}</span><span class=s2> æœåŠ¡å®ä¾‹&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># æ£€æŸ¥ç†”æ–­å™¨</span>
</span></span><span class=line><span class=cl>        <span class=n>service_key</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>selected_service</span><span class=p>[</span><span class=s1>&#39;address&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>:</span><span class=si>{</span><span class=n>selected_service</span><span class=p>[</span><span class=s1>&#39;port&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>circuit_breaker</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>circuit_breakers</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>service_key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>circuit_breaker</span> <span class=ow>and</span> <span class=n>circuit_breaker</span><span class=o>.</span><span class=n>is_open</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=n>McpError</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>code</span><span class=o>=</span><span class=n>ErrorCode</span><span class=o>.</span><span class=n>SERVICE_UNAVAILABLE</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>message</span><span class=o>=</span><span class=sa>f</span><span class=s2>&#34;æœåŠ¡ </span><span class=si>{</span><span class=n>service_key</span><span class=si>}</span><span class=s2> ç†”æ–­ä¸­&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># è°ƒç”¨è¿œç¨‹æœåŠ¡</span>
</span></span><span class=line><span class=cl>            <span class=n>result</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>call_remote_service</span><span class=p>(</span><span class=n>selected_service</span><span class=p>,</span> <span class=n>method</span><span class=p>,</span> <span class=n>params</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># è®°å½•æˆåŠŸè°ƒç”¨</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>circuit_breaker</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>circuit_breaker</span><span class=o>.</span><span class=n>record_success</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># è®°å½•å¤±è´¥è°ƒç”¨</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>circuit_breaker</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>circuit_breaker</span><span class=o>.</span><span class=n>record_failure</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=n>e</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>CircuitBreaker</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;ç†”æ–­å™¨&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>failure_threshold</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>5</span><span class=p>,</span> <span class=n>timeout</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>60</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>failure_threshold</span> <span class=o>=</span> <span class=n>failure_threshold</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>timeout</span> <span class=o>=</span> <span class=n>timeout</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>failure_count</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>last_failure_time</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>state</span> <span class=o>=</span> <span class=s2>&#34;CLOSED&#34;</span>  <span class=c1># CLOSED, OPEN, HALF_OPEN</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>is_open</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;æ£€æŸ¥ç†”æ–­å™¨æ˜¯å¦å¼€å¯&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>state</span> <span class=o>==</span> <span class=s2>&#34;OPEN&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=bp>self</span><span class=o>.</span><span class=n>last_failure_time</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>timeout</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>state</span> <span class=o>=</span> <span class=s2>&#34;HALF_OPEN&#34;</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>record_success</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;è®°å½•æˆåŠŸè°ƒç”¨&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>failure_count</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>state</span> <span class=o>=</span> <span class=s2>&#34;CLOSED&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>record_failure</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;è®°å½•å¤±è´¥è°ƒç”¨&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>failure_count</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>last_failure_time</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>failure_count</span> <span class=o>&gt;=</span> <span class=bp>self</span><span class=o>.</span><span class=n>failure_threshold</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>state</span> <span class=o>=</span> <span class=s2>&#34;OPEN&#34;</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=äº‘åŸç”Ÿéƒ¨ç½²æ–¹æ¡ˆ>äº‘åŸç”Ÿéƒ¨ç½²æ–¹æ¡ˆ</h3><h4 id=kubernetesé…ç½®>Kubernetesé…ç½®</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span><span class=lnt>91
</span><span class=lnt>92
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># mcp-server-deployment.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mcp-server</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>mcp-server</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>mcp-server</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>mcp-server</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mcp-server</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>myregistry/mcp-server:latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>8000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>DATABASE_URL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>secretKeyRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mcp-secrets</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>database-url</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>REDIS_URL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>configMapKeyRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mcp-config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>redis-url</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;256Mi&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;250m&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>limits</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;512Mi&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;500m&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>livenessProbe</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>httpGet</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/health</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>8000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>initialDelaySeconds</span><span class=p>:</span><span class=w> </span><span class=m>30</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>periodSeconds</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>readinessProbe</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>httpGet</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/ready</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>8000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>initialDelaySeconds</span><span class=p>:</span><span class=w> </span><span class=m>5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>periodSeconds</span><span class=p>:</span><span class=w> </span><span class=m>5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mcp-server-service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>mcp-server</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>TCP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>8000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>LoadBalancer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>autoscaling/v2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>HorizontalPodAutoscaler</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mcp-server-hpa</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>scaleTargetRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mcp-server</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>minReplicas</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>maxReplicas</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>metrics</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Resource</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cpu</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>target</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Utilization</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>averageUtilization</span><span class=p>:</span><span class=w> </span><span class=m>70</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Resource</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>memory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>target</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Utilization</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>averageUtilization</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=helm-charté…ç½®>Helm Charté…ç½®</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># values.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>replicaCount</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>image</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>repository</span><span class=p>:</span><span class=w> </span><span class=l>myregistry/mcp-server</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tag</span><span class=p>:</span><span class=w> </span><span class=l>latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>pullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>IfNotPresent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>LoadBalancer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>8000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>ingress</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>kubernetes.io/ingress.class</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>cert-manager.io/cluster-issuer</span><span class=p>:</span><span class=w> </span><span class=l>letsencrypt-prod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>hosts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=l>mcp-api.example.com</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>paths</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>pathType</span><span class=p>:</span><span class=w> </span><span class=l>Prefix</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tls</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>secretName</span><span class=p>:</span><span class=w> </span><span class=l>mcp-api-tls</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>hosts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>mcp-api.example.com</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>autoscaling</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>minReplicas</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>maxReplicas</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>targetCPUUtilizationPercentage</span><span class=p>:</span><span class=w> </span><span class=m>70</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>targetMemoryUtilizationPercentage</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>limits</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>500m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>512Mi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>250m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>256Mi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># é…ç½®ç®¡ç†</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>config</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>database</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>postgresql://user:pass@postgres:5432/mcpdb</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>pool_size</span><span class=p>:</span><span class=w> </span><span class=m>20</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>timeout</span><span class=p>:</span><span class=w> </span><span class=m>30</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>redis</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>redis://redis:6379/0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ttl</span><span class=p>:</span><span class=w> </span><span class=m>3600</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>monitoring</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>prometheus</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>9090</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>security</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>jwt_secret</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;your-secret-key&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>cors_origins</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;https://app.example.com&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>             </span>- <span class=s2>&#34;https://admin.example.com&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=é«˜çº§è°ƒè¯•ä¸è¯Šæ–­å·¥å…·>é«˜çº§è°ƒè¯•ä¸è¯Šæ–­å·¥å…·</h3><h4 id=mcpåè®®è°ƒè¯•å™¨>MCPåè®®è°ƒè¯•å™¨</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>asyncio</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Dict</span><span class=p>,</span> <span class=n>List</span><span class=p>,</span> <span class=n>Any</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>datetime</span> <span class=kn>import</span> <span class=n>datetime</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>McpProtocolDebugger</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;MCPåè®®è°ƒè¯•å™¨&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>enable_trace</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>True</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>enable_trace</span> <span class=o>=</span> <span class=n>enable_trace</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>message_history</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>Dict</span><span class=p>]</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>error_history</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>Dict</span><span class=p>]</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>performance_metrics</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>List</span><span class=p>]</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>trace_message</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>direction</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>message</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;è·Ÿè¸ªæ¶ˆæ¯&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>enable_trace</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>trace_entry</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;timestamp&#39;</span><span class=p>:</span> <span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>()</span><span class=o>.</span><span class=n>isoformat</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;direction&#39;</span><span class=p>:</span> <span class=n>direction</span><span class=p>,</span>  <span class=c1># &#39;incoming&#39; æˆ– &#39;outgoing&#39;</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;message&#39;</span><span class=p>:</span> <span class=n>message</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;size&#39;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>message</span><span class=p>)</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>message_history</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>trace_entry</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># ä¿æŒå†å²è®°å½•å¤§å°</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>message_history</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>1000</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>message_history</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>message_history</span><span class=p>[</span><span class=o>-</span><span class=mi>1000</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>trace_error</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>error</span><span class=p>:</span> <span class=ne>Exception</span><span class=p>,</span> <span class=n>context</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;è·Ÿè¸ªé”™è¯¯&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>error_entry</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;timestamp&#39;</span><span class=p>:</span> <span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>()</span><span class=o>.</span><span class=n>isoformat</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;error_type&#39;</span><span class=p>:</span> <span class=nb>type</span><span class=p>(</span><span class=n>error</span><span class=p>)</span><span class=o>.</span><span class=vm>__name__</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;error_message&#39;</span><span class=p>:</span> <span class=nb>str</span><span class=p>(</span><span class=n>error</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;context&#39;</span><span class=p>:</span> <span class=n>context</span> <span class=ow>or</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>error_history</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>error_entry</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>error_history</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>100</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>error_history</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>error_history</span><span class=p>[</span><span class=o>-</span><span class=mi>100</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>record_performance</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>operation</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>duration</span><span class=p>:</span> <span class=nb>float</span><span class=p>,</span> <span class=n>metadata</span><span class=p>:</span> <span class=n>Dict</span> <span class=o>=</span> <span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;è®°å½•æ€§èƒ½æ•°æ®&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>operation</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>performance_metrics</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>performance_metrics</span><span class=p>[</span><span class=n>operation</span><span class=p>]</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>performance_entry</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;timestamp&#39;</span><span class=p>:</span> <span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>()</span><span class=o>.</span><span class=n>isoformat</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;duration&#39;</span><span class=p>:</span> <span class=n>duration</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;metadata&#39;</span><span class=p>:</span> <span class=n>metadata</span> <span class=ow>or</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>performance_metrics</span><span class=p>[</span><span class=n>operation</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>performance_entry</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># ä¿æŒæ¯ä¸ªæ“ä½œæœ€å¤š100æ¡è®°å½•</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>performance_metrics</span><span class=p>[</span><span class=n>operation</span><span class=p>])</span> <span class=o>&gt;</span> <span class=mi>100</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>performance_metrics</span><span class=p>[</span><span class=n>operation</span><span class=p>]</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>performance_metrics</span><span class=p>[</span><span class=n>operation</span><span class=p>][</span><span class=o>-</span><span class=mi>100</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_debug_report</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;ç”Ÿæˆè°ƒè¯•æŠ¥å‘Š&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>report</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;summary&#39;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;total_messages&#39;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>message_history</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;total_errors&#39;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>error_history</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;performance_operations&#39;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>performance_metrics</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;recent_messages&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>message_history</span><span class=p>[</span><span class=o>-</span><span class=mi>10</span><span class=p>:],</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;recent_errors&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>error_history</span><span class=p>[</span><span class=o>-</span><span class=mi>5</span><span class=p>:],</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;performance_summary&#39;</span><span class=p>:</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># æ€§èƒ½æ‘˜è¦</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>operation</span><span class=p>,</span> <span class=n>metrics</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>performance_metrics</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>metrics</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>durations</span> <span class=o>=</span> <span class=p>[</span><span class=n>m</span><span class=p>[</span><span class=s1>&#39;duration&#39;</span><span class=p>]</span> <span class=k>for</span> <span class=n>m</span> <span class=ow>in</span> <span class=n>metrics</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                <span class=n>report</span><span class=p>[</span><span class=s1>&#39;performance_summary&#39;</span><span class=p>][</span><span class=n>operation</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;count&#39;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=n>durations</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;avg_duration&#39;</span><span class=p>:</span> <span class=nb>sum</span><span class=p>(</span><span class=n>durations</span><span class=p>)</span> <span class=o>/</span> <span class=nb>len</span><span class=p>(</span><span class=n>durations</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;min_duration&#39;</span><span class=p>:</span> <span class=nb>min</span><span class=p>(</span><span class=n>durations</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;max_duration&#39;</span><span class=p>:</span> <span class=nb>max</span><span class=p>(</span><span class=n>durations</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>report</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>export_trace</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>filename</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;å¯¼å‡ºè·Ÿè¸ªæ•°æ®&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>filename</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>filename</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;mcp_trace_</span><span class=si>{</span><span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>()</span><span class=o>.</span><span class=n>strftime</span><span class=p>(</span><span class=s1>&#39;%Y%m</span><span class=si>%d</span><span class=s1>_%H%M%S&#39;</span><span class=p>)</span><span class=si>}</span><span class=s2>.json&#34;</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>trace_data</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;messages&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>message_history</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;errors&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>error_history</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;performance&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>performance_metrics</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;exported_at&#39;</span><span class=p>:</span> <span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>()</span><span class=o>.</span><span class=n>isoformat</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>filename</span><span class=p>,</span> <span class=s1>&#39;w&#39;</span><span class=p>,</span> <span class=n>encoding</span><span class=o>=</span><span class=s1>&#39;utf-8&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>json</span><span class=o>.</span><span class=n>dump</span><span class=p>(</span><span class=n>trace_data</span><span class=p>,</span> <span class=n>f</span><span class=p>,</span> <span class=n>ensure_ascii</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>indent</span><span class=o>=</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>filename</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>DebuggableMcpServer</span><span class=p>(</span><span class=n>McpServer</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;å¯è°ƒè¯•çš„MCPæœåŠ¡å™¨&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>debug_mode</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>False</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span><span class=n>name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>debug_mode</span> <span class=o>=</span> <span class=n>debug_mode</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>debugger</span> <span class=o>=</span> <span class=n>McpProtocolDebugger</span><span class=p>(</span><span class=n>enable_trace</span><span class=o>=</span><span class=n>debug_mode</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>request_id_counter</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>handle_request</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>method</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>params</span><span class=p>:</span> <span class=nb>dict</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;å¤„ç†è¯·æ±‚ï¼ˆå¸¦è°ƒè¯•åŠŸèƒ½ï¼‰&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>request_id_counter</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=n>request_id</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;req_</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>request_id_counter</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>start_time</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># è·Ÿè¸ªå…¥ç«™æ¶ˆæ¯</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>debug_mode</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>debugger</span><span class=o>.</span><span class=n>trace_message</span><span class=p>(</span><span class=s1>&#39;incoming&#39;</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;id&#39;</span><span class=p>:</span> <span class=n>request_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;method&#39;</span><span class=p>:</span> <span class=n>method</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;params&#39;</span><span class=p>:</span> <span class=n>params</span>
</span></span><span class=line><span class=cl>            <span class=p>})</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>result</span> <span class=o>=</span> <span class=k>await</span> <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=n>handle_request</span><span class=p>(</span><span class=n>method</span><span class=p>,</span> <span class=n>params</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># è·Ÿè¸ªå‡ºç«™å“åº”</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>debug_mode</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>debugger</span><span class=o>.</span><span class=n>trace_message</span><span class=p>(</span><span class=s1>&#39;outgoing&#39;</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;id&#39;</span><span class=p>:</span> <span class=n>request_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;result&#39;</span><span class=p>:</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>                <span class=p>})</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># è·Ÿè¸ªé”™è¯¯</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>debugger</span><span class=o>.</span><span class=n>trace_error</span><span class=p>(</span><span class=n>e</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;request_id&#39;</span><span class=p>:</span> <span class=n>request_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;method&#39;</span><span class=p>:</span> <span class=n>method</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;params&#39;</span><span class=p>:</span> <span class=n>params</span>
</span></span><span class=line><span class=cl>            <span class=p>})</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># è·Ÿè¸ªé”™è¯¯å“åº”</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>debug_mode</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>debugger</span><span class=o>.</span><span class=n>trace_message</span><span class=p>(</span><span class=s1>&#39;outgoing&#39;</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;id&#39;</span><span class=p>:</span> <span class=n>request_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;error&#39;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=s1>&#39;code&#39;</span><span class=p>:</span> <span class=nb>getattr</span><span class=p>(</span><span class=n>e</span><span class=p>,</span> <span class=s1>&#39;code&#39;</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                        <span class=s1>&#39;message&#39;</span><span class=p>:</span> <span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=p>})</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>raise</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>finally</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># è®°å½•æ€§èƒ½</span>
</span></span><span class=line><span class=cl>            <span class=n>duration</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>start_time</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>debugger</span><span class=o>.</span><span class=n>record_performance</span><span class=p>(</span><span class=n>method</span><span class=p>,</span> <span class=n>duration</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;request_id&#39;</span><span class=p>:</span> <span class=n>request_id</span>
</span></span><span class=line><span class=cl>            <span class=p>})</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>get_debug_info</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;è·å–è°ƒè¯•ä¿¡æ¯&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>debugger</span><span class=o>.</span><span class=n>get_debug_report</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>export_debug_trace</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;å¯¼å‡ºè°ƒè¯•è·Ÿè¸ª&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>debugger</span><span class=o>.</span><span class=n>export_trace</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=æ™ºèƒ½é”™è¯¯æ¢å¤æœºåˆ¶>æ™ºèƒ½é”™è¯¯æ¢å¤æœºåˆ¶</h3><h4 id=è‡ªåŠ¨æ•…éšœæ¢å¤>è‡ªåŠ¨æ•…éšœæ¢å¤</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>asyncio</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Callable</span><span class=p>,</span> <span class=n>Dict</span><span class=p>,</span> <span class=n>Any</span><span class=p>,</span> <span class=n>Optional</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>enum</span> <span class=kn>import</span> <span class=n>Enum</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>RecoveryStrategy</span><span class=p>(</span><span class=n>Enum</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;æ¢å¤ç­–ç•¥&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>RETRY</span> <span class=o>=</span> <span class=s2>&#34;retry&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>FALLBACK</span> <span class=o>=</span> <span class=s2>&#34;fallback&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>CIRCUIT_BREAKER</span> <span class=o>=</span> <span class=s2>&#34;circuit_breaker&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>GRACEFUL_DEGRADATION</span> <span class=o>=</span> <span class=s2>&#34;graceful_degradation&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ErrorRecoveryManager</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;é”™è¯¯æ¢å¤ç®¡ç†å™¨&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>recovery_strategies</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>RecoveryStrategy</span><span class=p>]</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>fallback_handlers</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Callable</span><span class=p>]</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>retry_policies</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Dict</span><span class=p>]</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>circuit_breakers</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>CircuitBreaker</span><span class=p>]</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>register_strategy</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>operation</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>strategy</span><span class=p>:</span> <span class=n>RecoveryStrategy</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;æ³¨å†Œæ¢å¤ç­–ç•¥&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>recovery_strategies</span><span class=p>[</span><span class=n>operation</span><span class=p>]</span> <span class=o>=</span> <span class=n>strategy</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>strategy</span> <span class=o>==</span> <span class=n>RecoveryStrategy</span><span class=o>.</span><span class=n>RETRY</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>retry_policies</span><span class=p>[</span><span class=n>operation</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;max_attempts&#39;</span><span class=p>:</span> <span class=n>kwargs</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;max_attempts&#39;</span><span class=p>,</span> <span class=mi>3</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;delay&#39;</span><span class=p>:</span> <span class=n>kwargs</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;delay&#39;</span><span class=p>,</span> <span class=mf>1.0</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;backoff_multiplier&#39;</span><span class=p>:</span> <span class=n>kwargs</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;backoff_multiplier&#39;</span><span class=p>,</span> <span class=mf>2.0</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;max_delay&#39;</span><span class=p>:</span> <span class=n>kwargs</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;max_delay&#39;</span><span class=p>,</span> <span class=mf>30.0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>strategy</span> <span class=o>==</span> <span class=n>RecoveryStrategy</span><span class=o>.</span><span class=n>CIRCUIT_BREAKER</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>circuit_breakers</span><span class=p>[</span><span class=n>operation</span><span class=p>]</span> <span class=o>=</span> <span class=n>CircuitBreaker</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>failure_threshold</span><span class=o>=</span><span class=n>kwargs</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;failure_threshold&#39;</span><span class=p>,</span> <span class=mi>5</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=n>timeout</span><span class=o>=</span><span class=n>kwargs</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;timeout&#39;</span><span class=p>,</span> <span class=mi>60</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>register_fallback</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>operation</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>handler</span><span class=p>:</span> <span class=n>Callable</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;æ³¨å†Œé™çº§å¤„ç†å™¨&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>fallback_handlers</span><span class=p>[</span><span class=n>operation</span><span class=p>]</span> <span class=o>=</span> <span class=n>handler</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>execute_with_recovery</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>operation</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>func</span><span class=p>:</span> <span class=n>Callable</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;å¸¦æ¢å¤æœºåˆ¶çš„æ‰§è¡Œ&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>strategy</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>recovery_strategies</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>operation</span><span class=p>,</span> <span class=n>RecoveryStrategy</span><span class=o>.</span><span class=n>RETRY</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>strategy</span> <span class=o>==</span> <span class=n>RecoveryStrategy</span><span class=o>.</span><span class=n>RETRY</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_execute_with_retry</span><span class=p>(</span><span class=n>operation</span><span class=p>,</span> <span class=n>func</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>strategy</span> <span class=o>==</span> <span class=n>RecoveryStrategy</span><span class=o>.</span><span class=n>FALLBACK</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_execute_with_fallback</span><span class=p>(</span><span class=n>operation</span><span class=p>,</span> <span class=n>func</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>strategy</span> <span class=o>==</span> <span class=n>RecoveryStrategy</span><span class=o>.</span><span class=n>CIRCUIT_BREAKER</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_execute_with_circuit_breaker</span><span class=p>(</span><span class=n>operation</span><span class=p>,</span> <span class=n>func</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>strategy</span> <span class=o>==</span> <span class=n>RecoveryStrategy</span><span class=o>.</span><span class=n>GRACEFUL_DEGRADATION</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_execute_with_degradation</span><span class=p>(</span><span class=n>operation</span><span class=p>,</span> <span class=n>func</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=k>await</span> <span class=n>func</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>_execute_with_retry</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>operation</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>func</span><span class=p>:</span> <span class=n>Callable</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;é‡è¯•æ‰§è¡Œ&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>policy</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>retry_policies</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>operation</span><span class=p>,</span> <span class=p>{})</span>
</span></span><span class=line><span class=cl>        <span class=n>max_attempts</span> <span class=o>=</span> <span class=n>policy</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;max_attempts&#39;</span><span class=p>,</span> <span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>delay</span> <span class=o>=</span> <span class=n>policy</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;delay&#39;</span><span class=p>,</span> <span class=mf>1.0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>backoff_multiplier</span> <span class=o>=</span> <span class=n>policy</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;backoff_multiplier&#39;</span><span class=p>,</span> <span class=mf>2.0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>max_delay</span> <span class=o>=</span> <span class=n>policy</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;max_delay&#39;</span><span class=p>,</span> <span class=mf>30.0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>last_exception</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>        <span class=n>current_delay</span> <span class=o>=</span> <span class=n>delay</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>attempt</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>max_attempts</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=k>await</span> <span class=n>func</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>last_exception</span> <span class=o>=</span> <span class=n>e</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>attempt</span> <span class=o>&lt;</span> <span class=n>max_attempts</span> <span class=o>-</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>await</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=n>current_delay</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=n>current_delay</span> <span class=o>=</span> <span class=nb>min</span><span class=p>(</span><span class=n>current_delay</span> <span class=o>*</span> <span class=n>backoff_multiplier</span><span class=p>,</span> <span class=n>max_delay</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># æ‰€æœ‰é‡è¯•éƒ½å¤±è´¥ï¼ŒæŠ›å‡ºæœ€åä¸€ä¸ªå¼‚å¸¸</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=n>last_exception</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>_execute_with_fallback</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>operation</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>func</span><span class=p>:</span> <span class=n>Callable</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;é™çº§æ‰§è¡Œ&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=k>await</span> <span class=n>func</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>fallback_handler</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fallback_handlers</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>operation</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>fallback_handler</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=k>await</span> <span class=n>fallback_handler</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=n>e</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>_execute_with_circuit_breaker</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>operation</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>func</span><span class=p>:</span> <span class=n>Callable</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;ç†”æ–­å™¨æ‰§è¡Œ&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>circuit_breaker</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>circuit_breakers</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>operation</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>circuit_breaker</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=k>await</span> <span class=n>func</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>circuit_breaker</span><span class=o>.</span><span class=n>is_open</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=n>McpError</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>code</span><span class=o>=</span><span class=n>ErrorCode</span><span class=o>.</span><span class=n>SERVICE_UNAVAILABLE</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>message</span><span class=o>=</span><span class=sa>f</span><span class=s2>&#34;æœåŠ¡ </span><span class=si>{</span><span class=n>operation</span><span class=si>}</span><span class=s2> ç†”æ–­ä¸­&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>result</span> <span class=o>=</span> <span class=k>await</span> <span class=n>func</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>circuit_breaker</span><span class=o>.</span><span class=n>record_success</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>circuit_breaker</span><span class=o>.</span><span class=n>record_failure</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=n>e</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>_execute_with_degradation</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>operation</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>func</span><span class=p>:</span> <span class=n>Callable</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;ä¼˜é›…é™çº§æ‰§è¡Œ&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=k>await</span> <span class=n>func</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># è®°å½•é”™è¯¯ä½†è¿”å›é™çº§ç»“æœ</span>
</span></span><span class=line><span class=cl>            <span class=n>fallback_handler</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fallback_handlers</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>operation</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>fallback_handler</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=k>await</span> <span class=n>fallback_handler</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>except</span> <span class=ne>Exception</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=c1># é™çº§ä¹Ÿå¤±è´¥ï¼Œè¿”å›é»˜è®¤å€¼</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_get_default_response</span><span class=p>(</span><span class=n>operation</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_get_default_response</span><span class=p>(</span><span class=n>operation</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_get_default_response</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>operation</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;è·å–é»˜è®¤å“åº”&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>operation</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s1>&#39;read_&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>operation</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s1>&#39;list_&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>operation</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s1>&#39;call_&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>ToolResult</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>content</span><span class=o>=</span><span class=p>[</span><span class=n>TextContent</span><span class=p>(</span><span class=nb>type</span><span class=o>=</span><span class=s2>&#34;text&#34;</span><span class=p>,</span> <span class=n>text</span><span class=o>=</span><span class=s2>&#34;æœåŠ¡æš‚æ—¶ä¸å¯ç”¨&#34;</span><span class=p>)],</span>
</span></span><span class=line><span class=cl>                <span class=n>isError</span><span class=o>=</span><span class=kc>True</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ResilientMcpServer</span><span class=p>(</span><span class=n>McpServer</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;å…·æœ‰é”™è¯¯æ¢å¤èƒ½åŠ›çš„MCPæœåŠ¡å™¨&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span><span class=n>name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>recovery_manager</span> <span class=o>=</span> <span class=n>ErrorRecoveryManager</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>setup_recovery_strategies</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>setup_recovery_strategies</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;è®¾ç½®æ¢å¤ç­–ç•¥&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># èµ„æºè¯»å–ä½¿ç”¨é‡è¯•ç­–ç•¥</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>recovery_manager</span><span class=o>.</span><span class=n>register_strategy</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;read_resource&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>RecoveryStrategy</span><span class=o>.</span><span class=n>RETRY</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>max_attempts</span><span class=o>=</span><span class=mi>3</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>delay</span><span class=o>=</span><span class=mf>1.0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>backoff_multiplier</span><span class=o>=</span><span class=mf>2.0</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># å·¥å…·è°ƒç”¨ä½¿ç”¨ç†”æ–­å™¨</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>recovery_manager</span><span class=o>.</span><span class=n>register_strategy</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;call_tool&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>RecoveryStrategy</span><span class=o>.</span><span class=n>CIRCUIT_BREAKER</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>failure_threshold</span><span class=o>=</span><span class=mi>5</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>timeout</span><span class=o>=</span><span class=mi>60</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># æ³¨å†Œé™çº§å¤„ç†å™¨</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>recovery_manager</span><span class=o>.</span><span class=n>register_fallback</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;read_resource&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>fallback_read_resource</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>recovery_manager</span><span class=o>.</span><span class=n>register_fallback</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;call_tool&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>fallback_call_tool</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>read_resource</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>uri</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;å¸¦æ¢å¤æœºåˆ¶çš„èµ„æºè¯»å–&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>recovery_manager</span><span class=o>.</span><span class=n>execute_with_recovery</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;read_resource&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=n>read_resource</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>uri</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>call_tool</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>arguments</span><span class=p>:</span> <span class=nb>dict</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>ToolResult</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;å¸¦æ¢å¤æœºåˆ¶çš„å·¥å…·è°ƒç”¨&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>recovery_manager</span><span class=o>.</span><span class=n>execute_with_recovery</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;call_tool&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=n>call_tool</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>arguments</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>fallback_read_resource</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>uri</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;èµ„æºè¯»å–é™çº§å¤„ç†&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;èµ„æº </span><span class=si>{</span><span class=n>uri</span><span class=si>}</span><span class=s2> æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>fallback_call_tool</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>arguments</span><span class=p>:</span> <span class=nb>dict</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>ToolResult</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;å·¥å…·è°ƒç”¨é™çº§å¤„ç†&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>ToolResult</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>content</span><span class=o>=</span><span class=p>[</span><span class=n>TextContent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=nb>type</span><span class=o>=</span><span class=s2>&#34;text&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>text</span><span class=o>=</span><span class=sa>f</span><span class=s2>&#34;å·¥å…· </span><span class=si>{</span><span class=n>name</span><span class=si>}</span><span class=s2> æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>)],</span>
</span></span><span class=line><span class=cl>            <span class=n>isError</span><span class=o>=</span><span class=kc>True</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=å¤šç§Ÿæˆ·æ”¯æŒ>å¤šç§Ÿæˆ·æ”¯æŒ</h3><h4 id=ç§Ÿæˆ·éš”ç¦»æœºåˆ¶>ç§Ÿæˆ·éš”ç¦»æœºåˆ¶</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Dict</span><span class=p>,</span> <span class=n>Set</span><span class=p>,</span> <span class=n>Optional</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>hashlib</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>TenantManager</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;ç§Ÿæˆ·ç®¡ç†å™¨&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>tenants</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Dict</span><span class=p>]</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>tenant_resources</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Set</span><span class=p>[</span><span class=nb>str</span><span class=p>]]</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>tenant_quotas</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Dict</span><span class=p>]</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>tenant_usage</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Dict</span><span class=p>]</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>create_tenant</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>tenant_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>config</span><span class=p>:</span> <span class=n>Dict</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;åˆ›å»ºç§Ÿæˆ·&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>tenants</span><span class=p>[</span><span class=n>tenant_id</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;id&#39;</span><span class=p>:</span> <span class=n>tenant_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;name&#39;</span><span class=p>:</span> <span class=n>config</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;name&#39;</span><span class=p>,</span> <span class=n>tenant_id</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;created_at&#39;</span><span class=p>:</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;status&#39;</span><span class=p>:</span> <span class=s1>&#39;active&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;config&#39;</span><span class=p>:</span> <span class=n>config</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># åˆå§‹åŒ–èµ„æºå’Œé…é¢</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>tenant_resources</span><span class=p>[</span><span class=n>tenant_id</span><span class=p>]</span> <span class=o>=</span> <span class=nb>set</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>tenant_quotas</span><span class=p>[</span><span class=n>tenant_id</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;max_resources&#39;</span><span class=p>:</span> <span class=n>config</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;max_resources&#39;</span><span class=p>,</span> <span class=mi>100</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;max_requests_per_minute&#39;</span><span class=p>:</span> <span class=n>config</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;max_requests_per_minute&#39;</span><span class=p>,</span> <span class=mi>1000</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;max_storage_mb&#39;</span><span class=p>:</span> <span class=n>config</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;max_storage_mb&#39;</span><span class=p>,</span> <span class=mi>1024</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>tenant_usage</span><span class=p>[</span><span class=n>tenant_id</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;resources_count&#39;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;requests_count&#39;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;storage_used_mb&#39;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;last_reset&#39;</span><span class=p>:</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_tenant</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>tenant_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=n>Dict</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;è·å–ç§Ÿæˆ·ä¿¡æ¯&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>tenants</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>tenant_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>check_quota</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>tenant_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>resource_type</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>amount</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>1</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;æ£€æŸ¥é…é¢&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>tenant_id</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>tenant_quotas</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>quota</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>tenant_quotas</span><span class=p>[</span><span class=n>tenant_id</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>usage</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>tenant_usage</span><span class=p>[</span><span class=n>tenant_id</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># é‡ç½®æ¯åˆ†é’Ÿçš„è¯·æ±‚è®¡æ•°</span>
</span></span><span class=line><span class=cl>        <span class=n>current_time</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>current_time</span> <span class=o>-</span> <span class=n>usage</span><span class=p>[</span><span class=s1>&#39;last_reset&#39;</span><span class=p>]</span> <span class=o>&gt;=</span> <span class=mi>60</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>usage</span><span class=p>[</span><span class=s1>&#39;requests_count&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>            <span class=n>usage</span><span class=p>[</span><span class=s1>&#39;last_reset&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>current_time</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>resource_type</span> <span class=o>==</span> <span class=s1>&#39;requests&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>usage</span><span class=p>[</span><span class=s1>&#39;requests_count&#39;</span><span class=p>]</span> <span class=o>+</span> <span class=n>amount</span> <span class=o>&lt;=</span> <span class=n>quota</span><span class=p>[</span><span class=s1>&#39;max_requests_per_minute&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>resource_type</span> <span class=o>==</span> <span class=s1>&#39;resources&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>usage</span><span class=p>[</span><span class=s1>&#39;resources_count&#39;</span><span class=p>]</span> <span class=o>+</span> <span class=n>amount</span> <span class=o>&lt;=</span> <span class=n>quota</span><span class=p>[</span><span class=s1>&#39;max_resources&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>resource_type</span> <span class=o>==</span> <span class=s1>&#39;storage&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>usage</span><span class=p>[</span><span class=s1>&#39;storage_used_mb&#39;</span><span class=p>]</span> <span class=o>+</span> <span class=n>amount</span> <span class=o>&lt;=</span> <span class=n>quota</span><span class=p>[</span><span class=s1>&#39;max_storage_mb&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>consume_quota</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>tenant_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>resource_type</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>amount</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;æ¶ˆè´¹é…é¢&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>tenant_id</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>tenant_usage</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>usage</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>tenant_usage</span><span class=p>[</span><span class=n>tenant_id</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>resource_type</span> <span class=o>==</span> <span class=s1>&#39;requests&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>usage</span><span class=p>[</span><span class=s1>&#39;requests_count&#39;</span><span class=p>]</span> <span class=o>+=</span> <span class=n>amount</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>resource_type</span> <span class=o>==</span> <span class=s1>&#39;resources&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>usage</span><span class=p>[</span><span class=s1>&#39;resources_count&#39;</span><span class=p>]</span> <span class=o>+=</span> <span class=n>amount</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>resource_type</span> <span class=o>==</span> <span class=s1>&#39;storage&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>usage</span><span class=p>[</span><span class=s1>&#39;storage_used_mb&#39;</span><span class=p>]</span> <span class=o>+=</span> <span class=n>amount</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_tenant_namespace</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>tenant_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>resource_name</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;è·å–ç§Ÿæˆ·å‘½åç©ºé—´çš„èµ„æºå&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;tenant:</span><span class=si>{</span><span class=n>tenant_id</span><span class=si>}</span><span class=s2>:</span><span class=si>{</span><span class=n>resource_name</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>MultiTenantMcpServer</span><span class=p>(</span><span class=n>McpServer</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;å¤šç§Ÿæˆ·MCPæœåŠ¡å™¨&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span><span class=n>name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>tenant_manager</span> <span class=o>=</span> <span class=n>TenantManager</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>tenant_contexts</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=p>{}</span>  <span class=c1># è¿æ¥ID -&gt; ç§Ÿæˆ·IDæ˜ å°„</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>authenticate_tenant</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>token</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>str</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;ç§Ÿæˆ·è®¤è¯&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># è¿™é‡Œåº”è¯¥å®ç°å®é™…çš„JWTéªŒè¯é€»è¾‘</span>
</span></span><span class=line><span class=cl>        <span class=c1># ä¸ºç®€åŒ–ç¤ºä¾‹ï¼Œç›´æ¥ä»tokenä¸­æå–ç§Ÿæˆ·ID</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># å‡è®¾tokenæ ¼å¼ä¸º &#34;tenant_id:signature&#34;</span>
</span></span><span class=line><span class=cl>            <span class=n>tenant_id</span> <span class=o>=</span> <span class=n>token</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;:&#39;</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>tenant_manager</span><span class=o>.</span><span class=n>get_tenant</span><span class=p>(</span><span class=n>tenant_id</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>tenant_id</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>Exception</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>pass</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>handle_request</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>method</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>params</span><span class=p>:</span> <span class=nb>dict</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;å¤„ç†å¤šç§Ÿæˆ·è¯·æ±‚&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># è·å–å½“å‰è¿æ¥çš„ç§Ÿæˆ·ID</span>
</span></span><span class=line><span class=cl>        <span class=n>connection_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_current_connection_id</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>tenant_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>tenant_contexts</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>connection_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>tenant_id</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=n>McpError</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>code</span><span class=o>=</span><span class=n>ErrorCode</span><span class=o>.</span><span class=n>UNAUTHORIZED</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>message</span><span class=o>=</span><span class=s2>&#34;éœ€è¦ç§Ÿæˆ·è®¤è¯&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># æ£€æŸ¥è¯·æ±‚é…é¢</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>tenant_manager</span><span class=o>.</span><span class=n>check_quota</span><span class=p>(</span><span class=n>tenant_id</span><span class=p>,</span> <span class=s1>&#39;requests&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=n>McpError</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>code</span><span class=o>=</span><span class=n>ErrorCode</span><span class=o>.</span><span class=n>RATE_LIMITED</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>message</span><span class=o>=</span><span class=s2>&#34;ç§Ÿæˆ·è¯·æ±‚é…é¢å·²ç”¨å®Œ&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># æ¶ˆè´¹é…é¢</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>tenant_manager</span><span class=o>.</span><span class=n>consume_quota</span><span class=p>(</span><span class=n>tenant_id</span><span class=p>,</span> <span class=s1>&#39;requests&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># åœ¨è¯·æ±‚å‚æ•°ä¸­æ³¨å…¥ç§Ÿæˆ·ä¸Šä¸‹æ–‡</span>
</span></span><span class=line><span class=cl>        <span class=n>params</span><span class=p>[</span><span class=s1>&#39;_tenant_id&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>tenant_id</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>await</span> <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=n>handle_request</span><span class=p>(</span><span class=n>method</span><span class=p>,</span> <span class=n>params</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>read_resource</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>uri</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;å¤šç§Ÿæˆ·èµ„æºè¯»å–&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>tenant_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_get_current_tenant_id</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># æ·»åŠ ç§Ÿæˆ·å‘½åç©ºé—´</span>
</span></span><span class=line><span class=cl>        <span class=n>namespaced_uri</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>tenant_manager</span><span class=o>.</span><span class=n>get_tenant_namespace</span><span class=p>(</span><span class=n>tenant_id</span><span class=p>,</span> <span class=n>uri</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>await</span> <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=n>read_resource</span><span class=p>(</span><span class=n>namespaced_uri</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>list_resources</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=n>Resource</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;åˆ—å‡ºç§Ÿæˆ·èµ„æº&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>tenant_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_get_current_tenant_id</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># è·å–æ‰€æœ‰èµ„æºå¹¶è¿‡æ»¤ç§Ÿæˆ·èµ„æº</span>
</span></span><span class=line><span class=cl>        <span class=n>all_resources</span> <span class=o>=</span> <span class=k>await</span> <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=n>list_resources</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>tenant_prefix</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;tenant:</span><span class=si>{</span><span class=n>tenant_id</span><span class=si>}</span><span class=s2>:&#34;</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>tenant_resources</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>resource</span> <span class=ow>in</span> <span class=n>all_resources</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>resource</span><span class=o>.</span><span class=n>uri</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=n>tenant_prefix</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=c1># ç§»é™¤ç§Ÿæˆ·å‰ç¼€ï¼Œè¿”å›åŸå§‹URI</span>
</span></span><span class=line><span class=cl>                <span class=n>original_uri</span> <span class=o>=</span> <span class=n>resource</span><span class=o>.</span><span class=n>uri</span><span class=p>[</span><span class=nb>len</span><span class=p>(</span><span class=n>tenant_prefix</span><span class=p>):]</span>
</span></span><span class=line><span class=cl>                <span class=n>tenant_resources</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>Resource</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                    <span class=n>uri</span><span class=o>=</span><span class=n>original_uri</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>name</span><span class=o>=</span><span class=n>resource</span><span class=o>.</span><span class=n>name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>description</span><span class=o>=</span><span class=n>resource</span><span class=o>.</span><span class=n>description</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>mimeType</span><span class=o>=</span><span class=n>resource</span><span class=o>.</span><span class=n>mimeType</span>
</span></span><span class=line><span class=cl>                <span class=p>))</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>tenant_resources</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_get_current_tenant_id</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;è·å–å½“å‰ç§Ÿæˆ·ID&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>connection_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_current_connection_id</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>tenant_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>tenant_contexts</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>connection_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>tenant_id</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=n>McpError</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>code</span><span class=o>=</span><span class=n>ErrorCode</span><span class=o>.</span><span class=n>UNAUTHORIZED</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>message</span><span class=o>=</span><span class=s2>&#34;æœªæ‰¾åˆ°ç§Ÿæˆ·ä¸Šä¸‹æ–‡&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>tenant_id</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>create_tenant</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>tenant_config</span><span class=p>:</span> <span class=n>Dict</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;åˆ›å»ºæ–°ç§Ÿæˆ·&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>tenant_id</span> <span class=o>=</span> <span class=n>tenant_config</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;id&#39;</span><span class=p>)</span> <span class=ow>or</span> <span class=bp>self</span><span class=o>.</span><span class=n>_generate_tenant_id</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>tenant_manager</span><span class=o>.</span><span class=n>create_tenant</span><span class=p>(</span><span class=n>tenant_id</span><span class=p>,</span> <span class=n>tenant_config</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>tenant_id</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_generate_tenant_id</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;ç”Ÿæˆç§Ÿæˆ·ID&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=kn>import</span> <span class=nn>uuid</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nb>str</span><span class=p>(</span><span class=n>uuid</span><span class=o>.</span><span class=n>uuid4</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>get_tenant_usage</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>tenant_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;è·å–ç§Ÿæˆ·ä½¿ç”¨æƒ…å†µ&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>usage</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>tenant_manager</span><span class=o>.</span><span class=n>tenant_usage</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>tenant_id</span><span class=p>,</span> <span class=p>{})</span>
</span></span><span class=line><span class=cl>        <span class=n>quota</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>tenant_manager</span><span class=o>.</span><span class=n>tenant_quotas</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>tenant_id</span><span class=p>,</span> <span class=p>{})</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;usage&#39;</span><span class=p>:</span> <span class=n>usage</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;quota&#39;</span><span class=p>:</span> <span class=n>quota</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;utilization&#39;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;requests&#39;</span><span class=p>:</span> <span class=n>usage</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;requests_count&#39;</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span> <span class=o>/</span> <span class=nb>max</span><span class=p>(</span><span class=n>quota</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;max_requests_per_minute&#39;</span><span class=p>,</span> <span class=mi>1</span><span class=p>),</span> <span class=mi>1</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;resources&#39;</span><span class=p>:</span> <span class=n>usage</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;resources_count&#39;</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span> <span class=o>/</span> <span class=nb>max</span><span class=p>(</span><span class=n>quota</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;max_resources&#39;</span><span class=p>,</span> <span class=mi>1</span><span class=p>),</span> <span class=mi>1</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;storage&#39;</span><span class=p>:</span> <span class=n>usage</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;storage_used_mb&#39;</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span> <span class=o>/</span> <span class=nb>max</span><span class=p>(</span><span class=n>quota</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;max_storage_mb&#39;</span><span class=p>,</span> <span class=mi>1</span><span class=p>),</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=-mcpå¼€å‘å®è·µ>ğŸ› ï¸ MCPå¼€å‘å®è·µ</h2><h3 id=å¼€å‘ç¯å¢ƒæ­å»º>å¼€å‘ç¯å¢ƒæ­å»º</h3><h4 id=1-å®‰è£…å¼€å‘å·¥å…·>1. å®‰è£…å¼€å‘å·¥å…·</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># Pythonç¯å¢ƒ</span>
</span></span><span class=line><span class=cl>pip install mcp
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># TypeScriptç¯å¢ƒ</span>
</span></span><span class=line><span class=cl>npm install @modelcontextprotocol/sdk
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># è°ƒè¯•å·¥å…·</span>
</span></span><span class=line><span class=cl>npm install -g @modelcontextprotocol/inspector
</span></span></code></pre></td></tr></table></div></div><h4 id=2-é¡¹ç›®ç»“æ„>2. é¡¹ç›®ç»“æ„</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>my</span><span class=o>-</span><span class=n>mcp</span><span class=o>-</span><span class=n>server</span><span class=o>/</span>
</span></span><span class=line><span class=cl><span class=err>â”œâ”€â”€</span> <span class=n>src</span><span class=o>/</span>
</span></span><span class=line><span class=cl><span class=err>â”‚</span>   <span class=err>â”œâ”€â”€</span> <span class=n>__init__</span><span class=o>.</span><span class=n>py</span>
</span></span><span class=line><span class=cl><span class=err>â”‚</span>   <span class=err>â”œâ”€â”€</span> <span class=n>server</span><span class=o>.</span><span class=n>py</span>          <span class=c1># ä¸»æœåŠ¡å™¨ä»£ç </span>
</span></span><span class=line><span class=cl><span class=err>â”‚</span>   <span class=err>â”œâ”€â”€</span> <span class=n>resources</span><span class=o>.</span><span class=n>py</span>       <span class=c1># èµ„æºå¤„ç†</span>
</span></span><span class=line><span class=cl><span class=err>â”‚</span>   <span class=err>â”œâ”€â”€</span> <span class=n>tools</span><span class=o>.</span><span class=n>py</span>          <span class=c1># å·¥å…·å®ç°</span>
</span></span><span class=line><span class=cl><span class=err>â”‚</span>   <span class=err>â””â”€â”€</span> <span class=n>prompts</span><span class=o>.</span><span class=n>py</span>        <span class=c1># æç¤ºæ¨¡æ¿</span>
</span></span><span class=line><span class=cl><span class=err>â”œâ”€â”€</span> <span class=n>config</span><span class=o>/</span>
</span></span><span class=line><span class=cl><span class=err>â”‚</span>   <span class=err>â””â”€â”€</span> <span class=n>server_config</span><span class=o>.</span><span class=n>json</span>
</span></span><span class=line><span class=cl><span class=err>â”œâ”€â”€</span> <span class=n>tests</span><span class=o>/</span>
</span></span><span class=line><span class=cl><span class=err>â”‚</span>   <span class=err>â””â”€â”€</span> <span class=n>test_server</span><span class=o>.</span><span class=n>py</span>
</span></span><span class=line><span class=cl><span class=err>â”œâ”€â”€</span> <span class=n>requirements</span><span class=o>.</span><span class=n>txt</span>
</span></span><span class=line><span class=cl><span class=err>â””â”€â”€</span> <span class=n>README</span><span class=o>.</span><span class=n>md</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=å¼€å‘æœ€ä½³å®è·µ>å¼€å‘æœ€ä½³å®è·µ</h3><h4 id=1-æœåŠ¡å™¨è®¾è®¡åŸåˆ™>1. æœåŠ¡å™¨è®¾è®¡åŸåˆ™</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>mcp</span> <span class=kn>import</span> <span class=n>McpServer</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>List</span><span class=p>,</span> <span class=n>Optional</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>asyncio</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>BestPracticeServer</span><span class=p>(</span><span class=n>McpServer</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span><span class=s2>&#34;best-practice-server&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>name</span> <span class=o>=</span> <span class=s2>&#34;æœ€ä½³å®è·µæœåŠ¡å™¨&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>version</span> <span class=o>=</span> <span class=s2>&#34;1.0.0&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>initialize</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;åˆå§‹åŒ–æœåŠ¡å™¨èµ„æº&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;æœåŠ¡å™¨åˆå§‹åŒ–ä¸­...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># åˆå§‹åŒ–æ•°æ®åº“è¿æ¥ã€ç¼“å­˜ç­‰</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>cleanup</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;æ¸…ç†èµ„æº&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;æœåŠ¡å™¨æ¸…ç†ä¸­...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># å…³é—­è¿æ¥ã€æ¸…ç†ç¼“å­˜ç­‰</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=2-é”™è¯¯å¤„ç†>2. é”™è¯¯å¤„ç†</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>mcp</span> <span class=kn>import</span> <span class=n>McpError</span><span class=p>,</span> <span class=n>ErrorCode</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>safe_tool_call</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>arguments</span><span class=p>:</span> <span class=nb>dict</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># å·¥å…·æ‰§è¡Œé€»è¾‘</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>execute_tool</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>arguments</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=n>ValidationError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=n>McpError</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>code</span><span class=o>=</span><span class=n>ErrorCode</span><span class=o>.</span><span class=n>INVALID_PARAMS</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>message</span><span class=o>=</span><span class=sa>f</span><span class=s2>&#34;å‚æ•°éªŒè¯å¤±è´¥: </span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>PermissionError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=n>McpError</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>code</span><span class=o>=</span><span class=n>ErrorCode</span><span class=o>.</span><span class=n>PERMISSION_DENIED</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>message</span><span class=o>=</span><span class=s2>&#34;æƒé™ä¸è¶³&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;å·¥å…·æ‰§è¡Œå¤±è´¥: </span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=n>McpError</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>code</span><span class=o>=</span><span class=n>ErrorCode</span><span class=o>.</span><span class=n>INTERNAL_ERROR</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>message</span><span class=o>=</span><span class=s2>&#34;å†…éƒ¨æœåŠ¡å™¨é”™è¯¯&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=3-æ€§èƒ½ä¼˜åŒ–>3. æ€§èƒ½ä¼˜åŒ–</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>asyncio</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>functools</span> <span class=kn>import</span> <span class=n>lru_cache</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>OptimizedServer</span><span class=p>(</span><span class=n>McpServer</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nd>@lru_cache</span><span class=p>(</span><span class=n>maxsize</span><span class=o>=</span><span class=mi>100</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>get_cached_resource</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>uri</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;ç¼“å­˜èµ„æºå†…å®¹&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>load_resource</span><span class=p>(</span><span class=n>uri</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>batch_process_resources</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>uris</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;æ‰¹é‡å¤„ç†èµ„æº&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>tasks</span> <span class=o>=</span> <span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>get_cached_resource</span><span class=p>(</span><span class=n>uri</span><span class=p>)</span> <span class=k>for</span> <span class=n>uri</span> <span class=ow>in</span> <span class=n>uris</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>await</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>gather</span><span class=p>(</span><span class=o>*</span><span class=n>tasks</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=è°ƒè¯•ä¸æµ‹è¯•>è°ƒè¯•ä¸æµ‹è¯•</h3><h4 id=1-ä½¿ç”¨mcp-inspector>1. ä½¿ç”¨MCP Inspector</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># å¯åŠ¨è°ƒè¯•å·¥å…·</span>
</span></span><span class=line><span class=cl>npx @modelcontextprotocol/inspector
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># æµ‹è¯•æœåŠ¡å™¨è¿æ¥</span>
</span></span><span class=line><span class=cl>mcp-inspector --server python my_server.py
</span></span></code></pre></td></tr></table></div></div><h4 id=2-å•å…ƒæµ‹è¯•>2. å•å…ƒæµ‹è¯•</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pytest</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>mcp.testing</span> <span class=kn>import</span> <span class=n>McpTestClient</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@pytest.mark.asyncio</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>test_resource_listing</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>client</span> <span class=o>=</span> <span class=n>McpTestClient</span><span class=p>(</span><span class=n>MyMcpServer</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=k>await</span> <span class=n>client</span><span class=o>.</span><span class=n>connect</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>resources</span> <span class=o>=</span> <span class=k>await</span> <span class=n>client</span><span class=o>.</span><span class=n>list_resources</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>len</span><span class=p>(</span><span class=n>resources</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>resources</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>name</span> <span class=o>==</span> <span class=s2>&#34;æµ‹è¯•èµ„æº&#34;</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=-å®é™…åº”ç”¨æ¡ˆä¾‹>ğŸ”§ å®é™…åº”ç”¨æ¡ˆä¾‹</h2><h3 id=æ¡ˆä¾‹ä¸€ä»£ç åº“åˆ†ææœåŠ¡å™¨>æ¡ˆä¾‹ä¸€ï¼šä»£ç åº“åˆ†ææœåŠ¡å™¨</h3><h4 id=éœ€æ±‚åˆ†æ>éœ€æ±‚åˆ†æ</h4><p>ä¸ºAIæ¨¡å‹æä¾›ä»£ç åº“çš„å®Œæ•´ä¸Šä¸‹æ–‡ï¼ŒåŒ…æ‹¬æ–‡ä»¶ç»“æ„ã€ä»£ç å†…å®¹ã€Gitå†å²ç­‰ã€‚</p><h4 id=å®ç°æ–¹æ¡ˆ>å®ç°æ–¹æ¡ˆ</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>CodebaseServer</span><span class=p>(</span><span class=n>McpServer</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>repo_path</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span><span class=s2>&#34;codebase-server&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>repo_path</span> <span class=o>=</span> <span class=n>repo_path</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>git_repo</span> <span class=o>=</span> <span class=n>GitRepository</span><span class=p>(</span><span class=n>repo_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>list_resources</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;åˆ—å‡ºä»£ç åº“ä¸­çš„æ‰€æœ‰æ–‡ä»¶&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>files</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>root</span><span class=p>,</span> <span class=n>dirs</span><span class=p>,</span> <span class=n>filenames</span> <span class=ow>in</span> <span class=n>os</span><span class=o>.</span><span class=n>walk</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>repo_path</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>filename</span> <span class=ow>in</span> <span class=n>filenames</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>is_code_file</span><span class=p>(</span><span class=n>filename</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                    <span class=n>file_path</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>root</span><span class=p>,</span> <span class=n>filename</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=n>relative_path</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>relpath</span><span class=p>(</span><span class=n>file_path</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>repo_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=n>files</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>Resource</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                        <span class=n>uri</span><span class=o>=</span><span class=sa>f</span><span class=s2>&#34;file://</span><span class=si>{</span><span class=n>file_path</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>name</span><span class=o>=</span><span class=n>relative_path</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>description</span><span class=o>=</span><span class=sa>f</span><span class=s2>&#34;ä»£ç æ–‡ä»¶: </span><span class=si>{</span><span class=n>relative_path</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>mimeType</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>get_mime_type</span><span class=p>(</span><span class=n>filename</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>files</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>list_tools</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=n>Tool</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>name</span><span class=o>=</span><span class=s2>&#34;analyze_code_structure&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>description</span><span class=o>=</span><span class=s2>&#34;åˆ†æä»£ç ç»“æ„å’Œä¾èµ–å…³ç³»&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>inputSchema</span><span class=o>=</span><span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;object&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;properties&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;file_pattern&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                            <span class=s2>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;string&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                            <span class=s2>&#34;description&#34;</span><span class=p>:</span> <span class=s2>&#34;æ–‡ä»¶åŒ¹é…æ¨¡å¼&#34;</span>
</span></span><span class=line><span class=cl>                        <span class=p>}</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=n>Tool</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>name</span><span class=o>=</span><span class=s2>&#34;get_git_history&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>description</span><span class=o>=</span><span class=s2>&#34;è·å–Gitæäº¤å†å²&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>inputSchema</span><span class=o>=</span><span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;object&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;properties&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;file_path&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                            <span class=s2>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;string&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                            <span class=s2>&#34;description&#34;</span><span class=p>:</span> <span class=s2>&#34;æ–‡ä»¶è·¯å¾„&#34;</span>
</span></span><span class=line><span class=cl>                        <span class=p>},</span>
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;limit&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                            <span class=s2>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;integer&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                            <span class=s2>&#34;description&#34;</span><span class=p>:</span> <span class=s2>&#34;å†å²è®°å½•æ•°é‡é™åˆ¶&#34;</span>
</span></span><span class=line><span class=cl>                        <span class=p>}</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>]</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=æ¡ˆä¾‹äºŒæ•°æ®åº“ç®¡ç†æœåŠ¡å™¨>æ¡ˆä¾‹äºŒï¼šæ•°æ®åº“ç®¡ç†æœåŠ¡å™¨</h3><h4 id=åŠŸèƒ½ç‰¹æ€§>åŠŸèƒ½ç‰¹æ€§</h4><ul><li>æ•°æ®åº“è¿æ¥ç®¡ç†</li><li>SQLæŸ¥è¯¢æ‰§è¡Œ</li><li>è¡¨ç»“æ„åˆ†æ</li><li>æ•°æ®å®‰å…¨ä¿æŠ¤</li></ul><h4 id=å®ç°ä»£ç >å®ç°ä»£ç </h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>asyncpg</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Dict</span><span class=p>,</span> <span class=n>Any</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>DatabaseServer</span><span class=p>(</span><span class=n>McpServer</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>db_config</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span><span class=s2>&#34;database-server&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>db_config</span> <span class=o>=</span> <span class=n>db_config</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>connection_pool</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>initialize</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;åˆå§‹åŒ–æ•°æ®åº“è¿æ¥æ± &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>connection_pool</span> <span class=o>=</span> <span class=k>await</span> <span class=n>asyncpg</span><span class=o>.</span><span class=n>create_pool</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=o>**</span><span class=bp>self</span><span class=o>.</span><span class=n>db_config</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>min_size</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>max_size</span><span class=o>=</span><span class=mi>10</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>list_resources</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;åˆ—å‡ºæ•°æ®åº“è¡¨å’Œè§†å›¾&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>async</span> <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>connection_pool</span><span class=o>.</span><span class=n>acquire</span><span class=p>()</span> <span class=k>as</span> <span class=n>conn</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>tables</span> <span class=o>=</span> <span class=k>await</span> <span class=n>conn</span><span class=o>.</span><span class=n>fetch</span><span class=p>(</span><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>                SELECT table_name, table_type 
</span></span></span><span class=line><span class=cl><span class=s2>                FROM information_schema.tables 
</span></span></span><span class=line><span class=cl><span class=s2>                WHERE table_schema = &#39;public&#39;
</span></span></span><span class=line><span class=cl><span class=s2>            &#34;&#34;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>                <span class=n>Resource</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                    <span class=n>uri</span><span class=o>=</span><span class=sa>f</span><span class=s2>&#34;table://</span><span class=si>{</span><span class=n>table</span><span class=p>[</span><span class=s1>&#39;table_name&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>name</span><span class=o>=</span><span class=n>table</span><span class=p>[</span><span class=s1>&#39;table_name&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                    <span class=n>description</span><span class=o>=</span><span class=sa>f</span><span class=s2>&#34;æ•°æ®åº“</span><span class=si>{</span><span class=n>table</span><span class=p>[</span><span class=s1>&#39;table_type&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>table</span><span class=p>[</span><span class=s1>&#39;table_name&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>mimeType</span><span class=o>=</span><span class=s2>&#34;application/sql&#34;</span>
</span></span><span class=line><span class=cl>                <span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>for</span> <span class=n>table</span> <span class=ow>in</span> <span class=n>tables</span>
</span></span><span class=line><span class=cl>            <span class=p>]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>call_tool</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>arguments</span><span class=p>:</span> <span class=nb>dict</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>name</span> <span class=o>==</span> <span class=s2>&#34;execute_query&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>query</span> <span class=o>=</span> <span class=n>arguments</span><span class=p>[</span><span class=s2>&#34;query&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># å®‰å…¨æ£€æŸ¥</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>is_safe_query</span><span class=p>(</span><span class=n>query</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=k>raise</span> <span class=n>McpError</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                    <span class=n>code</span><span class=o>=</span><span class=n>ErrorCode</span><span class=o>.</span><span class=n>PERMISSION_DENIED</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>message</span><span class=o>=</span><span class=s2>&#34;æŸ¥è¯¢åŒ…å«ä¸å®‰å…¨çš„æ“ä½œ&#34;</span>
</span></span><span class=line><span class=cl>                <span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>async</span> <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>connection_pool</span><span class=o>.</span><span class=n>acquire</span><span class=p>()</span> <span class=k>as</span> <span class=n>conn</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>result</span> <span class=o>=</span> <span class=k>await</span> <span class=n>conn</span><span class=o>.</span><span class=n>fetch</span><span class=p>(</span><span class=n>query</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=n>ToolResult</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                        <span class=n>content</span><span class=o>=</span><span class=p>[{</span>
</span></span><span class=line><span class=cl>                            <span class=s2>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;text&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                            <span class=s2>&#34;text&#34;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>format_query_result</span><span class=p>(</span><span class=n>result</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                        <span class=p>}]</span>
</span></span><span class=line><span class=cl>                    <span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=n>ToolResult</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                        <span class=n>content</span><span class=o>=</span><span class=p>[{</span>
</span></span><span class=line><span class=cl>                            <span class=s2>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;text&#34;</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                            <span class=s2>&#34;text&#34;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&#34;æŸ¥è¯¢æ‰§è¡Œå¤±è´¥: </span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>                        <span class=p>}],</span>
</span></span><span class=line><span class=cl>                        <span class=n>isError</span><span class=o>=</span><span class=kc>True</span>
</span></span><span class=line><span class=cl>                    <span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>is_safe_query</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;æ£€æŸ¥æŸ¥è¯¢æ˜¯å¦å®‰å…¨&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>dangerous_keywords</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;DROP&#39;</span><span class=p>,</span> <span class=s1>&#39;DELETE&#39;</span><span class=p>,</span> <span class=s1>&#39;UPDATE&#39;</span><span class=p>,</span> <span class=s1>&#39;INSERT&#39;</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>            <span class=s1>&#39;ALTER&#39;</span><span class=p>,</span> <span class=s1>&#39;CREATE&#39;</span><span class=p>,</span> <span class=s1>&#39;TRUNCATE&#39;</span>
</span></span><span class=line><span class=cl>        <span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>query_upper</span> <span class=o>=</span> <span class=n>query</span><span class=o>.</span><span class=n>upper</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=ow>not</span> <span class=nb>any</span><span class=p>(</span><span class=n>keyword</span> <span class=ow>in</span> <span class=n>query_upper</span> <span class=k>for</span> <span class=n>keyword</span> <span class=ow>in</span> <span class=n>dangerous_keywords</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=æ¡ˆä¾‹ä¸‰æ–‡æ¡£çŸ¥è¯†åº“æœåŠ¡å™¨>æ¡ˆä¾‹ä¸‰ï¼šæ–‡æ¡£çŸ¥è¯†åº“æœåŠ¡å™¨</h3><h4 id=åº”ç”¨åœºæ™¯-1>åº”ç”¨åœºæ™¯</h4><p>ä¸ºAIåŠ©æ‰‹æä¾›ä¼ä¸šå†…éƒ¨æ–‡æ¡£ã€çŸ¥è¯†åº“çš„è®¿é—®èƒ½åŠ›ã€‚</p><h4 id=æ ¸å¿ƒå®ç°>æ ¸å¿ƒå®ç°</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pathlib</span> <span class=kn>import</span> <span class=n>Path</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>markdown</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>bs4</span> <span class=kn>import</span> <span class=n>BeautifulSoup</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>KnowledgeBaseServer</span><span class=p>(</span><span class=n>McpServer</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>docs_path</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span><span class=s2>&#34;knowledge-base-server&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>docs_path</span> <span class=o>=</span> <span class=n>Path</span><span class=p>(</span><span class=n>docs_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>doc_index</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>initialize</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;æ„å»ºæ–‡æ¡£ç´¢å¼•&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>build_document_index</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>build_document_index</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;æ„å»ºæ–‡æ¡£ç´¢å¼•ä»¥æ”¯æŒå¿«é€Ÿæœç´¢&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>doc_file</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>docs_path</span><span class=o>.</span><span class=n>rglob</span><span class=p>(</span><span class=s2>&#34;*.md&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>content</span> <span class=o>=</span> <span class=n>doc_file</span><span class=o>.</span><span class=n>read_text</span><span class=p>(</span><span class=n>encoding</span><span class=o>=</span><span class=s1>&#39;utf-8&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=c1># æå–æ ‡é¢˜å’Œå…³é”®è¯</span>
</span></span><span class=line><span class=cl>            <span class=n>html</span> <span class=o>=</span> <span class=n>markdown</span><span class=o>.</span><span class=n>markdown</span><span class=p>(</span><span class=n>content</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>soup</span> <span class=o>=</span> <span class=n>BeautifulSoup</span><span class=p>(</span><span class=n>html</span><span class=p>,</span> <span class=s1>&#39;html.parser&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>doc_index</span><span class=p>[</span><span class=nb>str</span><span class=p>(</span><span class=n>doc_file</span><span class=p>)]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;title&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>extract_title</span><span class=p>(</span><span class=n>soup</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;keywords&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>extract_keywords</span><span class=p>(</span><span class=n>content</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;summary&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>generate_summary</span><span class=p>(</span><span class=n>content</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>list_prompts</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=n>Prompt</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>name</span><span class=o>=</span><span class=s2>&#34;document_qa&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>description</span><span class=o>=</span><span class=s2>&#34;æ–‡æ¡£é—®ç­”æç¤ºæ¨¡æ¿&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>arguments</span><span class=o>=</span><span class=p>[</span>
</span></span><span class=line><span class=cl>                    <span class=n>PromptArgument</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                        <span class=n>name</span><span class=o>=</span><span class=s2>&#34;question&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>description</span><span class=o>=</span><span class=s2>&#34;ç”¨æˆ·é—®é¢˜&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>required</span><span class=o>=</span><span class=kc>True</span>
</span></span><span class=line><span class=cl>                    <span class=p>),</span>
</span></span><span class=line><span class=cl>                    <span class=n>PromptArgument</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                        <span class=n>name</span><span class=o>=</span><span class=s2>&#34;context_docs&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>description</span><span class=o>=</span><span class=s2>&#34;ç›¸å…³æ–‡æ¡£&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>required</span><span class=o>=</span><span class=kc>False</span>
</span></span><span class=line><span class=cl>                    <span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>get_prompt</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>arguments</span><span class=p>:</span> <span class=nb>dict</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>name</span> <span class=o>==</span> <span class=s2>&#34;document_qa&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>question</span> <span class=o>=</span> <span class=n>arguments</span><span class=p>[</span><span class=s2>&#34;question&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>context_docs</span> <span class=o>=</span> <span class=n>arguments</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;context_docs&#34;</span><span class=p>,</span> <span class=s2>&#34;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>åŸºäºä»¥ä¸‹æ–‡æ¡£å†…å®¹å›ç­”ç”¨æˆ·é—®é¢˜ã€‚
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>ç›¸å…³æ–‡æ¡£ï¼š
</span></span></span><span class=line><span class=cl><span class=s2></span><span class=si>{</span><span class=n>context_docs</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>ç”¨æˆ·é—®é¢˜ï¼š</span><span class=si>{</span><span class=n>question</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>è¯·åŸºäºæ–‡æ¡£å†…å®¹æä¾›å‡†ç¡®ã€è¯¦ç»†çš„å›ç­”ã€‚å¦‚æœæ–‡æ¡£ä¸­æ²¡æœ‰ç›¸å…³ä¿¡æ¯ï¼Œè¯·æ˜ç¡®è¯´æ˜ã€‚
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=-ä¼ä¸šçº§éƒ¨ç½²æ–¹æ¡ˆ>ğŸ¢ ä¼ä¸šçº§éƒ¨ç½²æ–¹æ¡ˆ</h2><h3 id=éƒ¨ç½²æ¶æ„>éƒ¨ç½²æ¶æ„</h3><h4 id=1-æœ¬åœ°éƒ¨ç½²>1. æœ¬åœ°éƒ¨ç½²</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># docker-compose.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;3.8&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>mcp-server</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>build</span><span class=p>:</span><span class=w> </span><span class=l>.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;8080:8080&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>environment</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>DB_HOST=postgres</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>REDIS_URL=redis://redis:6379</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>./data:/app/data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>depends_on</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>postgres</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>redis</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>postgres</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>postgres:15</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>environment</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>POSTGRES_DB</span><span class=p>:</span><span class=w> </span><span class=l>mcpdata</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>POSTGRES_USER</span><span class=p>:</span><span class=w> </span><span class=l>mcpuser</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>POSTGRES_PASSWORD</span><span class=p>:</span><span class=w> </span><span class=l>mcppass</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>postgres_data:/var/lib/postgresql/data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>redis</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>redis:7-alpine</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>postgres_data</span><span class=p>:</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=2-äº‘ç«¯éƒ¨ç½²>2. äº‘ç«¯éƒ¨ç½²</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># Kuberneteséƒ¨ç½²ç¤ºä¾‹</span>
</span></span><span class=line><span class=cl>kubectl apply -f - <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: apps/v1
</span></span></span><span class=line><span class=cl><span class=s>kind: Deployment
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: mcp-server
</span></span></span><span class=line><span class=cl><span class=s>spec:
</span></span></span><span class=line><span class=cl><span class=s>  replicas: 3
</span></span></span><span class=line><span class=cl><span class=s>  selector:
</span></span></span><span class=line><span class=cl><span class=s>    matchLabels:
</span></span></span><span class=line><span class=cl><span class=s>      app: mcp-server
</span></span></span><span class=line><span class=cl><span class=s>  template:
</span></span></span><span class=line><span class=cl><span class=s>    metadata:
</span></span></span><span class=line><span class=cl><span class=s>      labels:
</span></span></span><span class=line><span class=cl><span class=s>        app: mcp-server
</span></span></span><span class=line><span class=cl><span class=s>    spec:
</span></span></span><span class=line><span class=cl><span class=s>      containers:
</span></span></span><span class=line><span class=cl><span class=s>      - name: mcp-server
</span></span></span><span class=line><span class=cl><span class=s>        image: my-org/mcp-server:latest
</span></span></span><span class=line><span class=cl><span class=s>        ports:
</span></span></span><span class=line><span class=cl><span class=s>        - containerPort: 8080
</span></span></span><span class=line><span class=cl><span class=s>        env:
</span></span></span><span class=line><span class=cl><span class=s>        - name: DB_HOST
</span></span></span><span class=line><span class=cl><span class=s>          value: &#34;postgres-service&#34;
</span></span></span><span class=line><span class=cl><span class=s>        - name: REDIS_URL
</span></span></span><span class=line><span class=cl><span class=s>          value: &#34;redis://redis-service:6379&#34;
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=å®‰å…¨æœ€ä½³å®è·µ>å®‰å…¨æœ€ä½³å®è·µ</h3><h4 id=1-è®¤è¯æˆæƒ>1. è®¤è¯æˆæƒ</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>functools</span> <span class=kn>import</span> <span class=n>wraps</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>jwt</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>SecureMcpServer</span><span class=p>(</span><span class=n>McpServer</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span><span class=s2>&#34;secure-server&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>jwt_secret</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>getenv</span><span class=p>(</span><span class=s2>&#34;JWT_SECRET&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>authorized_clients</span> <span class=o>=</span> <span class=nb>set</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>require_auth</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>func</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nd>@wraps</span><span class=p>(</span><span class=n>func</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>async</span> <span class=k>def</span> <span class=nf>wrapper</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>client_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_current_client_id</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>client_id</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>authorized_clients</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>raise</span> <span class=n>McpError</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                    <span class=n>code</span><span class=o>=</span><span class=n>ErrorCode</span><span class=o>.</span><span class=n>PERMISSION_DENIED</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>message</span><span class=o>=</span><span class=s2>&#34;æœªæˆæƒçš„å®¢æˆ·ç«¯&#34;</span>
</span></span><span class=line><span class=cl>                <span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=k>await</span> <span class=n>func</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>wrapper</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@require_auth</span>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>call_tool</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>arguments</span><span class=p>:</span> <span class=nb>dict</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># å®‰å…¨çš„å·¥å…·è°ƒç”¨</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>await</span> <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=n>call_tool</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>arguments</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=2-æ•°æ®åŠ å¯†>2. æ•°æ®åŠ å¯†</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>cryptography.fernet</span> <span class=kn>import</span> <span class=n>Fernet</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>EncryptedDataServer</span><span class=p>(</span><span class=n>McpServer</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span><span class=s2>&#34;encrypted-server&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>cipher_suite</span> <span class=o>=</span> <span class=n>Fernet</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>getenv</span><span class=p>(</span><span class=s2>&#34;ENCRYPTION_KEY&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>read_resource</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>uri</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;è¯»å–åŠ å¯†èµ„æº&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>encrypted_data</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>load_encrypted_data</span><span class=p>(</span><span class=n>uri</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>decrypted_data</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>cipher_suite</span><span class=o>.</span><span class=n>decrypt</span><span class=p>(</span><span class=n>encrypted_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>decrypted_data</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=s1>&#39;utf-8&#39;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=-æœªæ¥å‘å±•è¶‹åŠ¿>ğŸš€ æœªæ¥å‘å±•è¶‹åŠ¿</h2><h3 id=æŠ€æœ¯æ¼”è¿›æ–¹å‘>æŠ€æœ¯æ¼”è¿›æ–¹å‘</h3><h4 id=1-åè®®å¢å¼º>1. åè®®å¢å¼º</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-markdown data-lang=markdown><span class=line><span class=cl>ğŸ”® æœªæ¥ç‰¹æ€§ï¼š
</span></span><span class=line><span class=cl><span class=k>-</span> æµå¼æ•°æ®ä¼ è¾“æ”¯æŒ
</span></span><span class=line><span class=cl><span class=k>-</span> æ›´å¼ºçš„ç±»å‹ç³»ç»Ÿ
</span></span><span class=line><span class=cl><span class=k>-</span> å†…ç½®ç¼“å­˜æœºåˆ¶
</span></span><span class=line><span class=cl><span class=k>-</span> äº‹åŠ¡æ”¯æŒ
</span></span><span class=line><span class=cl><span class=k>-</span> æ›´å¥½çš„é”™è¯¯æ¢å¤
</span></span></code></pre></td></tr></table></div></div><h4 id=2-ç”Ÿæ€ç³»ç»Ÿæ‰©å±•>2. ç”Ÿæ€ç³»ç»Ÿæ‰©å±•</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-markdown data-lang=markdown><span class=line><span class=cl>ğŸŒ ç”Ÿæ€å‘å±•ï¼š
</span></span><span class=line><span class=cl><span class=k>-</span> æ›´å¤šé¢„æ„å»ºæœåŠ¡å™¨
</span></span><span class=line><span class=cl><span class=k>-</span> å¯è§†åŒ–é…ç½®å·¥å…·
</span></span><span class=line><span class=cl><span class=k>-</span> ç›‘æ§å’Œåˆ†æå¹³å°
</span></span><span class=line><span class=cl><span class=k>-</span> æ’ä»¶å¸‚åœº
</span></span><span class=line><span class=cl><span class=k>-</span> ä¼ä¸šçº§ç®¡ç†æ§åˆ¶å°
</span></span></code></pre></td></tr></table></div></div><h4 id=3-ä¸ai-agenté›†æˆ>3. ä¸AI Agenté›†æˆ</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># æœªæ¥çš„AI Agenté›†æˆç¤ºä¾‹</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>IntelligentMcpAgent</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>mcp_clients</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>reasoning_engine</span> <span class=o>=</span> <span class=n>ReasoningEngine</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>process_request</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>user_request</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># 1. åˆ†æç”¨æˆ·è¯·æ±‚</span>
</span></span><span class=line><span class=cl>        <span class=n>intent</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>reasoning_engine</span><span class=o>.</span><span class=n>analyze_intent</span><span class=p>(</span><span class=n>user_request</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 2. é€‰æ‹©åˆé€‚çš„MCPæœåŠ¡å™¨</span>
</span></span><span class=line><span class=cl>        <span class=n>relevant_servers</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>select_servers</span><span class=p>(</span><span class=n>intent</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 3. æ”¶é›†ä¸Šä¸‹æ–‡ä¿¡æ¯</span>
</span></span><span class=line><span class=cl>        <span class=n>context</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>gather_context</span><span class=p>(</span><span class=n>relevant_servers</span><span class=p>,</span> <span class=n>intent</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 4. ç”Ÿæˆå“åº”</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>generate_response</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>user_request</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>response</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=-æ€§èƒ½ä¼˜åŒ–ä¸ç›‘æ§ç³»ç»Ÿ>ğŸ“Š æ€§èƒ½ä¼˜åŒ–ä¸ç›‘æ§ç³»ç»Ÿ</h2><h3 id=é«˜çº§æ€§èƒ½ç›‘æ§>é«˜çº§æ€§èƒ½ç›‘æ§</h3><h4 id=å®æ—¶æ€§èƒ½æŒ‡æ ‡æ”¶é›†>å®æ—¶æ€§èƒ½æŒ‡æ ‡æ”¶é›†</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span><span class=lnt>210
</span><span class=lnt>211
</span><span class=lnt>212
</span><span class=lnt>213
</span><span class=lnt>214
</span><span class=lnt>215
</span><span class=lnt>216
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>psutil</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>asyncio</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>dataclasses</span> <span class=kn>import</span> <span class=n>dataclass</span><span class=p>,</span> <span class=n>asdict</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Dict</span><span class=p>,</span> <span class=n>List</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>collections</span> <span class=kn>import</span> <span class=n>deque</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@dataclass</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>PerformanceMetrics</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;æ€§èƒ½æŒ‡æ ‡æ•°æ®ç»“æ„&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>timestamp</span><span class=p>:</span> <span class=nb>float</span>
</span></span><span class=line><span class=cl>    <span class=n>cpu_usage</span><span class=p>:</span> <span class=nb>float</span>
</span></span><span class=line><span class=cl>    <span class=n>memory_usage</span><span class=p>:</span> <span class=nb>float</span>
</span></span><span class=line><span class=cl>    <span class=n>memory_available</span><span class=p>:</span> <span class=nb>int</span>
</span></span><span class=line><span class=cl>    <span class=n>disk_io_read</span><span class=p>:</span> <span class=nb>int</span>
</span></span><span class=line><span class=cl>    <span class=n>disk_io_write</span><span class=p>:</span> <span class=nb>int</span>
</span></span><span class=line><span class=cl>    <span class=n>network_sent</span><span class=p>:</span> <span class=nb>int</span>
</span></span><span class=line><span class=cl>    <span class=n>network_recv</span><span class=p>:</span> <span class=nb>int</span>
</span></span><span class=line><span class=cl>    <span class=n>active_connections</span><span class=p>:</span> <span class=nb>int</span>
</span></span><span class=line><span class=cl>    <span class=n>response_time</span><span class=p>:</span> <span class=nb>float</span>
</span></span><span class=line><span class=cl>    <span class=n>request_count</span><span class=p>:</span> <span class=nb>int</span>
</span></span><span class=line><span class=cl>    <span class=n>error_count</span><span class=p>:</span> <span class=nb>int</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>PerformanceMonitor</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;æ€§èƒ½ç›‘æ§å™¨&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>collection_interval</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>5</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>collection_interval</span> <span class=o>=</span> <span class=n>collection_interval</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>metrics_history</span><span class=p>:</span> <span class=n>deque</span> <span class=o>=</span> <span class=n>deque</span><span class=p>(</span><span class=n>maxlen</span><span class=o>=</span><span class=mi>1000</span><span class=p>)</span>  <span class=c1># ä¿ç•™æœ€è¿‘1000æ¡è®°å½•</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>is_monitoring</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>thresholds</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;cpu_usage&#39;</span><span class=p>:</span> <span class=mf>80.0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;memory_usage&#39;</span><span class=p>:</span> <span class=mf>85.0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;response_time&#39;</span><span class=p>:</span> <span class=mf>5.0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;error_rate&#39;</span><span class=p>:</span> <span class=mf>0.05</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>alerts</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>start_monitoring</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;å¯åŠ¨ç›‘æ§&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>is_monitoring</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=bp>self</span><span class=o>.</span><span class=n>is_monitoring</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>metrics</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>collect_metrics</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>metrics_history</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>metrics</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># æ£€æŸ¥å‘Šè­¦é˜ˆå€¼</span>
</span></span><span class=line><span class=cl>            <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>check_alerts</span><span class=p>(</span><span class=n>metrics</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>await</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>collection_interval</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>collect_metrics</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>PerformanceMetrics</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;æ”¶é›†æ€§èƒ½æŒ‡æ ‡&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># ç³»ç»Ÿèµ„æºæŒ‡æ ‡</span>
</span></span><span class=line><span class=cl>        <span class=n>cpu_usage</span> <span class=o>=</span> <span class=n>psutil</span><span class=o>.</span><span class=n>cpu_percent</span><span class=p>(</span><span class=n>interval</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>memory</span> <span class=o>=</span> <span class=n>psutil</span><span class=o>.</span><span class=n>virtual_memory</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>disk_io</span> <span class=o>=</span> <span class=n>psutil</span><span class=o>.</span><span class=n>disk_io_counters</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>network_io</span> <span class=o>=</span> <span class=n>psutil</span><span class=o>.</span><span class=n>net_io_counters</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># åº”ç”¨æŒ‡æ ‡</span>
</span></span><span class=line><span class=cl>        <span class=n>active_connections</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_active_connections</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>response_time</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_average_response_time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>request_count</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_request_count</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>error_count</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_error_count</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>PerformanceMetrics</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>timestamp</span><span class=o>=</span><span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>            <span class=n>cpu_usage</span><span class=o>=</span><span class=n>cpu_usage</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>memory_usage</span><span class=o>=</span><span class=n>memory</span><span class=o>.</span><span class=n>percent</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>memory_available</span><span class=o>=</span><span class=n>memory</span><span class=o>.</span><span class=n>available</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>disk_io_read</span><span class=o>=</span><span class=n>disk_io</span><span class=o>.</span><span class=n>read_bytes</span> <span class=k>if</span> <span class=n>disk_io</span> <span class=k>else</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>disk_io_write</span><span class=o>=</span><span class=n>disk_io</span><span class=o>.</span><span class=n>write_bytes</span> <span class=k>if</span> <span class=n>disk_io</span> <span class=k>else</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>network_sent</span><span class=o>=</span><span class=n>network_io</span><span class=o>.</span><span class=n>bytes_sent</span> <span class=k>if</span> <span class=n>network_io</span> <span class=k>else</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>network_recv</span><span class=o>=</span><span class=n>network_io</span><span class=o>.</span><span class=n>bytes_recv</span> <span class=k>if</span> <span class=n>network_io</span> <span class=k>else</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>active_connections</span><span class=o>=</span><span class=n>active_connections</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>response_time</span><span class=o>=</span><span class=n>response_time</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>request_count</span><span class=o>=</span><span class=n>request_count</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>error_count</span><span class=o>=</span><span class=n>error_count</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>check_alerts</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>metrics</span><span class=p>:</span> <span class=n>PerformanceMetrics</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;æ£€æŸ¥å‘Šè­¦æ¡ä»¶&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>alerts</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>metrics</span><span class=o>.</span><span class=n>cpu_usage</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>thresholds</span><span class=p>[</span><span class=s1>&#39;cpu_usage&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>            <span class=n>alerts</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;type&#39;</span><span class=p>:</span> <span class=s1>&#39;CPU_HIGH&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;message&#39;</span><span class=p>:</span> <span class=sa>f</span><span class=s1>&#39;CPUä½¿ç”¨ç‡è¿‡é«˜: </span><span class=si>{</span><span class=n>metrics</span><span class=o>.</span><span class=n>cpu_usage</span><span class=si>:</span><span class=s1>.2f</span><span class=si>}</span><span class=s1>%&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;severity&#39;</span><span class=p>:</span> <span class=s1>&#39;WARNING&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;timestamp&#39;</span><span class=p>:</span> <span class=n>metrics</span><span class=o>.</span><span class=n>timestamp</span>
</span></span><span class=line><span class=cl>            <span class=p>})</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>metrics</span><span class=o>.</span><span class=n>memory_usage</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>thresholds</span><span class=p>[</span><span class=s1>&#39;memory_usage&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>            <span class=n>alerts</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;type&#39;</span><span class=p>:</span> <span class=s1>&#39;MEMORY_HIGH&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;message&#39;</span><span class=p>:</span> <span class=sa>f</span><span class=s1>&#39;å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜: </span><span class=si>{</span><span class=n>metrics</span><span class=o>.</span><span class=n>memory_usage</span><span class=si>:</span><span class=s1>.2f</span><span class=si>}</span><span class=s1>%&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;severity&#39;</span><span class=p>:</span> <span class=s1>&#39;WARNING&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;timestamp&#39;</span><span class=p>:</span> <span class=n>metrics</span><span class=o>.</span><span class=n>timestamp</span>
</span></span><span class=line><span class=cl>            <span class=p>})</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>metrics</span><span class=o>.</span><span class=n>response_time</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>thresholds</span><span class=p>[</span><span class=s1>&#39;response_time&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>            <span class=n>alerts</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;type&#39;</span><span class=p>:</span> <span class=s1>&#39;RESPONSE_SLOW&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;message&#39;</span><span class=p>:</span> <span class=sa>f</span><span class=s1>&#39;å“åº”æ—¶é—´è¿‡é•¿: </span><span class=si>{</span><span class=n>metrics</span><span class=o>.</span><span class=n>response_time</span><span class=si>:</span><span class=s1>.2f</span><span class=si>}</span><span class=s1>s&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;severity&#39;</span><span class=p>:</span> <span class=s1>&#39;CRITICAL&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;timestamp&#39;</span><span class=p>:</span> <span class=n>metrics</span><span class=o>.</span><span class=n>timestamp</span>
</span></span><span class=line><span class=cl>            <span class=p>})</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># è®¡ç®—é”™è¯¯ç‡</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>metrics</span><span class=o>.</span><span class=n>request_count</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>error_rate</span> <span class=o>=</span> <span class=n>metrics</span><span class=o>.</span><span class=n>error_count</span> <span class=o>/</span> <span class=n>metrics</span><span class=o>.</span><span class=n>request_count</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>error_rate</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>thresholds</span><span class=p>[</span><span class=s1>&#39;error_rate&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                <span class=n>alerts</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;type&#39;</span><span class=p>:</span> <span class=s1>&#39;ERROR_RATE_HIGH&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;message&#39;</span><span class=p>:</span> <span class=sa>f</span><span class=s1>&#39;é”™è¯¯ç‡è¿‡é«˜: </span><span class=si>{</span><span class=n>error_rate</span><span class=si>:</span><span class=s1>.2%</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;severity&#39;</span><span class=p>:</span> <span class=s1>&#39;CRITICAL&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;timestamp&#39;</span><span class=p>:</span> <span class=n>metrics</span><span class=o>.</span><span class=n>timestamp</span>
</span></span><span class=line><span class=cl>                <span class=p>})</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>alerts</span><span class=o>.</span><span class=n>extend</span><span class=p>(</span><span class=n>alerts</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># å‘é€å‘Šè­¦é€šçŸ¥</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>alert</span> <span class=ow>in</span> <span class=n>alerts</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>send_alert_notification</span><span class=p>(</span><span class=n>alert</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_metrics_summary</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>duration_minutes</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>60</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;è·å–æŒ‡æ ‡æ‘˜è¦&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>cutoff_time</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=p>(</span><span class=n>duration_minutes</span> <span class=o>*</span> <span class=mi>60</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>recent_metrics</span> <span class=o>=</span> <span class=p>[</span><span class=n>m</span> <span class=k>for</span> <span class=n>m</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>metrics_history</span> <span class=k>if</span> <span class=n>m</span><span class=o>.</span><span class=n>timestamp</span> <span class=o>&gt;=</span> <span class=n>cutoff_time</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>recent_metrics</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;avg_cpu_usage&#39;</span><span class=p>:</span> <span class=nb>sum</span><span class=p>(</span><span class=n>m</span><span class=o>.</span><span class=n>cpu_usage</span> <span class=k>for</span> <span class=n>m</span> <span class=ow>in</span> <span class=n>recent_metrics</span><span class=p>)</span> <span class=o>/</span> <span class=nb>len</span><span class=p>(</span><span class=n>recent_metrics</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;avg_memory_usage&#39;</span><span class=p>:</span> <span class=nb>sum</span><span class=p>(</span><span class=n>m</span><span class=o>.</span><span class=n>memory_usage</span> <span class=k>for</span> <span class=n>m</span> <span class=ow>in</span> <span class=n>recent_metrics</span><span class=p>)</span> <span class=o>/</span> <span class=nb>len</span><span class=p>(</span><span class=n>recent_metrics</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;avg_response_time&#39;</span><span class=p>:</span> <span class=nb>sum</span><span class=p>(</span><span class=n>m</span><span class=o>.</span><span class=n>response_time</span> <span class=k>for</span> <span class=n>m</span> <span class=ow>in</span> <span class=n>recent_metrics</span><span class=p>)</span> <span class=o>/</span> <span class=nb>len</span><span class=p>(</span><span class=n>recent_metrics</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;total_requests&#39;</span><span class=p>:</span> <span class=nb>sum</span><span class=p>(</span><span class=n>m</span><span class=o>.</span><span class=n>request_count</span> <span class=k>for</span> <span class=n>m</span> <span class=ow>in</span> <span class=n>recent_metrics</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;total_errors&#39;</span><span class=p>:</span> <span class=nb>sum</span><span class=p>(</span><span class=n>m</span><span class=o>.</span><span class=n>error_count</span> <span class=k>for</span> <span class=n>m</span> <span class=ow>in</span> <span class=n>recent_metrics</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;error_rate&#39;</span><span class=p>:</span> <span class=nb>sum</span><span class=p>(</span><span class=n>m</span><span class=o>.</span><span class=n>error_count</span> <span class=k>for</span> <span class=n>m</span> <span class=ow>in</span> <span class=n>recent_metrics</span><span class=p>)</span> <span class=o>/</span> <span class=nb>max</span><span class=p>(</span><span class=nb>sum</span><span class=p>(</span><span class=n>m</span><span class=o>.</span><span class=n>request_count</span> <span class=k>for</span> <span class=n>m</span> <span class=ow>in</span> <span class=n>recent_metrics</span><span class=p>),</span> <span class=mi>1</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;sample_count&#39;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=n>recent_metrics</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>MonitoredMcpServer</span><span class=p>(</span><span class=n>McpServer</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;å¸¦æ€§èƒ½ç›‘æ§çš„MCPæœåŠ¡å™¨&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span><span class=s2>&#34;monitored-server&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>performance_monitor</span> <span class=o>=</span> <span class=n>PerformanceMonitor</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>request_stats</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;total_requests&#39;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;total_errors&#39;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;response_times&#39;</span><span class=p>:</span> <span class=n>deque</span><span class=p>(</span><span class=n>maxlen</span><span class=o>=</span><span class=mi>1000</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>start</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;å¯åŠ¨æœåŠ¡å™¨&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># å¯åŠ¨æ€§èƒ½ç›‘æ§</span>
</span></span><span class=line><span class=cl>        <span class=n>asyncio</span><span class=o>.</span><span class=n>create_task</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>performance_monitor</span><span class=o>.</span><span class=n>start_monitoring</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># å¯åŠ¨è‡ªåŠ¨ä¼˜åŒ–</span>
</span></span><span class=line><span class=cl>        <span class=n>asyncio</span><span class=o>.</span><span class=n>create_task</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>auto_optimization_loop</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>handle_request</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>method</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>params</span><span class=p>:</span> <span class=nb>dict</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;å¤„ç†è¯·æ±‚å¹¶è®°å½•æ€§èƒ½æŒ‡æ ‡&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>start_time</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>request_stats</span><span class=p>[</span><span class=s1>&#39;total_requests&#39;</span><span class=p>]</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>result</span> <span class=o>=</span> <span class=k>await</span> <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=n>handle_request</span><span class=p>(</span><span class=n>method</span><span class=p>,</span> <span class=n>params</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>request_stats</span><span class=p>[</span><span class=s1>&#39;total_errors&#39;</span><span class=p>]</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span>
</span></span><span class=line><span class=cl>        <span class=k>finally</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>end_time</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>response_time</span> <span class=o>=</span> <span class=n>end_time</span> <span class=o>-</span> <span class=n>start_time</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>request_stats</span><span class=p>[</span><span class=s1>&#39;response_times&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>response_time</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_performance_report</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;è·å–æ€§èƒ½æŠ¥å‘Š&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>summary</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>performance_monitor</span><span class=o>.</span><span class=n>get_metrics_summary</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>recent_alerts</span> <span class=o>=</span> <span class=p>[</span><span class=n>a</span> <span class=k>for</span> <span class=n>a</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>performance_monitor</span><span class=o>.</span><span class=n>alerts</span> 
</span></span><span class=line><span class=cl>                        <span class=k>if</span> <span class=n>a</span><span class=p>[</span><span class=s1>&#39;timestamp&#39;</span><span class=p>]</span> <span class=o>&gt;</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=mi>3600</span><span class=p>]</span>  <span class=c1># æœ€è¿‘1å°æ—¶çš„å‘Šè­¦</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;system_metrics&#39;</span><span class=p>:</span> <span class=n>summary</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;request_stats&#39;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;total_requests&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>request_stats</span><span class=p>[</span><span class=s1>&#39;total_requests&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;total_errors&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>request_stats</span><span class=p>[</span><span class=s1>&#39;total_errors&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;error_rate&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>request_stats</span><span class=p>[</span><span class=s1>&#39;total_errors&#39;</span><span class=p>]</span> <span class=o>/</span> <span class=nb>max</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>request_stats</span><span class=p>[</span><span class=s1>&#39;total_requests&#39;</span><span class=p>],</span> <span class=mi>1</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;avg_response_time&#39;</span><span class=p>:</span> <span class=nb>sum</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>request_stats</span><span class=p>[</span><span class=s1>&#39;response_times&#39;</span><span class=p>])</span> <span class=o>/</span> <span class=nb>max</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>request_stats</span><span class=p>[</span><span class=s1>&#39;response_times&#39;</span><span class=p>]),</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;recent_alerts&#39;</span><span class=p>:</span> <span class=n>recent_alerts</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;optimization_recommendations&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_optimization_recommendations</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_optimization_recommendations</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;è·å–ä¼˜åŒ–å»ºè®®&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>recommendations</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=n>summary</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>performance_monitor</span><span class=o>.</span><span class=n>get_metrics_summary</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>summary</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;avg_memory_usage&#39;</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>80</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>recommendations</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s2>&#34;è€ƒè™‘å¢åŠ å†…å­˜æˆ–ä¼˜åŒ–å†…å­˜ä½¿ç”¨&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>summary</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;avg_cpu_usage&#39;</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>80</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>recommendations</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s2>&#34;è€ƒè™‘å¢åŠ CPUæ ¸å¿ƒæ•°æˆ–ä¼˜åŒ–CPUå¯†é›†å‹æ“ä½œ&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>summary</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;avg_response_time&#39;</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mf>3.0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>recommendations</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s2>&#34;è€ƒè™‘å¯ç”¨ç¼“å­˜æˆ–ä¼˜åŒ–æ•°æ®åº“æŸ¥è¯¢&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>summary</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;error_rate&#39;</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mf>0.05</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>recommendations</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s2>&#34;æ£€æŸ¥é”™è¯¯æ—¥å¿—å¹¶ä¿®å¤é«˜é¢‘é”™è¯¯&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>recommendations</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=ç¼“å­˜ä¼˜åŒ–ç­–ç•¥>ç¼“å­˜ä¼˜åŒ–ç­–ç•¥</h3><h4 id=å¤šçº§ç¼“å­˜ç³»ç»Ÿ>å¤šçº§ç¼“å­˜ç³»ç»Ÿ</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>redis</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pickle</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Any</span><span class=p>,</span> <span class=n>Optional</span><span class=p>,</span> <span class=n>Union</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>abc</span> <span class=kn>import</span> <span class=n>ABC</span><span class=p>,</span> <span class=n>abstractmethod</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>CacheBackend</span><span class=p>(</span><span class=n>ABC</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;ç¼“å­˜åç«¯æŠ½è±¡åŸºç±»&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@abstractmethod</span>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>get</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>key</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=n>Any</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=k>pass</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@abstractmethod</span>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>set</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>key</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>value</span><span class=p>:</span> <span class=n>Any</span><span class=p>,</span> <span class=n>ttl</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>pass</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@abstractmethod</span>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>delete</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>key</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>pass</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@abstractmethod</span>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>exists</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>key</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>MemoryCache</span><span class=p>(</span><span class=n>CacheBackend</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;å†…å­˜ç¼“å­˜&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>max_size</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>1000</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>cache</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>max_size</span> <span class=o>=</span> <span class=n>max_size</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>access_times</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>get</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>key</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=n>Any</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>key</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>cache</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>access_times</span><span class=p>[</span><span class=n>key</span><span class=p>]</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>cache</span><span class=p>[</span><span class=n>key</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>set</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>key</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>value</span><span class=p>:</span> <span class=n>Any</span><span class=p>,</span> <span class=n>ttl</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>cache</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=bp>self</span><span class=o>.</span><span class=n>max_size</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># LRUæ·˜æ±°</span>
</span></span><span class=line><span class=cl>            <span class=n>oldest_key</span> <span class=o>=</span> <span class=nb>min</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>access_times</span><span class=o>.</span><span class=n>keys</span><span class=p>(),</span> 
</span></span><span class=line><span class=cl>                           <span class=n>key</span><span class=o>=</span><span class=k>lambda</span> <span class=n>k</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>access_times</span><span class=p>[</span><span class=n>k</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>delete</span><span class=p>(</span><span class=n>oldest_key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>cache</span><span class=p>[</span><span class=n>key</span><span class=p>]</span> <span class=o>=</span> <span class=n>value</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>access_times</span><span class=p>[</span><span class=n>key</span><span class=p>]</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>ttl</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># è®¾ç½®è¿‡æœŸæ—¶é—´</span>
</span></span><span class=line><span class=cl>            <span class=n>asyncio</span><span class=o>.</span><span class=n>create_task</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_expire_key</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>ttl</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>_expire_key</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>key</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>ttl</span><span class=p>:</span> <span class=nb>int</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=n>ttl</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>delete</span><span class=p>(</span><span class=n>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>delete</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>key</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>cache</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>access_times</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>exists</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>key</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>key</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>cache</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>RedisCache</span><span class=p>(</span><span class=n>CacheBackend</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Redisç¼“å­˜&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>redis_url</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s2>&#34;redis://localhost:6379&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>redis</span> <span class=o>=</span> <span class=n>redis</span><span class=o>.</span><span class=n>from_url</span><span class=p>(</span><span class=n>redis_url</span><span class=p>,</span> <span class=n>decode_responses</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>get</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>key</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=n>Any</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>redis</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>data</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>pickle</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>set</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>key</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>value</span><span class=p>:</span> <span class=n>Any</span><span class=p>,</span> <span class=n>ttl</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span> <span class=o>=</span> <span class=n>pickle</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>ttl</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>redis</span><span class=o>.</span><span class=n>setex</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>ttl</span><span class=p>,</span> <span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>redis</span><span class=o>.</span><span class=n>set</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>delete</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>key</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>redis</span><span class=o>.</span><span class=n>delete</span><span class=p>(</span><span class=n>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>exists</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>key</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>redis</span><span class=o>.</span><span class=n>exists</span><span class=p>(</span><span class=n>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>MultiLevelCache</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;å¤šçº§ç¼“å­˜ç³»ç»Ÿ&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>levels</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=n>MemoryCache</span><span class=p>(</span><span class=n>max_size</span><span class=o>=</span><span class=mi>100</span><span class=p>),</span>  <span class=c1># L1: å†…å­˜ç¼“å­˜</span>
</span></span><span class=line><span class=cl>            <span class=n>RedisCache</span><span class=p>(),</span>               <span class=c1># L2: Redisç¼“å­˜</span>
</span></span><span class=line><span class=cl>        <span class=p>]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>get</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>key</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=n>Any</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;ä»ç¼“å­˜è·å–æ•°æ®ï¼ŒæŒ‰çº§åˆ«æŸ¥æ‰¾&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>cache</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>levels</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>value</span> <span class=o>=</span> <span class=k>await</span> <span class=n>cache</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>value</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1># å›å¡«åˆ°æ›´é«˜çº§åˆ«çš„ç¼“å­˜</span>
</span></span><span class=line><span class=cl>                <span class=k>for</span> <span class=n>j</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>i</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                    <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>levels</span><span class=p>[</span><span class=n>j</span><span class=p>]</span><span class=o>.</span><span class=n>set</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>value</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>set</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>key</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>value</span><span class=p>:</span> <span class=n>Any</span><span class=p>,</span> <span class=n>ttl</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;è®¾ç½®ç¼“å­˜åˆ°æ‰€æœ‰çº§åˆ«&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>cache</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>levels</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>await</span> <span class=n>cache</span><span class=o>.</span><span class=n>set</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>value</span><span class=p>,</span> <span class=n>ttl</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>delete</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>key</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;ä»æ‰€æœ‰çº§åˆ«åˆ é™¤ç¼“å­˜&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>cache</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>levels</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>await</span> <span class=n>cache</span><span class=o>.</span><span class=n>delete</span><span class=p>(</span><span class=n>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>CachedMcpServer</span><span class=p>(</span><span class=n>McpServer</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;å¸¦ç¼“å­˜çš„MCPæœåŠ¡å™¨&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span><span class=s2>&#34;cached-server&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>cache</span> <span class=o>=</span> <span class=n>MultiLevelCache</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>cache_stats</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;hits&#39;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;misses&#39;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;sets&#39;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;deletes&#39;</span><span class=p>:</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>read_resource</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>uri</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;å¸¦ç¼“å­˜çš„èµ„æºè¯»å–&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>cache_key</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;resource:</span><span class=si>{</span><span class=n>uri</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># å°è¯•ä»ç¼“å­˜è·å–</span>
</span></span><span class=line><span class=cl>        <span class=n>cached_data</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>cache</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>cache_key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>cached_data</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>cache_stats</span><span class=p>[</span><span class=s1>&#39;hits&#39;</span><span class=p>]</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>cached_data</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># ç¼“å­˜æœªå‘½ä¸­ï¼Œä»æºè¯»å–</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>cache_stats</span><span class=p>[</span><span class=s1>&#39;misses&#39;</span><span class=p>]</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span> <span class=o>=</span> <span class=k>await</span> <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=n>read_resource</span><span class=p>(</span><span class=n>uri</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># å­˜å…¥ç¼“å­˜</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>cache</span><span class=o>.</span><span class=n>set</span><span class=p>(</span><span class=n>cache_key</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=n>ttl</span><span class=o>=</span><span class=mi>3600</span><span class=p>)</span>  <span class=c1># 1å°æ—¶è¿‡æœŸ</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>cache_stats</span><span class=p>[</span><span class=s1>&#39;sets&#39;</span><span class=p>]</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>data</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_cache_stats</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;è·å–ç¼“å­˜ç»Ÿè®¡&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>total_requests</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>cache_stats</span><span class=p>[</span><span class=s1>&#39;hits&#39;</span><span class=p>]</span> <span class=o>+</span> <span class=bp>self</span><span class=o>.</span><span class=n>cache_stats</span><span class=p>[</span><span class=s1>&#39;misses&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>hit_rate</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>cache_stats</span><span class=p>[</span><span class=s1>&#39;hits&#39;</span><span class=p>]</span> <span class=o>/</span> <span class=nb>max</span><span class=p>(</span><span class=n>total_requests</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;hit_rate&#39;</span><span class=p>:</span> <span class=n>hit_rate</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;total_hits&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>cache_stats</span><span class=p>[</span><span class=s1>&#39;hits&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;total_misses&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>cache_stats</span><span class=p>[</span><span class=s1>&#39;misses&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;total_sets&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>cache_stats</span><span class=p>[</span><span class=s1>&#39;sets&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;total_deletes&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>cache_stats</span><span class=p>[</span><span class=s1>&#39;deletes&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=æ€§èƒ½è°ƒä¼˜>æ€§èƒ½è°ƒä¼˜</h3><h4 id=1-è¿æ¥æ± ç®¡ç†>1. è¿æ¥æ± ç®¡ç†</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>asyncio</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>contextlib</span> <span class=kn>import</span> <span class=n>asynccontextmanager</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>PooledMcpServer</span><span class=p>(</span><span class=n>McpServer</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span><span class=s2>&#34;pooled-server&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>connection_pool</span> <span class=o>=</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>Queue</span><span class=p>(</span><span class=n>maxsize</span><span class=o>=</span><span class=mi>10</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>metrics</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;active_connections&#39;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;total_requests&#39;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;error_count&#39;</span><span class=p>:</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@asynccontextmanager</span>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>get_connection</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;è·å–è¿æ¥çš„ä¸Šä¸‹æ–‡ç®¡ç†å™¨&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;active_connections&#39;</span><span class=p>]</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>            <span class=n>connection</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>connection_pool</span><span class=o>.</span><span class=n>get</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>yield</span> <span class=n>connection</span>
</span></span><span class=line><span class=cl>        <span class=k>finally</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>connection_pool</span><span class=o>.</span><span class=n>put</span><span class=p>(</span><span class=n>connection</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;active_connections&#39;</span><span class=p>]</span> <span class=o>-=</span> <span class=mi>1</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=2-è¯·æ±‚é™æµ>2. è¯·æ±‚é™æµ</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>collections</span> <span class=kn>import</span> <span class=n>defaultdict</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>RateLimitedServer</span><span class=p>(</span><span class=n>McpServer</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span><span class=s2>&#34;rate-limited-server&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>request_counts</span> <span class=o>=</span> <span class=n>defaultdict</span><span class=p>(</span><span class=nb>list</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>rate_limit</span> <span class=o>=</span> <span class=mi>100</span>  <span class=c1># æ¯åˆ†é’Ÿ100ä¸ªè¯·æ±‚</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>check_rate_limit</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>client_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;æ£€æŸ¥è¯·æ±‚é¢‘ç‡é™åˆ¶&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>now</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>minute_ago</span> <span class=o>=</span> <span class=n>now</span> <span class=o>-</span> <span class=mi>60</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># æ¸…ç†è¿‡æœŸè®°å½•</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>request_counts</span><span class=p>[</span><span class=n>client_id</span><span class=p>]</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=n>timestamp</span> <span class=k>for</span> <span class=n>timestamp</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>request_counts</span><span class=p>[</span><span class=n>client_id</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>timestamp</span> <span class=o>&gt;</span> <span class=n>minute_ago</span>
</span></span><span class=line><span class=cl>        <span class=p>]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># æ£€æŸ¥æ˜¯å¦è¶…è¿‡é™åˆ¶</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>request_counts</span><span class=p>[</span><span class=n>client_id</span><span class=p>])</span> <span class=o>&gt;=</span> <span class=bp>self</span><span class=o>.</span><span class=n>rate_limit</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=n>McpError</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>code</span><span class=o>=</span><span class=n>ErrorCode</span><span class=o>.</span><span class=n>RATE_LIMITED</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>message</span><span class=o>=</span><span class=s2>&#34;è¯·æ±‚é¢‘ç‡è¿‡é«˜ï¼Œè¯·ç¨åé‡è¯•&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>request_counts</span><span class=p>[</span><span class=n>client_id</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>now</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=ç›‘æ§ä½“ç³»>ç›‘æ§ä½“ç³»</h3><h4 id=1-æŒ‡æ ‡æ”¶é›†>1. æŒ‡æ ‡æ”¶é›†</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>dataclasses</span> <span class=kn>import</span> <span class=n>dataclass</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Dict</span><span class=p>,</span> <span class=n>Any</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@dataclass</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>RequestMetrics</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>method</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>duration</span><span class=p>:</span> <span class=nb>float</span>
</span></span><span class=line><span class=cl>    <span class=n>success</span><span class=p>:</span> <span class=nb>bool</span>
</span></span><span class=line><span class=cl>    <span class=n>client_id</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>timestamp</span><span class=p>:</span> <span class=nb>float</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>MonitoredMcpServer</span><span class=p>(</span><span class=n>McpServer</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span><span class=s2>&#34;monitored-server&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>metrics</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>RequestMetrics</span><span class=p>]</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>health_status</span> <span class=o>=</span> <span class=s2>&#34;healthy&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>handle_request</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>method</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>params</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;å¤„ç†è¯·æ±‚å¹¶æ”¶é›†æŒ‡æ ‡&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>start_time</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>client_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_current_client_id</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>success</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>result</span> <span class=o>=</span> <span class=k>await</span> <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=n>handle_request</span><span class=p>(</span><span class=n>method</span><span class=p>,</span> <span class=n>params</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>success</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span>
</span></span><span class=line><span class=cl>        <span class=k>finally</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>duration</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>start_time</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>metrics</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>RequestMetrics</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>method</span><span class=o>=</span><span class=n>method</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>duration</span><span class=o>=</span><span class=n>duration</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>success</span><span class=o>=</span><span class=n>success</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>client_id</span><span class=o>=</span><span class=n>client_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>timestamp</span><span class=o>=</span><span class=n>start_time</span>
</span></span><span class=line><span class=cl>            <span class=p>))</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>get_health_status</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;å¥åº·æ£€æŸ¥ç«¯ç‚¹&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>recent_errors</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=n>m</span> <span class=k>for</span> <span class=n>m</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>metrics</span><span class=p>[</span><span class=o>-</span><span class=mi>100</span><span class=p>:]</span>  <span class=c1># æœ€è¿‘100ä¸ªè¯·æ±‚</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=ow>not</span> <span class=n>m</span><span class=o>.</span><span class=n>success</span>
</span></span><span class=line><span class=cl>        <span class=p>]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>error_rate</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>recent_errors</span><span class=p>)</span> <span class=o>/</span> <span class=nb>min</span><span class=p>(</span><span class=mi>100</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>metrics</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>error_rate</span> <span class=o>&gt;</span> <span class=mf>0.1</span><span class=p>:</span>  <span class=c1># é”™è¯¯ç‡è¶…è¿‡10%</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>health_status</span> <span class=o>=</span> <span class=s2>&#34;unhealthy&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>health_status</span> <span class=o>=</span> <span class=s2>&#34;healthy&#34;</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;status&#34;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>health_status</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;error_rate&#34;</span><span class=p>:</span> <span class=n>error_rate</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;total_requests&#34;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>metrics</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;uptime&#34;</span><span class=p>:</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=bp>self</span><span class=o>.</span><span class=n>start_time</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=-å­¦ä¹ èµ„æºä¸ç¤¾åŒº>ğŸ“š å­¦ä¹ èµ„æºä¸ç¤¾åŒº</h2><h3 id=å®˜æ–¹èµ„æº>å®˜æ–¹èµ„æº</h3><ul><li><strong><a href=https://modelcontextprotocol.io target=_blank rel="noopener noreffer">MCPå®˜æ–¹æ–‡æ¡£</a></strong> - å®Œæ•´çš„åè®®è§„èŒƒå’Œå¼€å‘æŒ‡å—</li><li><strong><a href=https://www.anthropic.com/news/model-context-protocol target=_blank rel="noopener noreffer">Anthropicå®˜æ–¹åšå®¢</a></strong> - MCPå‘å¸ƒå…¬å‘Šå’ŒæŠ€æœ¯è§£è¯»</li><li><strong><a href=https://github.com/modelcontextprotocol target=_blank rel="noopener noreffer">GitHubä»“åº“</a></strong> - å®˜æ–¹SDKå’Œç¤ºä¾‹ä»£ç </li><li><strong><a href=https://github.com/modelcontextprotocol/inspector target=_blank rel="noopener noreffer">MCP Inspector</a></strong> - è°ƒè¯•å’Œæµ‹è¯•å·¥å…·</li></ul><h3 id=å¼€å‘å·¥å…·>å¼€å‘å·¥å…·</h3><ul><li><strong>Python SDK</strong>: <code>pip install mcp</code></li><li><strong>TypeScript SDK</strong>: <code>npm install @modelcontextprotocol/sdk</code></li><li><strong>è°ƒè¯•å·¥å…·</strong>: <code>npm install -g @modelcontextprotocol/inspector</code></li></ul><h3 id=ç¤¾åŒºé¡¹ç›®>ç¤¾åŒºé¡¹ç›®</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-markdown data-lang=markdown><span class=line><span class=cl>ğŸ”§ å®ç”¨å·¥å…·ï¼š
</span></span><span class=line><span class=cl><span class=k>-</span> MCPæœåŠ¡å™¨æ¨¡æ¿åº“
</span></span><span class=line><span class=cl><span class=k>-</span> å¯è§†åŒ–é…ç½®å·¥å…·
</span></span><span class=line><span class=cl><span class=k>-</span> æ€§èƒ½ç›‘æ§ä»ªè¡¨æ¿
</span></span><span class=line><span class=cl><span class=k>-</span> è‡ªåŠ¨åŒ–æµ‹è¯•æ¡†æ¶
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ğŸŒŸ å¼€æºæœåŠ¡å™¨ï¼š
</span></span><span class=line><span class=cl><span class=k>-</span> æ–‡ä»¶ç³»ç»ŸæœåŠ¡å™¨
</span></span><span class=line><span class=cl><span class=k>-</span> æ•°æ®åº“è¿æ¥å™¨
</span></span><span class=line><span class=cl><span class=k>-</span> GitHubé›†æˆ
</span></span><span class=line><span class=cl><span class=k>-</span> Slacké›†æˆ
</span></span><span class=line><span class=cl><span class=k>-</span> Google Driveè¿æ¥å™¨
</span></span></code></pre></td></tr></table></div></div><hr><h2 id=-æ€»ç»“>ğŸ“ æ€»ç»“</h2><p>MCPï¼ˆModel Context Protocolï¼‰ä½œä¸ºAIé¢†åŸŸçš„é‡è¦æŠ€æœ¯åˆ›æ–°ï¼Œä¸ºæ„å»ºæ™ºèƒ½ã€äº’è”çš„AIç³»ç»Ÿæä¾›äº†æ ‡å‡†åŒ–çš„è§£å†³æ–¹æ¡ˆã€‚é€šè¿‡æœ¬æ–‡çš„æ·±å…¥è§£æï¼Œæˆ‘ä»¬äº†è§£äº†ï¼š</p><h3 id=-æ ¸å¿ƒä»·å€¼>ğŸ¯ æ ¸å¿ƒä»·å€¼</h3><ol><li><strong>æ ‡å‡†åŒ–</strong>: ç»Ÿä¸€AIæ¨¡å‹ä¸æ•°æ®æºçš„è¿æ¥æ–¹å¼</li><li><strong>å¯æ‰©å±•</strong>: æ”¯æŒçµæ´»çš„æœåŠ¡å™¨ç»„åˆå’Œæ‰©å±•</li><li><strong>å®‰å…¨æ€§</strong>: å†…ç½®æƒé™æ§åˆ¶å’Œæ•°æ®ä¿æŠ¤æœºåˆ¶</li><li><strong>å¼€æ”¾æ€§</strong>: å¼€æºåè®®ï¼Œä¿ƒè¿›ç”Ÿæ€å‘å±•</li></ol><h3 id=-æŠ€æœ¯ç‰¹ç‚¹>ğŸ—ï¸ æŠ€æœ¯ç‰¹ç‚¹</h3><ul><li>ç®€æ´çš„å®¢æˆ·ç«¯-æœåŠ¡å™¨æ¶æ„</li><li>å¼ºå¤§çš„Resourcesã€Toolsã€Promptsä¸‰å¤§æ ¸å¿ƒæ¦‚å¿µ</li><li>çµæ´»çš„ä¼ è¾“åè®®æ”¯æŒ</li><li>å®Œå–„çš„é”™è¯¯å¤„ç†æœºåˆ¶</li></ul><h3 id=-å‘å±•å‰æ™¯>ğŸš€ å‘å±•å‰æ™¯</h3><p>MCPå°†æˆä¸ºAIåº”ç”¨å¼€å‘çš„é‡è¦åŸºç¡€è®¾æ–½ï¼Œæ¨åŠ¨AIå·¥å…·çš„æ ‡å‡†åŒ–å’Œç”Ÿæ€åŒ–å‘å±•ã€‚éšç€æ›´å¤šå·¥å…·å’Œå¹³å°çš„æ”¯æŒï¼ŒMCPç”Ÿæ€ç³»ç»Ÿå°†è¶Šæ¥è¶Šä¸°å¯Œï¼Œä¸ºå¼€å‘è€…å’Œä¼ä¸šæä¾›æ›´å¼ºå¤§çš„AIåº”ç”¨æ„å»ºèƒ½åŠ›ã€‚</p><p><strong>å¼€å§‹ä½ çš„MCPä¹‹æ—…</strong>ï¼šä»ç®€å•çš„æ–‡ä»¶ç³»ç»ŸæœåŠ¡å™¨å¼€å§‹ï¼Œé€æ­¥æ¢ç´¢æ›´å¤æ‚çš„åº”ç”¨åœºæ™¯ï¼ŒåŠ å…¥è¿™ä¸ªæ¿€åŠ¨äººå¿ƒçš„æŠ€æœ¯ç”Ÿæ€ï¼</p><hr><p><em>å‚è€ƒèµ„æ–™ï¼š</em></p><ul><li><em><a href=https://www.anthropic.com/news/model-context-protocol target=_blank rel="noopener noreffer">Anthropicå®˜æ–¹MCPä»‹ç»</a></em></li><li><em><a href=https://modelcontextprotocol.io target=_blank rel="noopener noreffer">MCPå®˜æ–¹æ–‡æ¡£</a></em></li><li><em><a href=https://github.com/modelcontextprotocol target=_blank rel="noopener noreffer">MCP GitHubä»“åº“</a></em></li></ul><blockquote><p>ğŸ’¡ <strong>æç¤º</strong>ï¼šMCPæŠ€æœ¯è¿˜åœ¨å¿«é€Ÿå‘å±•ä¸­ï¼Œå»ºè®®å…³æ³¨å®˜æ–¹æ›´æ–°ï¼ŒåŠæ—¶å­¦ä¹ æ–°ç‰¹æ€§å’Œæœ€ä½³å®è·µï¼</p></blockquote></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>æ›´æ–°äº 2025-06-15</span></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/mcp/index.md target=_blank>é˜…è¯»åŸå§‹æ–‡æ¡£</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="åˆ†äº«åˆ° Twitter" data-sharer=twitter data-url=https://sincerecsl.github.io/mcp/ data-title="æ·±å…¥ç†è§£MCPï¼šModel Context Protocolæ¶æ„è§£æä¸å¼€å‘å®è·µ" data-via=SincereCSL95 data-hashtags=MCP,AI,LLM,Claude,åè®®,æ¶æ„><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="åˆ†äº«åˆ° Facebook" data-sharer=facebook data-url=https://sincerecsl.github.io/mcp/ data-hashtag=MCP><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="åˆ†äº«åˆ° WhatsApp" data-sharer=whatsapp data-url=https://sincerecsl.github.io/mcp/ data-title="æ·±å…¥ç†è§£MCPï¼šModel Context Protocolæ¶æ„è§£æä¸å¼€å‘å®è·µ" data-web><i class="fab fa-whatsapp fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="åˆ†äº«åˆ° Hacker News" data-sharer=hackernews data-url=https://sincerecsl.github.io/mcp/ data-title="æ·±å…¥ç†è§£MCPï¼šModel Context Protocolæ¶æ„è§£æä¸å¼€å‘å®è·µ"><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="åˆ†äº«åˆ° Reddit" data-sharer=reddit data-url=https://sincerecsl.github.io/mcp/><i class="fab fa-reddit fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="åˆ†äº«åˆ° Line" data-sharer=line data-url=https://sincerecsl.github.io/mcp/ data-title="æ·±å…¥ç†è§£MCPï¼šModel Context Protocolæ¶æ„è§£æä¸å¼€å‘å®è·µ"><i data-svg-src=/lib/simple-icons/icons/line.min.svg aria-hidden=true></i></a><a href=javascript:void(0); title="åˆ†äº«åˆ° å¾®åš" data-sharer=weibo data-url=https://sincerecsl.github.io/mcp/ data-title="æ·±å…¥ç†è§£MCPï¼šModel Context Protocolæ¶æ„è§£æä¸å¼€å‘å®è·µ" data-ralateuid=u/5535058729><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="åˆ†äº«åˆ° Blogger" data-sharer=blogger data-url=https://sincerecsl.github.io/mcp/ data-title="æ·±å…¥ç†è§£MCPï¼šModel Context Protocolæ¶æ„è§£æä¸å¼€å‘å®è·µ" data-description="å…¨é¢è§£æMCPï¼ˆModel Context Protocolï¼‰ï¼šä»æ¶æ„åŸç†åˆ°å¼€å‘å®è·µï¼Œæ¢ç´¢AIå·¥å…·çš„æ ‡å‡†åŒ–è¿æ¥åè®®"><i class="fab fa-blogger fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="åˆ†äº«åˆ° Evernote" data-sharer=evernote data-url=https://sincerecsl.github.io/mcp/ data-title="æ·±å…¥ç†è§£MCPï¼šModel Context Protocolæ¶æ„è§£æä¸å¼€å‘å®è·µ"><i class="fab fa-evernote fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="åˆ†äº«åˆ° Skype" data-sharer=skype data-url=https://sincerecsl.github.io/mcp/ data-title="æ·±å…¥ç†è§£MCPï¼šModel Context Protocolæ¶æ„è§£æä¸å¼€å‘å®è·µ"><i class="fab fa-skype fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/mcp/>MCP</a>,&nbsp;<a href=/tags/ai/>AI</a>,&nbsp;<a href=/tags/llm/>LLM</a>,&nbsp;<a href=/tags/claude/>Claude</a>,&nbsp;<a href=/tags/%E5%8D%8F%E8%AE%AE/>åè®®</a>,&nbsp;<a href=/tags/%E6%9E%B6%E6%9E%84/>æ¶æ„</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>è¿”å›</a></span>&nbsp;|&nbsp;<span><a href=/>ä¸»é¡µ</a></span></section></div><div class=post-nav><a href=/ai/ class=next rel=next title=æˆ‘çš„AIå·¥å…·ä½¿ç”¨ç¬”è®°>æˆ‘çš„AIå·¥å…·ä½¿ç”¨ç¬”è®°<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div><div id=comments><div id=valine class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://valine.js.org/>Valine</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>SincereCSL</div><div class=footer-line>ç”± <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.147.9">Hugo</a> å¼ºåŠ›é©±åŠ¨ | ä¸»é¢˜ - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2022 - 2025</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank></a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=å›åˆ°é¡¶éƒ¨><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title=æŸ¥çœ‹è¯„è®º><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=/lib/valine/valine.min.css><link rel=stylesheet href=/lib/katex/katex.min.css><link rel=stylesheet href=/lib/cookieconsent/cookieconsent.min.css><script type=text/javascript src=/lib/valine/Valine.min.js></script><script type=text/javascript src=/lib/autocomplete/autocomplete.min.js></script><script type=text/javascript src=/lib/lunr/lunr.min.js></script><script type=text/javascript src=/lib/lunr/lunr.stemmer.support.min.js></script><script type=text/javascript src=/lib/lunr/lunr.zh.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/sharer/sharer.min.js></script><script type=text/javascript src=/lib/katex/katex.min.js></script><script type=text/javascript src=/lib/katex/contrib/auto-render.min.js></script><script type=text/javascript src=/lib/katex/contrib/copy-tex.min.js></script><script type=text/javascript src=/lib/katex/contrib/mhchem.min.js></script><script type=text/javascript src=/lib/cookieconsent/cookieconsent.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"å¤åˆ¶åˆ°å‰ªè´´æ¿",maxShownLines:10},comment:{valine:{appId:"nM17GGWo6Zp1bj316CxfmLIo-MdYXbMMI",appKey:"z9DvzP8ZaKB4Ci6y2ivyepGR",avatar:"mp",el:"#valine",emojiCDN:"https://cdn.jsdelivr.net/npm/emoji-datasource-google@14.0.0/img/google/64/",emojiMaps:{100:"1f4af.png",alien:"1f47d.png",anger:"1f4a2.png",angry:"1f620.png",anguished:"1f627.png",astonished:"1f632.png",black_heart:"1f5a4.png",blue_heart:"1f499.png",blush:"1f60a.png",bomb:"1f4a3.png",boom:"1f4a5.png",broken_heart:"1f494.png",brown_heart:"1f90e.png",clown_face:"1f921.png",cold_face:"1f976.png",cold_sweat:"1f630.png",confounded:"1f616.png",confused:"1f615.png",cry:"1f622.png",crying_cat_face:"1f63f.png",cupid:"1f498.png",dash:"1f4a8.png",disappointed:"1f61e.png",disappointed_relieved:"1f625.png",dizzy:"1f4ab.png",dizzy_face:"1f635.png",drooling_face:"1f924.png",exploding_head:"1f92f.png",expressionless:"1f611.png",face_vomiting:"1f92e.png",face_with_cowboy_hat:"1f920.png",face_with_hand_over_mouth:"1f92d.png",face_with_head_bandage:"1f915.png",face_with_monocle:"1f9d0.png",face_with_raised_eyebrow:"1f928.png",face_with_rolling_eyes:"1f644.png",face_with_symbols_on_mouth:"1f92c.png",face_with_thermometer:"1f912.png",fearful:"1f628.png",flushed:"1f633.png",frowning:"1f626.png",ghost:"1f47b.png",gift_heart:"1f49d.png",green_heart:"1f49a.png",grimacing:"1f62c.png",grin:"1f601.png",grinning:"1f600.png",hankey:"1f4a9.png",hear_no_evil:"1f649.png",heart:"2764-fe0f.png",heart_decoration:"1f49f.png",heart_eyes:"1f60d.png",heart_eyes_cat:"1f63b.png",heartbeat:"1f493.png",heartpulse:"1f497.png",heavy_heart_exclamation_mark_ornament:"2763-fe0f.png",hole:"1f573-fe0f.png",hot_face:"1f975.png",hugging_face:"1f917.png",hushed:"1f62f.png",imp:"1f47f.png",innocent:"1f607.png",japanese_goblin:"1f47a.png",japanese_ogre:"1f479.png",joy:"1f602.png",joy_cat:"1f639.png",kiss:"1f48b.png",kissing:"1f617.png",kissing_cat:"1f63d.png",kissing_closed_eyes:"1f61a.png",kissing_heart:"1f618.png",kissing_smiling_eyes:"1f619.png",laughing:"1f606.png",left_speech_bubble:"1f5e8-fe0f.png",love_letter:"1f48c.png",lying_face:"1f925.png",mask:"1f637.png",money_mouth_face:"1f911.png",nauseated_face:"1f922.png",nerd_face:"1f913.png",neutral_face:"1f610.png",no_mouth:"1f636.png",open_mouth:"1f62e.png",orange_heart:"1f9e1.png",partying_face:"1f973.png",pensive:"1f614.png",persevere:"1f623.png",pleading_face:"1f97a.png",pouting_cat:"1f63e.png",purple_heart:"1f49c.png",rage:"1f621.png",relaxed:"263a-fe0f.png",relieved:"1f60c.png",revolving_hearts:"1f49e.png",right_anger_bubble:"1f5ef-fe0f.png",robot_face:"1f916.png",rolling_on_the_floor_laughing:"1f923.png",scream:"1f631.png",scream_cat:"1f640.png",see_no_evil:"1f648.png",shushing_face:"1f92b.png",skull:"1f480.png",skull_and_crossbones:"2620-fe0f.png",sleeping:"1f634.png",sleepy:"1f62a.png",slightly_frowning_face:"1f641.png",slightly_smiling_face:"1f642.png",smile:"1f604.png",smile_cat:"1f638.png",smiley:"1f603.png",smiley_cat:"1f63a.png",smiling_face_with_3_hearts:"1f970.png",smiling_imp:"1f608.png",smirk:"1f60f.png",smirk_cat:"1f63c.png",sneezing_face:"1f927.png",sob:"1f62d.png",space_invader:"1f47e.png",sparkling_heart:"1f496.png",speak_no_evil:"1f64a.png",speech_balloon:"1f4ac.png","star-struck":"1f929.png",stuck_out_tongue:"1f61b.png",stuck_out_tongue_closed_eyes:"1f61d.png",stuck_out_tongue_winking_eye:"1f61c.png",sunglasses:"1f60e.png",sweat:"1f613.png",sweat_drops:"1f4a6.png",sweat_smile:"1f605.png",thinking_face:"1f914.png",thought_balloon:"1f4ad.png",tired_face:"1f62b.png",triumph:"1f624.png",two_hearts:"1f495.png",unamused:"1f612.png",upside_down_face:"1f643.png",weary:"1f629.png",white_frowning_face:"2639-fe0f.png",white_heart:"1f90d.png",wink:"1f609.png",woozy_face:"1f974.png",worried:"1f61f.png",yawning_face:"1f971.png",yellow_heart:"1f49b.png",yum:"1f60b.png",zany_face:"1f92a.png",zipper_mouth_face:"1f910.png",zzz:"1f4a4.png"},enableQQ:!1,highlight:!0,lang:"zh-CN",pageSize:10,placeholder:"è¯´ç‚¹ä»€ä¹ˆå§...",recordIP:!0,serverURLs:"https://nm17ggwo.api.lncldglobal.com",visitor:!0}},cookieconsent:{content:{dismiss:"åŒæ„",link:"äº†è§£æ›´å¤š",message:"æœ¬ç½‘ç«™ä½¿ç”¨ Cookies æ¥æ”¹å–„æ‚¨çš„æµè§ˆä½“éªŒ."},enable:!0,palette:{button:{background:"#f0f0f0"},popup:{background:"#1aa3ff"}},theme:"edgeless"},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{highlightTag:"em",lunrIndexURL:"/index.json",lunrLanguageCode:"zh",lunrSegmentitURL:"/lib/lunr/lunr.segmentit.js",maxResultLength:10,noResultsFound:"æ²¡æœ‰æ‰¾åˆ°ç»“æœ",snippetLength:50,type:"lunr"}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>