<!doctype html><html lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>深入理解MCP：Model Context Protocol架构解析与开发实践 - SincereCSL's Blog</title><meta name=Description content="全面解析MCP（Model Context Protocol）：从架构原理到开发实践，探索AI工具的标准化连接协议"><meta property="og:url" content="https://sincerecsl.github.io/mcp/"><meta property="og:site_name" content="SincereCSL's Blog"><meta property="og:title" content="深入理解MCP：Model Context Protocol架构解析与开发实践"><meta property="og:description" content="全面解析MCP（Model Context Protocol）：从架构原理到开发实践，探索AI工具的标准化连接协议"><meta property="og:locale" content="zh_CN"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-06-15T10:30:00+08:00"><meta property="article:modified_time" content="2025-06-15T10:30:00+08:00"><meta property="article:tag" content="MCP"><meta property="article:tag" content="AI"><meta property="article:tag" content="LLM"><meta property="article:tag" content="Claude"><meta property="article:tag" content="协议"><meta property="article:tag" content="架构"><meta name=twitter:card content="summary"><meta name=twitter:title content="深入理解MCP：Model Context Protocol架构解析与开发实践"><meta name=twitter:description content="全面解析MCP（Model Context Protocol）：从架构原理到开发实践，探索AI工具的标准化连接协议"><meta name=twitter:site content="@SincereCSL95"><meta name=application-name content="LoveIt"><meta name=apple-mobile-web-app-title content="LoveIt"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://sincerecsl.github.io/mcp/><link rel=next href=https://sincerecsl.github.io/ai/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=/lib/fontawesome-free/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/fontawesome-free/all.min.css></noscript><link rel=preload href=/lib/animate/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/animate/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"深入理解MCP：Model Context Protocol架构解析与开发实践","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/sincerecsl.github.io\/mcp\/"},"genre":"posts","keywords":"MCP, AI, LLM, Claude, 协议, 架构","wordcount":18885,"url":"https:\/\/sincerecsl.github.io\/mcp\/","datePublished":"2025-06-15T10:30:00+08:00","dateModified":"2025-06-15T10:30:00+08:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"SincereCSL"},"description":"全面解析MCP（Model Context Protocol）：从架构原理到开发实践，探索AI工具的标准化连接协议"}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="SincereCSL's Blog"><span class=header-title-pre><i class='far fa-grin-stars fa-fw'></i></span>SincereCSL</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/>主页 </a><a class=menu-item href=/posts/>所有文章 </a><a class=menu-item href=/links/>Links </a><a class=menu-item href=/categories/>分类 </a><a class=menu-item href=/about/>关于 </a><a class=menu-item href=https://github.com/SincereCSL rel="noopener noreffer" target=_blank><i class='fab fa-github fa-fw'></i> </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder=搜索文章标题或内容... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fas fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i>
</span></span><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="SincereCSL's Blog"><span class=header-title-pre><i class='far fa-grin-stars fa-fw'></i></span>SincereCSL</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fas fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></div><a class=menu-item href=/ title>主页</a><a class=menu-item href=/posts/ title>所有文章</a><a class=menu-item href=/links/ title>Links</a><a class=menu-item href=/categories/ title>分类</a><a class=menu-item href=/about/ title>关于</a><a class=menu-item href=https://github.com/SincereCSL title rel="noopener noreffer" target=_blank><i class='fab fa-github fa-fw'></i></a><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">深入理解MCP：Model Context Protocol架构解析与开发实践</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>SincereCSL</a></span>&nbsp;<span class=post-category>收录于 <a href=/categories/ai%E5%B7%A5%E5%85%B7/><i class="far fa-folder fa-fw" aria-hidden=true></i>AI工具</a>&nbsp;<a href=/categories/%E6%8A%80%E6%9C%AF%E6%B7%B1%E5%BA%A6/><i class="far fa-folder fa-fw" aria-hidden=true></i>技术深度</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2025-06-15>2025-06-15</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;约 18885 字&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;预计阅读 38 分钟&nbsp;<span id=/mcp/ class=leancloud_visitors data-flag-title="深入理解MCP：Model Context Protocol架构解析与开发实践">
<i class="far fa-eye fa-fw" aria-hidden=true></i>&nbsp;<span class=leancloud-visitors-count></span>&nbsp;次阅读
</span>&nbsp;</div></div><div class="details toc" id=toc-static data-kept=true><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#-什么是mcp>🎯 什么是MCP？</a><ul><li><a href=#定义与概念>定义与概念</a></li><li><a href=#核心价值>核心价值</a></li></ul></li><li><a href=#-mcp架构深度解析>🏗️ MCP架构深度解析</a><ul><li><a href=#整体架构>整体架构</a></li><li><a href=#核心组件详解>核心组件详解</a></li><li><a href=#通信机制>通信机制</a></li></ul></li><li><a href=#-mcp核心概念详解>💻 MCP核心概念详解</a><ul><li><a href=#协议生命周期管理>协议生命周期管理</a></li><li><a href=#1-resources资源深度解析>1. Resources（资源）深度解析</a></li><li><a href=#2-tools工具高级特性>2. Tools（工具）高级特性</a></li><li><a href=#3-prompts提示模板>3. Prompts（提示模板）</a></li><li><a href=#数据加密与脱敏>数据加密与脱敏</a></li></ul></li><li><a href=#-mcp协议扩展>🔄 MCP协议扩展</a><ul><li><a href=#自定义协议扩展>自定义协议扩展</a></li><li><a href=#事件驱动架构>事件驱动架构</a></li><li><a href=#云原生部署方案>云原生部署方案</a></li><li><a href=#高级调试与诊断工具>高级调试与诊断工具</a></li><li><a href=#智能错误恢复机制>智能错误恢复机制</a></li><li><a href=#多租户支持>多租户支持</a></li></ul></li><li><a href=#-mcp开发实践>🛠️ MCP开发实践</a><ul><li><a href=#开发环境搭建>开发环境搭建</a></li><li><a href=#开发最佳实践>开发最佳实践</a></li><li><a href=#调试与测试>调试与测试</a></li></ul></li><li><a href=#-实际应用案例>🔧 实际应用案例</a><ul><li><a href=#案例一代码库分析服务器>案例一：代码库分析服务器</a></li><li><a href=#案例二数据库管理服务器>案例二：数据库管理服务器</a></li><li><a href=#案例三文档知识库服务器>案例三：文档知识库服务器</a></li></ul></li><li><a href=#-企业级部署方案>🏢 企业级部署方案</a><ul><li><a href=#部署架构>部署架构</a></li><li><a href=#安全最佳实践>安全最佳实践</a></li></ul></li><li><a href=#-未来发展趋势>🚀 未来发展趋势</a><ul><li><a href=#技术演进方向>技术演进方向</a></li></ul></li><li><a href=#-性能优化与监控系统>📊 性能优化与监控系统</a><ul><li><a href=#高级性能监控>高级性能监控</a></li><li><a href=#缓存优化策略>缓存优化策略</a></li><li><a href=#性能调优>性能调优</a></li><li><a href=#监控体系>监控体系</a></li></ul></li><li><a href=#-学习资源与社区>📚 学习资源与社区</a><ul><li><a href=#官方资源>官方资源</a></li><li><a href=#开发工具>开发工具</a></li><li><a href=#社区项目>社区项目</a></li></ul></li><li><a href=#-总结>📝 总结</a><ul><li><a href=#-核心价值>🎯 核心价值</a></li><li><a href=#-技术特点>🏗️ 技术特点</a></li><li><a href=#-发展前景>🚀 发展前景</a></li></ul></li></ul></nav></div></div><div class=content id=content><blockquote><p>📝 <strong>前言</strong>：MCP（Model Context Protocol）是由Anthropic发布的开放标准，旨在标准化AI助手与数据源之间的连接方式。本文将深入解析MCP的架构原理、开发模式和实际应用，帮助开发者理解和使用这一革命性的协议。</p></blockquote><h2 id=-什么是mcp>🎯 什么是MCP？</h2><h3 id=定义与概念>定义与概念</h3><p><strong>Model Context Protocol (MCP)</strong> 是一个开放的协议标准，它标准化了应用程序向大语言模型（LLM）提供上下文的方式。</p><h4 id=形象比喻>形象比喻</h4><p>如果把MCP比作USB-C接口：</p><ul><li><strong>USB-C</strong>：为设备连接各种外设提供标准化接口</li><li><strong>MCP</strong>：为AI模型连接不同数据源和工具提供标准化协议</li></ul><h3 id=核心价值>核心价值</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-markdown data-lang=markdown><span class=line><span class=cl>🎯 MCP解决的核心问题：
</span></span><span class=line><span class=cl><span class=k>1.</span> 数据孤岛：AI模型被困在信息孤岛中
</span></span><span class=line><span class=cl><span class=k>2.</span> 集成复杂：每个数据源需要定制化实现
</span></span><span class=line><span class=cl><span class=k>3.</span> 扩展困难：连接系统难以规模化
</span></span><span class=line><span class=cl><span class=k>4.</span> 维护成本：碎片化集成难以维护
</span></span></code></pre></td></tr></table></div></div><h2 id=-mcp架构深度解析>🏗️ MCP架构深度解析</h2><h3 id=整体架构>整体架构</h3><p>MCP采用<strong>客户端-服务器</strong>架构，支持一个宿主应用连接多个服务器：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>graph TB
</span></span><span class=line><span class=cl>    Host[MCP Host&lt;br/&gt;宿主应用] --&gt; Client1[MCP Client 1]
</span></span><span class=line><span class=cl>    Host --&gt; Client2[MCP Client 2]
</span></span><span class=line><span class=cl>    Host --&gt; Client3[MCP Client 3]
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    Client1 --&gt; Server1[MCP Server 1&lt;br/&gt;文件系统]
</span></span><span class=line><span class=cl>    Client2 --&gt; Server2[MCP Server 2&lt;br/&gt;数据库]
</span></span><span class=line><span class=cl>    Client3 --&gt; Server3[MCP Server 3&lt;br/&gt;API服务]
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    Server1 --&gt; Data1[本地文件]
</span></span><span class=line><span class=cl>    Server2 --&gt; Data2[PostgreSQL]
</span></span><span class=line><span class=cl>    Server3 --&gt; Data3[外部API]
</span></span></code></pre></td></tr></table></div></div><h3 id=核心组件详解>核心组件详解</h3><h4 id=1-mcp-host宿主>1. MCP Host（宿主）</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-markdown data-lang=markdown><span class=line><span class=cl>🏠 定义：运行AI模型的应用程序
</span></span><span class=line><span class=cl>📋 功能：
</span></span><span class=line><span class=cl><span class=k>-</span> 管理与多个MCP服务器的连接
</span></span><span class=line><span class=cl><span class=k>-</span> 协调AI模型与外部数据的交互
</span></span><span class=line><span class=cl><span class=k>-</span> 处理用户请求和响应
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>💡 典型示例：
</span></span><span class=line><span class=cl><span class=k>-</span> Claude Desktop
</span></span><span class=line><span class=cl><span class=k>-</span> VS Code插件
</span></span><span class=line><span class=cl><span class=k>-</span> 自定义AI应用
</span></span></code></pre></td></tr></table></div></div><h4 id=2-mcp-client客户端>2. MCP Client（客户端）</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-markdown data-lang=markdown><span class=line><span class=cl>🔌 定义：协议客户端，维护与服务器的1:1连接
</span></span><span class=line><span class=cl>📋 功能：
</span></span><span class=line><span class=cl><span class=k>-</span> 处理协议通信
</span></span><span class=line><span class=cl><span class=k>-</span> 管理连接状态
</span></span><span class=line><span class=cl><span class=k>-</span> 数据序列化/反序列化
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>🛠️ 实现方式：
</span></span><span class=line><span class=cl><span class=k>-</span> 通常内嵌在Host应用中
</span></span><span class=line><span class=cl><span class=k>-</span> 使用官方SDK开发
</span></span><span class=line><span class=cl><span class=k>-</span> 支持多种传输协议
</span></span></code></pre></td></tr></table></div></div><h4 id=3-mcp-server服务器>3. MCP Server（服务器）</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-markdown data-lang=markdown><span class=line><span class=cl>⚙️ 定义：轻量级程序，通过标准协议暴露特定能力
</span></span><span class=line><span class=cl>📋 功能：
</span></span><span class=line><span class=cl><span class=k>-</span> 提供Resources（资源）
</span></span><span class=line><span class=cl><span class=k>-</span> 暴露Tools（工具）
</span></span><span class=line><span class=cl><span class=k>-</span> 实现Prompts（提示模板）
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>🌟 特点：
</span></span><span class=line><span class=cl><span class=k>-</span> 单一职责原则
</span></span><span class=line><span class=cl><span class=k>-</span> 标准化接口
</span></span><span class=line><span class=cl><span class=k>-</span> 易于部署和维护
</span></span></code></pre></td></tr></table></div></div><h3 id=通信机制>通信机制</h3><h4 id=传输层transport>传输层（Transport）</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;jsonrpc&#34;</span><span class=p>:</span> <span class=s2>&#34;2.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;method&#34;</span><span class=p>:</span> <span class=s2>&#34;resources/list&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;params&#34;</span><span class=p>:</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>MCP支持多种传输方式：</p><h4 id=标准输入输出stdio>标准输入/输出（stdio）</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 启动stdio传输的MCP服务器</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>sys</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>asyncio</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>mcp.server.stdio</span> <span class=kn>import</span> <span class=n>stdio_server</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>main</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>with</span> <span class=n>stdio_server</span><span class=p>()</span> <span class=k>as</span> <span class=p>(</span><span class=n>read_stream</span><span class=p>,</span> <span class=n>write_stream</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=n>run_server</span><span class=p>(</span><span class=n>read_stream</span><span class=p>,</span> <span class=n>write_stream</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>asyncio</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>main</span><span class=p>())</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=http传输>HTTP传输</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># HTTP传输配置</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>mcp.server.fastapi</span> <span class=kn>import</span> <span class=n>create_mcp_app</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>fastapi</span> <span class=kn>import</span> <span class=n>FastAPI</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>app</span> <span class=o>=</span> <span class=n>FastAPI</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>mcp_app</span> <span class=o>=</span> <span class=n>create_mcp_app</span><span class=p>(</span><span class=n>MyMcpServer</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=n>app</span><span class=o>.</span><span class=n>mount</span><span class=p>(</span><span class=s2>&#34;/mcp&#34;</span><span class=p>,</span> <span class=n>mcp_app</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 启动HTTP服务器</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=kn>import</span> <span class=nn>uvicorn</span>
</span></span><span class=line><span class=cl>    <span class=n>uvicorn</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>app</span><span class=p>,</span> <span class=n>host</span><span class=o>=</span><span class=s2>&#34;0.0.0.0&#34;</span><span class=p>,</span> <span class=n>port</span><span class=o>=</span><span class=mi>8000</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=websocket传输>WebSocket传输</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># WebSocket实时通信</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>websockets</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>mcp.server.websocket</span> <span class=kn>import</span> <span class=n>websocket_server</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>handle_websocket</span><span class=p>(</span><span class=n>websocket</span><span class=p>,</span> <span class=n>path</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>with</span> <span class=n>websocket_server</span><span class=p>(</span><span class=n>websocket</span><span class=p>)</span> <span class=k>as</span> <span class=n>server</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=n>server</span><span class=o>.</span><span class=n>run</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>start_server</span> <span class=o>=</span> <span class=n>websockets</span><span class=o>.</span><span class=n>serve</span><span class=p>(</span><span class=n>handle_websocket</span><span class=p>,</span> <span class=s2>&#34;localhost&#34;</span><span class=p>,</span> <span class=mi>8765</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>asyncio</span><span class=o>.</span><span class=n>get_event_loop</span><span class=p>()</span><span class=o>.</span><span class=n>run_until_complete</span><span class=p>(</span><span class=n>start_server</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=协议消息格式详解>协议消息格式详解</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;jsonrpc&#34;</span><span class=p>:</span> <span class=s2>&#34;2.0&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;method&#34;</span><span class=p>:</span> <span class=s2>&#34;initialize&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;params&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;protocolVersion&#34;</span><span class=p>:</span> <span class=s2>&#34;2024-11-05&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;capabilities&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;resources&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;subscribe&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;listChanged&#34;</span><span class=p>:</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;tools&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;listChanged&#34;</span><span class=p>:</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;prompts&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;listChanged&#34;</span><span class=p>:</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;logging&#34;</span><span class=p>:</span> <span class=p>{},</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;sampling&#34;</span><span class=p>:</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;clientInfo&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;example-client&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nt>&#34;version&#34;</span><span class=p>:</span> <span class=s2>&#34;1.0.0&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=-mcp核心概念详解>💻 MCP核心概念详解</h2><h3 id=协议生命周期管理>协议生命周期管理</h3><h4 id=1-连接建立流程>1. 连接建立流程</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>sequenceDiagram</span>
</span></span><span class=line><span class=cl>    <span class=n>participant</span> <span class=n>Client</span>
</span></span><span class=line><span class=cl>    <span class=n>participant</span> <span class=n>Server</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>Client</span><span class=o>-&gt;&gt;</span><span class=n>Server</span><span class=p>:</span> <span class=n>initialize</span> <span class=n>request</span>
</span></span><span class=line><span class=cl>    <span class=n>Server</span><span class=o>-&gt;&gt;</span><span class=n>Client</span><span class=p>:</span> <span class=n>initialize</span> <span class=n>response</span>
</span></span><span class=line><span class=cl>    <span class=n>Client</span><span class=o>-&gt;&gt;</span><span class=n>Server</span><span class=p>:</span> <span class=n>initialized</span> <span class=n>notification</span>
</span></span><span class=line><span class=cl>    <span class=n>Note</span> <span class=n>over</span> <span class=n>Client</span><span class=p>,</span><span class=n>Server</span><span class=p>:</span> <span class=err>连接建立完成</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>Client</span><span class=o>-&gt;&gt;</span><span class=n>Server</span><span class=p>:</span> <span class=n>resources</span><span class=o>/</span><span class=n>list</span>
</span></span><span class=line><span class=cl>    <span class=n>Server</span><span class=o>-&gt;&gt;</span><span class=n>Client</span><span class=p>:</span> <span class=n>resources</span> <span class=n>list</span> <span class=n>response</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>Client</span><span class=o>-&gt;&gt;</span><span class=n>Server</span><span class=p>:</span> <span class=n>tools</span><span class=o>/</span><span class=n>list</span>  
</span></span><span class=line><span class=cl>    <span class=n>Server</span><span class=o>-&gt;&gt;</span><span class=n>Client</span><span class=p>:</span> <span class=n>tools</span> <span class=n>list</span> <span class=n>response</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>Note</span> <span class=n>over</span> <span class=n>Client</span><span class=p>,</span><span class=n>Server</span><span class=p>:</span> <span class=err>正常通信阶段</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=2-能力协商capabilities>2. 能力协商（Capabilities）</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>ServerCapabilities</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>resources</span> <span class=o>=</span> <span class=n>ResourceCapabilities</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>subscribe</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>        <span class=c1># 支持资源订阅</span>
</span></span><span class=line><span class=cl>            <span class=n>listChanged</span><span class=o>=</span><span class=kc>True</span>      <span class=c1># 支持列表变更通知</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>tools</span> <span class=o>=</span> <span class=n>ToolCapabilities</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>listChanged</span><span class=o>=</span><span class=kc>True</span>      <span class=c1># 支持工具列表变更</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>prompts</span> <span class=o>=</span> <span class=n>PromptCapabilities</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>listChanged</span><span class=o>=</span><span class=kc>True</span>      <span class=c1># 支持提示模板变更</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>logging</span> <span class=o>=</span> <span class=n>LoggingCapabilities</span><span class=p>()</span>      <span class=c1># 日志功能</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>sampling</span> <span class=o>=</span> <span class=n>SamplingCapabilities</span><span class=p>()</span>   <span class=c1># 采样功能</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 服务器能力声明</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>handle_initialize</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>params</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>InitializeResult</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>protocolVersion</span><span class=o>=</span><span class=s2>&#34;2024-11-05&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>capabilities</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>get_capabilities</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=n>serverInfo</span><span class=o>=</span><span class=n>ServerInfo</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>name</span><span class=o>=</span><span class=s2>&#34;advanced-mcp-server&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>version</span><span class=o>=</span><span class=s2>&#34;2.0.0&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=1-resources资源深度解析>1. Resources（资源）深度解析</h3><h4 id=定义与作用>定义与作用</h4><p>Resources是MCP服务器暴露给AI模型的<strong>只读数据</strong>，可以是文件、数据库记录、API响应等。</p><h4 id=资源类型系统>资源类型系统</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Union</span><span class=p>,</span> <span class=n>List</span><span class=p>,</span> <span class=n>Dict</span><span class=p>,</span> <span class=n>Any</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>dataclasses</span> <span class=kn>import</span> <span class=n>dataclass</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>enum</span> <span class=kn>import</span> <span class=n>Enum</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ResourceType</span><span class=p>(</span><span class=n>Enum</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>TEXT</span> <span class=o>=</span> <span class=s2>&#34;text&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>BINARY</span> <span class=o>=</span> <span class=s2>&#34;binary&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>JSON</span> <span class=o>=</span> <span class=s2>&#34;json&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>XML</span> <span class=o>=</span> <span class=s2>&#34;xml&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>CSV</span> <span class=o>=</span> <span class=s2>&#34;csv&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>IMAGE</span> <span class=o>=</span> <span class=s2>&#34;image&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>AUDIO</span> <span class=o>=</span> <span class=s2>&#34;audio&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>VIDEO</span> <span class=o>=</span> <span class=s2>&#34;video&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@dataclass</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ResourceMetadata</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;资源元数据&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>size</span><span class=p>:</span> <span class=nb>int</span>
</span></span><span class=line><span class=cl>    <span class=n>lastModified</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>encoding</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>language</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=n>tags</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=n>permissions</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=nb>bool</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@dataclass</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>AdvancedResource</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>uri</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>name</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>description</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>mimeType</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>resourceType</span><span class=p>:</span> <span class=n>ResourceType</span>
</span></span><span class=line><span class=cl>    <span class=n>metadata</span><span class=p>:</span> <span class=n>ResourceMetadata</span>
</span></span><span class=line><span class=cl>    <span class=n>annotations</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=高级资源实现>高级资源实现</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>AdvancedResourceServer</span><span class=p>(</span><span class=n>McpServer</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span><span class=s2>&#34;advanced-resource-server&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>resource_cache</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>resource_subscribers</span> <span class=o>=</span> <span class=nb>set</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>list_resources</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=n>AdvancedResource</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;列出所有可用资源&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>resources</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 动态扫描文件系统</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>file_path</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>scan_directory</span><span class=p>(</span><span class=s2>&#34;/data&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>resource</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>create_resource_from_file</span><span class=p>(</span><span class=n>file_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>resources</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>resource</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>        <span class=c1># 数据库资源</span>
</span></span><span class=line><span class=cl>        <span class=n>db_resources</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_database_resources</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>resources</span><span class=o>.</span><span class=n>extend</span><span class=p>(</span><span class=n>db_resources</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># API资源</span>
</span></span><span class=line><span class=cl>        <span class=n>api_resources</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_api_resources</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>resources</span><span class=o>.</span><span class=n>extend</span><span class=p>(</span><span class=n>api_resources</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>resources</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>read_resource</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>uri</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Union</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=nb>bytes</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;读取资源内容，支持缓存和压缩&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 检查缓存</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>uri</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>resource_cache</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>cache_entry</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>resource_cache</span><span class=p>[</span><span class=n>uri</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>is_cache_expired</span><span class=p>(</span><span class=n>cache_entry</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>cache_entry</span><span class=p>[</span><span class=s1>&#39;content&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 根据URI类型读取资源</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>uri</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s2>&#34;file://&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>content</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>read_file_resource</span><span class=p>(</span><span class=n>uri</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>uri</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s2>&#34;db://&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>content</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>read_database_resource</span><span class=p>(</span><span class=n>uri</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>uri</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s2>&#34;api://&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>content</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>read_api_resource</span><span class=p>(</span><span class=n>uri</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;不支持的资源URI: </span><span class=si>{</span><span class=n>uri</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 更新缓存</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>resource_cache</span><span class=p>[</span><span class=n>uri</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;content&#39;</span><span class=p>:</span> <span class=n>content</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;timestamp&#39;</span><span class=p>:</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;size&#39;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=n>content</span><span class=p>)</span> <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>content</span><span class=p>,</span> <span class=nb>str</span><span class=p>)</span> <span class=k>else</span> <span class=nb>len</span><span class=p>(</span><span class=n>content</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>content</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>subscribe_to_resource</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>uri</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;订阅资源变更通知&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>resource_subscribers</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>uri</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># 启动文件监控</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>start_file_watcher</span><span class=p>(</span><span class=n>uri</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>notify_resource_changed</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>uri</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;通知资源变更&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>uri</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>resource_subscribers</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>send_notification</span><span class=p>(</span><span class=s2>&#34;notifications/resources/updated&#34;</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;uri&#34;</span><span class=p>:</span> <span class=n>uri</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;timestamp&#34;</span><span class=p>:</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=p>})</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=实现示例>实现示例</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 文件系统资源服务器</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>mcp</span> <span class=kn>import</span> <span class=n>McpServer</span><span class=p>,</span> <span class=n>Resource</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>FileSystemServer</span><span class=p>(</span><span class=n>McpServer</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>list_resources</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=n>Resource</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>uri</span><span class=o>=</span><span class=s2>&#34;file:///path/to/document.txt&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>name</span><span class=o>=</span><span class=s2>&#34;项目文档&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>description</span><span class=o>=</span><span class=s2>&#34;项目的详细说明文档&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>mimeType</span><span class=o>=</span><span class=s2>&#34;text/plain&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>read_resource</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>uri</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>uri</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s2>&#34;file://&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>path</span> <span class=o>=</span> <span class=n>uri</span><span class=p>[</span><span class=mi>7</span><span class=p>:]</span>  <span class=c1># 移除file://前缀</span>
</span></span><span class=line><span class=cl>            <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>path</span><span class=p>,</span> <span class=s1>&#39;r&#39;</span><span class=p>,</span> <span class=n>encoding</span><span class=o>=</span><span class=s1>&#39;utf-8&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>f</span><span class=o>.</span><span class=n>read</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=应用场景>应用场景</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-markdown data-lang=markdown><span class=line><span class=cl>📁 文件系统：
</span></span><span class=line><span class=cl><span class=k>-</span> 代码文件、文档、配置文件
</span></span><span class=line><span class=cl><span class=k>-</span> 支持多种文件格式（txt, md, json, etc.）
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>🗄️ 数据库：
</span></span><span class=line><span class=cl><span class=k>-</span> 表结构、查询结果
</span></span><span class=line><span class=cl><span class=k>-</span> 支持SQL和NoSQL数据库
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>🌐 Web资源：
</span></span><span class=line><span class=cl><span class=k>-</span> API响应、网页内容
</span></span><span class=line><span class=cl><span class=k>-</span> 实时数据抓取
</span></span></code></pre></td></tr></table></div></div><h3 id=2-tools工具高级特性>2. Tools（工具）高级特性</h3><h4 id=定义与作用-1>定义与作用</h4><p>Tools允许AI模型<strong>执行操作</strong>，如文件写入、API调用、数据库更新等。</p><h4 id=工具参数验证系统>工具参数验证系统</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pydantic</span> <span class=kn>import</span> <span class=n>BaseModel</span><span class=p>,</span> <span class=n>validator</span><span class=p>,</span> <span class=n>Field</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Optional</span><span class=p>,</span> <span class=n>Union</span><span class=p>,</span> <span class=n>List</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>jsonschema</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>AdvancedToolParameter</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;高级工具参数定义&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>name</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=nb>type</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>description</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>required</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>    <span class=n>default</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=n>Any</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=n>enum</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]]</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=n>pattern</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=n>minimum</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>float</span><span class=p>]]</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=n>maximum</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=n>Union</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>float</span><span class=p>]]</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@validator</span><span class=p>(</span><span class=s1>&#39;type&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>validate_type</span><span class=p>(</span><span class=bp>cls</span><span class=p>,</span> <span class=n>v</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>valid_types</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;string&#39;</span><span class=p>,</span> <span class=s1>&#39;number&#39;</span><span class=p>,</span> <span class=s1>&#39;integer&#39;</span><span class=p>,</span> <span class=s1>&#39;boolean&#39;</span><span class=p>,</span> <span class=s1>&#39;array&#39;</span><span class=p>,</span> <span class=s1>&#39;object&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>v</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>valid_types</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;Invalid type: </span><span class=si>{</span><span class=n>v</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>v</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>AdvancedTool</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;高级工具定义&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>name</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>description</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>parameters</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>AdvancedToolParameter</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>examples</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=n>List</span><span class=p>[</span><span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]]]</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    <span class=n>category</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s2>&#34;general&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>tags</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=n>timeout</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>30</span>  <span class=c1># 超时时间（秒）</span>
</span></span><span class=line><span class=cl>    <span class=n>retryable</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>    <span class=n>permissions</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>validate_input</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>arguments</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;验证输入参数&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>schema</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>generate_json_schema</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>jsonschema</span><span class=o>.</span><span class=n>validate</span><span class=p>(</span><span class=n>arguments</span><span class=p>,</span> <span class=n>schema</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=n>jsonschema</span><span class=o>.</span><span class=n>ValidationError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;参数验证失败: </span><span class=si>{</span><span class=n>e</span><span class=o>.</span><span class=n>message</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>generate_json_schema</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;生成JSON Schema用于参数验证&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>properties</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=n>required</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>param</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>parameters</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>prop</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;type&#34;</span><span class=p>:</span> <span class=n>param</span><span class=o>.</span><span class=n>type</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;description&#34;</span><span class=p>:</span> <span class=n>param</span><span class=o>.</span><span class=n>description</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>param</span><span class=o>.</span><span class=n>enum</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>prop</span><span class=p>[</span><span class=s2>&#34;enum&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=n>param</span><span class=o>.</span><span class=n>enum</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>param</span><span class=o>.</span><span class=n>pattern</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>prop</span><span class=p>[</span><span class=s2>&#34;pattern&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=n>param</span><span class=o>.</span><span class=n>pattern</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>param</span><span class=o>.</span><span class=n>minimum</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>prop</span><span class=p>[</span><span class=s2>&#34;minimum&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=n>param</span><span class=o>.</span><span class=n>minimum</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>param</span><span class=o>.</span><span class=n>maximum</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>prop</span><span class=p>[</span><span class=s2>&#34;maximum&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=n>param</span><span class=o>.</span><span class=n>maximum</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>param</span><span class=o>.</span><span class=n>default</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>prop</span><span class=p>[</span><span class=s2>&#34;default&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=n>param</span><span class=o>.</span><span class=n>default</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>            <span class=n>properties</span><span class=p>[</span><span class=n>param</span><span class=o>.</span><span class=n>name</span><span class=p>]</span> <span class=o>=</span> <span class=n>prop</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>param</span><span class=o>.</span><span class=n>required</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>required</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>param</span><span class=o>.</span><span class=n>name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;object&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;properties&#34;</span><span class=p>:</span> <span class=n>properties</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;required&#34;</span><span class=p>:</span> <span class=n>required</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=工具执行引擎>工具执行引擎</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>asyncio</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>contextlib</span> <span class=kn>import</span> <span class=n>asynccontextmanager</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>AsyncGenerator</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ToolExecutionContext</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;工具执行上下文&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>tool_name</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>client_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>tool_name</span> <span class=o>=</span> <span class=n>tool_name</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>client_id</span> <span class=o>=</span> <span class=n>client_id</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>start_time</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>execution_id</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>tool_name</span><span class=si>}</span><span class=s2>_</span><span class=si>{</span><span class=nb>int</span><span class=p>(</span><span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>())</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>metadata</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>AdvancedToolServer</span><span class=p>(</span><span class=n>McpServer</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span><span class=s2>&#34;advanced-tool-server&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>tool_registry</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>execution_history</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>concurrent_executions</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>register_tool</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>tool</span><span class=p>:</span> <span class=n>AdvancedTool</span><span class=p>,</span> <span class=n>handler_func</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;注册工具和处理函数&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>tool_registry</span><span class=p>[</span><span class=n>tool</span><span class=o>.</span><span class=n>name</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;tool&#39;</span><span class=p>:</span> <span class=n>tool</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;handler&#39;</span><span class=p>:</span> <span class=n>handler_func</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>list_tools</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=n>AdvancedTool</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;列出所有注册的工具&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>[</span><span class=n>entry</span><span class=p>[</span><span class=s1>&#39;tool&#39;</span><span class=p>]</span> <span class=k>for</span> <span class=n>entry</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>tool_registry</span><span class=o>.</span><span class=n>values</span><span class=p>()]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@asynccontextmanager</span>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>execution_context</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>tool_name</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>client_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>AsyncGenerator</span><span class=p>[</span><span class=n>ToolExecutionContext</span><span class=p>,</span> <span class=kc>None</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;工具执行上下文管理器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>context</span> <span class=o>=</span> <span class=n>ToolExecutionContext</span><span class=p>(</span><span class=n>tool_name</span><span class=p>,</span> <span class=n>client_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>concurrent_executions</span><span class=p>[</span><span class=n>context</span><span class=o>.</span><span class=n>execution_id</span><span class=p>]</span> <span class=o>=</span> <span class=n>context</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>yield</span> <span class=n>context</span>
</span></span><span class=line><span class=cl>        <span class=k>finally</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 记录执行历史</span>
</span></span><span class=line><span class=cl>            <span class=n>context</span><span class=o>.</span><span class=n>end_time</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>context</span><span class=o>.</span><span class=n>duration</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=n>end_time</span> <span class=o>-</span> <span class=n>context</span><span class=o>.</span><span class=n>start_time</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>execution_history</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>context</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 清理并发执行记录</span>
</span></span><span class=line><span class=cl>            <span class=k>del</span> <span class=bp>self</span><span class=o>.</span><span class=n>concurrent_executions</span><span class=p>[</span><span class=n>context</span><span class=o>.</span><span class=n>execution_id</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>call_tool</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>arguments</span><span class=p>:</span> <span class=nb>dict</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>ToolResult</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;执行工具调用&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>name</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>tool_registry</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=n>McpError</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>code</span><span class=o>=</span><span class=n>ErrorCode</span><span class=o>.</span><span class=n>METHOD_NOT_FOUND</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>message</span><span class=o>=</span><span class=sa>f</span><span class=s2>&#34;工具 &#39;</span><span class=si>{</span><span class=n>name</span><span class=si>}</span><span class=s2>&#39; 未找到&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>tool_entry</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>tool_registry</span><span class=p>[</span><span class=n>name</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>tool</span> <span class=o>=</span> <span class=n>tool_entry</span><span class=p>[</span><span class=s1>&#39;tool&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>handler</span> <span class=o>=</span> <span class=n>tool_entry</span><span class=p>[</span><span class=s1>&#39;handler&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 参数验证</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>tool</span><span class=o>.</span><span class=n>validate_input</span><span class=p>(</span><span class=n>arguments</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>ValueError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=n>McpError</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>code</span><span class=o>=</span><span class=n>ErrorCode</span><span class=o>.</span><span class=n>INVALID_PARAMS</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>message</span><span class=o>=</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 权限检查</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>check_tool_permissions</span><span class=p>(</span><span class=n>tool</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_current_client_id</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 执行工具</span>
</span></span><span class=line><span class=cl>        <span class=k>async</span> <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>execution_context</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_current_client_id</span><span class=p>())</span> <span class=k>as</span> <span class=n>context</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1># 设置超时</span>
</span></span><span class=line><span class=cl>                <span class=n>result</span> <span class=o>=</span> <span class=k>await</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>wait_for</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                    <span class=n>handler</span><span class=p>(</span><span class=n>arguments</span><span class=p>,</span> <span class=n>context</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                    <span class=n>timeout</span><span class=o>=</span><span class=n>tool</span><span class=o>.</span><span class=n>timeout</span>
</span></span><span class=line><span class=cl>                <span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>            <span class=k>except</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>TimeoutError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>raise</span> <span class=n>McpError</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                    <span class=n>code</span><span class=o>=</span><span class=n>ErrorCode</span><span class=o>.</span><span class=n>REQUEST_TIMEOUT</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>message</span><span class=o>=</span><span class=sa>f</span><span class=s2>&#34;工具执行超时 (</span><span class=si>{</span><span class=n>tool</span><span class=o>.</span><span class=n>timeout</span><span class=si>}</span><span class=s2>秒)&#34;</span>
</span></span><span class=line><span class=cl>                <span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>tool</span><span class=o>.</span><span class=n>retryable</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=c1># 可重试的工具进行重试</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>retry_tool_execution</span><span class=p>(</span><span class=n>tool</span><span class=p>,</span> <span class=n>handler</span><span class=p>,</span> <span class=n>arguments</span><span class=p>,</span> <span class=n>context</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>raise</span> <span class=n>McpError</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                        <span class=n>code</span><span class=o>=</span><span class=n>ErrorCode</span><span class=o>.</span><span class=n>INTERNAL_ERROR</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>message</span><span class=o>=</span><span class=sa>f</span><span class=s2>&#34;工具执行失败: </span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>retry_tool_execution</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>tool</span><span class=p>:</span> <span class=n>AdvancedTool</span><span class=p>,</span> <span class=n>handler</span><span class=p>,</span> <span class=n>arguments</span><span class=p>:</span> <span class=nb>dict</span><span class=p>,</span> <span class=n>context</span><span class=p>:</span> <span class=n>ToolExecutionContext</span><span class=p>,</span> <span class=n>max_retries</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>3</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>ToolResult</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;重试工具执行&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>attempt</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>max_retries</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>await</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>2</span> <span class=o>**</span> <span class=n>attempt</span><span class=p>)</span>  <span class=c1># 指数退避</span>
</span></span><span class=line><span class=cl>                <span class=n>result</span> <span class=o>=</span> <span class=k>await</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>wait_for</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                    <span class=n>handler</span><span class=p>(</span><span class=n>arguments</span><span class=p>,</span> <span class=n>context</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                    <span class=n>timeout</span><span class=o>=</span><span class=n>tool</span><span class=o>.</span><span class=n>timeout</span>
</span></span><span class=line><span class=cl>                <span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>            <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>attempt</span> <span class=o>==</span> <span class=n>max_retries</span> <span class=o>-</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>raise</span> <span class=n>McpError</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                        <span class=n>code</span><span class=o>=</span><span class=n>ErrorCode</span><span class=o>.</span><span class=n>INTERNAL_ERROR</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>message</span><span class=o>=</span><span class=sa>f</span><span class=s2>&#34;工具执行失败（重试</span><span class=si>{</span><span class=n>max_retries</span><span class=si>}</span><span class=s2>次后）: </span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>continue</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=工具组合与工作流>工具组合与工作流</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>ToolWorkflow</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;工具工作流编排&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>name</span> <span class=o>=</span> <span class=n>name</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>steps</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>conditions</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>add_step</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>tool_name</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>arguments</span><span class=p>:</span> <span class=nb>dict</span><span class=p>,</span> <span class=n>condition</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=n>callable</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;添加工作流步骤&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>steps</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;tool&#39;</span><span class=p>:</span> <span class=n>tool_name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;arguments&#39;</span><span class=p>:</span> <span class=n>arguments</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;condition&#39;</span><span class=p>:</span> <span class=n>condition</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>execute</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>tool_server</span><span class=p>:</span> <span class=n>AdvancedToolServer</span><span class=p>,</span> <span class=n>context</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=n>ToolResult</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;执行工作流&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>results</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=n>workflow_context</span> <span class=o>=</span> <span class=n>context</span> <span class=ow>or</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>step</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>steps</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 检查执行条件</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>step</span><span class=p>[</span><span class=s1>&#39;condition&#39;</span><span class=p>]</span> <span class=ow>and</span> <span class=ow>not</span> <span class=n>step</span><span class=p>[</span><span class=s1>&#39;condition&#39;</span><span class=p>](</span><span class=n>workflow_context</span><span class=p>,</span> <span class=n>results</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=k>continue</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 动态参数替换</span>
</span></span><span class=line><span class=cl>            <span class=n>arguments</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>resolve_arguments</span><span class=p>(</span><span class=n>step</span><span class=p>[</span><span class=s1>&#39;arguments&#39;</span><span class=p>],</span> <span class=n>workflow_context</span><span class=p>,</span> <span class=n>results</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 执行工具</span>
</span></span><span class=line><span class=cl>            <span class=n>result</span> <span class=o>=</span> <span class=k>await</span> <span class=n>tool_server</span><span class=o>.</span><span class=n>call_tool</span><span class=p>(</span><span class=n>step</span><span class=p>[</span><span class=s1>&#39;tool&#39;</span><span class=p>],</span> <span class=n>arguments</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>results</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>result</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 更新上下文</span>
</span></span><span class=line><span class=cl>            <span class=n>workflow_context</span><span class=p>[</span><span class=sa>f</span><span class=s2>&#34;step_</span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>results</span><span class=p>)</span><span class=si>}</span><span class=s2>_result&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>results</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>resolve_arguments</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>arguments</span><span class=p>:</span> <span class=nb>dict</span><span class=p>,</span> <span class=n>context</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>],</span> <span class=n>results</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>ToolResult</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=nb>dict</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;解析动态参数&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>resolved</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>key</span><span class=p>,</span> <span class=n>value</span> <span class=ow>in</span> <span class=n>arguments</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>value</span><span class=p>,</span> <span class=nb>str</span><span class=p>)</span> <span class=ow>and</span> <span class=n>value</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s2>&#34;${&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=c1># 动态参数解析</span>
</span></span><span class=line><span class=cl>                <span class=n>var_name</span> <span class=o>=</span> <span class=n>value</span><span class=p>[</span><span class=mi>2</span><span class=p>:</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>  <span class=c1># 移除 ${ 和 }</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>var_name</span> <span class=ow>in</span> <span class=n>context</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>resolved</span><span class=p>[</span><span class=n>key</span><span class=p>]</span> <span class=o>=</span> <span class=n>context</span><span class=p>[</span><span class=n>var_name</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                <span class=k>elif</span> <span class=n>var_name</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s2>&#34;result_&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                    <span class=c1># 引用之前的结果</span>
</span></span><span class=line><span class=cl>                    <span class=n>index</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>var_name</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&#34;_&#34;</span><span class=p>)[</span><span class=mi>1</span><span class=p>])</span> <span class=o>-</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=mi>0</span> <span class=o>&lt;=</span> <span class=n>index</span> <span class=o>&lt;</span> <span class=nb>len</span><span class=p>(</span><span class=n>results</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                        <span class=n>resolved</span><span class=p>[</span><span class=n>key</span><span class=p>]</span> <span class=o>=</span> <span class=n>results</span><span class=p>[</span><span class=n>index</span><span class=p>]</span><span class=o>.</span><span class=n>content</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>text</span>
</span></span><span class=line><span class=cl>                <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>resolved</span><span class=p>[</span><span class=n>key</span><span class=p>]</span> <span class=o>=</span> <span class=n>value</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>resolved</span><span class=p>[</span><span class=n>key</span><span class=p>]</span> <span class=o>=</span> <span class=n>value</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>resolved</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 工作流使用示例</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>setup_code_analysis_workflow</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>workflow</span> <span class=o>=</span> <span class=n>ToolWorkflow</span><span class=p>(</span><span class=s2>&#34;code_analysis&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 步骤1: 扫描代码文件</span>
</span></span><span class=line><span class=cl>    <span class=n>workflow</span><span class=o>.</span><span class=n>add_step</span><span class=p>(</span><span class=s2>&#34;scan_code_files&#34;</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;directory&#34;</span><span class=p>:</span> <span class=s2>&#34;$</span><span class=si>{target_directory}</span><span class=s2>&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;extensions&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;.py&#34;</span><span class=p>,</span> <span class=s2>&#34;.js&#34;</span><span class=p>,</span> <span class=s2>&#34;.ts&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 步骤2: 分析代码复杂度</span>
</span></span><span class=line><span class=cl>    <span class=n>workflow</span><span class=o>.</span><span class=n>add_step</span><span class=p>(</span><span class=s2>&#34;analyze_complexity&#34;</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;files&#34;</span><span class=p>:</span> <span class=s2>&#34;$</span><span class=si>{result_1}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span> <span class=n>condition</span><span class=o>=</span><span class=k>lambda</span> <span class=n>ctx</span><span class=p>,</span> <span class=n>results</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=n>results</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=ow>and</span> <span class=n>results</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>isError</span> <span class=o>==</span> <span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># 步骤3: 生成报告</span>
</span></span><span class=line><span class=cl>    <span class=n>workflow</span><span class=o>.</span><span class=n>add_step</span><span class=p>(</span><span class=s2>&#34;generate_report&#34;</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;analysis_data&#34;</span><span class=p>:</span> <span class=s2>&#34;$</span><span class=si>{result_2}</span><span class=s2>&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;format&#34;</span><span class=p>:</span> <span class=s2>&#34;markdown&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>workflow</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=实现示例-1>实现示例</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>mcp</span> <span class=kn>import</span> <span class=n>Tool</span><span class=p>,</span> <span class=n>ToolResult</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>DatabaseTool</span><span class=p>(</span><span class=n>McpServer</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>list_tools</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=n>Tool</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>name</span><span class=o>=</span><span class=s2>&#34;execute_query&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>description</span><span class=o>=</span><span class=s2>&#34;执行SQL查询&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>inputSchema</span><span class=o>=</span><span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;object&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;properties&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;query&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                            <span class=s2>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;string&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                            <span class=s2>&#34;description&#34;</span><span class=p>:</span> <span class=s2>&#34;要执行的SQL查询&#34;</span>
</span></span><span class=line><span class=cl>                        <span class=p>}</span>
</span></span><span class=line><span class=cl>                    <span class=p>},</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;required&#34;</span><span class=p>:</span> <span class=p>[</span><span class=s2>&#34;query&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>call_tool</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>arguments</span><span class=p>:</span> <span class=nb>dict</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>name</span> <span class=o>==</span> <span class=s2>&#34;execute_query&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>query</span> <span class=o>=</span> <span class=n>arguments</span><span class=p>[</span><span class=s2>&#34;query&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=c1># 执行数据库查询</span>
</span></span><span class=line><span class=cl>            <span class=n>result</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>db</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=n>query</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>ToolResult</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>content</span><span class=o>=</span><span class=p>[{</span><span class=s2>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;text&#34;</span><span class=p>,</span> <span class=s2>&#34;text&#34;</span><span class=p>:</span> <span class=nb>str</span><span class=p>(</span><span class=n>result</span><span class=p>)}],</span>
</span></span><span class=line><span class=cl>                <span class=n>isError</span><span class=o>=</span><span class=kc>False</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=安全考虑>安全考虑</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-markdown data-lang=markdown><span class=line><span class=cl>🔒 权限控制：
</span></span><span class=line><span class=cl><span class=k>-</span> 工具权限最小化原则
</span></span><span class=line><span class=cl><span class=k>-</span> 敏感操作需要确认
</span></span><span class=line><span class=cl><span class=k>-</span> 审计日志记录
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>⚠️ 输入验证：
</span></span><span class=line><span class=cl><span class=k>-</span> 参数类型检查
</span></span><span class=line><span class=cl><span class=k>-</span> SQL注入防护
</span></span><span class=line><span class=cl><span class=k>-</span> 文件路径验证
</span></span></code></pre></td></tr></table></div></div><h3 id=3-prompts提示模板>3. Prompts（提示模板）</h3><h4 id=定义与作用-2>定义与作用</h4><p>Prompts是可重用的提示模板，包含动态参数，用于标准化AI交互模式。</p><h4 id=实现示例-2>实现示例</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>mcp</span> <span class=kn>import</span> <span class=n>Prompt</span><span class=p>,</span> <span class=n>PromptArgument</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>CodeReviewServer</span><span class=p>(</span><span class=n>McpServer</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>list_prompts</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=n>Prompt</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>name</span><span class=o>=</span><span class=s2>&#34;code_review&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>description</span><span class=o>=</span><span class=s2>&#34;代码评审提示模板&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>arguments</span><span class=o>=</span><span class=p>[</span>
</span></span><span class=line><span class=cl>                    <span class=n>PromptArgument</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                        <span class=n>name</span><span class=o>=</span><span class=s2>&#34;code&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>description</span><span class=o>=</span><span class=s2>&#34;要评审的代码&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>required</span><span class=o>=</span><span class=kc>True</span>
</span></span><span class=line><span class=cl>                    <span class=p>),</span>
</span></span><span class=line><span class=cl>                    <span class=n>PromptArgument</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                        <span class=n>name</span><span class=o>=</span><span class=s2>&#34;language&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>description</span><span class=o>=</span><span class=s2>&#34;编程语言&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>required</span><span class=o>=</span><span class=kc>False</span>
</span></span><span class=line><span class=cl>                    <span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>get_prompt</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>arguments</span><span class=p>:</span> <span class=nb>dict</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>name</span> <span class=o>==</span> <span class=s2>&#34;code_review&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>code</span> <span class=o>=</span> <span class=n>arguments</span><span class=p>[</span><span class=s2>&#34;code&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>language</span> <span class=o>=</span> <span class=n>arguments</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;language&#34;</span><span class=p>,</span> <span class=s2>&#34;未知&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>请对以下</span><span class=si>{</span><span class=n>language</span><span class=si>}</span><span class=s2>代码进行详细评审：
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>代码内容：
</span></span></span><span class=line><span class=cl><span class=s2>```</span><span class=si>{</span><span class=n>language</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2></span><span class=si>{</span><span class=n>code</span><span class=si>}</span><span class=s2>
</span></span></span></code></pre></td></tr></table></div></div><p>请从以下几个方面进行分析：</p><ol><li>代码质量和规范性</li><li>性能优化建议</li><li>安全性问题</li><li>可维护性改进</li><li>最佳实践建议</li></ol><p>请提供具体的修改建议和示例代码。
"""</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## 🔒 MCP安全与中间件系统</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>### 认证与授权中间件</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#### JWT认证中间件</span>
</span></span><span class=line><span class=cl><span class=err>```</span><span class=n>python</span>
</span></span><span class=line><span class=cl><span class=n>import</span> <span class=n>jwt</span>
</span></span><span class=line><span class=cl><span class=n>from</span> <span class=n>functools</span> <span class=n>import</span> <span class=n>wraps</span>
</span></span><span class=line><span class=cl><span class=n>from</span> <span class=n>typing</span> <span class=n>import</span> <span class=n>Dict</span><span class=p>,</span> <span class=n>Any</span><span class=p>,</span> <span class=n>Optional</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=n>JWTAuthMiddleware</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>secret_key</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>algorithm</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s2>&#34;HS256&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>secret_key</span> <span class=o>=</span> <span class=n>secret_key</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>algorithm</span> <span class=o>=</span> <span class=n>algorithm</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>verify_token</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>token</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;验证JWT令牌&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>payload</span> <span class=o>=</span> <span class=n>jwt</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=n>token</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>secret_key</span><span class=p>,</span> <span class=n>algorithms</span><span class=o>=</span><span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>algorithm</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>payload</span>
</span></span><span class=line><span class=cl>        <span class=n>except</span> <span class=n>jwt</span><span class=o>.</span><span class=n>ExpiredSignatureError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>raise</span> <span class=n>McpError</span><span class=p>(</span><span class=n>code</span><span class=o>=</span><span class=n>ErrorCode</span><span class=o>.</span><span class=n>UNAUTHORIZED</span><span class=p>,</span> <span class=n>message</span><span class=o>=</span><span class=s2>&#34;令牌已过期&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>except</span> <span class=n>jwt</span><span class=o>.</span><span class=n>InvalidTokenError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>raise</span> <span class=n>McpError</span><span class=p>(</span><span class=n>code</span><span class=o>=</span><span class=n>ErrorCode</span><span class=o>.</span><span class=n>UNAUTHORIZED</span><span class=p>,</span> <span class=n>message</span><span class=o>=</span><span class=s2>&#34;无效令牌&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>require_permission</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>permission</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;权限装饰器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>def</span> <span class=nf>decorator</span><span class=p>(</span><span class=k>func</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=err>@</span><span class=n>wraps</span><span class=p>(</span><span class=k>func</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>async</span> <span class=k>def</span> <span class=nf>wrapper</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=n>client_token</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_client_token</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=n>payload</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>verify_token</span><span class=p>(</span><span class=n>client_token</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=n>user_permissions</span> <span class=o>=</span> <span class=n>payload</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;permissions&#39;</span><span class=p>,</span> <span class=p>[])</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>permission</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>user_permissions</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>raise</span> <span class=n>McpError</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                        <span class=n>code</span><span class=o>=</span><span class=n>ErrorCode</span><span class=o>.</span><span class=n>PERMISSION_DENIED</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>message</span><span class=o>=</span><span class=n>f</span><span class=s2>&#34;缺少权限: {permission}&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=p>)</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>await</span> <span class=k>func</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>wrapper</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>decorator</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=n>SecureServer</span><span class=p>(</span><span class=n>McpServer</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>super</span><span class=p>()</span><span class=o>.</span><span class=n>__init__</span><span class=p>(</span><span class=s2>&#34;secure-server&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>auth_middleware</span> <span class=o>=</span> <span class=n>JWTAuthMiddleware</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>getenv</span><span class=p>(</span><span class=s2>&#34;JWT_SECRET&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=err>@</span><span class=n>auth_middleware</span><span class=o>.</span><span class=n>require_permission</span><span class=p>(</span><span class=s2>&#34;read:resources&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>async</span> <span class=k>def</span> <span class=nf>read_resource</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>uri</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>await</span> <span class=n>super</span><span class=p>()</span><span class=o>.</span><span class=n>read_resource</span><span class=p>(</span><span class=n>uri</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=err>@</span><span class=n>auth_middleware</span><span class=o>.</span><span class=n>require_permission</span><span class=p>(</span><span class=s2>&#34;execute:tools&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>async</span> <span class=k>def</span> <span class=nf>call_tool</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>arguments</span><span class=p>:</span> <span class=n>dict</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>await</span> <span class=n>super</span><span class=p>()</span><span class=o>.</span><span class=n>call_tool</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>arguments</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=请求限流中间件>请求限流中间件</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>collections</span> <span class=kn>import</span> <span class=n>defaultdict</span><span class=p>,</span> <span class=n>deque</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>DefaultDict</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>RateLimiter</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>max_requests</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>window_seconds</span><span class=p>:</span> <span class=nb>int</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>max_requests</span> <span class=o>=</span> <span class=n>max_requests</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>window_seconds</span> <span class=o>=</span> <span class=n>window_seconds</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>requests</span><span class=p>:</span> <span class=n>DefaultDict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>deque</span><span class=p>]</span> <span class=o>=</span> <span class=n>defaultdict</span><span class=p>(</span><span class=n>deque</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>is_allowed</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>client_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;检查是否允许请求&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>now</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>client_requests</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>requests</span><span class=p>[</span><span class=n>client_id</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 清理过期请求</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=n>client_requests</span> <span class=ow>and</span> <span class=n>client_requests</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>&lt;=</span> <span class=n>now</span> <span class=o>-</span> <span class=bp>self</span><span class=o>.</span><span class=n>window_seconds</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>client_requests</span><span class=o>.</span><span class=n>popleft</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 检查请求数量</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>client_requests</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=bp>self</span><span class=o>.</span><span class=n>max_requests</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 记录新请求</span>
</span></span><span class=line><span class=cl>        <span class=n>client_requests</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>now</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>RateLimitedServer</span><span class=p>(</span><span class=n>McpServer</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span><span class=s2>&#34;rate-limited-server&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>rate_limiter</span> <span class=o>=</span> <span class=n>RateLimiter</span><span class=p>(</span><span class=n>max_requests</span><span class=o>=</span><span class=mi>100</span><span class=p>,</span> <span class=n>window_seconds</span><span class=o>=</span><span class=mi>60</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>handle_request</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>method</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>params</span><span class=p>:</span> <span class=nb>dict</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>client_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_current_client_id</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>rate_limiter</span><span class=o>.</span><span class=n>is_allowed</span><span class=p>(</span><span class=n>client_id</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=n>McpError</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>code</span><span class=o>=</span><span class=n>ErrorCode</span><span class=o>.</span><span class=n>RATE_LIMITED</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>message</span><span class=o>=</span><span class=s2>&#34;请求频率超限，请稍后重试&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>await</span> <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=n>handle_request</span><span class=p>(</span><span class=n>method</span><span class=p>,</span> <span class=n>params</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=数据加密与脱敏>数据加密与脱敏</h3><h4 id=字段级加密>字段级加密</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>cryptography.fernet</span> <span class=kn>import</span> <span class=n>Fernet</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>base64</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>FieldEncryption</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>encryption_key</span><span class=p>:</span> <span class=nb>bytes</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>cipher_suite</span> <span class=o>=</span> <span class=n>Fernet</span><span class=p>(</span><span class=n>encryption_key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>encrypt_field</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;加密字段&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>encrypted_data</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>cipher_suite</span><span class=o>.</span><span class=n>encrypt</span><span class=p>(</span><span class=n>data</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>base64</span><span class=o>.</span><span class=n>b64encode</span><span class=p>(</span><span class=n>encrypted_data</span><span class=p>)</span><span class=o>.</span><span class=n>decode</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>decrypt_field</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>encrypted_data</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;解密字段&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>decoded_data</span> <span class=o>=</span> <span class=n>base64</span><span class=o>.</span><span class=n>b64decode</span><span class=p>(</span><span class=n>encrypted_data</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=n>decrypted_data</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>cipher_suite</span><span class=o>.</span><span class=n>decrypt</span><span class=p>(</span><span class=n>decoded_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>decrypted_data</span><span class=o>.</span><span class=n>decode</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>DataMasking</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;数据脱敏工具&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@staticmethod</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>mask_email</span><span class=p>(</span><span class=n>email</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;邮箱脱敏&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=s1>&#39;@&#39;</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>email</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>email</span>
</span></span><span class=line><span class=cl>        <span class=n>local</span><span class=p>,</span> <span class=n>domain</span> <span class=o>=</span> <span class=n>email</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;@&#39;</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>masked_local</span> <span class=o>=</span> <span class=n>local</span><span class=p>[:</span><span class=mi>2</span><span class=p>]</span> <span class=o>+</span> <span class=s1>&#39;*&#39;</span> <span class=o>*</span> <span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>local</span><span class=p>)</span> <span class=o>-</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>masked_local</span><span class=si>}</span><span class=s2>@</span><span class=si>{</span><span class=n>domain</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@staticmethod</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>mask_phone</span><span class=p>(</span><span class=n>phone</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;电话号码脱敏&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>phone</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>7</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>phone</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>phone</span><span class=p>[:</span><span class=mi>3</span><span class=p>]</span> <span class=o>+</span> <span class=s1>&#39;*&#39;</span> <span class=o>*</span> <span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>phone</span><span class=p>)</span> <span class=o>-</span> <span class=mi>6</span><span class=p>)</span> <span class=o>+</span> <span class=n>phone</span><span class=p>[</span><span class=o>-</span><span class=mi>3</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@staticmethod</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>mask_id_card</span><span class=p>(</span><span class=n>id_card</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;身份证脱敏&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>id_card</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>8</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>id_card</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>id_card</span><span class=p>[:</span><span class=mi>4</span><span class=p>]</span> <span class=o>+</span> <span class=s1>&#39;*&#39;</span> <span class=o>*</span> <span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>id_card</span><span class=p>)</span> <span class=o>-</span> <span class=mi>8</span><span class=p>)</span> <span class=o>+</span> <span class=n>id_card</span><span class=p>[</span><span class=o>-</span><span class=mi>4</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>SecureDataServer</span><span class=p>(</span><span class=n>McpServer</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span><span class=s2>&#34;secure-data-server&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>field_encryption</span> <span class=o>=</span> <span class=n>FieldEncryption</span><span class=p>(</span><span class=n>Fernet</span><span class=o>.</span><span class=n>generate_key</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>data_masking</span> <span class=o>=</span> <span class=n>DataMasking</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>read_resource</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>uri</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;读取资源并进行数据脱敏&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>raw_data</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>load_raw_data</span><span class=p>(</span><span class=n>uri</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 根据资源类型进行脱敏</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>uri</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s2>&#34;user://&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>mask_user_data</span><span class=p>(</span><span class=n>raw_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>uri</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s2>&#34;sensitive://&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>decrypt_and_mask_data</span><span class=p>(</span><span class=n>raw_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>raw_data</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>mask_user_data</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;用户数据脱敏&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>user_data</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=s1>&#39;email&#39;</span> <span class=ow>in</span> <span class=n>user_data</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>user_data</span><span class=p>[</span><span class=s1>&#39;email&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>data_masking</span><span class=o>.</span><span class=n>mask_email</span><span class=p>(</span><span class=n>user_data</span><span class=p>[</span><span class=s1>&#39;email&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=s1>&#39;phone&#39;</span> <span class=ow>in</span> <span class=n>user_data</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>user_data</span><span class=p>[</span><span class=s1>&#39;phone&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>data_masking</span><span class=o>.</span><span class=n>mask_phone</span><span class=p>(</span><span class=n>user_data</span><span class=p>[</span><span class=s1>&#39;phone&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=s1>&#39;id_card&#39;</span> <span class=ow>in</span> <span class=n>user_data</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>user_data</span><span class=p>[</span><span class=s1>&#39;id_card&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>data_masking</span><span class=o>.</span><span class=n>mask_id_card</span><span class=p>(</span><span class=n>user_data</span><span class=p>[</span><span class=s1>&#39;id_card&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>user_data</span><span class=p>,</span> <span class=n>ensure_ascii</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=n>json</span><span class=o>.</span><span class=n>JSONDecodeError</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>data</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=-mcp协议扩展>🔄 MCP协议扩展</h2><h3 id=自定义协议扩展>自定义协议扩展</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>CustomProtocolExtension</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;自定义协议扩展&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>namespace</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>namespace</span> <span class=o>=</span> <span class=n>namespace</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>custom_methods</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>register_method</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>method_name</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>handler</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;注册自定义方法&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>full_method_name</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>namespace</span><span class=si>}</span><span class=s2>/</span><span class=si>{</span><span class=n>method_name</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>custom_methods</span><span class=p>[</span><span class=n>full_method_name</span><span class=p>]</span> <span class=o>=</span> <span class=n>handler</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>handle_custom_request</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>method</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>params</span><span class=p>:</span> <span class=nb>dict</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;处理自定义请求&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>method</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>custom_methods</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>custom_methods</span><span class=p>[</span><span class=n>method</span><span class=p>](</span><span class=n>params</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=n>McpError</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>code</span><span class=o>=</span><span class=n>ErrorCode</span><span class=o>.</span><span class=n>METHOD_NOT_FOUND</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>message</span><span class=o>=</span><span class=sa>f</span><span class=s2>&#34;自定义方法未找到: </span><span class=si>{</span><span class=n>method</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ExtendedServer</span><span class=p>(</span><span class=n>McpServer</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span><span class=s2>&#34;extended-server&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>extension</span> <span class=o>=</span> <span class=n>CustomProtocolExtension</span><span class=p>(</span><span class=s2>&#34;mycompany&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>setup_custom_methods</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>setup_custom_methods</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;设置自定义方法&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>extension</span><span class=o>.</span><span class=n>register_method</span><span class=p>(</span><span class=s2>&#34;bulk_upload&#34;</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>handle_bulk_upload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>extension</span><span class=o>.</span><span class=n>register_method</span><span class=p>(</span><span class=s2>&#34;stream_data&#34;</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>handle_stream_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>extension</span><span class=o>.</span><span class=n>register_method</span><span class=p>(</span><span class=s2>&#34;batch_process&#34;</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>handle_batch_process</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>handle_bulk_upload</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>params</span><span class=p>:</span> <span class=nb>dict</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;处理批量上传&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>files</span> <span class=o>=</span> <span class=n>params</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;files&#39;</span><span class=p>,</span> <span class=p>[])</span>
</span></span><span class=line><span class=cl>        <span class=n>results</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>file_info</span> <span class=ow>in</span> <span class=n>files</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>result</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>upload_single_file</span><span class=p>(</span><span class=n>file_info</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>results</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>result</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;uploaded&#34;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=n>results</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;results&#34;</span><span class=p>:</span> <span class=n>results</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>handle_stream_data</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>params</span><span class=p>:</span> <span class=nb>dict</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;处理流数据&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>stream_id</span> <span class=o>=</span> <span class=n>params</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;stream_id&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>chunk_size</span> <span class=o>=</span> <span class=n>params</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;chunk_size&#39;</span><span class=p>,</span> <span class=mi>1024</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>async</span> <span class=k>for</span> <span class=n>chunk</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_data_stream</span><span class=p>(</span><span class=n>stream_id</span><span class=p>,</span> <span class=n>chunk_size</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>yield</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;stream_id&#34;</span><span class=p>:</span> <span class=n>stream_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;chunk&#34;</span><span class=p>:</span> <span class=n>chunk</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;timestamp&#34;</span><span class=p>:</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=事件驱动架构>事件驱动架构</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span><span class=lnt>210
</span><span class=lnt>211
</span><span class=lnt>212
</span><span class=lnt>213
</span><span class=lnt>214
</span><span class=lnt>215
</span><span class=lnt>216
</span><span class=lnt>217
</span><span class=lnt>218
</span><span class=lnt>219
</span><span class=lnt>220
</span><span class=lnt>221
</span><span class=lnt>222
</span><span class=lnt>223
</span><span class=lnt>224
</span><span class=lnt>225
</span><span class=lnt>226
</span><span class=lnt>227
</span><span class=lnt>228
</span><span class=lnt>229
</span><span class=lnt>230
</span><span class=lnt>231
</span><span class=lnt>232
</span><span class=lnt>233
</span><span class=lnt>234
</span><span class=lnt>235
</span><span class=lnt>236
</span><span class=lnt>237
</span><span class=lnt>238
</span><span class=lnt>239
</span><span class=lnt>240
</span><span class=lnt>241
</span><span class=lnt>242
</span><span class=lnt>243
</span><span class=lnt>244
</span><span class=lnt>245
</span><span class=lnt>246
</span><span class=lnt>247
</span><span class=lnt>248
</span><span class=lnt>249
</span><span class=lnt>250
</span><span class=lnt>251
</span><span class=lnt>252
</span><span class=lnt>253
</span><span class=lnt>254
</span><span class=lnt>255
</span><span class=lnt>256
</span><span class=lnt>257
</span><span class=lnt>258
</span><span class=lnt>259
</span><span class=lnt>260
</span><span class=lnt>261
</span><span class=lnt>262
</span><span class=lnt>263
</span><span class=lnt>264
</span><span class=lnt>265
</span><span class=lnt>266
</span><span class=lnt>267
</span><span class=lnt>268
</span><span class=lnt>269
</span><span class=lnt>270
</span><span class=lnt>271
</span><span class=lnt>272
</span><span class=lnt>273
</span><span class=lnt>274
</span><span class=lnt>275
</span><span class=lnt>276
</span><span class=lnt>277
</span><span class=lnt>278
</span><span class=lnt>279
</span><span class=lnt>280
</span><span class=lnt>281
</span><span class=lnt>282
</span><span class=lnt>283
</span><span class=lnt>284
</span><span class=lnt>285
</span><span class=lnt>286
</span><span class=lnt>287
</span><span class=lnt>288
</span><span class=lnt>289
</span><span class=lnt>290
</span><span class=lnt>291
</span><span class=lnt>292
</span><span class=lnt>293
</span><span class=lnt>294
</span><span class=lnt>295
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>asyncio</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Callable</span><span class=p>,</span> <span class=n>List</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>dataclasses</span> <span class=kn>import</span> <span class=n>dataclass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@dataclass</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>McpEvent</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;MCP事件&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>type</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>data</span><span class=p>:</span> <span class=nb>dict</span>
</span></span><span class=line><span class=cl>    <span class=n>timestamp</span><span class=p>:</span> <span class=nb>float</span>
</span></span><span class=line><span class=cl>    <span class=n>source</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>EventBus</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;事件总线&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>subscribers</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>List</span><span class=p>[</span><span class=n>Callable</span><span class=p>]]</span> <span class=o>=</span> <span class=n>defaultdict</span><span class=p>(</span><span class=nb>list</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>event_history</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>McpEvent</span><span class=p>]</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>subscribe</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>event_type</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>handler</span><span class=p>:</span> <span class=n>Callable</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;订阅事件&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>subscribers</span><span class=p>[</span><span class=n>event_type</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>handler</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>unsubscribe</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>event_type</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>handler</span><span class=p>:</span> <span class=n>Callable</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;取消订阅&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>handler</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>subscribers</span><span class=p>[</span><span class=n>event_type</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>subscribers</span><span class=p>[</span><span class=n>event_type</span><span class=p>]</span><span class=o>.</span><span class=n>remove</span><span class=p>(</span><span class=n>handler</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>publish</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>event</span><span class=p>:</span> <span class=n>McpEvent</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;发布事件&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>event_history</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>event</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 通知所有订阅者</span>
</span></span><span class=line><span class=cl>        <span class=n>handlers</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>subscribers</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>event</span><span class=o>.</span><span class=n>type</span><span class=p>,</span> <span class=p>[])</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>handlers</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>await</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>gather</span><span class=p>(</span><span class=o>*</span><span class=p>[</span><span class=n>handler</span><span class=p>(</span><span class=n>event</span><span class=p>)</span> <span class=k>for</span> <span class=n>handler</span> <span class=ow>in</span> <span class=n>handlers</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_event_history</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>event_type</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span> <span class=n>limit</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>100</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=n>McpEvent</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;获取事件历史&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>events</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>event_history</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>event_type</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>events</span> <span class=o>=</span> <span class=p>[</span><span class=n>e</span> <span class=k>for</span> <span class=n>e</span> <span class=ow>in</span> <span class=n>events</span> <span class=k>if</span> <span class=n>e</span><span class=o>.</span><span class=n>type</span> <span class=o>==</span> <span class=n>event_type</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>events</span><span class=p>[</span><span class=o>-</span><span class=n>limit</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>EventDrivenServer</span><span class=p>(</span><span class=n>McpServer</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span><span class=s2>&#34;event-driven-server&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>event_bus</span> <span class=o>=</span> <span class=n>EventBus</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>setup_event_handlers</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>setup_event_handlers</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;设置事件处理器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>event_bus</span><span class=o>.</span><span class=n>subscribe</span><span class=p>(</span><span class=s2>&#34;resource.created&#34;</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>on_resource_created</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>event_bus</span><span class=o>.</span><span class=n>subscribe</span><span class=p>(</span><span class=s2>&#34;resource.updated&#34;</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>on_resource_updated</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>event_bus</span><span class=o>.</span><span class=n>subscribe</span><span class=p>(</span><span class=s2>&#34;tool.executed&#34;</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>on_tool_executed</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>event_bus</span><span class=o>.</span><span class=n>subscribe</span><span class=p>(</span><span class=s2>&#34;client.connected&#34;</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>on_client_connected</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>on_resource_created</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>event</span><span class=p>:</span> <span class=n>McpEvent</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;资源创建事件处理&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>resource_uri</span> <span class=o>=</span> <span class=n>event</span><span class=o>.</span><span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;uri&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>send_notification</span><span class=p>(</span><span class=s2>&#34;notifications/resources/created&#34;</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;uri&#34;</span><span class=p>:</span> <span class=n>resource_uri</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;timestamp&#34;</span><span class=p>:</span> <span class=n>event</span><span class=o>.</span><span class=n>timestamp</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>on_tool_executed</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>event</span><span class=p>:</span> <span class=n>McpEvent</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;工具执行事件处理&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>tool_name</span> <span class=o>=</span> <span class=n>event</span><span class=o>.</span><span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;tool_name&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>execution_time</span> <span class=o>=</span> <span class=n>event</span><span class=o>.</span><span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;duration&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 记录性能指标</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>record_performance_metric</span><span class=p>(</span><span class=n>tool_name</span><span class=p>,</span> <span class=n>execution_time</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 如果执行时间过长，发送警告</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>execution_time</span> <span class=o>&gt;</span> <span class=mi>10</span><span class=p>:</span>  <span class=c1># 10秒</span>
</span></span><span class=line><span class=cl>            <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>send_notification</span><span class=p>(</span><span class=s2>&#34;notifications/performance/warning&#34;</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;tool&#34;</span><span class=p>:</span> <span class=n>tool_name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;duration&#34;</span><span class=p>:</span> <span class=n>execution_time</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;message&#34;</span><span class=p>:</span> <span class=s2>&#34;工具执行时间过长&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>### 分布式MCP架构</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#### 服务发现与负载均衡</span>
</span></span><span class=line><span class=cl><span class=err>```</span><span class=n>python</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>consul</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>hashlib</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>List</span><span class=p>,</span> <span class=n>Dict</span><span class=p>,</span> <span class=n>Optional</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ServiceDiscovery</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;服务发现&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>consul_host</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s2>&#34;localhost&#34;</span><span class=p>,</span> <span class=n>consul_port</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>8500</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>consul</span> <span class=o>=</span> <span class=n>consul</span><span class=o>.</span><span class=n>Consul</span><span class=p>(</span><span class=n>host</span><span class=o>=</span><span class=n>consul_host</span><span class=p>,</span> <span class=n>port</span><span class=o>=</span><span class=n>consul_port</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>service_cache</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>cache_ttl</span> <span class=o>=</span> <span class=mi>30</span>  <span class=c1># 缓存30秒</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>register_service</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>service_name</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>host</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>port</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>tags</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;注册服务&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>service_id</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>service_name</span><span class=si>}</span><span class=s2>-</span><span class=si>{</span><span class=n>host</span><span class=si>}</span><span class=s2>-</span><span class=si>{</span><span class=n>port</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>consul</span><span class=o>.</span><span class=n>agent</span><span class=o>.</span><span class=n>service</span><span class=o>.</span><span class=n>register</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>name</span><span class=o>=</span><span class=n>service_name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>service_id</span><span class=o>=</span><span class=n>service_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>address</span><span class=o>=</span><span class=n>host</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>port</span><span class=o>=</span><span class=n>port</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>tags</span><span class=o>=</span><span class=n>tags</span> <span class=ow>or</span> <span class=p>[],</span>
</span></span><span class=line><span class=cl>            <span class=n>check</span><span class=o>=</span><span class=n>consul</span><span class=o>.</span><span class=n>Check</span><span class=o>.</span><span class=n>http</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;http://</span><span class=si>{</span><span class=n>host</span><span class=si>}</span><span class=s2>:</span><span class=si>{</span><span class=n>port</span><span class=si>}</span><span class=s2>/health&#34;</span><span class=p>,</span> <span class=n>interval</span><span class=o>=</span><span class=s2>&#34;10s&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>discover_services</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>service_name</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=n>Dict</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;发现服务&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 检查缓存</span>
</span></span><span class=line><span class=cl>        <span class=n>cache_key</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;services:</span><span class=si>{</span><span class=n>service_name</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>cache_key</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>service_cache</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>cached_data</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>service_cache</span><span class=p>[</span><span class=n>cache_key</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>cached_data</span><span class=p>[</span><span class=s1>&#39;timestamp&#39;</span><span class=p>]</span> <span class=o>&lt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>cache_ttl</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>cached_data</span><span class=p>[</span><span class=s1>&#39;services&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 从Consul获取服务列表</span>
</span></span><span class=line><span class=cl>        <span class=n>_</span><span class=p>,</span> <span class=n>services</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>consul</span><span class=o>.</span><span class=n>health</span><span class=o>.</span><span class=n>service</span><span class=p>(</span><span class=n>service_name</span><span class=p>,</span> <span class=n>passing</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>service_list</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>service</span> <span class=ow>in</span> <span class=n>services</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>service_info</span> <span class=o>=</span> <span class=n>service</span><span class=p>[</span><span class=s1>&#39;Service&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>service_list</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;id&#39;</span><span class=p>:</span> <span class=n>service_info</span><span class=p>[</span><span class=s1>&#39;ID&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;address&#39;</span><span class=p>:</span> <span class=n>service_info</span><span class=p>[</span><span class=s1>&#39;Address&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;port&#39;</span><span class=p>:</span> <span class=n>service_info</span><span class=p>[</span><span class=s1>&#39;Port&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;tags&#39;</span><span class=p>:</span> <span class=n>service_info</span><span class=p>[</span><span class=s1>&#39;Tags&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=p>})</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 更新缓存</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>service_cache</span><span class=p>[</span><span class=n>cache_key</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;services&#39;</span><span class=p>:</span> <span class=n>service_list</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;timestamp&#39;</span><span class=p>:</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>service_list</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>LoadBalancer</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;负载均衡器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>strategy</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s2>&#34;round_robin&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>strategy</span> <span class=o>=</span> <span class=n>strategy</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>round_robin_index</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>service_weights</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>service_health</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>select_service</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>services</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>Dict</span><span class=p>],</span> <span class=n>client_id</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=kc>None</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=n>Dict</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;选择服务实例&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>services</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 过滤健康的服务</span>
</span></span><span class=line><span class=cl>        <span class=n>healthy_services</span> <span class=o>=</span> <span class=p>[</span><span class=n>s</span> <span class=k>for</span> <span class=n>s</span> <span class=ow>in</span> <span class=n>services</span> <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>service_health</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>s</span><span class=p>[</span><span class=s1>&#39;id&#39;</span><span class=p>],</span> <span class=kc>True</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>healthy_services</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>strategy</span> <span class=o>==</span> <span class=s2>&#34;round_robin&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_round_robin_select</span><span class=p>(</span><span class=n>healthy_services</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=bp>self</span><span class=o>.</span><span class=n>strategy</span> <span class=o>==</span> <span class=s2>&#34;weighted&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_weighted_select</span><span class=p>(</span><span class=n>healthy_services</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=bp>self</span><span class=o>.</span><span class=n>strategy</span> <span class=o>==</span> <span class=s2>&#34;consistent_hash&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_consistent_hash_select</span><span class=p>(</span><span class=n>healthy_services</span><span class=p>,</span> <span class=n>client_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>healthy_services</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_round_robin_select</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>services</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>Dict</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;轮询选择&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>service</span> <span class=o>=</span> <span class=n>services</span><span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>round_robin_index</span> <span class=o>%</span> <span class=nb>len</span><span class=p>(</span><span class=n>services</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>round_robin_index</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>service</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_weighted_select</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>services</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>Dict</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;加权选择&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 根据服务权重选择</span>
</span></span><span class=line><span class=cl>        <span class=n>total_weight</span> <span class=o>=</span> <span class=nb>sum</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>service_weights</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>s</span><span class=p>[</span><span class=s1>&#39;id&#39;</span><span class=p>],</span> <span class=mi>1</span><span class=p>)</span> <span class=k>for</span> <span class=n>s</span> <span class=ow>in</span> <span class=n>services</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=kn>import</span> <span class=nn>random</span>
</span></span><span class=line><span class=cl>        <span class=n>target</span> <span class=o>=</span> <span class=n>random</span><span class=o>.</span><span class=n>uniform</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>total_weight</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>current_weight</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>service</span> <span class=ow>in</span> <span class=n>services</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>current_weight</span> <span class=o>+=</span> <span class=bp>self</span><span class=o>.</span><span class=n>service_weights</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>service</span><span class=p>[</span><span class=s1>&#39;id&#39;</span><span class=p>],</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>current_weight</span> <span class=o>&gt;=</span> <span class=n>target</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>service</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>services</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_consistent_hash_select</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>services</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>Dict</span><span class=p>],</span> <span class=n>client_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;一致性哈希选择&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>client_id</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>services</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 计算客户端ID的哈希值</span>
</span></span><span class=line><span class=cl>        <span class=n>client_hash</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>hashlib</span><span class=o>.</span><span class=n>md5</span><span class=p>(</span><span class=n>client_id</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span><span class=o>.</span><span class=n>hexdigest</span><span class=p>(),</span> <span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 为每个服务计算哈希值并找到最接近的</span>
</span></span><span class=line><span class=cl>        <span class=n>service_hashes</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>service</span> <span class=ow>in</span> <span class=n>services</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>service_key</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>service</span><span class=p>[</span><span class=s1>&#39;address&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>:</span><span class=si>{</span><span class=n>service</span><span class=p>[</span><span class=s1>&#39;port&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>            <span class=n>service_hash</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>hashlib</span><span class=o>.</span><span class=n>md5</span><span class=p>(</span><span class=n>service_key</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span><span class=o>.</span><span class=n>hexdigest</span><span class=p>(),</span> <span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>service_hashes</span><span class=o>.</span><span class=n>append</span><span class=p>((</span><span class=n>service_hash</span><span class=p>,</span> <span class=n>service</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 排序并找到大于等于客户端哈希的第一个服务</span>
</span></span><span class=line><span class=cl>        <span class=n>service_hashes</span><span class=o>.</span><span class=n>sort</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>service_hash</span><span class=p>,</span> <span class=n>service</span> <span class=ow>in</span> <span class=n>service_hashes</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>service_hash</span> <span class=o>&gt;=</span> <span class=n>client_hash</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>service</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 如果没找到，返回第一个服务（环形结构）</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>service_hashes</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>DistributedMcpClient</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;分布式MCP客户端&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>service_name</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>service_name</span> <span class=o>=</span> <span class=n>service_name</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>service_discovery</span> <span class=o>=</span> <span class=n>ServiceDiscovery</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>load_balancer</span> <span class=o>=</span> <span class=n>LoadBalancer</span><span class=p>(</span><span class=n>strategy</span><span class=o>=</span><span class=s2>&#34;consistent_hash&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>circuit_breakers</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>call_service</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>method</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>params</span><span class=p>:</span> <span class=nb>dict</span><span class=p>,</span> <span class=n>client_id</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;调用分布式服务&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 服务发现</span>
</span></span><span class=line><span class=cl>        <span class=n>services</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>service_discovery</span><span class=o>.</span><span class=n>discover_services</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>service_name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 负载均衡选择服务</span>
</span></span><span class=line><span class=cl>        <span class=n>selected_service</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>load_balancer</span><span class=o>.</span><span class=n>select_service</span><span class=p>(</span><span class=n>services</span><span class=p>,</span> <span class=n>client_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>selected_service</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=n>McpError</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>code</span><span class=o>=</span><span class=n>ErrorCode</span><span class=o>.</span><span class=n>SERVICE_UNAVAILABLE</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>message</span><span class=o>=</span><span class=sa>f</span><span class=s2>&#34;没有可用的 </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>service_name</span><span class=si>}</span><span class=s2> 服务实例&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 检查熔断器</span>
</span></span><span class=line><span class=cl>        <span class=n>service_key</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>selected_service</span><span class=p>[</span><span class=s1>&#39;address&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>:</span><span class=si>{</span><span class=n>selected_service</span><span class=p>[</span><span class=s1>&#39;port&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>circuit_breaker</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>circuit_breakers</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>service_key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>circuit_breaker</span> <span class=ow>and</span> <span class=n>circuit_breaker</span><span class=o>.</span><span class=n>is_open</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=n>McpError</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>code</span><span class=o>=</span><span class=n>ErrorCode</span><span class=o>.</span><span class=n>SERVICE_UNAVAILABLE</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>message</span><span class=o>=</span><span class=sa>f</span><span class=s2>&#34;服务 </span><span class=si>{</span><span class=n>service_key</span><span class=si>}</span><span class=s2> 熔断中&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 调用远程服务</span>
</span></span><span class=line><span class=cl>            <span class=n>result</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>call_remote_service</span><span class=p>(</span><span class=n>selected_service</span><span class=p>,</span> <span class=n>method</span><span class=p>,</span> <span class=n>params</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 记录成功调用</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>circuit_breaker</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>circuit_breaker</span><span class=o>.</span><span class=n>record_success</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 记录失败调用</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>circuit_breaker</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>circuit_breaker</span><span class=o>.</span><span class=n>record_failure</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=n>e</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>CircuitBreaker</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;熔断器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>failure_threshold</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>5</span><span class=p>,</span> <span class=n>timeout</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>60</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>failure_threshold</span> <span class=o>=</span> <span class=n>failure_threshold</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>timeout</span> <span class=o>=</span> <span class=n>timeout</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>failure_count</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>last_failure_time</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>state</span> <span class=o>=</span> <span class=s2>&#34;CLOSED&#34;</span>  <span class=c1># CLOSED, OPEN, HALF_OPEN</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>is_open</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;检查熔断器是否开启&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>state</span> <span class=o>==</span> <span class=s2>&#34;OPEN&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=bp>self</span><span class=o>.</span><span class=n>last_failure_time</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>timeout</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>state</span> <span class=o>=</span> <span class=s2>&#34;HALF_OPEN&#34;</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>record_success</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;记录成功调用&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>failure_count</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>state</span> <span class=o>=</span> <span class=s2>&#34;CLOSED&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>record_failure</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;记录失败调用&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>failure_count</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>last_failure_time</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>failure_count</span> <span class=o>&gt;=</span> <span class=bp>self</span><span class=o>.</span><span class=n>failure_threshold</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>state</span> <span class=o>=</span> <span class=s2>&#34;OPEN&#34;</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=云原生部署方案>云原生部署方案</h3><h4 id=kubernetes配置>Kubernetes配置</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span><span class=lnt>91
</span><span class=lnt>92
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># mcp-server-deployment.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mcp-server</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>mcp-server</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>mcp-server</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>mcp-server</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mcp-server</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>myregistry/mcp-server:latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>8000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>DATABASE_URL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>secretKeyRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mcp-secrets</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>database-url</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>REDIS_URL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>configMapKeyRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mcp-config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>redis-url</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;256Mi&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;250m&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>limits</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;512Mi&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;500m&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>livenessProbe</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>httpGet</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/health</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>8000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>initialDelaySeconds</span><span class=p>:</span><span class=w> </span><span class=m>30</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>periodSeconds</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>readinessProbe</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>httpGet</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/ready</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>8000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>initialDelaySeconds</span><span class=p>:</span><span class=w> </span><span class=m>5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>periodSeconds</span><span class=p>:</span><span class=w> </span><span class=m>5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mcp-server-service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>mcp-server</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>TCP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>8000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>LoadBalancer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>autoscaling/v2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>HorizontalPodAutoscaler</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mcp-server-hpa</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>scaleTargetRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mcp-server</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>minReplicas</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>maxReplicas</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>metrics</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Resource</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cpu</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>target</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Utilization</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>averageUtilization</span><span class=p>:</span><span class=w> </span><span class=m>70</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Resource</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>memory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>target</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Utilization</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>averageUtilization</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=helm-chart配置>Helm Chart配置</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># values.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>replicaCount</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>image</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>repository</span><span class=p>:</span><span class=w> </span><span class=l>myregistry/mcp-server</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tag</span><span class=p>:</span><span class=w> </span><span class=l>latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>pullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>IfNotPresent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>LoadBalancer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>8000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>ingress</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>kubernetes.io/ingress.class</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>cert-manager.io/cluster-issuer</span><span class=p>:</span><span class=w> </span><span class=l>letsencrypt-prod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>hosts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=l>mcp-api.example.com</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>paths</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>pathType</span><span class=p>:</span><span class=w> </span><span class=l>Prefix</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tls</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>secretName</span><span class=p>:</span><span class=w> </span><span class=l>mcp-api-tls</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>hosts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>mcp-api.example.com</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>autoscaling</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>minReplicas</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>maxReplicas</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>targetCPUUtilizationPercentage</span><span class=p>:</span><span class=w> </span><span class=m>70</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>targetMemoryUtilizationPercentage</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>limits</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>500m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>512Mi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>250m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>256Mi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 配置管理</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>config</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>database</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>postgresql://user:pass@postgres:5432/mcpdb</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>pool_size</span><span class=p>:</span><span class=w> </span><span class=m>20</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>timeout</span><span class=p>:</span><span class=w> </span><span class=m>30</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>redis</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>redis://redis:6379/0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ttl</span><span class=p>:</span><span class=w> </span><span class=m>3600</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>monitoring</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>prometheus</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>9090</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>security</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>jwt_secret</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;your-secret-key&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>cors_origins</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;https://app.example.com&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>             </span>- <span class=s2>&#34;https://admin.example.com&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=高级调试与诊断工具>高级调试与诊断工具</h3><h4 id=mcp协议调试器>MCP协议调试器</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>json</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>asyncio</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Dict</span><span class=p>,</span> <span class=n>List</span><span class=p>,</span> <span class=n>Any</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>datetime</span> <span class=kn>import</span> <span class=n>datetime</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>McpProtocolDebugger</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;MCP协议调试器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>enable_trace</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>True</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>enable_trace</span> <span class=o>=</span> <span class=n>enable_trace</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>message_history</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>Dict</span><span class=p>]</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>error_history</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>Dict</span><span class=p>]</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>performance_metrics</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>List</span><span class=p>]</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>trace_message</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>direction</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>message</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;跟踪消息&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>enable_trace</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>trace_entry</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;timestamp&#39;</span><span class=p>:</span> <span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>()</span><span class=o>.</span><span class=n>isoformat</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;direction&#39;</span><span class=p>:</span> <span class=n>direction</span><span class=p>,</span>  <span class=c1># &#39;incoming&#39; 或 &#39;outgoing&#39;</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;message&#39;</span><span class=p>:</span> <span class=n>message</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;size&#39;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>message</span><span class=p>)</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>message_history</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>trace_entry</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 保持历史记录大小</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>message_history</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>1000</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>message_history</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>message_history</span><span class=p>[</span><span class=o>-</span><span class=mi>1000</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>trace_error</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>error</span><span class=p>:</span> <span class=ne>Exception</span><span class=p>,</span> <span class=n>context</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;跟踪错误&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>error_entry</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;timestamp&#39;</span><span class=p>:</span> <span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>()</span><span class=o>.</span><span class=n>isoformat</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;error_type&#39;</span><span class=p>:</span> <span class=nb>type</span><span class=p>(</span><span class=n>error</span><span class=p>)</span><span class=o>.</span><span class=vm>__name__</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;error_message&#39;</span><span class=p>:</span> <span class=nb>str</span><span class=p>(</span><span class=n>error</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;context&#39;</span><span class=p>:</span> <span class=n>context</span> <span class=ow>or</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>error_history</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>error_entry</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>error_history</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>100</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>error_history</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>error_history</span><span class=p>[</span><span class=o>-</span><span class=mi>100</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>record_performance</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>operation</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>duration</span><span class=p>:</span> <span class=nb>float</span><span class=p>,</span> <span class=n>metadata</span><span class=p>:</span> <span class=n>Dict</span> <span class=o>=</span> <span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;记录性能数据&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>operation</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>performance_metrics</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>performance_metrics</span><span class=p>[</span><span class=n>operation</span><span class=p>]</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>performance_entry</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;timestamp&#39;</span><span class=p>:</span> <span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>()</span><span class=o>.</span><span class=n>isoformat</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;duration&#39;</span><span class=p>:</span> <span class=n>duration</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;metadata&#39;</span><span class=p>:</span> <span class=n>metadata</span> <span class=ow>or</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>performance_metrics</span><span class=p>[</span><span class=n>operation</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>performance_entry</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 保持每个操作最多100条记录</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>performance_metrics</span><span class=p>[</span><span class=n>operation</span><span class=p>])</span> <span class=o>&gt;</span> <span class=mi>100</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>performance_metrics</span><span class=p>[</span><span class=n>operation</span><span class=p>]</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>performance_metrics</span><span class=p>[</span><span class=n>operation</span><span class=p>][</span><span class=o>-</span><span class=mi>100</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_debug_report</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;生成调试报告&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>report</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;summary&#39;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;total_messages&#39;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>message_history</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;total_errors&#39;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>error_history</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;performance_operations&#39;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>performance_metrics</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;recent_messages&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>message_history</span><span class=p>[</span><span class=o>-</span><span class=mi>10</span><span class=p>:],</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;recent_errors&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>error_history</span><span class=p>[</span><span class=o>-</span><span class=mi>5</span><span class=p>:],</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;performance_summary&#39;</span><span class=p>:</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 性能摘要</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>operation</span><span class=p>,</span> <span class=n>metrics</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>performance_metrics</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>metrics</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>durations</span> <span class=o>=</span> <span class=p>[</span><span class=n>m</span><span class=p>[</span><span class=s1>&#39;duration&#39;</span><span class=p>]</span> <span class=k>for</span> <span class=n>m</span> <span class=ow>in</span> <span class=n>metrics</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                <span class=n>report</span><span class=p>[</span><span class=s1>&#39;performance_summary&#39;</span><span class=p>][</span><span class=n>operation</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;count&#39;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=n>durations</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;avg_duration&#39;</span><span class=p>:</span> <span class=nb>sum</span><span class=p>(</span><span class=n>durations</span><span class=p>)</span> <span class=o>/</span> <span class=nb>len</span><span class=p>(</span><span class=n>durations</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;min_duration&#39;</span><span class=p>:</span> <span class=nb>min</span><span class=p>(</span><span class=n>durations</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;max_duration&#39;</span><span class=p>:</span> <span class=nb>max</span><span class=p>(</span><span class=n>durations</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>report</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>export_trace</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>filename</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;导出跟踪数据&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>filename</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>filename</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;mcp_trace_</span><span class=si>{</span><span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>()</span><span class=o>.</span><span class=n>strftime</span><span class=p>(</span><span class=s1>&#39;%Y%m</span><span class=si>%d</span><span class=s1>_%H%M%S&#39;</span><span class=p>)</span><span class=si>}</span><span class=s2>.json&#34;</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>trace_data</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;messages&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>message_history</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;errors&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>error_history</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;performance&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>performance_metrics</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;exported_at&#39;</span><span class=p>:</span> <span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>()</span><span class=o>.</span><span class=n>isoformat</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>filename</span><span class=p>,</span> <span class=s1>&#39;w&#39;</span><span class=p>,</span> <span class=n>encoding</span><span class=o>=</span><span class=s1>&#39;utf-8&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>f</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>json</span><span class=o>.</span><span class=n>dump</span><span class=p>(</span><span class=n>trace_data</span><span class=p>,</span> <span class=n>f</span><span class=p>,</span> <span class=n>ensure_ascii</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span> <span class=n>indent</span><span class=o>=</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>filename</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>DebuggableMcpServer</span><span class=p>(</span><span class=n>McpServer</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;可调试的MCP服务器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>debug_mode</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>False</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span><span class=n>name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>debug_mode</span> <span class=o>=</span> <span class=n>debug_mode</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>debugger</span> <span class=o>=</span> <span class=n>McpProtocolDebugger</span><span class=p>(</span><span class=n>enable_trace</span><span class=o>=</span><span class=n>debug_mode</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>request_id_counter</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>handle_request</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>method</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>params</span><span class=p>:</span> <span class=nb>dict</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;处理请求（带调试功能）&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>request_id_counter</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=n>request_id</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;req_</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>request_id_counter</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>start_time</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 跟踪入站消息</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>debug_mode</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>debugger</span><span class=o>.</span><span class=n>trace_message</span><span class=p>(</span><span class=s1>&#39;incoming&#39;</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;id&#39;</span><span class=p>:</span> <span class=n>request_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;method&#39;</span><span class=p>:</span> <span class=n>method</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;params&#39;</span><span class=p>:</span> <span class=n>params</span>
</span></span><span class=line><span class=cl>            <span class=p>})</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>result</span> <span class=o>=</span> <span class=k>await</span> <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=n>handle_request</span><span class=p>(</span><span class=n>method</span><span class=p>,</span> <span class=n>params</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 跟踪出站响应</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>debug_mode</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>debugger</span><span class=o>.</span><span class=n>trace_message</span><span class=p>(</span><span class=s1>&#39;outgoing&#39;</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;id&#39;</span><span class=p>:</span> <span class=n>request_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;result&#39;</span><span class=p>:</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>                <span class=p>})</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 跟踪错误</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>debugger</span><span class=o>.</span><span class=n>trace_error</span><span class=p>(</span><span class=n>e</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;request_id&#39;</span><span class=p>:</span> <span class=n>request_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;method&#39;</span><span class=p>:</span> <span class=n>method</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;params&#39;</span><span class=p>:</span> <span class=n>params</span>
</span></span><span class=line><span class=cl>            <span class=p>})</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 跟踪错误响应</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>debug_mode</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=bp>self</span><span class=o>.</span><span class=n>debugger</span><span class=o>.</span><span class=n>trace_message</span><span class=p>(</span><span class=s1>&#39;outgoing&#39;</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;id&#39;</span><span class=p>:</span> <span class=n>request_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;error&#39;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=s1>&#39;code&#39;</span><span class=p>:</span> <span class=nb>getattr</span><span class=p>(</span><span class=n>e</span><span class=p>,</span> <span class=s1>&#39;code&#39;</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                        <span class=s1>&#39;message&#39;</span><span class=p>:</span> <span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=p>})</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>raise</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>finally</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 记录性能</span>
</span></span><span class=line><span class=cl>            <span class=n>duration</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>start_time</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>debugger</span><span class=o>.</span><span class=n>record_performance</span><span class=p>(</span><span class=n>method</span><span class=p>,</span> <span class=n>duration</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;request_id&#39;</span><span class=p>:</span> <span class=n>request_id</span>
</span></span><span class=line><span class=cl>            <span class=p>})</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>get_debug_info</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;获取调试信息&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>debugger</span><span class=o>.</span><span class=n>get_debug_report</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>export_debug_trace</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;导出调试跟踪&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>debugger</span><span class=o>.</span><span class=n>export_trace</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=智能错误恢复机制>智能错误恢复机制</h3><h4 id=自动故障恢复>自动故障恢复</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>asyncio</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Callable</span><span class=p>,</span> <span class=n>Dict</span><span class=p>,</span> <span class=n>Any</span><span class=p>,</span> <span class=n>Optional</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>enum</span> <span class=kn>import</span> <span class=n>Enum</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>RecoveryStrategy</span><span class=p>(</span><span class=n>Enum</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;恢复策略&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>RETRY</span> <span class=o>=</span> <span class=s2>&#34;retry&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>FALLBACK</span> <span class=o>=</span> <span class=s2>&#34;fallback&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>CIRCUIT_BREAKER</span> <span class=o>=</span> <span class=s2>&#34;circuit_breaker&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>GRACEFUL_DEGRADATION</span> <span class=o>=</span> <span class=s2>&#34;graceful_degradation&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ErrorRecoveryManager</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;错误恢复管理器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>recovery_strategies</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>RecoveryStrategy</span><span class=p>]</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>fallback_handlers</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Callable</span><span class=p>]</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>retry_policies</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Dict</span><span class=p>]</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>circuit_breakers</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>CircuitBreaker</span><span class=p>]</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>register_strategy</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>operation</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>strategy</span><span class=p>:</span> <span class=n>RecoveryStrategy</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;注册恢复策略&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>recovery_strategies</span><span class=p>[</span><span class=n>operation</span><span class=p>]</span> <span class=o>=</span> <span class=n>strategy</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>strategy</span> <span class=o>==</span> <span class=n>RecoveryStrategy</span><span class=o>.</span><span class=n>RETRY</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>retry_policies</span><span class=p>[</span><span class=n>operation</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;max_attempts&#39;</span><span class=p>:</span> <span class=n>kwargs</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;max_attempts&#39;</span><span class=p>,</span> <span class=mi>3</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;delay&#39;</span><span class=p>:</span> <span class=n>kwargs</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;delay&#39;</span><span class=p>,</span> <span class=mf>1.0</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;backoff_multiplier&#39;</span><span class=p>:</span> <span class=n>kwargs</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;backoff_multiplier&#39;</span><span class=p>,</span> <span class=mf>2.0</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;max_delay&#39;</span><span class=p>:</span> <span class=n>kwargs</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;max_delay&#39;</span><span class=p>,</span> <span class=mf>30.0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>strategy</span> <span class=o>==</span> <span class=n>RecoveryStrategy</span><span class=o>.</span><span class=n>CIRCUIT_BREAKER</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>circuit_breakers</span><span class=p>[</span><span class=n>operation</span><span class=p>]</span> <span class=o>=</span> <span class=n>CircuitBreaker</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>failure_threshold</span><span class=o>=</span><span class=n>kwargs</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;failure_threshold&#39;</span><span class=p>,</span> <span class=mi>5</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=n>timeout</span><span class=o>=</span><span class=n>kwargs</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;timeout&#39;</span><span class=p>,</span> <span class=mi>60</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>register_fallback</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>operation</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>handler</span><span class=p>:</span> <span class=n>Callable</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;注册降级处理器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>fallback_handlers</span><span class=p>[</span><span class=n>operation</span><span class=p>]</span> <span class=o>=</span> <span class=n>handler</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>execute_with_recovery</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>operation</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>func</span><span class=p>:</span> <span class=n>Callable</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;带恢复机制的执行&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>strategy</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>recovery_strategies</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>operation</span><span class=p>,</span> <span class=n>RecoveryStrategy</span><span class=o>.</span><span class=n>RETRY</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>strategy</span> <span class=o>==</span> <span class=n>RecoveryStrategy</span><span class=o>.</span><span class=n>RETRY</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_execute_with_retry</span><span class=p>(</span><span class=n>operation</span><span class=p>,</span> <span class=n>func</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>strategy</span> <span class=o>==</span> <span class=n>RecoveryStrategy</span><span class=o>.</span><span class=n>FALLBACK</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_execute_with_fallback</span><span class=p>(</span><span class=n>operation</span><span class=p>,</span> <span class=n>func</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>strategy</span> <span class=o>==</span> <span class=n>RecoveryStrategy</span><span class=o>.</span><span class=n>CIRCUIT_BREAKER</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_execute_with_circuit_breaker</span><span class=p>(</span><span class=n>operation</span><span class=p>,</span> <span class=n>func</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>strategy</span> <span class=o>==</span> <span class=n>RecoveryStrategy</span><span class=o>.</span><span class=n>GRACEFUL_DEGRADATION</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_execute_with_degradation</span><span class=p>(</span><span class=n>operation</span><span class=p>,</span> <span class=n>func</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=k>await</span> <span class=n>func</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>_execute_with_retry</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>operation</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>func</span><span class=p>:</span> <span class=n>Callable</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;重试执行&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>policy</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>retry_policies</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>operation</span><span class=p>,</span> <span class=p>{})</span>
</span></span><span class=line><span class=cl>        <span class=n>max_attempts</span> <span class=o>=</span> <span class=n>policy</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;max_attempts&#39;</span><span class=p>,</span> <span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>delay</span> <span class=o>=</span> <span class=n>policy</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;delay&#39;</span><span class=p>,</span> <span class=mf>1.0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>backoff_multiplier</span> <span class=o>=</span> <span class=n>policy</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;backoff_multiplier&#39;</span><span class=p>,</span> <span class=mf>2.0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>max_delay</span> <span class=o>=</span> <span class=n>policy</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;max_delay&#39;</span><span class=p>,</span> <span class=mf>30.0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>last_exception</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>        <span class=n>current_delay</span> <span class=o>=</span> <span class=n>delay</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>attempt</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>max_attempts</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=k>await</span> <span class=n>func</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>last_exception</span> <span class=o>=</span> <span class=n>e</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>attempt</span> <span class=o>&lt;</span> <span class=n>max_attempts</span> <span class=o>-</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>await</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=n>current_delay</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=n>current_delay</span> <span class=o>=</span> <span class=nb>min</span><span class=p>(</span><span class=n>current_delay</span> <span class=o>*</span> <span class=n>backoff_multiplier</span><span class=p>,</span> <span class=n>max_delay</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 所有重试都失败，抛出最后一个异常</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=n>last_exception</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>_execute_with_fallback</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>operation</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>func</span><span class=p>:</span> <span class=n>Callable</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;降级执行&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=k>await</span> <span class=n>func</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>fallback_handler</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fallback_handlers</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>operation</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>fallback_handler</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=k>await</span> <span class=n>fallback_handler</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=n>e</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>_execute_with_circuit_breaker</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>operation</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>func</span><span class=p>:</span> <span class=n>Callable</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;熔断器执行&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>circuit_breaker</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>circuit_breakers</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>operation</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>circuit_breaker</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=k>await</span> <span class=n>func</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>circuit_breaker</span><span class=o>.</span><span class=n>is_open</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=n>McpError</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>code</span><span class=o>=</span><span class=n>ErrorCode</span><span class=o>.</span><span class=n>SERVICE_UNAVAILABLE</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>message</span><span class=o>=</span><span class=sa>f</span><span class=s2>&#34;服务 </span><span class=si>{</span><span class=n>operation</span><span class=si>}</span><span class=s2> 熔断中&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>result</span> <span class=o>=</span> <span class=k>await</span> <span class=n>func</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>circuit_breaker</span><span class=o>.</span><span class=n>record_success</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>circuit_breaker</span><span class=o>.</span><span class=n>record_failure</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=n>e</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>_execute_with_degradation</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>operation</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>func</span><span class=p>:</span> <span class=n>Callable</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;优雅降级执行&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=k>await</span> <span class=n>func</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 记录错误但返回降级结果</span>
</span></span><span class=line><span class=cl>            <span class=n>fallback_handler</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>fallback_handlers</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>operation</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>fallback_handler</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=k>await</span> <span class=n>fallback_handler</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>except</span> <span class=ne>Exception</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=c1># 降级也失败，返回默认值</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_get_default_response</span><span class=p>(</span><span class=n>operation</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_get_default_response</span><span class=p>(</span><span class=n>operation</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_get_default_response</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>operation</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;获取默认响应&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>operation</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s1>&#39;read_&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>operation</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s1>&#39;list_&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>operation</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s1>&#39;call_&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>ToolResult</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>content</span><span class=o>=</span><span class=p>[</span><span class=n>TextContent</span><span class=p>(</span><span class=nb>type</span><span class=o>=</span><span class=s2>&#34;text&#34;</span><span class=p>,</span> <span class=n>text</span><span class=o>=</span><span class=s2>&#34;服务暂时不可用&#34;</span><span class=p>)],</span>
</span></span><span class=line><span class=cl>                <span class=n>isError</span><span class=o>=</span><span class=kc>True</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>ResilientMcpServer</span><span class=p>(</span><span class=n>McpServer</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;具有错误恢复能力的MCP服务器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span><span class=n>name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>recovery_manager</span> <span class=o>=</span> <span class=n>ErrorRecoveryManager</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>setup_recovery_strategies</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>setup_recovery_strategies</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;设置恢复策略&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 资源读取使用重试策略</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>recovery_manager</span><span class=o>.</span><span class=n>register_strategy</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;read_resource&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>RecoveryStrategy</span><span class=o>.</span><span class=n>RETRY</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>max_attempts</span><span class=o>=</span><span class=mi>3</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>delay</span><span class=o>=</span><span class=mf>1.0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>backoff_multiplier</span><span class=o>=</span><span class=mf>2.0</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 工具调用使用熔断器</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>recovery_manager</span><span class=o>.</span><span class=n>register_strategy</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;call_tool&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>RecoveryStrategy</span><span class=o>.</span><span class=n>CIRCUIT_BREAKER</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>failure_threshold</span><span class=o>=</span><span class=mi>5</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>timeout</span><span class=o>=</span><span class=mi>60</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 注册降级处理器</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>recovery_manager</span><span class=o>.</span><span class=n>register_fallback</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;read_resource&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>fallback_read_resource</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>recovery_manager</span><span class=o>.</span><span class=n>register_fallback</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;call_tool&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>fallback_call_tool</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>read_resource</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>uri</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;带恢复机制的资源读取&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>recovery_manager</span><span class=o>.</span><span class=n>execute_with_recovery</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;read_resource&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=n>read_resource</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>uri</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>call_tool</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>arguments</span><span class=p>:</span> <span class=nb>dict</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>ToolResult</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;带恢复机制的工具调用&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>recovery_manager</span><span class=o>.</span><span class=n>execute_with_recovery</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;call_tool&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=n>call_tool</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>arguments</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>fallback_read_resource</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>uri</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;资源读取降级处理&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;资源 </span><span class=si>{</span><span class=n>uri</span><span class=si>}</span><span class=s2> 暂时不可用，请稍后重试&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>fallback_call_tool</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>arguments</span><span class=p>:</span> <span class=nb>dict</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>ToolResult</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;工具调用降级处理&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>ToolResult</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>content</span><span class=o>=</span><span class=p>[</span><span class=n>TextContent</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=nb>type</span><span class=o>=</span><span class=s2>&#34;text&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>text</span><span class=o>=</span><span class=sa>f</span><span class=s2>&#34;工具 </span><span class=si>{</span><span class=n>name</span><span class=si>}</span><span class=s2> 暂时不可用，请稍后重试&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>)],</span>
</span></span><span class=line><span class=cl>            <span class=n>isError</span><span class=o>=</span><span class=kc>True</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=多租户支持>多租户支持</h3><h4 id=租户隔离机制>租户隔离机制</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Dict</span><span class=p>,</span> <span class=n>Set</span><span class=p>,</span> <span class=n>Optional</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>hashlib</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>TenantManager</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;租户管理器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>tenants</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Dict</span><span class=p>]</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>tenant_resources</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Set</span><span class=p>[</span><span class=nb>str</span><span class=p>]]</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>tenant_quotas</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Dict</span><span class=p>]</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>tenant_usage</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Dict</span><span class=p>]</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>create_tenant</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>tenant_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>config</span><span class=p>:</span> <span class=n>Dict</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;创建租户&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>tenants</span><span class=p>[</span><span class=n>tenant_id</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;id&#39;</span><span class=p>:</span> <span class=n>tenant_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;name&#39;</span><span class=p>:</span> <span class=n>config</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;name&#39;</span><span class=p>,</span> <span class=n>tenant_id</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;created_at&#39;</span><span class=p>:</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;status&#39;</span><span class=p>:</span> <span class=s1>&#39;active&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;config&#39;</span><span class=p>:</span> <span class=n>config</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 初始化资源和配额</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>tenant_resources</span><span class=p>[</span><span class=n>tenant_id</span><span class=p>]</span> <span class=o>=</span> <span class=nb>set</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>tenant_quotas</span><span class=p>[</span><span class=n>tenant_id</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;max_resources&#39;</span><span class=p>:</span> <span class=n>config</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;max_resources&#39;</span><span class=p>,</span> <span class=mi>100</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;max_requests_per_minute&#39;</span><span class=p>:</span> <span class=n>config</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;max_requests_per_minute&#39;</span><span class=p>,</span> <span class=mi>1000</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;max_storage_mb&#39;</span><span class=p>:</span> <span class=n>config</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;max_storage_mb&#39;</span><span class=p>,</span> <span class=mi>1024</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>tenant_usage</span><span class=p>[</span><span class=n>tenant_id</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;resources_count&#39;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;requests_count&#39;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;storage_used_mb&#39;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;last_reset&#39;</span><span class=p>:</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_tenant</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>tenant_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=n>Dict</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;获取租户信息&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>tenants</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>tenant_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>check_quota</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>tenant_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>resource_type</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>amount</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>1</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;检查配额&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>tenant_id</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>tenant_quotas</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>quota</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>tenant_quotas</span><span class=p>[</span><span class=n>tenant_id</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>usage</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>tenant_usage</span><span class=p>[</span><span class=n>tenant_id</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 重置每分钟的请求计数</span>
</span></span><span class=line><span class=cl>        <span class=n>current_time</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>current_time</span> <span class=o>-</span> <span class=n>usage</span><span class=p>[</span><span class=s1>&#39;last_reset&#39;</span><span class=p>]</span> <span class=o>&gt;=</span> <span class=mi>60</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>usage</span><span class=p>[</span><span class=s1>&#39;requests_count&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>            <span class=n>usage</span><span class=p>[</span><span class=s1>&#39;last_reset&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>current_time</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>resource_type</span> <span class=o>==</span> <span class=s1>&#39;requests&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>usage</span><span class=p>[</span><span class=s1>&#39;requests_count&#39;</span><span class=p>]</span> <span class=o>+</span> <span class=n>amount</span> <span class=o>&lt;=</span> <span class=n>quota</span><span class=p>[</span><span class=s1>&#39;max_requests_per_minute&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>resource_type</span> <span class=o>==</span> <span class=s1>&#39;resources&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>usage</span><span class=p>[</span><span class=s1>&#39;resources_count&#39;</span><span class=p>]</span> <span class=o>+</span> <span class=n>amount</span> <span class=o>&lt;=</span> <span class=n>quota</span><span class=p>[</span><span class=s1>&#39;max_resources&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>resource_type</span> <span class=o>==</span> <span class=s1>&#39;storage&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>usage</span><span class=p>[</span><span class=s1>&#39;storage_used_mb&#39;</span><span class=p>]</span> <span class=o>+</span> <span class=n>amount</span> <span class=o>&lt;=</span> <span class=n>quota</span><span class=p>[</span><span class=s1>&#39;max_storage_mb&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>consume_quota</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>tenant_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>resource_type</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>amount</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>1</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;消费配额&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>tenant_id</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>tenant_usage</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>usage</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>tenant_usage</span><span class=p>[</span><span class=n>tenant_id</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>resource_type</span> <span class=o>==</span> <span class=s1>&#39;requests&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>usage</span><span class=p>[</span><span class=s1>&#39;requests_count&#39;</span><span class=p>]</span> <span class=o>+=</span> <span class=n>amount</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>resource_type</span> <span class=o>==</span> <span class=s1>&#39;resources&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>usage</span><span class=p>[</span><span class=s1>&#39;resources_count&#39;</span><span class=p>]</span> <span class=o>+=</span> <span class=n>amount</span>
</span></span><span class=line><span class=cl>        <span class=k>elif</span> <span class=n>resource_type</span> <span class=o>==</span> <span class=s1>&#39;storage&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>usage</span><span class=p>[</span><span class=s1>&#39;storage_used_mb&#39;</span><span class=p>]</span> <span class=o>+=</span> <span class=n>amount</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_tenant_namespace</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>tenant_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>resource_name</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;获取租户命名空间的资源名&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;tenant:</span><span class=si>{</span><span class=n>tenant_id</span><span class=si>}</span><span class=s2>:</span><span class=si>{</span><span class=n>resource_name</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>MultiTenantMcpServer</span><span class=p>(</span><span class=n>McpServer</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;多租户MCP服务器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span><span class=n>name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>tenant_manager</span> <span class=o>=</span> <span class=n>TenantManager</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>tenant_contexts</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=p>{}</span>  <span class=c1># 连接ID -&gt; 租户ID映射</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>authenticate_tenant</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>token</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>str</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;租户认证&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 这里应该实现实际的JWT验证逻辑</span>
</span></span><span class=line><span class=cl>        <span class=c1># 为简化示例，直接从token中提取租户ID</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 假设token格式为 &#34;tenant_id:signature&#34;</span>
</span></span><span class=line><span class=cl>            <span class=n>tenant_id</span> <span class=o>=</span> <span class=n>token</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;:&#39;</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>tenant_manager</span><span class=o>.</span><span class=n>get_tenant</span><span class=p>(</span><span class=n>tenant_id</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>tenant_id</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>Exception</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>pass</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>handle_request</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>method</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>params</span><span class=p>:</span> <span class=nb>dict</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;处理多租户请求&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 获取当前连接的租户ID</span>
</span></span><span class=line><span class=cl>        <span class=n>connection_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_current_connection_id</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>tenant_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>tenant_contexts</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>connection_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>tenant_id</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=n>McpError</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>code</span><span class=o>=</span><span class=n>ErrorCode</span><span class=o>.</span><span class=n>UNAUTHORIZED</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>message</span><span class=o>=</span><span class=s2>&#34;需要租户认证&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 检查请求配额</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>tenant_manager</span><span class=o>.</span><span class=n>check_quota</span><span class=p>(</span><span class=n>tenant_id</span><span class=p>,</span> <span class=s1>&#39;requests&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=n>McpError</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>code</span><span class=o>=</span><span class=n>ErrorCode</span><span class=o>.</span><span class=n>RATE_LIMITED</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>message</span><span class=o>=</span><span class=s2>&#34;租户请求配额已用完&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 消费配额</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>tenant_manager</span><span class=o>.</span><span class=n>consume_quota</span><span class=p>(</span><span class=n>tenant_id</span><span class=p>,</span> <span class=s1>&#39;requests&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 在请求参数中注入租户上下文</span>
</span></span><span class=line><span class=cl>        <span class=n>params</span><span class=p>[</span><span class=s1>&#39;_tenant_id&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>tenant_id</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>await</span> <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=n>handle_request</span><span class=p>(</span><span class=n>method</span><span class=p>,</span> <span class=n>params</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>read_resource</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>uri</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;多租户资源读取&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>tenant_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_get_current_tenant_id</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 添加租户命名空间</span>
</span></span><span class=line><span class=cl>        <span class=n>namespaced_uri</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>tenant_manager</span><span class=o>.</span><span class=n>get_tenant_namespace</span><span class=p>(</span><span class=n>tenant_id</span><span class=p>,</span> <span class=n>uri</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>await</span> <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=n>read_resource</span><span class=p>(</span><span class=n>namespaced_uri</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>list_resources</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=n>Resource</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;列出租户资源&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>tenant_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_get_current_tenant_id</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 获取所有资源并过滤租户资源</span>
</span></span><span class=line><span class=cl>        <span class=n>all_resources</span> <span class=o>=</span> <span class=k>await</span> <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=n>list_resources</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>tenant_prefix</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;tenant:</span><span class=si>{</span><span class=n>tenant_id</span><span class=si>}</span><span class=s2>:&#34;</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>tenant_resources</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>resource</span> <span class=ow>in</span> <span class=n>all_resources</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>resource</span><span class=o>.</span><span class=n>uri</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=n>tenant_prefix</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=c1># 移除租户前缀，返回原始URI</span>
</span></span><span class=line><span class=cl>                <span class=n>original_uri</span> <span class=o>=</span> <span class=n>resource</span><span class=o>.</span><span class=n>uri</span><span class=p>[</span><span class=nb>len</span><span class=p>(</span><span class=n>tenant_prefix</span><span class=p>):]</span>
</span></span><span class=line><span class=cl>                <span class=n>tenant_resources</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>Resource</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                    <span class=n>uri</span><span class=o>=</span><span class=n>original_uri</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>name</span><span class=o>=</span><span class=n>resource</span><span class=o>.</span><span class=n>name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>description</span><span class=o>=</span><span class=n>resource</span><span class=o>.</span><span class=n>description</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>mimeType</span><span class=o>=</span><span class=n>resource</span><span class=o>.</span><span class=n>mimeType</span>
</span></span><span class=line><span class=cl>                <span class=p>))</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>tenant_resources</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_get_current_tenant_id</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;获取当前租户ID&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>connection_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_current_connection_id</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>tenant_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>tenant_contexts</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>connection_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>tenant_id</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=n>McpError</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>code</span><span class=o>=</span><span class=n>ErrorCode</span><span class=o>.</span><span class=n>UNAUTHORIZED</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>message</span><span class=o>=</span><span class=s2>&#34;未找到租户上下文&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>tenant_id</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>create_tenant</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>tenant_config</span><span class=p>:</span> <span class=n>Dict</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;创建新租户&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>tenant_id</span> <span class=o>=</span> <span class=n>tenant_config</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;id&#39;</span><span class=p>)</span> <span class=ow>or</span> <span class=bp>self</span><span class=o>.</span><span class=n>_generate_tenant_id</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>tenant_manager</span><span class=o>.</span><span class=n>create_tenant</span><span class=p>(</span><span class=n>tenant_id</span><span class=p>,</span> <span class=n>tenant_config</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>tenant_id</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>_generate_tenant_id</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;生成租户ID&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=kn>import</span> <span class=nn>uuid</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nb>str</span><span class=p>(</span><span class=n>uuid</span><span class=o>.</span><span class=n>uuid4</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>get_tenant_usage</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>tenant_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;获取租户使用情况&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>usage</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>tenant_manager</span><span class=o>.</span><span class=n>tenant_usage</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>tenant_id</span><span class=p>,</span> <span class=p>{})</span>
</span></span><span class=line><span class=cl>        <span class=n>quota</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>tenant_manager</span><span class=o>.</span><span class=n>tenant_quotas</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>tenant_id</span><span class=p>,</span> <span class=p>{})</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;usage&#39;</span><span class=p>:</span> <span class=n>usage</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;quota&#39;</span><span class=p>:</span> <span class=n>quota</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;utilization&#39;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;requests&#39;</span><span class=p>:</span> <span class=n>usage</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;requests_count&#39;</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span> <span class=o>/</span> <span class=nb>max</span><span class=p>(</span><span class=n>quota</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;max_requests_per_minute&#39;</span><span class=p>,</span> <span class=mi>1</span><span class=p>),</span> <span class=mi>1</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;resources&#39;</span><span class=p>:</span> <span class=n>usage</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;resources_count&#39;</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span> <span class=o>/</span> <span class=nb>max</span><span class=p>(</span><span class=n>quota</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;max_resources&#39;</span><span class=p>,</span> <span class=mi>1</span><span class=p>),</span> <span class=mi>1</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;storage&#39;</span><span class=p>:</span> <span class=n>usage</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;storage_used_mb&#39;</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span> <span class=o>/</span> <span class=nb>max</span><span class=p>(</span><span class=n>quota</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;max_storage_mb&#39;</span><span class=p>,</span> <span class=mi>1</span><span class=p>),</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=-mcp开发实践>🛠️ MCP开发实践</h2><h3 id=开发环境搭建>开发环境搭建</h3><h4 id=1-安装开发工具>1. 安装开发工具</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># Python环境</span>
</span></span><span class=line><span class=cl>pip install mcp
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># TypeScript环境</span>
</span></span><span class=line><span class=cl>npm install @modelcontextprotocol/sdk
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 调试工具</span>
</span></span><span class=line><span class=cl>npm install -g @modelcontextprotocol/inspector
</span></span></code></pre></td></tr></table></div></div><h4 id=2-项目结构>2. 项目结构</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>my</span><span class=o>-</span><span class=n>mcp</span><span class=o>-</span><span class=n>server</span><span class=o>/</span>
</span></span><span class=line><span class=cl><span class=err>├──</span> <span class=n>src</span><span class=o>/</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>├──</span> <span class=n>__init__</span><span class=o>.</span><span class=n>py</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>├──</span> <span class=n>server</span><span class=o>.</span><span class=n>py</span>          <span class=c1># 主服务器代码</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>├──</span> <span class=n>resources</span><span class=o>.</span><span class=n>py</span>       <span class=c1># 资源处理</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>├──</span> <span class=n>tools</span><span class=o>.</span><span class=n>py</span>          <span class=c1># 工具实现</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>└──</span> <span class=n>prompts</span><span class=o>.</span><span class=n>py</span>        <span class=c1># 提示模板</span>
</span></span><span class=line><span class=cl><span class=err>├──</span> <span class=n>config</span><span class=o>/</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>└──</span> <span class=n>server_config</span><span class=o>.</span><span class=n>json</span>
</span></span><span class=line><span class=cl><span class=err>├──</span> <span class=n>tests</span><span class=o>/</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>└──</span> <span class=n>test_server</span><span class=o>.</span><span class=n>py</span>
</span></span><span class=line><span class=cl><span class=err>├──</span> <span class=n>requirements</span><span class=o>.</span><span class=n>txt</span>
</span></span><span class=line><span class=cl><span class=err>└──</span> <span class=n>README</span><span class=o>.</span><span class=n>md</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=开发最佳实践>开发最佳实践</h3><h4 id=1-服务器设计原则>1. 服务器设计原则</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>mcp</span> <span class=kn>import</span> <span class=n>McpServer</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>List</span><span class=p>,</span> <span class=n>Optional</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>asyncio</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>BestPracticeServer</span><span class=p>(</span><span class=n>McpServer</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span><span class=s2>&#34;best-practice-server&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>name</span> <span class=o>=</span> <span class=s2>&#34;最佳实践服务器&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>version</span> <span class=o>=</span> <span class=s2>&#34;1.0.0&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>initialize</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;初始化服务器资源&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;服务器初始化中...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># 初始化数据库连接、缓存等</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>cleanup</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;清理资源&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&#34;服务器清理中...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># 关闭连接、清理缓存等</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=2-错误处理>2. 错误处理</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>mcp</span> <span class=kn>import</span> <span class=n>McpError</span><span class=p>,</span> <span class=n>ErrorCode</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>safe_tool_call</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>arguments</span><span class=p>:</span> <span class=nb>dict</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># 工具执行逻辑</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>execute_tool</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>arguments</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=n>ValidationError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=n>McpError</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>code</span><span class=o>=</span><span class=n>ErrorCode</span><span class=o>.</span><span class=n>INVALID_PARAMS</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>message</span><span class=o>=</span><span class=sa>f</span><span class=s2>&#34;参数验证失败: </span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>PermissionError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=n>McpError</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>code</span><span class=o>=</span><span class=n>ErrorCode</span><span class=o>.</span><span class=n>PERMISSION_DENIED</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>message</span><span class=o>=</span><span class=s2>&#34;权限不足&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;工具执行失败: </span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>raise</span> <span class=n>McpError</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>code</span><span class=o>=</span><span class=n>ErrorCode</span><span class=o>.</span><span class=n>INTERNAL_ERROR</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>message</span><span class=o>=</span><span class=s2>&#34;内部服务器错误&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=3-性能优化>3. 性能优化</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>asyncio</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>functools</span> <span class=kn>import</span> <span class=n>lru_cache</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>OptimizedServer</span><span class=p>(</span><span class=n>McpServer</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nd>@lru_cache</span><span class=p>(</span><span class=n>maxsize</span><span class=o>=</span><span class=mi>100</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>get_cached_resource</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>uri</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;缓存资源内容&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>load_resource</span><span class=p>(</span><span class=n>uri</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>batch_process_resources</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>uris</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;批量处理资源&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>tasks</span> <span class=o>=</span> <span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>get_cached_resource</span><span class=p>(</span><span class=n>uri</span><span class=p>)</span> <span class=k>for</span> <span class=n>uri</span> <span class=ow>in</span> <span class=n>uris</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>await</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>gather</span><span class=p>(</span><span class=o>*</span><span class=n>tasks</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=调试与测试>调试与测试</h3><h4 id=1-使用mcp-inspector>1. 使用MCP Inspector</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 启动调试工具</span>
</span></span><span class=line><span class=cl>npx @modelcontextprotocol/inspector
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 测试服务器连接</span>
</span></span><span class=line><span class=cl>mcp-inspector --server python my_server.py
</span></span></code></pre></td></tr></table></div></div><h4 id=2-单元测试>2. 单元测试</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pytest</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>mcp.testing</span> <span class=kn>import</span> <span class=n>McpTestClient</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@pytest.mark.asyncio</span>
</span></span><span class=line><span class=cl><span class=k>async</span> <span class=k>def</span> <span class=nf>test_resource_listing</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>client</span> <span class=o>=</span> <span class=n>McpTestClient</span><span class=p>(</span><span class=n>MyMcpServer</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=k>await</span> <span class=n>client</span><span class=o>.</span><span class=n>connect</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>resources</span> <span class=o>=</span> <span class=k>await</span> <span class=n>client</span><span class=o>.</span><span class=n>list_resources</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=nb>len</span><span class=p>(</span><span class=n>resources</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=k>assert</span> <span class=n>resources</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>name</span> <span class=o>==</span> <span class=s2>&#34;测试资源&#34;</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=-实际应用案例>🔧 实际应用案例</h2><h3 id=案例一代码库分析服务器>案例一：代码库分析服务器</h3><h4 id=需求分析>需求分析</h4><p>为AI模型提供代码库的完整上下文，包括文件结构、代码内容、Git历史等。</p><h4 id=实现方案>实现方案</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>class</span> <span class=nc>CodebaseServer</span><span class=p>(</span><span class=n>McpServer</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>repo_path</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span><span class=s2>&#34;codebase-server&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>repo_path</span> <span class=o>=</span> <span class=n>repo_path</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>git_repo</span> <span class=o>=</span> <span class=n>GitRepository</span><span class=p>(</span><span class=n>repo_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>list_resources</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;列出代码库中的所有文件&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>files</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>root</span><span class=p>,</span> <span class=n>dirs</span><span class=p>,</span> <span class=n>filenames</span> <span class=ow>in</span> <span class=n>os</span><span class=o>.</span><span class=n>walk</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>repo_path</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>filename</span> <span class=ow>in</span> <span class=n>filenames</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>is_code_file</span><span class=p>(</span><span class=n>filename</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                    <span class=n>file_path</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>root</span><span class=p>,</span> <span class=n>filename</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=n>relative_path</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>relpath</span><span class=p>(</span><span class=n>file_path</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>repo_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=n>files</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>Resource</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                        <span class=n>uri</span><span class=o>=</span><span class=sa>f</span><span class=s2>&#34;file://</span><span class=si>{</span><span class=n>file_path</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>name</span><span class=o>=</span><span class=n>relative_path</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>description</span><span class=o>=</span><span class=sa>f</span><span class=s2>&#34;代码文件: </span><span class=si>{</span><span class=n>relative_path</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>mimeType</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>get_mime_type</span><span class=p>(</span><span class=n>filename</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>files</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>list_tools</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=n>Tool</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>name</span><span class=o>=</span><span class=s2>&#34;analyze_code_structure&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>description</span><span class=o>=</span><span class=s2>&#34;分析代码结构和依赖关系&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>inputSchema</span><span class=o>=</span><span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;object&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;properties&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;file_pattern&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                            <span class=s2>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;string&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                            <span class=s2>&#34;description&#34;</span><span class=p>:</span> <span class=s2>&#34;文件匹配模式&#34;</span>
</span></span><span class=line><span class=cl>                        <span class=p>}</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=n>Tool</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>name</span><span class=o>=</span><span class=s2>&#34;get_git_history&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>description</span><span class=o>=</span><span class=s2>&#34;获取Git提交历史&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>inputSchema</span><span class=o>=</span><span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;object&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s2>&#34;properties&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;file_path&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                            <span class=s2>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;string&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                            <span class=s2>&#34;description&#34;</span><span class=p>:</span> <span class=s2>&#34;文件路径&#34;</span>
</span></span><span class=line><span class=cl>                        <span class=p>},</span>
</span></span><span class=line><span class=cl>                        <span class=s2>&#34;limit&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                            <span class=s2>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;integer&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                            <span class=s2>&#34;description&#34;</span><span class=p>:</span> <span class=s2>&#34;历史记录数量限制&#34;</span>
</span></span><span class=line><span class=cl>                        <span class=p>}</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>]</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=案例二数据库管理服务器>案例二：数据库管理服务器</h3><h4 id=功能特性>功能特性</h4><ul><li>数据库连接管理</li><li>SQL查询执行</li><li>表结构分析</li><li>数据安全保护</li></ul><h4 id=实现代码>实现代码</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>asyncpg</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Dict</span><span class=p>,</span> <span class=n>Any</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>DatabaseServer</span><span class=p>(</span><span class=n>McpServer</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>db_config</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span><span class=s2>&#34;database-server&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>db_config</span> <span class=o>=</span> <span class=n>db_config</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>connection_pool</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>initialize</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;初始化数据库连接池&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>connection_pool</span> <span class=o>=</span> <span class=k>await</span> <span class=n>asyncpg</span><span class=o>.</span><span class=n>create_pool</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=o>**</span><span class=bp>self</span><span class=o>.</span><span class=n>db_config</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>min_size</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>max_size</span><span class=o>=</span><span class=mi>10</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>list_resources</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;列出数据库表和视图&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>async</span> <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>connection_pool</span><span class=o>.</span><span class=n>acquire</span><span class=p>()</span> <span class=k>as</span> <span class=n>conn</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>tables</span> <span class=o>=</span> <span class=k>await</span> <span class=n>conn</span><span class=o>.</span><span class=n>fetch</span><span class=p>(</span><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>                SELECT table_name, table_type 
</span></span></span><span class=line><span class=cl><span class=s2>                FROM information_schema.tables 
</span></span></span><span class=line><span class=cl><span class=s2>                WHERE table_schema = &#39;public&#39;
</span></span></span><span class=line><span class=cl><span class=s2>            &#34;&#34;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>                <span class=n>Resource</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                    <span class=n>uri</span><span class=o>=</span><span class=sa>f</span><span class=s2>&#34;table://</span><span class=si>{</span><span class=n>table</span><span class=p>[</span><span class=s1>&#39;table_name&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>name</span><span class=o>=</span><span class=n>table</span><span class=p>[</span><span class=s1>&#39;table_name&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                    <span class=n>description</span><span class=o>=</span><span class=sa>f</span><span class=s2>&#34;数据库</span><span class=si>{</span><span class=n>table</span><span class=p>[</span><span class=s1>&#39;table_type&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>table</span><span class=p>[</span><span class=s1>&#39;table_name&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>mimeType</span><span class=o>=</span><span class=s2>&#34;application/sql&#34;</span>
</span></span><span class=line><span class=cl>                <span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>for</span> <span class=n>table</span> <span class=ow>in</span> <span class=n>tables</span>
</span></span><span class=line><span class=cl>            <span class=p>]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>call_tool</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>arguments</span><span class=p>:</span> <span class=nb>dict</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>name</span> <span class=o>==</span> <span class=s2>&#34;execute_query&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>query</span> <span class=o>=</span> <span class=n>arguments</span><span class=p>[</span><span class=s2>&#34;query&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 安全检查</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>is_safe_query</span><span class=p>(</span><span class=n>query</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=k>raise</span> <span class=n>McpError</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                    <span class=n>code</span><span class=o>=</span><span class=n>ErrorCode</span><span class=o>.</span><span class=n>PERMISSION_DENIED</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>message</span><span class=o>=</span><span class=s2>&#34;查询包含不安全的操作&#34;</span>
</span></span><span class=line><span class=cl>                <span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>async</span> <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>connection_pool</span><span class=o>.</span><span class=n>acquire</span><span class=p>()</span> <span class=k>as</span> <span class=n>conn</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>result</span> <span class=o>=</span> <span class=k>await</span> <span class=n>conn</span><span class=o>.</span><span class=n>fetch</span><span class=p>(</span><span class=n>query</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=n>ToolResult</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                        <span class=n>content</span><span class=o>=</span><span class=p>[{</span>
</span></span><span class=line><span class=cl>                            <span class=s2>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;text&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                            <span class=s2>&#34;text&#34;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>format_query_result</span><span class=p>(</span><span class=n>result</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                        <span class=p>}]</span>
</span></span><span class=line><span class=cl>                    <span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=n>ToolResult</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                        <span class=n>content</span><span class=o>=</span><span class=p>[{</span>
</span></span><span class=line><span class=cl>                            <span class=s2>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;text&#34;</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                            <span class=s2>&#34;text&#34;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&#34;查询执行失败: </span><span class=si>{</span><span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>                        <span class=p>}],</span>
</span></span><span class=line><span class=cl>                        <span class=n>isError</span><span class=o>=</span><span class=kc>True</span>
</span></span><span class=line><span class=cl>                    <span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>is_safe_query</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>query</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;检查查询是否安全&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>dangerous_keywords</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;DROP&#39;</span><span class=p>,</span> <span class=s1>&#39;DELETE&#39;</span><span class=p>,</span> <span class=s1>&#39;UPDATE&#39;</span><span class=p>,</span> <span class=s1>&#39;INSERT&#39;</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>            <span class=s1>&#39;ALTER&#39;</span><span class=p>,</span> <span class=s1>&#39;CREATE&#39;</span><span class=p>,</span> <span class=s1>&#39;TRUNCATE&#39;</span>
</span></span><span class=line><span class=cl>        <span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>query_upper</span> <span class=o>=</span> <span class=n>query</span><span class=o>.</span><span class=n>upper</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=ow>not</span> <span class=nb>any</span><span class=p>(</span><span class=n>keyword</span> <span class=ow>in</span> <span class=n>query_upper</span> <span class=k>for</span> <span class=n>keyword</span> <span class=ow>in</span> <span class=n>dangerous_keywords</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=案例三文档知识库服务器>案例三：文档知识库服务器</h3><h4 id=应用场景-1>应用场景</h4><p>为AI助手提供企业内部文档、知识库的访问能力。</p><h4 id=核心实现>核心实现</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pathlib</span> <span class=kn>import</span> <span class=n>Path</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>markdown</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>bs4</span> <span class=kn>import</span> <span class=n>BeautifulSoup</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>KnowledgeBaseServer</span><span class=p>(</span><span class=n>McpServer</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>docs_path</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span><span class=s2>&#34;knowledge-base-server&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>docs_path</span> <span class=o>=</span> <span class=n>Path</span><span class=p>(</span><span class=n>docs_path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>doc_index</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>initialize</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;构建文档索引&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>build_document_index</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>build_document_index</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;构建文档索引以支持快速搜索&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>doc_file</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>docs_path</span><span class=o>.</span><span class=n>rglob</span><span class=p>(</span><span class=s2>&#34;*.md&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>content</span> <span class=o>=</span> <span class=n>doc_file</span><span class=o>.</span><span class=n>read_text</span><span class=p>(</span><span class=n>encoding</span><span class=o>=</span><span class=s1>&#39;utf-8&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=c1># 提取标题和关键词</span>
</span></span><span class=line><span class=cl>            <span class=n>html</span> <span class=o>=</span> <span class=n>markdown</span><span class=o>.</span><span class=n>markdown</span><span class=p>(</span><span class=n>content</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>soup</span> <span class=o>=</span> <span class=n>BeautifulSoup</span><span class=p>(</span><span class=n>html</span><span class=p>,</span> <span class=s1>&#39;html.parser&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>doc_index</span><span class=p>[</span><span class=nb>str</span><span class=p>(</span><span class=n>doc_file</span><span class=p>)]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;title&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>extract_title</span><span class=p>(</span><span class=n>soup</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;keywords&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>extract_keywords</span><span class=p>(</span><span class=n>content</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;summary&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>generate_summary</span><span class=p>(</span><span class=n>content</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>list_prompts</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=n>Prompt</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>name</span><span class=o>=</span><span class=s2>&#34;document_qa&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>description</span><span class=o>=</span><span class=s2>&#34;文档问答提示模板&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>arguments</span><span class=o>=</span><span class=p>[</span>
</span></span><span class=line><span class=cl>                    <span class=n>PromptArgument</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                        <span class=n>name</span><span class=o>=</span><span class=s2>&#34;question&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>description</span><span class=o>=</span><span class=s2>&#34;用户问题&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>required</span><span class=o>=</span><span class=kc>True</span>
</span></span><span class=line><span class=cl>                    <span class=p>),</span>
</span></span><span class=line><span class=cl>                    <span class=n>PromptArgument</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                        <span class=n>name</span><span class=o>=</span><span class=s2>&#34;context_docs&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>description</span><span class=o>=</span><span class=s2>&#34;相关文档&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=n>required</span><span class=o>=</span><span class=kc>False</span>
</span></span><span class=line><span class=cl>                    <span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>get_prompt</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>arguments</span><span class=p>:</span> <span class=nb>dict</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>name</span> <span class=o>==</span> <span class=s2>&#34;document_qa&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>question</span> <span class=o>=</span> <span class=n>arguments</span><span class=p>[</span><span class=s2>&#34;question&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=n>context_docs</span> <span class=o>=</span> <span class=n>arguments</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;context_docs&#34;</span><span class=p>,</span> <span class=s2>&#34;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>基于以下文档内容回答用户问题。
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>相关文档：
</span></span></span><span class=line><span class=cl><span class=s2></span><span class=si>{</span><span class=n>context_docs</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>用户问题：</span><span class=si>{</span><span class=n>question</span><span class=si>}</span><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>请基于文档内容提供准确、详细的回答。如果文档中没有相关信息，请明确说明。
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=-企业级部署方案>🏢 企业级部署方案</h2><h3 id=部署架构>部署架构</h3><h4 id=1-本地部署>1. 本地部署</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># docker-compose.yml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;3.8&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>mcp-server</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>build</span><span class=p>:</span><span class=w> </span><span class=l>.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;8080:8080&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>environment</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>DB_HOST=postgres</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>REDIS_URL=redis://redis:6379</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>./data:/app/data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>depends_on</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>postgres</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>redis</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>postgres</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>postgres:15</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>environment</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>POSTGRES_DB</span><span class=p>:</span><span class=w> </span><span class=l>mcpdata</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>POSTGRES_USER</span><span class=p>:</span><span class=w> </span><span class=l>mcpuser</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>POSTGRES_PASSWORD</span><span class=p>:</span><span class=w> </span><span class=l>mcppass</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>postgres_data:/var/lib/postgresql/data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>redis</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>redis:7-alpine</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>postgres_data</span><span class=p>:</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=2-云端部署>2. 云端部署</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># Kubernetes部署示例</span>
</span></span><span class=line><span class=cl>kubectl apply -f - <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: apps/v1
</span></span></span><span class=line><span class=cl><span class=s>kind: Deployment
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: mcp-server
</span></span></span><span class=line><span class=cl><span class=s>spec:
</span></span></span><span class=line><span class=cl><span class=s>  replicas: 3
</span></span></span><span class=line><span class=cl><span class=s>  selector:
</span></span></span><span class=line><span class=cl><span class=s>    matchLabels:
</span></span></span><span class=line><span class=cl><span class=s>      app: mcp-server
</span></span></span><span class=line><span class=cl><span class=s>  template:
</span></span></span><span class=line><span class=cl><span class=s>    metadata:
</span></span></span><span class=line><span class=cl><span class=s>      labels:
</span></span></span><span class=line><span class=cl><span class=s>        app: mcp-server
</span></span></span><span class=line><span class=cl><span class=s>    spec:
</span></span></span><span class=line><span class=cl><span class=s>      containers:
</span></span></span><span class=line><span class=cl><span class=s>      - name: mcp-server
</span></span></span><span class=line><span class=cl><span class=s>        image: my-org/mcp-server:latest
</span></span></span><span class=line><span class=cl><span class=s>        ports:
</span></span></span><span class=line><span class=cl><span class=s>        - containerPort: 8080
</span></span></span><span class=line><span class=cl><span class=s>        env:
</span></span></span><span class=line><span class=cl><span class=s>        - name: DB_HOST
</span></span></span><span class=line><span class=cl><span class=s>          value: &#34;postgres-service&#34;
</span></span></span><span class=line><span class=cl><span class=s>        - name: REDIS_URL
</span></span></span><span class=line><span class=cl><span class=s>          value: &#34;redis://redis-service:6379&#34;
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=安全最佳实践>安全最佳实践</h3><h4 id=1-认证授权>1. 认证授权</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>functools</span> <span class=kn>import</span> <span class=n>wraps</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>jwt</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>SecureMcpServer</span><span class=p>(</span><span class=n>McpServer</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span><span class=s2>&#34;secure-server&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>jwt_secret</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>getenv</span><span class=p>(</span><span class=s2>&#34;JWT_SECRET&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>authorized_clients</span> <span class=o>=</span> <span class=nb>set</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>require_auth</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>func</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nd>@wraps</span><span class=p>(</span><span class=n>func</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>async</span> <span class=k>def</span> <span class=nf>wrapper</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>client_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_current_client_id</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>client_id</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>authorized_clients</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>raise</span> <span class=n>McpError</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                    <span class=n>code</span><span class=o>=</span><span class=n>ErrorCode</span><span class=o>.</span><span class=n>PERMISSION_DENIED</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>message</span><span class=o>=</span><span class=s2>&#34;未授权的客户端&#34;</span>
</span></span><span class=line><span class=cl>                <span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=k>await</span> <span class=n>func</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>wrapper</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@require_auth</span>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>call_tool</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>arguments</span><span class=p>:</span> <span class=nb>dict</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># 安全的工具调用</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>await</span> <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=n>call_tool</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>arguments</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=2-数据加密>2. 数据加密</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>cryptography.fernet</span> <span class=kn>import</span> <span class=n>Fernet</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>EncryptedDataServer</span><span class=p>(</span><span class=n>McpServer</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span><span class=s2>&#34;encrypted-server&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>cipher_suite</span> <span class=o>=</span> <span class=n>Fernet</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>getenv</span><span class=p>(</span><span class=s2>&#34;ENCRYPTION_KEY&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>read_resource</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>uri</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;读取加密资源&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>encrypted_data</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>load_encrypted_data</span><span class=p>(</span><span class=n>uri</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>decrypted_data</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>cipher_suite</span><span class=o>.</span><span class=n>decrypt</span><span class=p>(</span><span class=n>encrypted_data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>decrypted_data</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=s1>&#39;utf-8&#39;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=-未来发展趋势>🚀 未来发展趋势</h2><h3 id=技术演进方向>技术演进方向</h3><h4 id=1-协议增强>1. 协议增强</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-markdown data-lang=markdown><span class=line><span class=cl>🔮 未来特性：
</span></span><span class=line><span class=cl><span class=k>-</span> 流式数据传输支持
</span></span><span class=line><span class=cl><span class=k>-</span> 更强的类型系统
</span></span><span class=line><span class=cl><span class=k>-</span> 内置缓存机制
</span></span><span class=line><span class=cl><span class=k>-</span> 事务支持
</span></span><span class=line><span class=cl><span class=k>-</span> 更好的错误恢复
</span></span></code></pre></td></tr></table></div></div><h4 id=2-生态系统扩展>2. 生态系统扩展</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-markdown data-lang=markdown><span class=line><span class=cl>🌍 生态发展：
</span></span><span class=line><span class=cl><span class=k>-</span> 更多预构建服务器
</span></span><span class=line><span class=cl><span class=k>-</span> 可视化配置工具
</span></span><span class=line><span class=cl><span class=k>-</span> 监控和分析平台
</span></span><span class=line><span class=cl><span class=k>-</span> 插件市场
</span></span><span class=line><span class=cl><span class=k>-</span> 企业级管理控制台
</span></span></code></pre></td></tr></table></div></div><h4 id=3-与ai-agent集成>3. 与AI Agent集成</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 未来的AI Agent集成示例</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>IntelligentMcpAgent</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>mcp_clients</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>reasoning_engine</span> <span class=o>=</span> <span class=n>ReasoningEngine</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>process_request</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>user_request</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># 1. 分析用户请求</span>
</span></span><span class=line><span class=cl>        <span class=n>intent</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>reasoning_engine</span><span class=o>.</span><span class=n>analyze_intent</span><span class=p>(</span><span class=n>user_request</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 2. 选择合适的MCP服务器</span>
</span></span><span class=line><span class=cl>        <span class=n>relevant_servers</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>select_servers</span><span class=p>(</span><span class=n>intent</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 3. 收集上下文信息</span>
</span></span><span class=line><span class=cl>        <span class=n>context</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>gather_context</span><span class=p>(</span><span class=n>relevant_servers</span><span class=p>,</span> <span class=n>intent</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 4. 生成响应</span>
</span></span><span class=line><span class=cl>        <span class=n>response</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>generate_response</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>user_request</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>response</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=-性能优化与监控系统>📊 性能优化与监控系统</h2><h3 id=高级性能监控>高级性能监控</h3><h4 id=实时性能指标收集>实时性能指标收集</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span><span class=lnt>210
</span><span class=lnt>211
</span><span class=lnt>212
</span><span class=lnt>213
</span><span class=lnt>214
</span><span class=lnt>215
</span><span class=lnt>216
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>psutil</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>asyncio</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>dataclasses</span> <span class=kn>import</span> <span class=n>dataclass</span><span class=p>,</span> <span class=n>asdict</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Dict</span><span class=p>,</span> <span class=n>List</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>collections</span> <span class=kn>import</span> <span class=n>deque</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@dataclass</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>PerformanceMetrics</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;性能指标数据结构&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>timestamp</span><span class=p>:</span> <span class=nb>float</span>
</span></span><span class=line><span class=cl>    <span class=n>cpu_usage</span><span class=p>:</span> <span class=nb>float</span>
</span></span><span class=line><span class=cl>    <span class=n>memory_usage</span><span class=p>:</span> <span class=nb>float</span>
</span></span><span class=line><span class=cl>    <span class=n>memory_available</span><span class=p>:</span> <span class=nb>int</span>
</span></span><span class=line><span class=cl>    <span class=n>disk_io_read</span><span class=p>:</span> <span class=nb>int</span>
</span></span><span class=line><span class=cl>    <span class=n>disk_io_write</span><span class=p>:</span> <span class=nb>int</span>
</span></span><span class=line><span class=cl>    <span class=n>network_sent</span><span class=p>:</span> <span class=nb>int</span>
</span></span><span class=line><span class=cl>    <span class=n>network_recv</span><span class=p>:</span> <span class=nb>int</span>
</span></span><span class=line><span class=cl>    <span class=n>active_connections</span><span class=p>:</span> <span class=nb>int</span>
</span></span><span class=line><span class=cl>    <span class=n>response_time</span><span class=p>:</span> <span class=nb>float</span>
</span></span><span class=line><span class=cl>    <span class=n>request_count</span><span class=p>:</span> <span class=nb>int</span>
</span></span><span class=line><span class=cl>    <span class=n>error_count</span><span class=p>:</span> <span class=nb>int</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>PerformanceMonitor</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;性能监控器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>collection_interval</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>5</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>collection_interval</span> <span class=o>=</span> <span class=n>collection_interval</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>metrics_history</span><span class=p>:</span> <span class=n>deque</span> <span class=o>=</span> <span class=n>deque</span><span class=p>(</span><span class=n>maxlen</span><span class=o>=</span><span class=mi>1000</span><span class=p>)</span>  <span class=c1># 保留最近1000条记录</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>is_monitoring</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>thresholds</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;cpu_usage&#39;</span><span class=p>:</span> <span class=mf>80.0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;memory_usage&#39;</span><span class=p>:</span> <span class=mf>85.0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;response_time&#39;</span><span class=p>:</span> <span class=mf>5.0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;error_rate&#39;</span><span class=p>:</span> <span class=mf>0.05</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>alerts</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>start_monitoring</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;启动监控&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>is_monitoring</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=bp>self</span><span class=o>.</span><span class=n>is_monitoring</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>metrics</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>collect_metrics</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>metrics_history</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>metrics</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># 检查告警阈值</span>
</span></span><span class=line><span class=cl>            <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>check_alerts</span><span class=p>(</span><span class=n>metrics</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=k>await</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>collection_interval</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>collect_metrics</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>PerformanceMetrics</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;收集性能指标&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 系统资源指标</span>
</span></span><span class=line><span class=cl>        <span class=n>cpu_usage</span> <span class=o>=</span> <span class=n>psutil</span><span class=o>.</span><span class=n>cpu_percent</span><span class=p>(</span><span class=n>interval</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>memory</span> <span class=o>=</span> <span class=n>psutil</span><span class=o>.</span><span class=n>virtual_memory</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>disk_io</span> <span class=o>=</span> <span class=n>psutil</span><span class=o>.</span><span class=n>disk_io_counters</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>network_io</span> <span class=o>=</span> <span class=n>psutil</span><span class=o>.</span><span class=n>net_io_counters</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 应用指标</span>
</span></span><span class=line><span class=cl>        <span class=n>active_connections</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_active_connections</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>response_time</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_average_response_time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>request_count</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_request_count</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>error_count</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_error_count</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>PerformanceMetrics</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>timestamp</span><span class=o>=</span><span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>            <span class=n>cpu_usage</span><span class=o>=</span><span class=n>cpu_usage</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>memory_usage</span><span class=o>=</span><span class=n>memory</span><span class=o>.</span><span class=n>percent</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>memory_available</span><span class=o>=</span><span class=n>memory</span><span class=o>.</span><span class=n>available</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>disk_io_read</span><span class=o>=</span><span class=n>disk_io</span><span class=o>.</span><span class=n>read_bytes</span> <span class=k>if</span> <span class=n>disk_io</span> <span class=k>else</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>disk_io_write</span><span class=o>=</span><span class=n>disk_io</span><span class=o>.</span><span class=n>write_bytes</span> <span class=k>if</span> <span class=n>disk_io</span> <span class=k>else</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>network_sent</span><span class=o>=</span><span class=n>network_io</span><span class=o>.</span><span class=n>bytes_sent</span> <span class=k>if</span> <span class=n>network_io</span> <span class=k>else</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>network_recv</span><span class=o>=</span><span class=n>network_io</span><span class=o>.</span><span class=n>bytes_recv</span> <span class=k>if</span> <span class=n>network_io</span> <span class=k>else</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>active_connections</span><span class=o>=</span><span class=n>active_connections</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>response_time</span><span class=o>=</span><span class=n>response_time</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>request_count</span><span class=o>=</span><span class=n>request_count</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>error_count</span><span class=o>=</span><span class=n>error_count</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>check_alerts</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>metrics</span><span class=p>:</span> <span class=n>PerformanceMetrics</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;检查告警条件&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>alerts</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>metrics</span><span class=o>.</span><span class=n>cpu_usage</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>thresholds</span><span class=p>[</span><span class=s1>&#39;cpu_usage&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>            <span class=n>alerts</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;type&#39;</span><span class=p>:</span> <span class=s1>&#39;CPU_HIGH&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;message&#39;</span><span class=p>:</span> <span class=sa>f</span><span class=s1>&#39;CPU使用率过高: </span><span class=si>{</span><span class=n>metrics</span><span class=o>.</span><span class=n>cpu_usage</span><span class=si>:</span><span class=s1>.2f</span><span class=si>}</span><span class=s1>%&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;severity&#39;</span><span class=p>:</span> <span class=s1>&#39;WARNING&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;timestamp&#39;</span><span class=p>:</span> <span class=n>metrics</span><span class=o>.</span><span class=n>timestamp</span>
</span></span><span class=line><span class=cl>            <span class=p>})</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>metrics</span><span class=o>.</span><span class=n>memory_usage</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>thresholds</span><span class=p>[</span><span class=s1>&#39;memory_usage&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>            <span class=n>alerts</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;type&#39;</span><span class=p>:</span> <span class=s1>&#39;MEMORY_HIGH&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;message&#39;</span><span class=p>:</span> <span class=sa>f</span><span class=s1>&#39;内存使用率过高: </span><span class=si>{</span><span class=n>metrics</span><span class=o>.</span><span class=n>memory_usage</span><span class=si>:</span><span class=s1>.2f</span><span class=si>}</span><span class=s1>%&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;severity&#39;</span><span class=p>:</span> <span class=s1>&#39;WARNING&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;timestamp&#39;</span><span class=p>:</span> <span class=n>metrics</span><span class=o>.</span><span class=n>timestamp</span>
</span></span><span class=line><span class=cl>            <span class=p>})</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>metrics</span><span class=o>.</span><span class=n>response_time</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>thresholds</span><span class=p>[</span><span class=s1>&#39;response_time&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>            <span class=n>alerts</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;type&#39;</span><span class=p>:</span> <span class=s1>&#39;RESPONSE_SLOW&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;message&#39;</span><span class=p>:</span> <span class=sa>f</span><span class=s1>&#39;响应时间过长: </span><span class=si>{</span><span class=n>metrics</span><span class=o>.</span><span class=n>response_time</span><span class=si>:</span><span class=s1>.2f</span><span class=si>}</span><span class=s1>s&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;severity&#39;</span><span class=p>:</span> <span class=s1>&#39;CRITICAL&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;timestamp&#39;</span><span class=p>:</span> <span class=n>metrics</span><span class=o>.</span><span class=n>timestamp</span>
</span></span><span class=line><span class=cl>            <span class=p>})</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 计算错误率</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>metrics</span><span class=o>.</span><span class=n>request_count</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>error_rate</span> <span class=o>=</span> <span class=n>metrics</span><span class=o>.</span><span class=n>error_count</span> <span class=o>/</span> <span class=n>metrics</span><span class=o>.</span><span class=n>request_count</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>error_rate</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>thresholds</span><span class=p>[</span><span class=s1>&#39;error_rate&#39;</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>                <span class=n>alerts</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;type&#39;</span><span class=p>:</span> <span class=s1>&#39;ERROR_RATE_HIGH&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;message&#39;</span><span class=p>:</span> <span class=sa>f</span><span class=s1>&#39;错误率过高: </span><span class=si>{</span><span class=n>error_rate</span><span class=si>:</span><span class=s1>.2%</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;severity&#39;</span><span class=p>:</span> <span class=s1>&#39;CRITICAL&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=s1>&#39;timestamp&#39;</span><span class=p>:</span> <span class=n>metrics</span><span class=o>.</span><span class=n>timestamp</span>
</span></span><span class=line><span class=cl>                <span class=p>})</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>alerts</span><span class=o>.</span><span class=n>extend</span><span class=p>(</span><span class=n>alerts</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 发送告警通知</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>alert</span> <span class=ow>in</span> <span class=n>alerts</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>send_alert_notification</span><span class=p>(</span><span class=n>alert</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_metrics_summary</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>duration_minutes</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>60</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;获取指标摘要&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>cutoff_time</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=p>(</span><span class=n>duration_minutes</span> <span class=o>*</span> <span class=mi>60</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>recent_metrics</span> <span class=o>=</span> <span class=p>[</span><span class=n>m</span> <span class=k>for</span> <span class=n>m</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>metrics_history</span> <span class=k>if</span> <span class=n>m</span><span class=o>.</span><span class=n>timestamp</span> <span class=o>&gt;=</span> <span class=n>cutoff_time</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>recent_metrics</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;avg_cpu_usage&#39;</span><span class=p>:</span> <span class=nb>sum</span><span class=p>(</span><span class=n>m</span><span class=o>.</span><span class=n>cpu_usage</span> <span class=k>for</span> <span class=n>m</span> <span class=ow>in</span> <span class=n>recent_metrics</span><span class=p>)</span> <span class=o>/</span> <span class=nb>len</span><span class=p>(</span><span class=n>recent_metrics</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;avg_memory_usage&#39;</span><span class=p>:</span> <span class=nb>sum</span><span class=p>(</span><span class=n>m</span><span class=o>.</span><span class=n>memory_usage</span> <span class=k>for</span> <span class=n>m</span> <span class=ow>in</span> <span class=n>recent_metrics</span><span class=p>)</span> <span class=o>/</span> <span class=nb>len</span><span class=p>(</span><span class=n>recent_metrics</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;avg_response_time&#39;</span><span class=p>:</span> <span class=nb>sum</span><span class=p>(</span><span class=n>m</span><span class=o>.</span><span class=n>response_time</span> <span class=k>for</span> <span class=n>m</span> <span class=ow>in</span> <span class=n>recent_metrics</span><span class=p>)</span> <span class=o>/</span> <span class=nb>len</span><span class=p>(</span><span class=n>recent_metrics</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;total_requests&#39;</span><span class=p>:</span> <span class=nb>sum</span><span class=p>(</span><span class=n>m</span><span class=o>.</span><span class=n>request_count</span> <span class=k>for</span> <span class=n>m</span> <span class=ow>in</span> <span class=n>recent_metrics</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;total_errors&#39;</span><span class=p>:</span> <span class=nb>sum</span><span class=p>(</span><span class=n>m</span><span class=o>.</span><span class=n>error_count</span> <span class=k>for</span> <span class=n>m</span> <span class=ow>in</span> <span class=n>recent_metrics</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;error_rate&#39;</span><span class=p>:</span> <span class=nb>sum</span><span class=p>(</span><span class=n>m</span><span class=o>.</span><span class=n>error_count</span> <span class=k>for</span> <span class=n>m</span> <span class=ow>in</span> <span class=n>recent_metrics</span><span class=p>)</span> <span class=o>/</span> <span class=nb>max</span><span class=p>(</span><span class=nb>sum</span><span class=p>(</span><span class=n>m</span><span class=o>.</span><span class=n>request_count</span> <span class=k>for</span> <span class=n>m</span> <span class=ow>in</span> <span class=n>recent_metrics</span><span class=p>),</span> <span class=mi>1</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;sample_count&#39;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=n>recent_metrics</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>MonitoredMcpServer</span><span class=p>(</span><span class=n>McpServer</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;带性能监控的MCP服务器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span><span class=s2>&#34;monitored-server&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>performance_monitor</span> <span class=o>=</span> <span class=n>PerformanceMonitor</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>request_stats</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;total_requests&#39;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;total_errors&#39;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;response_times&#39;</span><span class=p>:</span> <span class=n>deque</span><span class=p>(</span><span class=n>maxlen</span><span class=o>=</span><span class=mi>1000</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>start</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;启动服务器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># 启动性能监控</span>
</span></span><span class=line><span class=cl>        <span class=n>asyncio</span><span class=o>.</span><span class=n>create_task</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>performance_monitor</span><span class=o>.</span><span class=n>start_monitoring</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 启动自动优化</span>
</span></span><span class=line><span class=cl>        <span class=n>asyncio</span><span class=o>.</span><span class=n>create_task</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>auto_optimization_loop</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>handle_request</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>method</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>params</span><span class=p>:</span> <span class=nb>dict</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;处理请求并记录性能指标&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>start_time</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>request_stats</span><span class=p>[</span><span class=s1>&#39;total_requests&#39;</span><span class=p>]</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>result</span> <span class=o>=</span> <span class=k>await</span> <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=n>handle_request</span><span class=p>(</span><span class=n>method</span><span class=p>,</span> <span class=n>params</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>request_stats</span><span class=p>[</span><span class=s1>&#39;total_errors&#39;</span><span class=p>]</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span>
</span></span><span class=line><span class=cl>        <span class=k>finally</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>end_time</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>response_time</span> <span class=o>=</span> <span class=n>end_time</span> <span class=o>-</span> <span class=n>start_time</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>request_stats</span><span class=p>[</span><span class=s1>&#39;response_times&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>response_time</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_performance_report</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;获取性能报告&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>summary</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>performance_monitor</span><span class=o>.</span><span class=n>get_metrics_summary</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>recent_alerts</span> <span class=o>=</span> <span class=p>[</span><span class=n>a</span> <span class=k>for</span> <span class=n>a</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>performance_monitor</span><span class=o>.</span><span class=n>alerts</span> 
</span></span><span class=line><span class=cl>                        <span class=k>if</span> <span class=n>a</span><span class=p>[</span><span class=s1>&#39;timestamp&#39;</span><span class=p>]</span> <span class=o>&gt;</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=mi>3600</span><span class=p>]</span>  <span class=c1># 最近1小时的告警</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;system_metrics&#39;</span><span class=p>:</span> <span class=n>summary</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;request_stats&#39;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;total_requests&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>request_stats</span><span class=p>[</span><span class=s1>&#39;total_requests&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;total_errors&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>request_stats</span><span class=p>[</span><span class=s1>&#39;total_errors&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;error_rate&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>request_stats</span><span class=p>[</span><span class=s1>&#39;total_errors&#39;</span><span class=p>]</span> <span class=o>/</span> <span class=nb>max</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>request_stats</span><span class=p>[</span><span class=s1>&#39;total_requests&#39;</span><span class=p>],</span> <span class=mi>1</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=s1>&#39;avg_response_time&#39;</span><span class=p>:</span> <span class=nb>sum</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>request_stats</span><span class=p>[</span><span class=s1>&#39;response_times&#39;</span><span class=p>])</span> <span class=o>/</span> <span class=nb>max</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>request_stats</span><span class=p>[</span><span class=s1>&#39;response_times&#39;</span><span class=p>]),</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;recent_alerts&#39;</span><span class=p>:</span> <span class=n>recent_alerts</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;optimization_recommendations&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_optimization_recommendations</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_optimization_recommendations</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;获取优化建议&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>recommendations</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=n>summary</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>performance_monitor</span><span class=o>.</span><span class=n>get_metrics_summary</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>summary</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;avg_memory_usage&#39;</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>80</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>recommendations</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s2>&#34;考虑增加内存或优化内存使用&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>summary</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;avg_cpu_usage&#39;</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>80</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>recommendations</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s2>&#34;考虑增加CPU核心数或优化CPU密集型操作&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>summary</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;avg_response_time&#39;</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mf>3.0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>recommendations</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s2>&#34;考虑启用缓存或优化数据库查询&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>summary</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;error_rate&#39;</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mf>0.05</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>recommendations</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s2>&#34;检查错误日志并修复高频错误&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>recommendations</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=缓存优化策略>缓存优化策略</h3><h4 id=多级缓存系统>多级缓存系统</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>redis</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>pickle</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Any</span><span class=p>,</span> <span class=n>Optional</span><span class=p>,</span> <span class=n>Union</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>abc</span> <span class=kn>import</span> <span class=n>ABC</span><span class=p>,</span> <span class=n>abstractmethod</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>CacheBackend</span><span class=p>(</span><span class=n>ABC</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;缓存后端抽象基类&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@abstractmethod</span>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>get</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>key</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=n>Any</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=k>pass</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@abstractmethod</span>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>set</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>key</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>value</span><span class=p>:</span> <span class=n>Any</span><span class=p>,</span> <span class=n>ttl</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>pass</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@abstractmethod</span>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>delete</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>key</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>pass</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@abstractmethod</span>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>exists</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>key</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>MemoryCache</span><span class=p>(</span><span class=n>CacheBackend</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;内存缓存&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>max_size</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>1000</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>cache</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>max_size</span> <span class=o>=</span> <span class=n>max_size</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>access_times</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>get</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>key</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=n>Any</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>key</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>cache</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>access_times</span><span class=p>[</span><span class=n>key</span><span class=p>]</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>cache</span><span class=p>[</span><span class=n>key</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>set</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>key</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>value</span><span class=p>:</span> <span class=n>Any</span><span class=p>,</span> <span class=n>ttl</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>cache</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=bp>self</span><span class=o>.</span><span class=n>max_size</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># LRU淘汰</span>
</span></span><span class=line><span class=cl>            <span class=n>oldest_key</span> <span class=o>=</span> <span class=nb>min</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>access_times</span><span class=o>.</span><span class=n>keys</span><span class=p>(),</span> 
</span></span><span class=line><span class=cl>                           <span class=n>key</span><span class=o>=</span><span class=k>lambda</span> <span class=n>k</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>access_times</span><span class=p>[</span><span class=n>k</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>delete</span><span class=p>(</span><span class=n>oldest_key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>cache</span><span class=p>[</span><span class=n>key</span><span class=p>]</span> <span class=o>=</span> <span class=n>value</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>access_times</span><span class=p>[</span><span class=n>key</span><span class=p>]</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>ttl</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 设置过期时间</span>
</span></span><span class=line><span class=cl>            <span class=n>asyncio</span><span class=o>.</span><span class=n>create_task</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_expire_key</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>ttl</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>_expire_key</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>key</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>ttl</span><span class=p>:</span> <span class=nb>int</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=n>ttl</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>delete</span><span class=p>(</span><span class=n>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>delete</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>key</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>cache</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>access_times</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>exists</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>key</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>key</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>cache</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>RedisCache</span><span class=p>(</span><span class=n>CacheBackend</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Redis缓存&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>redis_url</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s2>&#34;redis://localhost:6379&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>redis</span> <span class=o>=</span> <span class=n>redis</span><span class=o>.</span><span class=n>from_url</span><span class=p>(</span><span class=n>redis_url</span><span class=p>,</span> <span class=n>decode_responses</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>get</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>key</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=n>Any</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>redis</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>data</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>pickle</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>set</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>key</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>value</span><span class=p>:</span> <span class=n>Any</span><span class=p>,</span> <span class=n>ttl</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span> <span class=o>=</span> <span class=n>pickle</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>ttl</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>redis</span><span class=o>.</span><span class=n>setex</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>ttl</span><span class=p>,</span> <span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>redis</span><span class=o>.</span><span class=n>set</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>delete</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>key</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>redis</span><span class=o>.</span><span class=n>delete</span><span class=p>(</span><span class=n>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>exists</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>key</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>redis</span><span class=o>.</span><span class=n>exists</span><span class=p>(</span><span class=n>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>MultiLevelCache</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;多级缓存系统&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>levels</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=n>MemoryCache</span><span class=p>(</span><span class=n>max_size</span><span class=o>=</span><span class=mi>100</span><span class=p>),</span>  <span class=c1># L1: 内存缓存</span>
</span></span><span class=line><span class=cl>            <span class=n>RedisCache</span><span class=p>(),</span>               <span class=c1># L2: Redis缓存</span>
</span></span><span class=line><span class=cl>        <span class=p>]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>get</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>key</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=n>Any</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;从缓存获取数据，按级别查找&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>cache</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>levels</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>value</span> <span class=o>=</span> <span class=k>await</span> <span class=n>cache</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>value</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1># 回填到更高级别的缓存</span>
</span></span><span class=line><span class=cl>                <span class=k>for</span> <span class=n>j</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>i</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                    <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>levels</span><span class=p>[</span><span class=n>j</span><span class=p>]</span><span class=o>.</span><span class=n>set</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>value</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>set</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>key</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>value</span><span class=p>:</span> <span class=n>Any</span><span class=p>,</span> <span class=n>ttl</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;设置缓存到所有级别&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>cache</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>levels</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>await</span> <span class=n>cache</span><span class=o>.</span><span class=n>set</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>value</span><span class=p>,</span> <span class=n>ttl</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>delete</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>key</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;从所有级别删除缓存&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>cache</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>levels</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>await</span> <span class=n>cache</span><span class=o>.</span><span class=n>delete</span><span class=p>(</span><span class=n>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>CachedMcpServer</span><span class=p>(</span><span class=n>McpServer</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;带缓存的MCP服务器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span><span class=s2>&#34;cached-server&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>cache</span> <span class=o>=</span> <span class=n>MultiLevelCache</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>cache_stats</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;hits&#39;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;misses&#39;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;sets&#39;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;deletes&#39;</span><span class=p>:</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>read_resource</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>uri</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;带缓存的资源读取&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>cache_key</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;resource:</span><span class=si>{</span><span class=n>uri</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 尝试从缓存获取</span>
</span></span><span class=line><span class=cl>        <span class=n>cached_data</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>cache</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>cache_key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>cached_data</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>cache_stats</span><span class=p>[</span><span class=s1>&#39;hits&#39;</span><span class=p>]</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>cached_data</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 缓存未命中，从源读取</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>cache_stats</span><span class=p>[</span><span class=s1>&#39;misses&#39;</span><span class=p>]</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=n>data</span> <span class=o>=</span> <span class=k>await</span> <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=n>read_resource</span><span class=p>(</span><span class=n>uri</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 存入缓存</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>cache</span><span class=o>.</span><span class=n>set</span><span class=p>(</span><span class=n>cache_key</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=n>ttl</span><span class=o>=</span><span class=mi>3600</span><span class=p>)</span>  <span class=c1># 1小时过期</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>cache_stats</span><span class=p>[</span><span class=s1>&#39;sets&#39;</span><span class=p>]</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>data</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>get_cache_stats</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Dict</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;获取缓存统计&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>total_requests</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>cache_stats</span><span class=p>[</span><span class=s1>&#39;hits&#39;</span><span class=p>]</span> <span class=o>+</span> <span class=bp>self</span><span class=o>.</span><span class=n>cache_stats</span><span class=p>[</span><span class=s1>&#39;misses&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>hit_rate</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>cache_stats</span><span class=p>[</span><span class=s1>&#39;hits&#39;</span><span class=p>]</span> <span class=o>/</span> <span class=nb>max</span><span class=p>(</span><span class=n>total_requests</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;hit_rate&#39;</span><span class=p>:</span> <span class=n>hit_rate</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;total_hits&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>cache_stats</span><span class=p>[</span><span class=s1>&#39;hits&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;total_misses&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>cache_stats</span><span class=p>[</span><span class=s1>&#39;misses&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;total_sets&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>cache_stats</span><span class=p>[</span><span class=s1>&#39;sets&#39;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;total_deletes&#39;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>cache_stats</span><span class=p>[</span><span class=s1>&#39;deletes&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=性能调优>性能调优</h3><h4 id=1-连接池管理>1. 连接池管理</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>asyncio</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>contextlib</span> <span class=kn>import</span> <span class=n>asynccontextmanager</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>PooledMcpServer</span><span class=p>(</span><span class=n>McpServer</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span><span class=s2>&#34;pooled-server&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>connection_pool</span> <span class=o>=</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>Queue</span><span class=p>(</span><span class=n>maxsize</span><span class=o>=</span><span class=mi>10</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>metrics</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;active_connections&#39;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;total_requests&#39;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;error_count&#39;</span><span class=p>:</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nd>@asynccontextmanager</span>
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>get_connection</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;获取连接的上下文管理器&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;active_connections&#39;</span><span class=p>]</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>            <span class=n>connection</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>connection_pool</span><span class=o>.</span><span class=n>get</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=k>yield</span> <span class=n>connection</span>
</span></span><span class=line><span class=cl>        <span class=k>finally</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>connection_pool</span><span class=o>.</span><span class=n>put</span><span class=p>(</span><span class=n>connection</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>metrics</span><span class=p>[</span><span class=s1>&#39;active_connections&#39;</span><span class=p>]</span> <span class=o>-=</span> <span class=mi>1</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=2-请求限流>2. 请求限流</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>collections</span> <span class=kn>import</span> <span class=n>defaultdict</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>RateLimitedServer</span><span class=p>(</span><span class=n>McpServer</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span><span class=s2>&#34;rate-limited-server&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>request_counts</span> <span class=o>=</span> <span class=n>defaultdict</span><span class=p>(</span><span class=nb>list</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>rate_limit</span> <span class=o>=</span> <span class=mi>100</span>  <span class=c1># 每分钟100个请求</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>check_rate_limit</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>client_id</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;检查请求频率限制&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>now</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>minute_ago</span> <span class=o>=</span> <span class=n>now</span> <span class=o>-</span> <span class=mi>60</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 清理过期记录</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>request_counts</span><span class=p>[</span><span class=n>client_id</span><span class=p>]</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=n>timestamp</span> <span class=k>for</span> <span class=n>timestamp</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>request_counts</span><span class=p>[</span><span class=n>client_id</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>timestamp</span> <span class=o>&gt;</span> <span class=n>minute_ago</span>
</span></span><span class=line><span class=cl>        <span class=p>]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># 检查是否超过限制</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>request_counts</span><span class=p>[</span><span class=n>client_id</span><span class=p>])</span> <span class=o>&gt;=</span> <span class=bp>self</span><span class=o>.</span><span class=n>rate_limit</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span> <span class=n>McpError</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>code</span><span class=o>=</span><span class=n>ErrorCode</span><span class=o>.</span><span class=n>RATE_LIMITED</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>message</span><span class=o>=</span><span class=s2>&#34;请求频率过高，请稍后重试&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>request_counts</span><span class=p>[</span><span class=n>client_id</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>now</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=监控体系>监控体系</h3><h4 id=1-指标收集>1. 指标收集</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>dataclasses</span> <span class=kn>import</span> <span class=n>dataclass</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Dict</span><span class=p>,</span> <span class=n>Any</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@dataclass</span>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>RequestMetrics</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>method</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>duration</span><span class=p>:</span> <span class=nb>float</span>
</span></span><span class=line><span class=cl>    <span class=n>success</span><span class=p>:</span> <span class=nb>bool</span>
</span></span><span class=line><span class=cl>    <span class=n>client_id</span><span class=p>:</span> <span class=nb>str</span>
</span></span><span class=line><span class=cl>    <span class=n>timestamp</span><span class=p>:</span> <span class=nb>float</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>MonitoredMcpServer</span><span class=p>(</span><span class=n>McpServer</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span><span class=s2>&#34;monitored-server&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>metrics</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>RequestMetrics</span><span class=p>]</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>health_status</span> <span class=o>=</span> <span class=s2>&#34;healthy&#34;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>handle_request</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>method</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>params</span><span class=p>:</span> <span class=n>Dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;处理请求并收集指标&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>start_time</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>client_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_current_client_id</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>success</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>result</span> <span class=o>=</span> <span class=k>await</span> <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=n>handle_request</span><span class=p>(</span><span class=n>method</span><span class=p>,</span> <span class=n>params</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>result</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>success</span> <span class=o>=</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>            <span class=k>raise</span>
</span></span><span class=line><span class=cl>        <span class=k>finally</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>duration</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>start_time</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>metrics</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>RequestMetrics</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>method</span><span class=o>=</span><span class=n>method</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>duration</span><span class=o>=</span><span class=n>duration</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>success</span><span class=o>=</span><span class=n>success</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>client_id</span><span class=o>=</span><span class=n>client_id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>timestamp</span><span class=o>=</span><span class=n>start_time</span>
</span></span><span class=line><span class=cl>            <span class=p>))</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>async</span> <span class=k>def</span> <span class=nf>get_health_status</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;健康检查端点&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>recent_errors</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=n>m</span> <span class=k>for</span> <span class=n>m</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>metrics</span><span class=p>[</span><span class=o>-</span><span class=mi>100</span><span class=p>:]</span>  <span class=c1># 最近100个请求</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=ow>not</span> <span class=n>m</span><span class=o>.</span><span class=n>success</span>
</span></span><span class=line><span class=cl>        <span class=p>]</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>error_rate</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>recent_errors</span><span class=p>)</span> <span class=o>/</span> <span class=nb>min</span><span class=p>(</span><span class=mi>100</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>metrics</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>error_rate</span> <span class=o>&gt;</span> <span class=mf>0.1</span><span class=p>:</span>  <span class=c1># 错误率超过10%</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>health_status</span> <span class=o>=</span> <span class=s2>&#34;unhealthy&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=bp>self</span><span class=o>.</span><span class=n>health_status</span> <span class=o>=</span> <span class=s2>&#34;healthy&#34;</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;status&#34;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>health_status</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;error_rate&#34;</span><span class=p>:</span> <span class=n>error_rate</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;total_requests&#34;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>metrics</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;uptime&#34;</span><span class=p>:</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=bp>self</span><span class=o>.</span><span class=n>start_time</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=-学习资源与社区>📚 学习资源与社区</h2><h3 id=官方资源>官方资源</h3><ul><li><strong><a href=https://modelcontextprotocol.io target=_blank rel="noopener noreffer">MCP官方文档</a></strong> - 完整的协议规范和开发指南</li><li><strong><a href=https://www.anthropic.com/news/model-context-protocol target=_blank rel="noopener noreffer">Anthropic官方博客</a></strong> - MCP发布公告和技术解读</li><li><strong><a href=https://github.com/modelcontextprotocol target=_blank rel="noopener noreffer">GitHub仓库</a></strong> - 官方SDK和示例代码</li><li><strong><a href=https://github.com/modelcontextprotocol/inspector target=_blank rel="noopener noreffer">MCP Inspector</a></strong> - 调试和测试工具</li></ul><h3 id=开发工具>开发工具</h3><ul><li><strong>Python SDK</strong>: <code>pip install mcp</code></li><li><strong>TypeScript SDK</strong>: <code>npm install @modelcontextprotocol/sdk</code></li><li><strong>调试工具</strong>: <code>npm install -g @modelcontextprotocol/inspector</code></li></ul><h3 id=社区项目>社区项目</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-markdown data-lang=markdown><span class=line><span class=cl>🔧 实用工具：
</span></span><span class=line><span class=cl><span class=k>-</span> MCP服务器模板库
</span></span><span class=line><span class=cl><span class=k>-</span> 可视化配置工具
</span></span><span class=line><span class=cl><span class=k>-</span> 性能监控仪表板
</span></span><span class=line><span class=cl><span class=k>-</span> 自动化测试框架
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>🌟 开源服务器：
</span></span><span class=line><span class=cl><span class=k>-</span> 文件系统服务器
</span></span><span class=line><span class=cl><span class=k>-</span> 数据库连接器
</span></span><span class=line><span class=cl><span class=k>-</span> GitHub集成
</span></span><span class=line><span class=cl><span class=k>-</span> Slack集成
</span></span><span class=line><span class=cl><span class=k>-</span> Google Drive连接器
</span></span></code></pre></td></tr></table></div></div><hr><h2 id=-总结>📝 总结</h2><p>MCP（Model Context Protocol）作为AI领域的重要技术创新，为构建智能、互联的AI系统提供了标准化的解决方案。通过本文的深入解析，我们了解了：</p><h3 id=-核心价值>🎯 核心价值</h3><ol><li><strong>标准化</strong>: 统一AI模型与数据源的连接方式</li><li><strong>可扩展</strong>: 支持灵活的服务器组合和扩展</li><li><strong>安全性</strong>: 内置权限控制和数据保护机制</li><li><strong>开放性</strong>: 开源协议，促进生态发展</li></ol><h3 id=-技术特点>🏗️ 技术特点</h3><ul><li>简洁的客户端-服务器架构</li><li>强大的Resources、Tools、Prompts三大核心概念</li><li>灵活的传输协议支持</li><li>完善的错误处理机制</li></ul><h3 id=-发展前景>🚀 发展前景</h3><p>MCP将成为AI应用开发的重要基础设施，推动AI工具的标准化和生态化发展。随着更多工具和平台的支持，MCP生态系统将越来越丰富，为开发者和企业提供更强大的AI应用构建能力。</p><p><strong>开始你的MCP之旅</strong>：从简单的文件系统服务器开始，逐步探索更复杂的应用场景，加入这个激动人心的技术生态！</p><hr><p><em>参考资料：</em></p><ul><li><em><a href=https://www.anthropic.com/news/model-context-protocol target=_blank rel="noopener noreffer">Anthropic官方MCP介绍</a></em></li><li><em><a href=https://modelcontextprotocol.io target=_blank rel="noopener noreffer">MCP官方文档</a></em></li><li><em><a href=https://github.com/modelcontextprotocol target=_blank rel="noopener noreffer">MCP GitHub仓库</a></em></li></ul><blockquote><p>💡 <strong>提示</strong>：MCP技术还在快速发展中，建议关注官方更新，及时学习新特性和最佳实践！</p></blockquote></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2025-06-15</span></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/mcp/index.md target=_blank>阅读原始文档</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 Twitter" data-sharer=twitter data-url=https://sincerecsl.github.io/mcp/ data-title="深入理解MCP：Model Context Protocol架构解析与开发实践" data-via=SincereCSL95 data-hashtags=MCP,AI,LLM,Claude,协议,架构><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=https://sincerecsl.github.io/mcp/ data-hashtag=MCP><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 WhatsApp" data-sharer=whatsapp data-url=https://sincerecsl.github.io/mcp/ data-title="深入理解MCP：Model Context Protocol架构解析与开发实践" data-web><i class="fab fa-whatsapp fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 Hacker News" data-sharer=hackernews data-url=https://sincerecsl.github.io/mcp/ data-title="深入理解MCP：Model Context Protocol架构解析与开发实践"><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 Reddit" data-sharer=reddit data-url=https://sincerecsl.github.io/mcp/><i class="fab fa-reddit fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 Line" data-sharer=line data-url=https://sincerecsl.github.io/mcp/ data-title="深入理解MCP：Model Context Protocol架构解析与开发实践"><i data-svg-src=/lib/simple-icons/icons/line.min.svg aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://sincerecsl.github.io/mcp/ data-title="深入理解MCP：Model Context Protocol架构解析与开发实践" data-ralateuid=u/5535058729><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 Blogger" data-sharer=blogger data-url=https://sincerecsl.github.io/mcp/ data-title="深入理解MCP：Model Context Protocol架构解析与开发实践" data-description="全面解析MCP（Model Context Protocol）：从架构原理到开发实践，探索AI工具的标准化连接协议"><i class="fab fa-blogger fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 Evernote" data-sharer=evernote data-url=https://sincerecsl.github.io/mcp/ data-title="深入理解MCP：Model Context Protocol架构解析与开发实践"><i class="fab fa-evernote fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 Skype" data-sharer=skype data-url=https://sincerecsl.github.io/mcp/ data-title="深入理解MCP：Model Context Protocol架构解析与开发实践"><i class="fab fa-skype fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/mcp/>MCP</a>,&nbsp;<a href=/tags/ai/>AI</a>,&nbsp;<a href=/tags/llm/>LLM</a>,&nbsp;<a href=/tags/claude/>Claude</a>,&nbsp;<a href=/tags/%E5%8D%8F%E8%AE%AE/>协议</a>,&nbsp;<a href=/tags/%E6%9E%B6%E6%9E%84/>架构</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/ai/ class=next rel=next title=我的AI工具使用笔记>我的AI工具使用笔记<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div><div id=comments><div id=valine class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://valine.js.org/>Valine</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>SincereCSL</div><div class=footer-line>由 <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.147.9">Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2022 - 2025</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank></a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=/lib/valine/valine.min.css><link rel=stylesheet href=/lib/katex/katex.min.css><link rel=stylesheet href=/lib/cookieconsent/cookieconsent.min.css><script type=text/javascript src=/lib/valine/Valine.min.js></script><script type=text/javascript src=/lib/autocomplete/autocomplete.min.js></script><script type=text/javascript src=/lib/lunr/lunr.min.js></script><script type=text/javascript src=/lib/lunr/lunr.stemmer.support.min.js></script><script type=text/javascript src=/lib/lunr/lunr.zh.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/sharer/sharer.min.js></script><script type=text/javascript src=/lib/katex/katex.min.js></script><script type=text/javascript src=/lib/katex/contrib/auto-render.min.js></script><script type=text/javascript src=/lib/katex/contrib/copy-tex.min.js></script><script type=text/javascript src=/lib/katex/contrib/mhchem.min.js></script><script type=text/javascript src=/lib/cookieconsent/cookieconsent.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:10},comment:{valine:{appId:"nM17GGWo6Zp1bj316CxfmLIo-MdYXbMMI",appKey:"z9DvzP8ZaKB4Ci6y2ivyepGR",avatar:"mp",el:"#valine",emojiCDN:"https://cdn.jsdelivr.net/npm/emoji-datasource-google@14.0.0/img/google/64/",emojiMaps:{100:"1f4af.png",alien:"1f47d.png",anger:"1f4a2.png",angry:"1f620.png",anguished:"1f627.png",astonished:"1f632.png",black_heart:"1f5a4.png",blue_heart:"1f499.png",blush:"1f60a.png",bomb:"1f4a3.png",boom:"1f4a5.png",broken_heart:"1f494.png",brown_heart:"1f90e.png",clown_face:"1f921.png",cold_face:"1f976.png",cold_sweat:"1f630.png",confounded:"1f616.png",confused:"1f615.png",cry:"1f622.png",crying_cat_face:"1f63f.png",cupid:"1f498.png",dash:"1f4a8.png",disappointed:"1f61e.png",disappointed_relieved:"1f625.png",dizzy:"1f4ab.png",dizzy_face:"1f635.png",drooling_face:"1f924.png",exploding_head:"1f92f.png",expressionless:"1f611.png",face_vomiting:"1f92e.png",face_with_cowboy_hat:"1f920.png",face_with_hand_over_mouth:"1f92d.png",face_with_head_bandage:"1f915.png",face_with_monocle:"1f9d0.png",face_with_raised_eyebrow:"1f928.png",face_with_rolling_eyes:"1f644.png",face_with_symbols_on_mouth:"1f92c.png",face_with_thermometer:"1f912.png",fearful:"1f628.png",flushed:"1f633.png",frowning:"1f626.png",ghost:"1f47b.png",gift_heart:"1f49d.png",green_heart:"1f49a.png",grimacing:"1f62c.png",grin:"1f601.png",grinning:"1f600.png",hankey:"1f4a9.png",hear_no_evil:"1f649.png",heart:"2764-fe0f.png",heart_decoration:"1f49f.png",heart_eyes:"1f60d.png",heart_eyes_cat:"1f63b.png",heartbeat:"1f493.png",heartpulse:"1f497.png",heavy_heart_exclamation_mark_ornament:"2763-fe0f.png",hole:"1f573-fe0f.png",hot_face:"1f975.png",hugging_face:"1f917.png",hushed:"1f62f.png",imp:"1f47f.png",innocent:"1f607.png",japanese_goblin:"1f47a.png",japanese_ogre:"1f479.png",joy:"1f602.png",joy_cat:"1f639.png",kiss:"1f48b.png",kissing:"1f617.png",kissing_cat:"1f63d.png",kissing_closed_eyes:"1f61a.png",kissing_heart:"1f618.png",kissing_smiling_eyes:"1f619.png",laughing:"1f606.png",left_speech_bubble:"1f5e8-fe0f.png",love_letter:"1f48c.png",lying_face:"1f925.png",mask:"1f637.png",money_mouth_face:"1f911.png",nauseated_face:"1f922.png",nerd_face:"1f913.png",neutral_face:"1f610.png",no_mouth:"1f636.png",open_mouth:"1f62e.png",orange_heart:"1f9e1.png",partying_face:"1f973.png",pensive:"1f614.png",persevere:"1f623.png",pleading_face:"1f97a.png",pouting_cat:"1f63e.png",purple_heart:"1f49c.png",rage:"1f621.png",relaxed:"263a-fe0f.png",relieved:"1f60c.png",revolving_hearts:"1f49e.png",right_anger_bubble:"1f5ef-fe0f.png",robot_face:"1f916.png",rolling_on_the_floor_laughing:"1f923.png",scream:"1f631.png",scream_cat:"1f640.png",see_no_evil:"1f648.png",shushing_face:"1f92b.png",skull:"1f480.png",skull_and_crossbones:"2620-fe0f.png",sleeping:"1f634.png",sleepy:"1f62a.png",slightly_frowning_face:"1f641.png",slightly_smiling_face:"1f642.png",smile:"1f604.png",smile_cat:"1f638.png",smiley:"1f603.png",smiley_cat:"1f63a.png",smiling_face_with_3_hearts:"1f970.png",smiling_imp:"1f608.png",smirk:"1f60f.png",smirk_cat:"1f63c.png",sneezing_face:"1f927.png",sob:"1f62d.png",space_invader:"1f47e.png",sparkling_heart:"1f496.png",speak_no_evil:"1f64a.png",speech_balloon:"1f4ac.png","star-struck":"1f929.png",stuck_out_tongue:"1f61b.png",stuck_out_tongue_closed_eyes:"1f61d.png",stuck_out_tongue_winking_eye:"1f61c.png",sunglasses:"1f60e.png",sweat:"1f613.png",sweat_drops:"1f4a6.png",sweat_smile:"1f605.png",thinking_face:"1f914.png",thought_balloon:"1f4ad.png",tired_face:"1f62b.png",triumph:"1f624.png",two_hearts:"1f495.png",unamused:"1f612.png",upside_down_face:"1f643.png",weary:"1f629.png",white_frowning_face:"2639-fe0f.png",white_heart:"1f90d.png",wink:"1f609.png",woozy_face:"1f974.png",worried:"1f61f.png",yawning_face:"1f971.png",yellow_heart:"1f49b.png",yum:"1f60b.png",zany_face:"1f92a.png",zipper_mouth_face:"1f910.png",zzz:"1f4a4.png"},enableQQ:!1,highlight:!0,lang:"zh-CN",pageSize:10,placeholder:"说点什么吧...",recordIP:!0,serverURLs:"https://nm17ggwo.api.lncldglobal.com",visitor:!0}},cookieconsent:{content:{dismiss:"同意",link:"了解更多",message:"本网站使用 Cookies 来改善您的浏览体验."},enable:!0,palette:{button:{background:"#f0f0f0"},popup:{background:"#1aa3ff"}},theme:"edgeless"},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{highlightTag:"em",lunrIndexURL:"/index.json",lunrLanguageCode:"zh",lunrSegmentitURL:"/lib/lunr/lunr.segmentit.js",maxResultLength:10,noResultsFound:"没有找到结果",snippetLength:50,type:"lunr"}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>